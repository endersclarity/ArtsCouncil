<!DOCTYPE html>
<!--
  Nevada County Arts Council Cultural Asset Map
  Neumorphism Design Variant

  This variant applies soft neumorphic design principles:
  - Soft gray background (#e0e5ec)
  - Raised and inset shadow effects
  - Minimal borders, tactile appearance
  - Low contrast, muted colors

  Source: index-maplibre.html
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Culture of Nevada County — Neumorphism</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="preconnect" href="https://api.maptiler.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Heritage Neumorphism - Warm, vintage civic aesthetic */
  --neuro-bg: #F4EFE6;
  --neuro-light: rgba(255,250,240,0.8);
  --neuro-dark: rgba(80,60,40,0.2);

  /* Heritage palette - Badge-aligned colors */
  --ink: #4A6B7C;              /* Slate navy from badge "CULTURAL ASSETS" */
  --cream: #F4EFE6;            /* Warm parchment background */
  --parchment: #E8DFD0;        /* Badge cream background */
  --gold: #D4AF37;             /* Rich gold from badge border/text */
  --gold-bright: #E0BB4A;      /* Brighter gold hover */
  --rust: #B85C38;             /* Warm rust accent */
  --deep-green: #5C7A5C;       /* Forest green from badge photo */
  --slate: #A89070;            /* Warm brown from badge landscape */
  --red-accent: #A0522D;       /* Terracotta */
  --blue-wash: #87CEEB;        /* Sky blue from badge photo */

  /* Heritage category colors - badge-derived palette */
  --cat-landmarks: #A0522D;       /* Terracotta/brick */
  --cat-eat: #D4AF37;             /* Rich gold from badge */
  --cat-arts: #5C7A5C;            /* Forest green from badge */
  --cat-cultural: #4A6B7C;        /* Slate navy from badge */
  --cat-fairs: #B85C38;           /* Aged rust */
  --cat-galleries: #7A6B7D;       /* Dusty plum/museum */
  --cat-walks: #7A9E7E;           /* Mountain green from badge */
  --cat-publicart: #D4AF37;       /* Rich gold from badge */
  --cat-performance: #87CEEB;     /* Sky blue from badge */
  --cat-preservation: #8B7355;    /* Warm brown from badge */

  --font-display: 'Playfair Display', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;

  /* Heritage Neumorphic shadows - warm brown tones */
  --shadow-raised: 6px 6px 12px rgba(80,60,40,0.2), -6px -6px 12px rgba(255,250,240,0.8);
  --shadow-inset: inset 3px 3px 6px rgba(80,60,40,0.2), inset -3px -3px 6px rgba(255,250,240,0.8);
  --shadow-soft: 4px 4px 8px rgba(80,60,40,0.15), -4px -4px 8px rgba(255,250,240,0.7);
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  font-weight: 500;
  background: var(--neuro-bg);
  color: var(--ink);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ========== HERO ========== */
.hero {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 3.2rem 3rem 1.35rem;
  background: var(--neuro-bg);
  overflow: hidden;
  position: relative;
}

.hero-badge {
  position: relative;
  z-index: 1;
  width: 440px;
  max-width: 80vw;
  opacity: 0;
  transform: scale(0.95);
  animation: badgeReveal 1.2s cubic-bezier(0.22, 1, 0.36, 1) 0.2s forwards;
  margin-bottom: 1.1rem;
  padding: 1rem;
  border-radius: 20px;
  background: var(--neuro-bg);
  box-shadow: var(--shadow-raised);
}

@keyframes badgeReveal {
  to { opacity: 1; transform: scale(1); }
}

.hero-content {
  position: relative;
  z-index: 1;
  max-width: 760px;
}

.hero-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--rust);
  margin-bottom: 1rem;
  opacity: 0;
  transform: translateY(15px);
  animation: fadeUp 0.8s ease 0.6s forwards;
}

.hero-title {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: clamp(1.8rem, 4vw, 2.8rem);
  line-height: 1.1;
  color: var(--ink);
  margin-bottom: 1rem;
  opacity: 0;
  transform: translateY(15px);
  animation: fadeUp 0.8s ease 0.8s forwards;
}

.hero-title em {
  font-style: italic;
  color: var(--gold);
}

.hero-sub {
  font-size: clamp(0.98rem, 1.7vw, 1.15rem);
  line-height: 1.55;
  color: var(--slate);
  max-width: 760px;
  margin: 0 auto;
  font-weight: 400;
  opacity: 0;
  transform: translateY(15px);
  animation: fadeUp 0.8s ease 1s forwards;
}

.hero-sub strong {
  color: var(--ink);
  font-weight: 700;
}

.hero-instructions {
  margin-top: 0.65rem;
  font-family: var(--font-mono);
  font-size: 0.56rem;
  letter-spacing: 0.09em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.5);
  opacity: 0;
  transform: translateY(10px);
  animation: fadeUp 0.8s ease 1.1s forwards;
}

@media (max-width: 600px) {
  .hero { padding: 2.35rem 1.2rem 1.1rem; }
  .hero-badge { width: 240px; }
  .hero-instructions { font-size: 0.52rem; letter-spacing: 0.07em; }
}

/* ========== SECTION INTRO ========== */
.section-intro {
  padding: 1.1rem 3rem 1.4rem;
  max-width: 1080px;
  margin: 0 auto;
  display: block;
  position: relative;
  z-index: 1;
  border-top: none;
}

/* Full-width neumorphic background behind centered intro */
.section-intro::before {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100vw;
  background: var(--neuro-bg);
  z-index: -1;
}

.section-intro .col-right { display: none; }

/* Removed paper texture for neumorphism */

.section-intro > * { position: relative; z-index: 1; }

/* Section divider watercolor decorations */
.section-watercolor {
  position: absolute;
  pointer-events: none;
  z-index: 0;
  opacity: 0.06;
}

/* hero watercolors now in layout, not absolute positioned */

.explore-section {
  position: relative;
}

.explore-section .section-watercolor {
  top: -1rem;
  left: 2rem;
  width: 180px;
  opacity: 0.05;
}

.colophon {
  position: relative;
}

.colophon .section-watercolor {
  top: 50%;
  right: 3rem;
  transform: translateY(-50%);
  width: 150px;
  opacity: 0.04;
}

.section-intro .col-left {
  position: static;
}

.section-tag {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--rust);
  margin-bottom: 1rem;
}

.section-heading {
  font-family: var(--font-display);
  font-size: clamp(1.28rem, 2.15vw, 1.85rem);
  font-weight: 700;
  line-height: 1.16;
  color: var(--ink);
  margin-bottom: 0.62rem;
}

.section-body {
  font-size: 0.95rem;
  line-height: 1.62;
  color: var(--slate);
  max-width: 860px;
}

.section-body p + p { margin-top: 0.55rem; }

.section-quicktips {
  margin-top: 0.68rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
}

.section-quicktip {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.28rem 0.48rem;
  border-radius: 999px;
  border: 1px solid rgba(26,22,18,0.14);
  background: rgba(244,239,231,0.86);
  font-family: var(--font-mono);
  font-size: 0.5rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.6);
}

.section-quicktip-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(26,22,18,0.4);
}

/* ========== CATEGORY CARDS ========== */
.categories-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
}

.cat-card {
  padding: 1.25rem 1.25rem 1.25rem 1rem;
  border: none;
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
  overflow: visible;
  background: var(--neuro-bg);
  display: flex;
  align-items: center;
  gap: 0.85rem;
  border-radius: 12px;
  box-shadow: var(--shadow-raised);
}

.cat-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 4px;
  height: 100%;
  background: var(--cat-color, var(--gold));
  transform: scaleY(0);
  transform-origin: bottom;
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  border-radius: 12px 0 0 12px;
}

.cat-card::after {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--cat-color, var(--gold));
  opacity: 0;
  transition: opacity 0.35s ease;
  z-index: 0;
  border-radius: 12px;
}

.cat-card:hover::before,
.cat-card.active::before { transform: scaleY(1); }

.cat-card:hover::after { opacity: 0.02; }
.cat-card.active::after { opacity: 0.04; }

.cat-card:hover, .cat-card.active {
  border-color: transparent;
  box-shadow: var(--shadow-inset);
  transform: translateY(2px);
}

.cat-card > * { position: relative; z-index: 1; }

.cat-icon {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  background: var(--neuro-bg);
  box-shadow: var(--shadow-soft);
}

.cat-card:hover .cat-icon { transform: scale(1.1); }
.cat-card.active .cat-icon { transform: scale(1.15); }

.cat-icon svg {
  width: 18px;
  height: 18px;
}

.cat-icon-watercolor {
  width: 32px;
  height: 32px;
  object-fit: contain;
}

.cat-icon-svg { display: flex; align-items: center; justify-content: center; }

.cat-card-info { flex: 1; min-width: 0; }

.cat-card-count {
  font-family: var(--font-display);
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--cat-color, var(--ink));
  line-height: 1;
  transition: color 0.2s ease;
}

.cat-card-name {
  font-size: 0.72rem;
  font-weight: 500;
  color: var(--slate);
  margin-top: 0.2rem;
  letter-spacing: 0.02em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.cat-card-active-label {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  opacity: 0;
  transition: opacity 0.25s ease;
  margin-top: 0.15rem;
  color: var(--cat-color, var(--gold));
}

.cat-card.active .cat-card-active-label { opacity: 1; }

/* ========== MAP SECTION ========== */
.map-section {
  background: var(--neuro-bg);
  padding: 0;
  position: relative;
  z-index: 1;
  transition: background 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

.map-header {
  padding: 4rem 3rem 1.2rem;
  max-width: 1400px;
  margin: 0 auto;
}

.map-title {
  font-family: var(--font-display);
  font-size: clamp(1.5rem, 3vw, 2.5rem);
  color: var(--ink);
  font-weight: 700;
  transition: color 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

.map-filter-bar {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  justify-content: flex-start;
  max-width: 980px;
}

.map-overlay-controls {
  position: absolute;
  top: 2.1rem;
  left: 2.1rem;
  right: 5.25rem;
  z-index: 20;
}

.map-filter-toggle {
  display: inline-flex;
  align-items: center;
  gap: 0.45rem;
  font-family: var(--font-body);
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--ink);
  background: rgba(244,239,231,0.96);
  border: 1px solid rgba(26,22,18,0.14);
  border-radius: 999px;
  padding: 0.38rem 0.62rem 0.38rem 0.48rem;
  box-shadow: 0 8px 20px rgba(26,22,18,0.16);
  cursor: pointer;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.map-filter-toggle:hover {
  transform: translateY(-1px);
}

.map-filter-toggle-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: rgba(26,22,18,0.34);
}

.map-filter-toggle-meta {
  font-family: var(--font-mono);
  font-size: 0.52rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.58);
  border: 1px solid rgba(26,22,18,0.12);
  border-radius: 999px;
  padding: 0.12rem 0.38rem;
}

.map-filter-toggle-caret {
  font-size: 0.68rem;
  color: rgba(26,22,18,0.55);
  transition: transform 0.2s ease;
}

.map-filter-panel {
  display: none;
  margin-top: 0.45rem;
  max-width: min(980px, calc(100vw - 170px));
}

.map-overlay-controls.expanded .map-filter-panel {
  display: block;
}

.map-overlay-controls.expanded .map-filter-toggle-caret {
  transform: rotate(180deg);
}

.map-filter-panel .map-filter-bar {
  background: rgba(244,239,231,0.92);
  border: 1px solid rgba(26,22,18,0.12);
  border-radius: 12px;
  box-shadow: 0 10px 24px rgba(26,22,18,0.14);
  padding: 0.45rem 0.55rem;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.map-overlay-secondary {
  margin-top: 0.35rem;
  display: inline-flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.3rem;
}

.map-legend-toggle {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  font-family: var(--font-body);
  font-size: 0.63rem;
  font-weight: 600;
  color: rgba(26,22,18,0.72);
  background: rgba(244,239,231,0.9);
  border: 1px solid rgba(26,22,18,0.12);
  border-radius: 999px;
  padding: 0.28rem 0.5rem;
  box-shadow: 0 6px 14px rgba(26,22,18,0.12);
  cursor: pointer;
}

.map-legend-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: rgba(26,22,18,0.45);
}

.map-legend-panel {
  display: none;
  grid-template-columns: repeat(2, minmax(120px, 1fr));
  gap: 0.32rem 0.55rem;
  max-width: 290px;
  padding: 0.48rem 0.56rem;
  border: 1px solid rgba(26,22,18,0.12);
  border-radius: 10px;
  background: rgba(244,239,231,0.92);
  box-shadow: 0 10px 20px rgba(26,22,18,0.12);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.map-overlay-controls.legend-expanded .map-legend-panel {
  display: grid;
}

.map-legend-item {
  display: inline-flex;
  align-items: center;
  gap: 0.32rem;
  min-width: 0;
  font-family: var(--font-mono);
  font-size: 0.48rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.58);
}

.map-legend-swatch {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
  border: 1px solid rgba(26,22,18,0.12);
}

.map-filter-group {
  display: inline-flex;
  align-items: center;
  gap: 0.45rem;
  flex-wrap: wrap;
}

.map-filter-group.status-group {
  margin-left: 0.35rem;
  padding-left: 0.6rem;
  border-left: 1px solid rgba(26,22,18,0.12);
}

.map-filter-group-label {
  font-family: var(--font-mono);
  font-size: 0.56rem;
  letter-spacing: 0.11em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.5);
  margin-right: 0.05rem;
}

.filter-pill {
  font-family: var(--font-body);
  font-size: 0.7rem;
  font-weight: 500;
  padding: 0.45rem 0.9rem 0.45rem 0.7rem;
  border: none;
  background: var(--neuro-bg);
  color: var(--slate);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  letter-spacing: 0.02em;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  border-radius: 20px;
  box-shadow: var(--shadow-raised);
}

.filter-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--pill-color, var(--slate));
  flex-shrink: 0;
  transition: all 0.3s ease;
  opacity: 0.5;
}

.filter-pill:hover {
  color: var(--ink);
  transform: translateY(-2px);
  box-shadow: 5px 5px 10px var(--neuro-dark), -5px -5px 10px var(--neuro-light);
}

.filter-pill:hover .filter-dot { opacity: 1; transform: scale(1.2); }

.filter-pill.active {
  background: var(--neuro-bg);
  color: var(--pill-color, var(--gold));
  font-weight: 600;
  box-shadow: var(--shadow-inset);
}

.filter-pill.active .filter-dot {
  background: var(--pill-color, var(--gold));
  opacity: 1;
}

.filter-pill.all-pill { padding-left: 0.9rem; }

.filter-pill.all-pill.active {
  background: var(--neuro-bg);
  color: var(--ink);
  box-shadow: var(--shadow-inset);
}

.filter-pill.open-now-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  border: 1px solid rgba(26,22,18,0.14);
  padding: 0.45rem 0.7rem 0.45rem 0.62rem;
}

.filter-pill.open-now-pill .status-toggle-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 1px solid rgba(26,22,18,0.35);
  background: rgba(26,22,18,0.07);
  transition: all 0.25s ease;
}

.filter-pill.open-now-pill .status-icon {
  font-size: 0.72rem;
  line-height: 1;
  opacity: 0.65;
}

.filter-pill.open-now-pill .status-text {
  letter-spacing: 0;
}

.filter-pill.open-now-pill .status-state-badge {
  margin-left: 0.1rem;
  font-family: var(--font-mono);
  font-size: 0.52rem;
  letter-spacing: 0.09em;
  text-transform: uppercase;
  padding: 0.12rem 0.4rem;
  border-radius: 999px;
  color: rgba(26,22,18,0.62);
  background: rgba(26,22,18,0.08);
}

.filter-pill.open-now-pill.active {
  color: #1f7f45;
  border-color: rgba(47,163,91,0.35);
}

.filter-pill.open-now-pill.active .status-icon {
  opacity: 1;
}

.filter-pill.open-now-pill.active .status-toggle-indicator {
  border-color: rgba(47,163,91,0.6);
  background: #2fa35b;
  box-shadow: 0 0 8px rgba(47,163,91,0.55);
}

.filter-pill.open-now-pill.active .status-state-badge {
  color: #1f7f45;
  background: rgba(47,163,91,0.14);
}

.filter-pill.events-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  border: 1px solid rgba(26,22,18,0.14);
  padding: 0.45rem 0.7rem 0.45rem 0.62rem;
}

.filter-pill.events-pill .status-toggle-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 1px solid rgba(26,22,18,0.35);
  background: rgba(26,22,18,0.07);
  transition: all 0.25s ease;
}

.filter-pill.events-pill .status-icon {
  font-size: 0.72rem;
  line-height: 1;
  opacity: 0.65;
}

.filter-pill.events-pill .status-state-badge {
  margin-left: 0.1rem;
  font-family: var(--font-mono);
  font-size: 0.52rem;
  letter-spacing: 0.09em;
  text-transform: uppercase;
  padding: 0.12rem 0.4rem;
  border-radius: 999px;
  color: rgba(26,22,18,0.62);
  background: rgba(26,22,18,0.08);
}

.filter-pill.events-pill.active {
  color: #b4581d;
  border-color: rgba(180,88,29,0.35);
}

.filter-pill.events-pill.active .status-icon {
  opacity: 1;
}

.filter-pill.events-pill.active .status-toggle-indicator {
  border-color: rgba(180,88,29,0.6);
  background: #b4581d;
  box-shadow: 0 0 8px rgba(180,88,29,0.45);
}

.filter-pill.events-pill.active .status-state-badge {
  color: #934512;
  background: rgba(180,88,29,0.14);
}

.hours-legend {
  display: none;
  align-items: center;
  gap: 0.6rem;
  margin-left: 0.1rem;
  padding: 0.3rem 0.1rem;
}

.hours-legend.visible {
  display: inline-flex;
}

.hours-legend-item {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-family: var(--font-mono);
  font-size: 0.54rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.55);
}

.hours-legend-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}

.hours-legend-dot.open {
  background: #2fa35b;
  box-shadow: 0 0 8px rgba(47, 163, 91, 0.65);
}

.hours-legend-dot.unknown {
  background: rgba(26,22,18,0.08);
  border: 1px solid rgba(26,22,18,0.45);
  opacity: 0.9;
}

.map-active-banner {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 3rem;
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.4s ease, opacity 0.3s ease;
  opacity: 0;
}

.map-active-banner.visible {
  max-height: 60px;
  opacity: 1;
}

.map-active-banner-inner {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 0;
}

.map-active-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  animation: dotPulse 2s ease-in-out infinite;
}

@keyframes dotPulse {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.3); }
}

.map-active-text {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.08em;
  color: rgba(26,22,18,0.5);
}

.map-active-text strong {
  color: var(--ink);
  font-weight: 600;
}

.map-active-clear {
  font-family: var(--font-body);
  font-size: 0.65rem;
  color: rgba(26,22,18,0.4);
  background: none;
  border: 1px solid rgba(26,22,18,0.15);
  padding: 0.25rem 0.6rem;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-left: auto;
}

.map-active-clear:hover {
  color: var(--ink);
  border-color: rgba(26,22,18,0.4);
}

.map-container {
  height: 70vh;
  min-height: 500px;
  position: relative;
  margin: 2rem;
  padding: 1.5rem;
  border: 4px solid var(--ink);
  border-radius: 20px;
  background: var(--neuro-bg);
  box-shadow: var(--shadow-inset);
}

#map {
  width: 100%;
  height: 100%;
  border-radius: 16px;
  overflow: hidden;
}

.smart-label-layer {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 16;
}

.smart-label-card {
  position: absolute;
  transform: translate(-50%, -100%);
  min-height: 22px;
  max-width: 210px;
  padding: 0.24rem 0.42rem;
  border-radius: 7px;
  border: 1px solid rgba(26,22,18,0.14);
  border-left: 3px solid rgba(26,22,18,0.38);
  background: rgba(244,239,231,0.95);
  box-shadow: 0 5px 14px rgba(26,22,18,0.14);
  display: inline-flex;
  align-items: center;
  gap: 0.32rem;
  pointer-events: auto;
  cursor: pointer;
}

.smart-label-card::after {
  content: '';
  position: absolute;
  left: 50%;
  bottom: -7px;
  width: 1px;
  height: 7px;
  background: rgba(26,22,18,0.34);
  transform: translateX(-50%);
}

.smart-label-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.smart-label-name {
  display: block;
  max-width: 182px;
  font-family: var(--font-body);
  font-size: 0.62rem;
  line-height: 1.15;
  letter-spacing: 0.01em;
  font-weight: 650;
  color: var(--ink);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

@media (max-width: 900px) {
  .smart-label-layer { display: none; }
}

/* MapLibre control overrides */
.maplibregl-ctrl-group {
  background: var(--ink) !important;
  border: 1px solid rgba(245,240,232,0.15) !important;
  border-radius: 0 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
}

.maplibregl-ctrl-group button {
  width: 32px !important;
  height: 32px !important;
}

.maplibregl-ctrl-group button + button {
  border-top: 1px solid rgba(245,240,232,0.1) !important;
}

.maplibregl-ctrl-group button .maplibregl-ctrl-icon {
  filter: invert(1) brightness(0.85);
}

.maplibregl-ctrl-attrib {
  background: rgba(26,22,18,0.7) !important;
  color: rgba(245,240,232,0.4) !important;
  font-size: 10px !important;
}

.maplibregl-ctrl-attrib a { color: var(--gold) !important; }

/* Keep cooperative-gesture behavior, hide the instructional overlay text */
.maplibregl-cooperative-gesture-screen {
  display: none !important;
}

/* Rich tooltip popups - Heritage Neumorphism */
.maplibregl-popup-content {
  background: var(--parchment) !important;
  color: var(--ink) !important;
  border: 3px solid var(--gold) !important;
  border-radius: 20px !important;
  padding: 0 !important;
  font-family: var(--font-body) !important;
  box-shadow: var(--shadow-raised) !important;
  max-width: 280px !important;
  min-width: 200px !important;
  overflow: hidden !important;
  animation: tooltipIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes tooltipIn {
  from { opacity: 0; transform: translateY(8px) scale(0.92); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.maplibregl-popup-tip {
  border-top-color: var(--gold) !important;
  filter: drop-shadow(2px 2px 3px rgba(80,60,40,0.15));
}

.maplibregl-popup-anchor-bottom .maplibregl-popup-tip {
  border-top-color: var(--gold) !important;
}

.maplibregl-popup-close-button { display: none; }

.tooltip-img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  display: block;
  position: relative;
}

.tooltip-img::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent 40%, rgba(74,107,124,0.3) 100%);
  pointer-events: none;
}
.tooltip-placeholder {
  width: 100%;
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.tooltip-placeholder svg {
  width: 36px;
  height: 36px;
  fill: currentColor;
  opacity: 0.5;
}
.tooltip-watercolor {
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0.25;
  position: absolute;
  inset: 0;
  padding: 10px;
}
.tooltip-body {
  padding: 0.65rem 0.85rem 0.75rem;
  background: var(--neuro-bg);
  border-radius: 0 0 17px 17px;
}
.tooltip-body strong {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: var(--ink);
}
.tooltip-body .tooltip-cat {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  opacity: 0.75;
  font-size: 0.72rem;
  font-weight: 500;
}
.tooltip-body .tooltip-cat-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
  box-shadow: var(--shadow-soft);
}
.tooltip-body .tooltip-city {
  opacity: 0.6;
  font-size: 0.7rem;
  margin-top: 0.2rem;
  font-weight: 400;
}

.tooltip-event {
  margin-top: 0.28rem;
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-family: var(--font-mono);
  font-size: 0.56rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: #934512;
}

.tooltip-event::before {
  content: '◷';
  font-size: 0.64rem;
  line-height: 1;
}

/* Detail panel image */
.detail-hero-img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  display: block;
}
.detail-hero-placeholder {
  width: 100%;
  height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.detail-hero-placeholder svg {
  width: 48px;
  height: 48px;
  fill: currentColor;
  opacity: 0.35;
}
.detail-hero-watercolor {
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0.4;
  padding: 20px;
}

/* ========== DETAIL PANEL ========== */
.detail-panel {
  position: fixed;
  right: -460px;
  top: 0;
  width: 440px;
  max-width: 90vw;
  height: 100vh;
  background: var(--neuro-bg);
  z-index: 10000;
  box-shadow: -12px 12px 24px var(--neuro-dark), 12px -12px 24px var(--neuro-light);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.detail-panel.open { right: 0; }

.detail-panel-overlay {
  position: fixed;
  inset: 0;
  background: rgba(26,22,18,0.5);
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s ease;
}

.detail-panel-overlay.open {
  opacity: 1;
  pointer-events: auto;
}

.detail-close {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  width: 36px;
  height: 36px;
  background: var(--neuro-bg);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  color: var(--ink);
  transition: all 0.2s ease;
  z-index: 2;
  border-radius: 50%;
  box-shadow: var(--shadow-raised);
}

.detail-close:hover {
  box-shadow: var(--shadow-inset);
  transform: scale(0.95);
}

.detail-category-bar {
  height: 4px;
  width: 100%;
  flex-shrink: 0;
}

.detail-content {
  padding: 3rem 2.5rem;
  flex: 1;
}

.detail-tag {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 1rem;
}

.detail-experiences-badge {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  margin-bottom: 0.75rem;
}

.detail-experiences-badge:empty { display: none; }

.detail-exp-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.05em;
  padding: 0.2rem 0.5rem;
  border: 1px solid;
  border-color: currentColor;
  opacity: 0.7;
  cursor: pointer;
  transition: all 0.2s ease;
}

.detail-exp-pill:hover { opacity: 1; }

.detail-exp-pill-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.detail-name {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 700;
  line-height: 1.15;
  margin-bottom: 1.5rem;
  padding-right: 2rem;
}

.detail-description {
  font-size: 0.95rem;
  line-height: 1.7;
  color: var(--slate);
  margin-bottom: 2rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid rgba(26,22,18,0.08);
}

.detail-description::first-letter {
  font-family: var(--font-display);
  font-size: 2.5em;
  float: left;
  line-height: 0.8;
  margin-right: 0.1em;
  margin-top: 0.05em;
  color: var(--gold);
}

.detail-meta {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.detail-meta-row {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
}

.detail-meta-icon {
  font-size: 0.85rem;
  width: 20px;
  text-align: center;
  flex-shrink: 0;
  margin-top: 2px;
  opacity: 0.5;
}

.detail-meta-value {
  font-size: 0.85rem;
  line-height: 1.5;
  color: var(--slate);
}

.detail-meta-value a {
  color: var(--blue-wash);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s ease;
}

.detail-meta-value a:hover { border-bottom-color: var(--blue-wash); }

.hours-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 0.2rem 0.45rem;
  border-radius: 999px;
  border: 1px solid currentColor;
  line-height: 1;
  white-space: nowrap;
}

.hours-pill::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
  flex-shrink: 0;
}

.hours-pill.hours-open {
  color: #1f7f45;
  background: rgba(47,163,91,0.12);
}

.hours-pill.hours-closed {
  color: rgba(26,22,18,0.55);
  background: rgba(26,22,18,0.06);
}

.hours-pill.hours-unknown {
  color: rgba(26,22,18,0.5);
  background: rgba(26,22,18,0.03);
}

.hours-pill.hours-unknown::before {
  background: transparent;
  border: 1px solid currentColor;
}

.detail-hours-today {
  margin-top: 0.35rem;
  color: rgba(26,22,18,0.62);
  font-size: 0.78rem;
}

.detail-events {
  margin-top: 1rem;
  display: grid;
  gap: 0.55rem;
}

.detail-events-title {
  font-family: var(--font-mono);
  font-size: 0.58rem;
  letter-spacing: 0.11em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.55);
}

.detail-events-empty {
  font-size: 0.72rem;
  color: rgba(26,22,18,0.5);
}

.detail-event-card {
  border: 1px solid rgba(26,22,18,0.1);
  border-left: 3px solid #b4581d;
  background: rgba(255,255,255,0.6);
  border-radius: 10px;
  padding: 0.5rem 0.6rem;
  display: grid;
  gap: 0.28rem;
}

.detail-event-title {
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.35;
}

.detail-event-time {
  font-family: var(--font-mono);
  font-size: 0.56rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.52);
}

.detail-event-link {
  font-size: 0.68rem;
  color: #934512;
  text-decoration: none;
  border-bottom: 1px solid rgba(148,69,18,0.28);
  width: fit-content;
}

.detail-event-link:hover {
  border-bottom-color: rgba(148,69,18,0.7);
}

.detail-flyto {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
  margin-top: 1.5rem;
  padding: 0.75rem 1rem;
  font-family: var(--font-body);
  font-size: 0.8rem;
  font-weight: 500;
  background: var(--parchment);
  border: 1px solid rgba(26,22,18,0.1);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
  color: var(--ink);
}

.detail-flyto:hover {
  background: var(--ink);
  color: var(--cream);
  border-color: var(--ink);
}

.detail-flyto-icon {
  font-size: 1rem;
}

/* ========== MUSE EDITORIAL CARDS ========== */
.muse-section {
  position: relative;
  z-index: 1;
  padding: 4rem 2rem 5rem;
  max-width: 1000px;
  margin: 0 auto;
}

.muse-section::before {
  content: '';
  position: absolute;
  top: 0; bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100vw;
  background: var(--parchment);
  z-index: -1;
}

.muse-section-header {
  margin-bottom: 3rem;
}

.muse-section-tag {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--rust);
  margin-bottom: 0.5rem;
}

.muse-section-title {
  font-family: var(--font-display);
  font-size: clamp(1.4rem, 2.5vw, 1.8rem);
  font-weight: 700;
  color: var(--ink);
  margin: 0;
}

.muse-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}

.muse-card {
  background: rgba(255,255,255,0.6);
  border: 1px solid rgba(26,22,18,0.06);
  border-radius: 8px;
  padding: 2rem 1.8rem;
  cursor: pointer;
  list-style: none;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
}

.muse-card:nth-child(2) {
  margin-top: 2.5rem;
}

.muse-card:nth-child(3) {
  margin-top: -1rem;
}

.muse-card:hover {
  background: rgba(255,255,255,0.9);
  border-color: rgba(26,22,18,0.12);
  box-shadow: 0 8px 32px rgba(26,22,18,0.06);
}

.muse-card > summary {
  list-style: none;
  cursor: pointer;
  display: block;
}

.muse-card > summary::-webkit-details-marker { display: none; }

.muse-card-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--slate);
  margin-bottom: 0.75rem;
}

.muse-card-title {
  font-family: var(--font-display);
  font-size: clamp(1.05rem, 1.8vw, 1.25rem);
  font-weight: 700;
  color: var(--ink);
  line-height: 1.3;
  margin-bottom: 1rem;
}

.muse-card-quote {
  font-family: var(--font-display);
  font-size: 0.9rem;
  font-style: italic;
  line-height: 1.65;
  color: rgba(26,22,18,0.7);
  margin-bottom: 0.75rem;
}

.muse-card-author {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.05em;
  color: var(--slate);
}

.muse-card-toggle {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--rust);
  margin-top: 1rem;
  transition: color 0.2s ease;
}

.muse-card > summary:hover .muse-card-toggle {
  color: var(--gold);
}

.muse-card[open] .muse-card-toggle { display: none; }

.muse-card-body {
  padding-top: 1.5rem;
  margin-top: 1rem;
  border-top: 1px solid rgba(26,22,18,0.08);
  font-size: 0.88rem;
  line-height: 1.8;
  color: rgba(26,22,18,0.7);
}

.muse-card-body p {
  margin-bottom: 1rem;
}

.muse-card-body p:last-child {
  margin-bottom: 0;
}

/* Corridor sub-sections within the Cultural Corridors card */
.muse-corridor {
  border-top: 1px solid rgba(26,22,18,0.08);
}

.muse-corridor:last-child {
  border-bottom: 1px solid rgba(26,22,18,0.08);
}

.muse-corridor summary {
  font-family: var(--font-display);
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--ink);
  padding: 1rem 0;
  cursor: pointer;
  list-style: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: color 0.2s ease;
}

.muse-corridor summary::-webkit-details-marker { display: none; }

.muse-corridor summary::after {
  content: '+';
  font-family: var(--font-body);
  font-weight: 300;
  font-size: 1.2rem;
  color: var(--slate);
  transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  flex-shrink: 0;
  margin-left: 1rem;
}

.muse-corridor[open] summary::after {
  transform: rotate(45deg);
}

.muse-corridor summary:hover {
  color: var(--rust);
}

.muse-corridor-body {
  padding: 0 0 1.2rem;
  font-size: 0.85rem;
  line-height: 1.8;
  color: rgba(26,22,18,0.7);
}

.muse-corridor-body p {
  margin-bottom: 0.8rem;
}

.muse-corridor-body p:last-child {
  margin-bottom: 0;
}

@media (max-width: 700px) {
  .muse-section { padding: 2.5rem 1.5rem 3rem; }
  .muse-cards { grid-template-columns: 1fr; }
  .muse-card:nth-child(2) { margin-top: 0; }
  .muse-card:nth-child(3) { margin-top: 0; }
}

/* ========== EXPLORE LIST ========== */
.explore-section {
  padding: 6rem 3rem;
  max-width: 1400px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* Full-width neumorphic background behind centered explore */
.explore-section::before {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100vw;
  background: var(--neuro-bg);
  z-index: -1;
}

.explore-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 3rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.explore-search {
  font-family: var(--font-body);
  font-size: 0.9rem;
  padding: 0.7rem 1.2rem;
  border: none;
  background: var(--neuro-bg);
  width: 320px;
  max-width: 100%;
  outline: none;
  transition: all 0.3s ease;
  border-radius: 12px;
  box-shadow: var(--shadow-inset);
  color: var(--ink);
}

.explore-search:focus {
  box-shadow: inset 4px 4px 8px var(--neuro-dark), inset -4px -4px 8px var(--neuro-light);
}

.explore-search::placeholder { color: var(--slate); opacity: 0.5; }

.explore-results-count {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--slate);
  letter-spacing: 0.1em;
  margin-bottom: 1rem;
}

.explore-search-events {
  margin-bottom: 0.9rem;
  padding: 0.58rem 0.66rem;
  background: rgba(255,255,255,0.45);
  border: 1px solid rgba(26,22,18,0.1);
  border-radius: 10px;
}

.explore-search-events[hidden] {
  display: none;
}

.explore-search-events-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 0.5rem;
  margin-bottom: 0.45rem;
}

.explore-search-events-title {
  font-family: var(--font-display);
  font-size: 0.86rem;
  color: var(--ink);
}

.explore-search-events-count {
  font-family: var(--font-mono);
  font-size: 0.56rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.5);
}

.explore-search-events-list {
  display: grid;
  gap: 0.42rem;
}

.explore-search-event {
  display: grid;
  gap: 0.18rem;
  padding: 0.42rem 0.5rem;
  border: 1px solid rgba(26,22,18,0.1);
  border-left: 3px solid #b4581d;
  border-radius: 8px;
  background: rgba(255,255,255,0.72);
}

.explore-search-event.mapped {
  cursor: pointer;
}

.explore-search-event-title {
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.3;
}

.explore-search-event-meta {
  font-family: var(--font-mono);
  font-size: 0.54rem;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.56);
  display: flex;
  flex-wrap: wrap;
  gap: 0.42rem;
  align-items: center;
}

.explore-search-event-link {
  width: fit-content;
  font-size: 0.62rem;
  color: #934512;
  text-decoration: none;
  border-bottom: 1px solid rgba(148,69,18,0.28);
}

.explore-search-event-link:hover {
  border-bottom-color: rgba(148,69,18,0.7);
}

.explore-categories {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  margin-bottom: 2rem;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
}

.explore-cat-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.6rem;
  padding: 1.5rem 1rem;
  background: white;
  border: 1px solid rgba(26,22,18,0.06);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.explore-cat-card::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--card-color);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.explore-cat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(26,22,18,0.08);
  border-color: rgba(26,22,18,0.12);
}

.explore-cat-card:hover::before {
  opacity: 1;
}

.explore-cat-card.active {
  border-color: var(--card-color);
  box-shadow: 0 2px 16px rgba(26,22,18,0.1);
}

.explore-cat-card.active::before {
  opacity: 1;
}

.explore-cat-card-img {
  width: 48px;
  height: 48px;
  object-fit: contain;
}

.explore-cat-card-name {
  font-family: var(--font-body);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.3;
}

.explore-cat-card-count {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  color: var(--slate);
  letter-spacing: 0.05em;
}

.explore-list-wrapper {
  display: none;
}

.explore-list-wrapper.visible {
  display: block;
}

.explore-list-back {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.05em;
  color: var(--slate);
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  margin-bottom: 1.5rem;
  transition: color 0.2s ease;
}

.explore-list-back:hover {
  color: var(--ink);
}

.explore-list-back::before {
  content: '\2190  ';
}

.explore-list {
  display: grid;
  gap: 0;
  border-top: 1px solid rgba(26,22,18,0.1);
}

.explore-item {
  display: grid;
  grid-template-columns: 4px 56px 1fr auto 32px;
  gap: 1rem;
  align-items: center;
  padding: 1rem 0;
  border-bottom: 1px solid rgba(26,22,18,0.06);
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
}

.explore-item-thumb {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  object-fit: cover;
  background: var(--neuro-bg);
  flex-shrink: 0;
  box-shadow: var(--shadow-soft);
}

.explore-item:hover {
  padding-left: 0.5rem;
  background: linear-gradient(90deg, var(--row-color, transparent) 0%, rgba(200,148,62,0.03) 2%, rgba(200,148,62,0.03) 100%);
}

.explore-item-bar {
  width: 4px;
  height: 100%;
  min-height: 20px;
  border-radius: 2px;
  opacity: 0.35;
  transition: opacity 0.25s ease, height 0.25s ease;
}

.explore-item:hover .explore-item-bar {
  opacity: 1;
}

.explore-item-info {
  min-width: 0;
}

.explore-item-name {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.15rem;
}

.explore-item-desc {
  font-size: 0.78rem;
  color: var(--slate);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
  margin-bottom: 0.25rem;
}

.explore-item-meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.explore-item-city {
  font-size: 0.75rem;
  color: rgba(26,22,18,0.4);
}

.explore-item-cat {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 0.2rem 0.5rem;
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  white-space: nowrap;
  border: 1px solid;
  border-color: currentColor;
  opacity: 0.5;
  transition: opacity 0.2s ease;
}

.explore-item:hover .explore-item-cat { opacity: 1; }

.explore-item-cat-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
}

.explore-item-arrow {
  font-size: 1.1rem;
  color: rgba(26,22,18,0.15);
  transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
}

.explore-item:hover .explore-item-arrow {
  color: var(--row-color, var(--gold));
  transform: translateX(4px);
}

.explore-item.hours-mode.hours-closed {
  opacity: 0.52;
}

.explore-item.hours-mode.hours-open .explore-item-name {
  color: #1f7f45;
}

.explore-item-hours {
  margin-left: auto;
}

.load-more-btn {
  display: block;
  margin: 2rem auto 0;
  padding: 0.8rem 2rem;
  font-family: var(--font-body);
  font-size: 0.85rem;
  font-weight: 500;
  background: var(--neuro-bg);
  border: none;
  cursor: pointer;
  transition: all 0.25s ease;
  color: var(--ink);
  border-radius: 12px;
  box-shadow: var(--shadow-raised);
}

.load-more-btn:hover {
  box-shadow: var(--shadow-inset);
  transform: translateY(2px);
}

/* ========== COLOPHON ========== */
.colophon {
  position: relative;
  z-index: 1;
  background: var(--neuro-bg);
  padding: 5rem 3rem 3rem;
  color: var(--slate);
  font-size: 0.8rem;
  line-height: 1.8;
}

.colophon-inner {
  max-width: 900px;
  margin: 0 auto;
}

.colophon-heading {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 400;
  color: rgba(245,240,232,0.7);
  margin-bottom: 2rem;
  letter-spacing: 0.02em;
}

.colophon-sections {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem 4rem;
  margin-bottom: 3rem;
}

.colophon-label {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(245,240,232,0.25);
  margin-bottom: 0.5rem;
}

.colophon a {
  color: var(--gold);
  text-decoration: none;
}

.colophon a:hover {
  color: var(--gold-bright);
}

.colophon-rule {
  border: none;
  border-top: 1px solid rgba(245,240,232,0.08);
  margin: 0 0 1.5rem;
}

.colophon-bottom {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  flex-wrap: wrap;
  gap: 1rem;
  font-size: 0.7rem;
  color: rgba(245,240,232,0.2);
}

.colophon-bottom a {
  color: rgba(245,240,232,0.3);
}

@media (max-width: 600px) {
  .colophon-sections { grid-template-columns: 1fr; gap: 2rem; }
}

/* ========== EXPERIENCE SELECTOR ========== */
.map-addons {
  max-width: 1400px;
  margin: 0.45rem auto 1.3rem;
  padding: 0 3rem;
  display: grid;
  gap: 0.65rem;
}

.map-events {
  max-width: 1400px;
  margin: 0 auto 2rem;
  padding: 0 3rem;
}

.map-events-details {
  border: 1px solid rgba(26,22,18,0.08);
  border-radius: 14px;
  background: var(--parchment);
  box-shadow: var(--shadow-soft);
}

.map-events-details > summary {
  list-style: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  padding: 0.72rem 0.82rem;
}

.map-events-details > summary::-webkit-details-marker {
  display: none;
}

.map-events-details .map-addon-body {
  padding: 0 0.82rem 0.82rem;
}

.map-events-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 0.8rem;
  margin-bottom: 0.55rem;
}

.map-events-title {
  font-family: var(--font-display);
  font-size: 0.94rem;
  line-height: 1.15;
  color: var(--ink);
  margin: 0;
}

.map-events-count {
  font-family: var(--font-mono);
  font-size: 0.58rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.52);
}

.map-events-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  margin-bottom: 0.7rem;
}

.map-events-category-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.72rem;
}

.map-events-category-label {
  font-family: var(--font-mono);
  font-size: 0.56rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.54);
}

.map-events-category-select {
  min-width: 180px;
  max-width: 100%;
  border: 1px solid rgba(26,22,18,0.18);
  border-radius: 8px;
  background: rgba(255,255,255,0.6);
  color: rgba(26,22,18,0.82);
  font-family: var(--font-mono);
  font-size: 0.56rem;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  padding: 0.32rem 0.45rem;
}

.map-events-category-select:focus-visible {
  outline: 2px solid rgba(180,88,29,0.55);
  outline-offset: 1px;
}

.map-events-chip {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  border: 1px solid rgba(26,22,18,0.18);
  background: rgba(255,255,255,0.5);
  color: rgba(26,22,18,0.62);
  border-radius: 999px;
  padding: 0.2rem 0.52rem;
  cursor: pointer;
}

.map-events-chip.active {
  color: #934512;
  border-color: rgba(180,88,29,0.45);
  background: rgba(180,88,29,0.09);
}

.map-events-list {
  display: flex;
  gap: 0.58rem;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  scrollbar-width: none;
  -ms-overflow-style: none;
  min-height: 252px;
}

.map-events-list::-webkit-scrollbar {
  display: none;
}

.map-events-empty {
  font-size: 0.74rem;
  color: rgba(26,22,18,0.55);
  padding: 0.55rem 0.2rem;
  width: 100%;
}

.map-event-item {
  border: 1px solid rgba(26,22,18,0.1);
  border-left: 3px solid #b4581d;
  background: rgba(255,255,255,0.66);
  border-radius: 10px;
  padding: 0.45rem;
  display: grid;
  gap: 0.3rem;
  align-content: start;
  flex: 0 0 calc((100% - 1.16rem) / 3);
  min-height: 252px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.map-event-item.mapped {
  cursor: pointer;
}

.map-event-item.mapped:hover {
  transform: translateY(-1px);
  box-shadow: 0 6px 18px rgba(26,22,18,0.08);
}

.map-event-item.unmapped {
  border-left-color: rgba(26,22,18,0.35);
  opacity: 0.88;
}

.map-event-image {
  width: 100%;
  height: 104px;
  border-radius: 8px;
  object-fit: cover;
  background: linear-gradient(135deg, rgba(74,107,124,0.22), rgba(180,88,29,0.2));
  border: 1px solid rgba(26,22,18,0.09);
}

.map-event-image.placeholder {
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(26,22,18,0.42);
  font-family: var(--font-mono);
  font-size: 0.56rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.map-event-title {
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.3;
}

.map-event-desc {
  font-size: 0.67rem;
  line-height: 1.35;
  color: rgba(26,22,18,0.7);
  min-height: 2.7em;
}

.map-event-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.48rem;
  align-items: center;
  font-family: var(--font-mono);
  font-size: 0.56rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.56);
}

.map-event-venue {
  color: rgba(26,22,18,0.7);
  font-size: 0.62rem;
}

.map-event-badge {
  border: 1px solid rgba(26,22,18,0.2);
  border-radius: 999px;
  padding: 0.1rem 0.38rem;
}

.map-event-link {
  font-size: 0.66rem;
  color: #934512;
  text-decoration: none;
  border-bottom: 1px solid rgba(148,69,18,0.28);
  width: fit-content;
}

.map-event-link:hover {
  border-bottom-color: rgba(148,69,18,0.7);
}

.map-events-carousel {
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: 0.45rem;
}

.map-events-nav {
  border: 1px solid rgba(26,22,18,0.16);
  background: rgba(255,255,255,0.65);
  color: rgba(26,22,18,0.62);
  border-radius: 999px;
  width: 1.6rem;
  height: 1.6rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 0.82rem;
  line-height: 1;
  cursor: pointer;
}

.map-events-nav:disabled {
  opacity: 0.35;
  cursor: default;
}

.map-events-page {
  margin-top: 0.42rem;
  font-family: var(--font-mono);
  font-size: 0.53rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.46);
  text-align: right;
}

.map-events-all {
  margin-top: 0.65rem;
  border-top: 1px solid rgba(26,22,18,0.09);
  padding-top: 0.55rem;
}

.map-events-all-head {
  font-family: var(--font-mono);
  font-size: 0.54rem;
  letter-spacing: 0.09em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.48);
  margin-bottom: 0.42rem;
}

.map-events-all-list {
  display: grid;
  gap: 0.4rem;
  max-height: 280px;
  overflow-y: auto;
  padding-right: 0.2rem;
}

.map-event-row {
  border: 1px solid rgba(26,22,18,0.1);
  border-left: 3px solid #b4581d;
  background: rgba(255,255,255,0.62);
  border-radius: 8px;
  padding: 0.36rem 0.5rem;
  display: grid;
  gap: 0.2rem;
}

.map-event-row.mapped {
  cursor: pointer;
}

.map-event-row-title {
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.25;
}

.map-event-row-meta {
  font-family: var(--font-mono);
  font-size: 0.53rem;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.56);
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  align-items: center;
}

.map-guides {
  background: var(--parchment);
  border: 1px solid rgba(26,22,18,0.08);
  border-radius: 14px;
  box-shadow: var(--shadow-soft);
  overflow: hidden;
}

.map-guides > summary {
  list-style: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  padding: 0.75rem 0.9rem;
  transition: background 0.25s ease;
}

.map-guides > summary::-webkit-details-marker { display: none; }
.map-guides > summary:hover { background: rgba(26,22,18,0.03); }

.map-addon-summary-right {
  display: inline-flex;
  align-items: center;
  gap: 0.55rem;
  flex-shrink: 0;
}

.map-addon-count {
  font-family: var(--font-mono);
  font-size: 0.57rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.5);
  border: 1px solid rgba(26,22,18,0.14);
  border-radius: 999px;
  padding: 0.15rem 0.42rem;
  white-space: nowrap;
}

.map-addon-caret {
  font-size: 0.9rem;
  color: rgba(26,22,18,0.5);
  transform: rotate(0deg);
  transition: transform 0.2s ease;
}

.map-guides[open] .map-addon-caret,
.map-subaddon[open] .map-addon-caret {
  transform: rotate(180deg);
}

.map-guides-body {
  padding: 0 0.8rem 0.85rem;
  display: grid;
  gap: 0.55rem;
}

.map-subaddon {
  border: 1px solid rgba(26,22,18,0.12);
  border-radius: 10px;
  background: rgba(255,255,255,0.55);
  overflow: hidden;
}

.map-subaddon > summary {
  list-style: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.65rem;
  padding: 0.62rem 0.72rem;
}

.map-subaddon > summary::-webkit-details-marker { display: none; }

.map-subaddon .map-addon-body {
  padding: 0 0.72rem 0.72rem;
}

.section-header {
  font-family: var(--font-display);
  font-size: 0.92rem;
  font-weight: 600;
  color: var(--ink);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.section-header-tag {
  font-size: 0.62rem;
  font-weight: 500;
  color: var(--gold);
  opacity: 0.8;
  font-family: var(--font-body);
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.experience-card {
  display: flex;
  align-items: center;
  gap: 0.55rem;
  padding: 0.42rem 0.68rem;
  border: none;
  background: var(--neuro-bg);
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
  overflow: visible;
  border-radius: 10px;
  box-shadow: 3px 3px 8px rgba(26,22,18,0.12), -2px -2px 6px rgba(255,255,255,0.58);
  min-width: 205px;
  flex: 0 0 auto;
}

.experience-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 3px;
  height: 100%;
  background: var(--exp-color, var(--gold));
  transform: scaleY(0);
  transform-origin: bottom;
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  border-radius: 12px 0 0 12px;
}

.experience-card:hover::before,
.experience-card.active::before { transform: scaleY(1); }

.experience-card:hover {
  transform: translateY(-1px);
  box-shadow: 4px 4px 10px rgba(26,22,18,0.16), -3px -3px 7px rgba(255,255,255,0.58);
}

.experience-card.active {
  box-shadow: var(--shadow-inset);
}

.experience-card-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
  transition: all 0.3s ease;
}

.experience-card.active .experience-card-dot {
  box-shadow: 0 0 8px currentColor;
}

.experience-card-info {
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
}

.experience-card-title {
  font-family: var(--font-body);
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--ink);
  transition: color 0.3s ease;
}

.experience-card-meta {
  font-family: var(--font-mono);
  font-size: 0.5rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.4);
  transition: color 0.3s ease;
}

.experience-card-close {
  display: none;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  font-size: 0.7rem;
  color: rgba(26,22,18,0.4);
  transition: color 0.2s ease;
}

.experience-card.active .experience-card-close { display: flex; }
.experience-card-close:hover { color: var(--ink); }

.experience-bar {
  flex-wrap: wrap;
  align-items: center;
}

.corridor-cards, .experience-cards {
  display: flex;
  gap: 0.5rem;
  flex-wrap: nowrap;
  align-items: stretch;
  overflow-x: auto;
  padding-bottom: 0.25rem;
  scrollbar-width: thin;
}

.corridor-cards::-webkit-scrollbar,
.experience-cards::-webkit-scrollbar { height: 6px; }
.corridor-cards::-webkit-scrollbar-thumb,
.experience-cards::-webkit-scrollbar-thumb { background: rgba(26,22,18,0.16); border-radius: 999px; }

/* ========== CORRIDOR INFO PANEL ========== */
.corridor-panel {
  position: absolute;
  bottom: 1.5rem;
  left: 1.5rem;
  z-index: 1000;
  background: rgba(26,22,18,0.92);
  border: 1px solid rgba(245,240,232,0.12);
  border-radius: 10px;
  padding: 0;
  max-width: 340px;
  max-height: 50vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  opacity: 0;
  transform: translateY(12px);
  pointer-events: none;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.corridor-panel.visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.corridor-panel-header {
  padding: 1.25rem 1.25rem 0.75rem;
  border-bottom: 1px solid rgba(245,240,232,0.08);
  flex-shrink: 0;
}

.corridor-panel-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 0.3rem;
}

.corridor-panel-title {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--cream);
  line-height: 1.2;
}

.corridor-panel-desc {
  font-size: 0.75rem;
  color: rgba(245,240,232,0.5);
  line-height: 1.5;
  margin-top: 0.5rem;
}

.corridor-panel-stops {
  overflow-y: auto;
  padding: 0.5rem 0;
  flex: 1;
  scrollbar-width: thin;
  scrollbar-color: rgba(245,240,232,0.15) transparent;
}

.corridor-panel-stops::-webkit-scrollbar { width: 3px; }
.corridor-panel-stops::-webkit-scrollbar-track { background: transparent; }
.corridor-panel-stops::-webkit-scrollbar-thumb { background: rgba(245,240,232,0.15); border-radius: 2px; }

.corridor-stop {
  display: flex;
  gap: 0.75rem;
  padding: 0.6rem 1.25rem;
  cursor: pointer;
  transition: background 0.2s ease;
}

.corridor-stop:hover { background: rgba(245,240,232,0.05); }

.corridor-stop-num {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  font-weight: 700;
  flex-shrink: 0;
  margin-top: 1px;
}

.corridor-stop-info { flex: 1; min-width: 0; }

.corridor-stop-name {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--cream);
  line-height: 1.3;
}

.corridor-stop-note {
  font-size: 0.7rem;
  color: rgba(245,240,232,0.4);
  line-height: 1.4;
  margin-top: 0.15rem;
}

.corridor-connector {
  padding: 0.15rem 1.25rem 0.15rem 3.1rem;
  font-family: var(--font-display);
  font-style: italic;
  font-size: 0.68rem;
  color: rgba(245,240,232,0.2);
  line-height: 1.4;
}

/* Tour button */
.corridor-tour-btn {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  background: none;
  border: 1px solid rgba(245,240,232,0.2);
  color: rgba(245,240,232,0.5);
  padding: 0.3rem 0.7rem;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
}

.corridor-tour-btn:hover {
  color: var(--cream);
  border-color: rgba(245,240,232,0.4);
}

.corridor-tour-btn.touring {
  color: var(--gold);
  border-color: var(--gold);
}

/* Stop number markers on map */
.stop-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.stop-badge:hover { transform: scale(1.15); }

/* ========== THEME TRANSITIONS ========== */
:root {
  --theme-accent: var(--gold);
  --theme-bg: var(--parchment);
  --theme-text: var(--ink);
  --theme-dimmed: rgba(26,22,18,0.12);
  --theme-route: var(--gold);
  --theme-transition: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

/* ========== ANIMATIONS ========== */
@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 1; }
}

.reveal {
  opacity: 0;
  transform: translateY(30px);
}

.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
  .section-intro { padding: 0.9rem 1.1rem 1rem; }
  .map-header { padding: 2rem 1.5rem 0.85rem; }
  .map-filter-bar { justify-content: flex-start; }
  .map-overlay-controls {
    top: 1.2rem;
    left: 1.2rem;
    right: 4.3rem;
  }
  .map-filter-panel .map-filter-bar {
    padding: 0.38rem 0.45rem;
  }
  .map-legend-panel {
    max-width: 250px;
    grid-template-columns: repeat(2, minmax(95px, 1fr));
  }
  .map-filter-group.status-group {
    border-left: none;
    margin-left: 0;
    padding-left: 0;
  }
  .map-addons { margin: 0 0 1.25rem; padding: 0 1.5rem; }
  .map-events { padding: 0 1.5rem; margin-bottom: 1.4rem; }
  .map-events-details > summary { padding: 0.68rem 0.72rem; }
  .map-events-details .map-addon-body { padding: 0 0.72rem 0.72rem; }
  .map-events-title { font-size: 0.9rem; }
  .map-events-list { min-height: 226px; }
  .map-event-item { min-height: 226px; }
  .map-event-item { flex-basis: calc((100% - 0.58rem) / 2); }
  .map-guides > summary { padding: 0.72rem 0.82rem; }
  .map-guides-body { padding: 0 0.62rem 0.72rem; }
  .map-subaddon > summary { padding: 0.55rem 0.62rem; }
  .map-subaddon .map-addon-body { padding: 0 0.62rem 0.62rem; }

  .section-header {
    font-size: 0.88rem;
  }
  .corridor-panel {
    max-width: 100%;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 12px 12px 0 0;
    max-height: none;
    height: auto;
  }
  .corridor-panel-header {
    padding: 0.75rem 1rem 0.5rem;
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0 0.75rem;
    border-bottom: none;
  }
  .corridor-panel-eyebrow { margin-bottom: 0; }
  .corridor-panel-title { font-size: 0.9rem; }
  .corridor-panel-desc { display: none; }
  .corridor-panel-stops {
    display: flex;
    flex-direction: row;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding: 0 0.5rem 0.65rem;
    gap: 0.5rem;
    scrollbar-width: none;
  }
  .corridor-panel-stops::-webkit-scrollbar { display: none; }
  .corridor-stop {
    flex: 0 0 200px;
    scroll-snap-align: start;
    padding: 0.5rem 0.75rem;
    border: 1px solid rgba(245,240,232,0.1);
    border-radius: 8px;
    background: rgba(245,240,232,0.04);
  }
  .corridor-stop-note {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .corridor-connector { display: none; }
  .explore-section { padding: 3rem 1.5rem; }
  .explore-categories { grid-template-columns: repeat(3, 1fr); }
  .explore-item { grid-template-columns: 4px 44px 1fr 24px; gap: 0.5rem; padding: 0.75rem 0; }
  .explore-item-thumb { width: 44px; height: 44px; border-radius: 6px; }
  .explore-item-desc { display: none; }
}

@media (max-width: 600px) {
  .detail-panel { width: 100vw; }
  .map-container { height: 60vh; min-height: 400px; margin: 1rem; padding: 0.75rem; border-width: 3px; }
  .map-overlay-controls {
    top: 0.9rem;
    left: 0.9rem;
    right: 3.9rem;
  }
  .map-filter-panel {
    max-width: calc(100vw - 90px);
  }
  .map-filter-panel .map-filter-bar {
    max-height: 42vh;
    overflow-y: auto;
  }
  .map-overlay-secondary {
    margin-top: 0.25rem;
  }
  .map-legend-panel {
    max-width: calc(100vw - 96px);
    grid-template-columns: repeat(1, minmax(120px, 1fr));
    max-height: 36vh;
    overflow-y: auto;
  }
  .map-addons { padding: 0 1rem; margin: 0 0 1rem; }
  .map-events { padding: 0 1rem; margin-bottom: 1rem; }
  .map-events-header { align-items: flex-start; flex-direction: column; gap: 0.35rem; }
  .map-events-details > summary { padding: 0.62rem 0.62rem; }
  .map-events-details .map-addon-body { padding: 0 0.62rem 0.62rem; }
  .map-events-carousel { grid-template-columns: 1fr; gap: 0.4rem; }
  .map-events-category-row { align-items: stretch; flex-direction: column; gap: 0.3rem; }
  .map-events-category-select { width: 100%; min-width: 0; }
  .map-events-list { min-height: auto; }
  .map-event-item { min-height: auto; }
  .map-event-item { flex-basis: 100%; }
  .map-events-nav { width: 100%; border-radius: 9px; height: 1.8rem; }
  .map-events-all-list { max-height: 230px; }
  .map-guides > summary { padding: 0.68rem 0.72rem; }
  .map-guides-body { padding: 0 0.55rem 0.62rem; }
  .map-subaddon > summary { padding: 0.5rem 0.55rem; }
  .map-subaddon .map-addon-body { padding: 0 0.55rem 0.55rem; }
  .section-header {
    font-size: 0.82rem;
  }
  .corridor-stop { flex: 0 0 170px; }
  .corridor-stop-name { font-size: 0.75rem; }
  .corridor-stop-note { font-size: 0.65rem; -webkit-line-clamp: 1; }
}
</style>
</head>
<body>

<!-- ====== HERO ====== -->
<section class="hero">
  <img src="img/Cultural+Assets+Banner.webp" alt="Nevada County Cultural Assets" class="hero-badge" fetchpriority="high">
  <div class="hero-content">
    <p class="hero-sub"><strong>Interactive atlas of cultural assets across the Sierra foothills.</strong></p>
    <p class="hero-instructions">Filter by category. Toggle Open Now. Click any marker for hours, details, and links.</p>
  </div>
</section>

<!-- ====== INTRO + CATEGORIES ====== -->
<section class="section-intro">
  <div class="col-left reveal">
    <div class="section-tag">01 / How to Use It</div>
    <h2 class="section-heading">Start with the map. Refine what you need in seconds.</h2>
    <div class="section-body">
      <p>Use this map to discover places to eat, gather, perform, learn, and explore across Nevada County. Apply categories, switch Open Now when you need something immediate, and click markers for practical details.</p>
      <div class="section-quicktips">
        <span class="section-quicktip"><span class="section-quicktip-dot"></span>Multi-category filters</span>
        <span class="section-quicktip"><span class="section-quicktip-dot"></span>Open now mode</span>
        <span class="section-quicktip"><span class="section-quicktip-dot"></span>Guided routes & corridors</span>
      </div>
    </div>
  </div>
  <div class="col-right reveal" style="transition-delay: 0.15s">
    <div class="section-tag">Categories</div>
    <div class="categories-grid" id="categoryGrid"></div>
  </div>
</section>

<!-- ====== MAP ====== -->
<section class="map-section" id="mapSection">
  <div class="map-header">
    <h2 class="map-title">Explore the Map</h2>
  </div>
  <div class="map-active-banner" id="mapActiveBanner">
    <div class="map-active-banner-inner">
      <div class="map-active-dot" id="mapActiveDot"></div>
      <div class="map-active-text">Showing <strong id="mapActiveCount">0</strong> <span id="mapActiveName">assets</span></div>
      <button class="map-active-clear" id="mapActiveClear">Clear filter</button>
    </div>
  </div>
  <div class="map-container">
    <div id="map"></div>
    <div class="map-overlay-controls">
      <button class="map-filter-toggle" id="mapFilterToggle" type="button" aria-expanded="false" aria-controls="mapFilterPanel">
        <span class="map-filter-toggle-dot" aria-hidden="true"></span>
        <span>Filters</span>
        <span class="map-filter-toggle-meta" id="mapFilterToggleMeta">All</span>
        <span class="map-filter-toggle-caret" aria-hidden="true">&#9662;</span>
      </button>
      <div class="map-filter-panel" id="mapFilterPanel">
        <div class="map-filter-bar" id="filterBar"></div>
      </div>
      <div class="map-overlay-secondary">
        <button class="map-legend-toggle" id="mapLegendToggle" type="button" aria-expanded="false" aria-controls="mapLegendPanel">
          <span class="map-legend-dot" aria-hidden="true"></span>
          <span>Legend</span>
        </button>
        <div class="map-legend-panel" id="mapLegendPanel"></div>
      </div>
    </div>
    <div class="corridor-panel" id="corridorPanel"></div>
  </div>
  <div class="map-addons" id="mapAddons">
    <details class="map-guides" id="mapGuides">
      <summary>
        <h3 class="section-header">Guided Routes &amp; Experiences</h3>
        <span class="map-addon-summary-right">
          <span class="map-addon-count" id="mapGuidesCount">0 guides</span>
          <span class="map-addon-caret">&#9662;</span>
        </span>
      </summary>
      <div class="map-guides-body">
        <details class="map-subaddon" id="corridorAddon">
          <summary>
            <h3 class="section-header">Cultural Corridors <span class="section-header-tag">from MUSE '26</span></h3>
            <span class="map-addon-summary-right">
              <span class="map-addon-count" id="corridorAddonCount">0 routes</span>
              <span class="map-addon-caret">&#9662;</span>
            </span>
          </summary>
          <div class="map-addon-body">
            <div class="corridor-cards" id="corridorCards"></div>
          </div>
        </details>
        <details class="map-subaddon" id="experienceAddon">
          <summary>
            <h3 class="section-header">Curated Experiences</h3>
            <span class="map-addon-summary-right">
              <span class="map-addon-count" id="experienceAddonCount">0 routes</span>
              <span class="map-addon-caret">&#9662;</span>
            </span>
          </summary>
          <div class="map-addon-body">
            <div class="experience-cards" id="experienceCards"></div>
          </div>
        </details>
      </div>
    </details>
  </div>
  <div class="map-events" id="mapEvents">
    <details class="map-subaddon map-events-details" id="mapEventsDetails">
      <summary>
        <h3 class="section-header">Upcoming Events</h3>
        <span class="map-addon-summary-right">
          <span class="map-addon-count" id="mapEventsCount">0 events</span>
          <span class="map-addon-caret">&#9662;</span>
        </span>
      </summary>
      <div class="map-addon-body">
        <div class="map-events-header">
          <h3 class="map-events-title">Upcoming events</h3>
          <span class="map-events-count" id="mapEventsScope">All categories</span>
        </div>
        <div class="map-events-filters" id="mapEventsFilters">
          <button class="map-events-chip active" type="button" data-event-filter="all">All</button>
          <button class="map-events-chip" type="button" data-event-filter="today">Today</button>
          <button class="map-events-chip" type="button" data-event-filter="weekend">Weekend</button>
          <button class="map-events-chip" type="button" data-event-filter="14d">14d</button>
        </div>
        <div class="map-events-category-row">
          <label class="map-events-category-label" for="mapEventsCategory">Category</label>
          <select id="mapEventsCategory" class="map-events-category-select" aria-label="Filter events by category">
            <option value="all">All categories</option>
          </select>
        </div>
        <div class="map-events-carousel">
          <button class="map-events-nav" id="mapEventsPrev" type="button" aria-label="Previous spotlight cards">&#9664;</button>
          <div class="map-events-list" id="mapEventsList"></div>
          <button class="map-events-nav" id="mapEventsNext" type="button" aria-label="Next spotlight cards">&#9654;</button>
        </div>
        <div class="map-events-page" id="mapEventsPage">Page 1 / 1</div>
        <div class="map-events-all">
          <div class="map-events-all-head">All upcoming events</div>
          <div class="map-events-all-list" id="mapEventsAllList"></div>
        </div>
      </div>
    </details>
  </div>
</section>

<!-- ====== MUSE EDITORIAL ====== -->
<div class="muse-section">
  <div class="muse-section-header reveal">
    <div class="muse-section-tag">from MUSE &rsquo;26 &middot; Issue 03</div>
    <h2 class="muse-section-title">Voices from Gold Country</h2>
  </div>

  <div class="muse-cards">

    <!-- Card 1: Cultural Corridors -->
    <details class="muse-card">
      <summary>
        <div class="muse-card-eyebrow">Routes &amp; Heritage</div>
        <div class="muse-card-title">Our Cultural Corridors</div>
        <div class="muse-card-quote">&ldquo;Nevada County&rsquo;s highways are more than just roads&mdash;they are cultural corridors, weaving together stories of California&rsquo;s First Peoples, Gold Rush miners, artists, and dreamers.&rdquo;</div>
        <div class="muse-card-author">&mdash; Jesse Locks</div>
        <span class="muse-card-toggle">Read more &darr;</span>
      </summary>
      <div class="muse-card-body">
        <p>Highways 49, 20, and 40&mdash;each with its own distinct heritage&mdash;form a network that connects the county&rsquo;s vibrant California Cultural Districts and historic landmarks, while offering breathtaking views of rolling foothills, towering pines, and High Sierra vistas.</p>
        <div class="muse-corridors">
          <details class="muse-corridor">
            <summary>Highway 40 &mdash; the Lincoln Highway</summary>
            <div class="muse-corridor-body">
              <p>Before Interstate 80 sped travelers through the Sierra, there was &ldquo;Old Highway 40&rdquo;&mdash;part of America&rsquo;s first transcontinental road. Ancient petroglyphs near Donner Summit, etched into granite thousands of years ago by the Martis People, offer a glimpse into the lives of the region&rsquo;s earliest inhabitants.</p>
              <p>From Clair Tappan Lodge to Rainbow Lodge, and the &ldquo;20 Mile Museum&rdquo; from Donner Lake to Cisco Grove, every curve tells a story of migration, innovation, and the spirit of the Sierra.</p>
            </div>
          </details>
          <details class="muse-corridor">
            <summary>Highway 20 &mdash; wagon trail to modern artery</summary>
            <div class="muse-corridor-body">
              <p>Stretching east to west, Highway 20 traces its roots to the 19th-century California Trail. The historic Washington Hotel, built in 1857, continues to serve as the community hub. Further south is Rough and Ready, founded in 1849&mdash;its mining heritage lives on in street names like Tornado, Gamble, and To Hell and Back Lane.</p>
            </div>
          </details>
          <details class="muse-corridor">
            <summary>Highway 49 &mdash; the golden chain of history</summary>
            <div class="muse-corridor-body">
              <p>The Golden Chain Highway links historic Gold Rush towns. Empire Mine State Historic Park in Grass Valley is one of the oldest, deepest, and richest gold mines in California. On the San Juan Ridge, the North Columbia Schoolhouse Cultural Center&mdash;a restored 1875 schoolhouse built by miners for their children&mdash;now hosts the internationally renowned Sierra Storytelling Festival.</p>
            </div>
          </details>
        </div>
      </div>
    </details>

    <!-- Card 2: Rural is the New Cool -->
    <details class="muse-card">
      <summary>
        <div class="muse-card-eyebrow">Community &amp; Place</div>
        <div class="muse-card-title">Rural is the New Cool</div>
        <div class="muse-card-quote">&ldquo;Few areas in Northern California, and beyond, can match the density of creativity we boast. Visitors come for our trails, wild spaces, and dreamy foothills&mdash;yet our cultural scene remains one of our most captivating surprises.&rdquo;</div>
        <div class="muse-card-author">&mdash; Diana Arbex, GV-NC Cultural District</div>
        <span class="muse-card-toggle">Read more &darr;</span>
      </summary>
      <div class="muse-card-body">
        <p>Our cultural richness is a reflection of the Nisenan and Washoe Peoples, whose traditions and enduring presence continue to shape our region. That richness is also carried forth by visionaries like Pulitzer Prize&ndash;winning poet Gary Snyder, whose arrival in the 1960s helped seed a generation of creatives.</p>
        <p>Drive north on Highway 49 to North Columbia Schoolhouse Cultural Center, and you will feel time slow down. Stop at Mother Truckers for one of its signature t-shirts illustrated by the late Randi Griffin. On arriving at &ldquo;the Schoolhouse,&rdquo; you&rsquo;ll find the Ridge&rsquo;s cultural epicenter&mdash;its walls hold decades of stories, folk music, poetry, and art.</p>
        <p>Back in Nevada City, download the Tree Tour in the STORY app and experience heirloom trees planted by Gold Rush horticulturist Felix Gillet. Visit the Crystal Rainbow Rock Shop, Winnie Superette&mdash;an Asian market hung with contemporary art&mdash;and Communal Caf&eacute; for coffee among locals.</p>
      </div>
    </details>

    <!-- Card 3: Art in Nature -->
    <details class="muse-card">
      <summary>
        <div class="muse-card-eyebrow">Arts &amp; Landscape</div>
        <div class="muse-card-title">Off the Wall: Art in Nature</div>
        <div class="muse-card-quote">&ldquo;Art in nature is such a beautiful process. We listen and we watch and we feel what is happening in the environment, and then we create from there.&rdquo;</div>
        <div class="muse-card-author">&mdash; Jenny Hale, place-based artist</div>
        <span class="muse-card-toggle">Read more &darr;</span>
      </summary>
      <div class="muse-card-body">
        <p>Each June, on trails across Nevada County, stars sway from low branches&mdash;the work of artists from Neighborhood Center of the Arts, created for Bear Yuba Land Trust&rsquo;s Summer Star Hike Challenge. With over 50 miles of trails and 26,000 acres conserved, that&rsquo;s quite the canvas.</p>
        <p>Since 2023, Art in Nature commissions have included Mekdela Maskal&rsquo;s naturally dyed prayer flags, Peggy Wright&rsquo;s nest of intertwined debris, and Andres Amador&rsquo;s &ldquo;Connections&rdquo;&mdash;a mycelium-like path through fallen trees on Hirschman&rsquo;s trail. For the Nisenan Gateway at Wildflower Ridge, artist Jenny Hale collaborated with the Nevada City Rancheria Nisenan Tribe to create a willow-and-cedar gateway honoring the land&rsquo;s original use as a Native trail.</p>
      </div>
    </details>

    <!-- Card 4: Living Like a Local - Truckee -->
    <details class="muse-card">
      <summary>
        <div class="muse-card-eyebrow">Truckee Cultural District</div>
        <div class="muse-card-title">Mountain Heart, Small-Town Soul</div>
        <div class="muse-card-quote">&ldquo;Our community&rsquo;s character is wrapped up in a certain sturdiness and a willingness to go out into nature regardless of how bad&mdash;or for some, how wonderful&mdash;that bad weather is.&rdquo;</div>
        <div class="muse-card-author">&mdash; Mayor Jan Zabriskie, Town of Truckee</div>
        <span class="muse-card-toggle">Read more &darr;</span>
      </summary>
      <div class="muse-card-body">
        <p>In 2024, Visit Truckee-Tahoe unveiled a new brand: &ldquo;Mountain Heart. Small Town Soul.&rdquo;&mdash;reflecting a community that is passionate and protective, pioneering and progressive, charming and a little funky. Visitors want to feel like locals, care about leaving a lighter footprint, and prefer scenery over a scene.</p>
        <p>For coffee, try Mountain Brew Coffee. For wine with a little funk, visit Truckee River Winery or The Pour House. Downtown galleries&mdash;Mountain Arts Collective, Piper J Gallery, Riverside Studios&mdash;offer a sampling of the creative talent in the district. And if you&rsquo;re staying up late, the historic Pastime Club vibrates after hours with pool, shuffleboard, and live entertainment.</p>
      </div>
    </details>

  </div>
</div>

<!-- ====== LIST ====== -->
<section class="explore-section" id="exploreSection">
  <div class="explore-header reveal">
    <div>
      <div class="section-tag">03 / Directory</div>
      <h2 class="section-heading">Explore by Category</h2>
    </div>
    <input type="text" class="explore-search" id="searchInput" placeholder="Search assets + events by name, city, or keyword...">
  </div>
  <div class="explore-categories" id="exploreCats"></div>
  <div class="explore-list-wrapper" id="exploreListWrapper">
    <button class="explore-list-back" id="exploreListBack">All categories</button>
    <div class="explore-results-count" id="resultsCount"></div>
    <div class="explore-search-events" id="exploreEventResults" hidden></div>
    <div class="explore-list" id="exploreList"></div>
    <button class="load-more-btn" id="loadMoreBtn">Show more</button>
  </div>
</section>

<!-- ====== DETAIL PANEL ====== -->
<div class="detail-panel-overlay" id="panelOverlay"></div>
<div class="detail-panel" id="detailPanel">
  <div class="detail-category-bar" id="detailCatBar"></div>
  <button class="detail-close" id="detailClose">&times;</button>
  <div id="detailHero"></div>
  <div class="detail-content">
    <div class="detail-tag" id="detailTag"></div>
    <div class="detail-experiences-badge" id="detailExpBadge"></div>
    <h3 class="detail-name" id="detailName"></h3>
    <div class="detail-description" id="detailDesc"></div>
    <div class="detail-meta" id="detailMeta"></div>
    <div class="detail-events" id="detailEvents"></div>
  </div>
</div>

<!-- ====== COLOPHON ====== -->
<footer class="colophon">
  <div class="colophon-inner">
    <div class="colophon-heading">About This Project</div>
    <div class="colophon-sections">
      <div>
        <div class="colophon-label">Data</div>
        687 cultural assets across 10 categories, sourced from the
        <a href="https://www.nevadacountyarts.org/cultural-asset-map" target="_blank">Nevada County Arts Council Cultural Asset Map</a>.
        Last updated December 2024.
      </div>
      <div>
        <div class="colophon-label">Editorial</div>
        Cultural Corridors content adapted from <em>MUSE</em> Issue 03, 2026 —
        "Our Cultural Corridors" by Jesse Locks.
        Illustration by Milada Belohlavek &amp; Ron Pitcher.
        Published by <a href="https://www.nevadacountyarts.org" target="_blank">Nevada County Arts Council</a>.
      </div>
      <div>
        <div class="colophon-label">Design</div>
        "Quiet Graphics" visual identity inspired by the Arts Council's
        original 2019 presentation. Watercolor illustrations honor
        that unrealized vision. Landscape basemap by <a href="https://www.maptiler.com" target="_blank">MapTiler</a>.
      </div>
      <div>
        <div class="colophon-label">Built by</div>
        <a href="https://www.thenorthstarhouse.org" target="_blank">Kaelen Jennings</a> — Development Consultant,
        North Star Historic Conservancy. Built with MapLibre GL JS, Turf.js, and GSAP.
        Assisted by Claude Code from Anthropic.
      </div>
    </div>
    <hr class="colophon-rule">
    <div class="colophon-bottom">
      <span>&copy; 2026 Nevada County Arts Council</span>
      <a href="index.html">View Leaflet version</a>
    </div>
  </div>
</footer>

<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
(function() {
  'use strict';

  // ============================================================
  // CONFIG
  // ============================================================
  const MAPTILER_KEY = 'LrWxywMynJX4Y3SvVJby';

  // SVG icons per category (inline, 18x18 viewBox)
  const ICONS = {
    'Historic Landmarks': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2L2 7h14L9 2z"/><rect x="4" y="7" width="10" height="8"/><rect x="7" y="10" width="4" height="5"/><line x1="2" y1="15" x2="16" y2="15"/></svg>',
    'Eat, Drink & Stay': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M3 2v6c0 2 2 3 4 3v5M14 2v4c0 1.5-1.5 2.5-3 2.5V14m0 0v2m0-2h0M14 2c0 2-1 3-3 3"/><circle cx="7" cy="14" r="1.5"/></svg>',
    'Arts Organizations': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><circle cx="9" cy="9" r="6"/><path d="M6 9c0-2 1.5-3.5 3-3.5s3 1.5 3 3.5-1.5 3.5-3 3.5S6 11 6 9z"/><path d="M9 5.5v7"/></svg>',
    'Cultural Resources': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="3" y="2" width="12" height="14" rx="1"/><line x1="6" y1="5" x2="12" y2="5"/><line x1="6" y1="8" x2="12" y2="8"/><line x1="6" y1="11" x2="10" y2="11"/></svg>',
    'Fairs & Festivals': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2l1.5 3 3.5.5-2.5 2.5.5 3.5L9 10l-3 1.5.5-3.5L4 5.5l3.5-.5z"/></svg>',
    'Galleries & Museums': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="2" y="4" width="14" height="11" rx="1"/><path d="M2 8h14"/><circle cx="7" cy="11" r="2"/><path d="M11 9l3 4"/></svg>',
    'Walks & Trails': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M3 15c2-3 4-5 6-8s3-3 6-5"/><circle cx="14" cy="4" r="1.5"/><path d="M5 13l-2 1m4-3l-2 1"/></svg>',
    'Public Art': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 3c-4 0-6 3-6 6 0 2 1 3 2 3 1.5 0 1.5-2 3-2s1.5 2 3 2 2-1 2-3c0-3-2-6-4-6z"/><circle cx="6" cy="8" r="1" fill="currentColor"/><circle cx="10" cy="7" r="1" fill="currentColor"/><circle cx="8" cy="10" r="1" fill="currentColor"/></svg>',
    'Performance Spaces': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M4 3h10l2 3v1H2V6l2-3z"/><path d="M3 7v7c0 1 1 2 2 2h8c1 0 2-1 2-2V7"/><path d="M7 10h4v3H7z"/></svg>',
    'Preservation & Culture': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2C6 2 3 5 3 9c0 3 2 5.5 4 6.5L9 16l2-.5c2-1 4-3.5 4-6.5 0-4-3-7-6-7z"/><path d="M9 6v4l2.5 1.5"/></svg>',
  };

  // Category config
  const CATS = {
    'Historic Landmarks':        { color: '#8b2500', short: 'Landmarks', watercolor: 'landmarks' },
    'Eat, Drink & Stay':         { color: '#a67830', short: 'Eat & Drink', watercolor: 'eat-drink' },
    'Arts Organizations':        { color: '#2d4a3e', short: 'Arts Orgs', watercolor: 'arts' },
    'Cultural Resources':        { color: '#3a5f7c', short: 'Cultural', watercolor: 'cultural' },
    'Fairs & Festivals':         { color: '#a0522d', short: 'Festivals', watercolor: 'fairs' },
    'Galleries & Museums':       { color: '#6b4e71', short: 'Galleries', watercolor: 'galleries' },
    'Walks & Trails':            { color: '#4a7c5f', short: 'Trails', watercolor: 'walks' },
    'Public Art':                { color: '#c45d3e', short: 'Public Art', watercolor: 'publicart' },
    'Performance Spaces':        { color: '#2a6496', short: 'Performance', watercolor: 'performance' },
    'Preservation & Culture':    { color: '#5c5020', short: 'Preservation', watercolor: 'preservation' },
  };

  // ============================================================
  // STATE
  // ============================================================
  let DATA = [];
  let IMAGE_DATA = {};
  let EXPERIENCES = [];
  let EVENTS = [];
  let EVENT_INDEX = null;
  let COUNTY_OUTLINE = null;
  let map;
  let activeCategories = new Set();
  let openNowMode = false;
  let events14dMode = false;
  let eventDateFilter = 'all';
  let eventCategoryFilter = 'all';
  let eventsListPage = 0;
  let mapFiltersExpanded = false;
  let mapLegendExpanded = false;
  let hasUserInteractedWithMap = false;
  let idlePreviewTimer = null;
  let idlePreviewFeatureId = null;
  let activeExperience = null;
  let cardElements = [];
  let listPage = 0;
  const LIST_PAGE_SIZE = 30;
  const EVENT_WINDOW_DAYS = 14;
  const PACIFIC_TZ = 'America/Los_Angeles';
  let matchedEventsByAsset = new Map();
  let unmatchedEvents = [];
  let eventsRotateRaf = null;
  let eventsRotateLastTs = 0;
  let eventsResumeTimer = null;

  // Experience overlay state
  let corridorMarkers = [];
  let currentResolvedStops = [];
  let routeAnimationId = null;
  let tourTimeouts = [];
  let activeMoveendHandler = null;  // Track for cleanup
  let dotPulseTween = null;
  let originalPaintValues = {};

  // Hover popup
  let hoverPopup = null;
  let hoveredFeatureId = null;
  let labeledFeatureIds = new Set();
  const LABEL_MAX_VISIBLE = 32;
  const LABEL_ALL_THRESHOLD = 16;
  const LABEL_SUBSET_COUNT = 12;
  const MOBILE_LABEL_MAX_VISIBLE = 46;
  const MOBILE_LABEL_MIN_ZOOM = 11.2;
  const MOBILE_LABEL_SIZE_BASE = 10;
  const MOBILE_LABEL_SIZE_LARGE = 13;
  const isCoarsePointer = window.matchMedia('(pointer: coarse)').matches;
  const smartLabelsEnabled = window.matchMedia('(hover: hover) and (pointer: fine)').matches;
  let smartLabelLayer = null;
  let smartLabelFrame = null;

  // ============================================================
  // LOAD DATA
  // ============================================================
  Promise.all([
    fetch('data.json').then(r => r.json()),
    fetch('image_data.json').then(r => r.json()).catch(() => ({})),
    fetch('experiences.json').then(r => r.json()).catch(() => []),
    fetch('events.json').then(r => r.json()).catch(() => []),
    fetch('events.index.json').then(r => r.json()).catch(() => null),
    fetch('nevada-county.geojson')
      .then((r) => (r.ok ? r.json() : null))
      .catch(() => null)
  ]).then(([data, images, experiences, events, eventIndex, countyOutline]) => {
    DATA = data;
    IMAGE_DATA = images;
    EXPERIENCES = experiences;
    EVENTS = Array.isArray(events) ? events : [];
    EVENT_INDEX = eventIndex;
    COUNTY_OUTLINE = sanitizeCountyOutline(countyOutline);
    buildVenueEventIndex();
    init();
  }).catch(err => {
    console.error('Failed to load data:', err);
  });

  function init() {
    animateStats();
    buildCategoryGrid();
    buildFilterBar();
    buildMapLegend();
    buildExperienceSelector();
    initMapLibre();
    buildExploreCats();
    buildList();
    buildMapEventsCategorySelect();
    buildMapEventsList();
    initScrollReveal();
    bindEvents();
    preloadWatercolors();
  }

  // Preload watercolor images — deferred until browser is idle
  function preloadWatercolors() {
    const load = () => {
      Object.values(CATS).forEach(cfg => {
        if (cfg.watercolor) {
          const img = new Image();
          img.src = `img/watercolor/${cfg.watercolor}.png`;
        }
      });
    };
    if ('requestIdleCallback' in window) {
      requestIdleCallback(load);
    } else {
      setTimeout(load, 3000);
    }
  }

  // ============================================================
  // STATS COUNTER (GSAP)
  // ============================================================
  function animateStats() {
    if (!document.getElementById('stat-total')) return;
    const cities = new Set(DATA.map(d => d.c).filter(Boolean));
    const targets = { total: 0, cats: 0, cities: 0 };
    gsap.to(targets, {
      total: DATA.length,
      cats: Object.keys(CATS).length,
      cities: cities.size,
      duration: 1.5,
      ease: 'power2.out',
      delay: 1.2,
      onUpdate: () => {
        document.getElementById('stat-total').textContent = Math.round(targets.total);
        document.getElementById('stat-cats').textContent = Math.round(targets.cats);
        document.getElementById('stat-cities').textContent = Math.round(targets.cities);
      }
    });
  }

  // ============================================================
  // UTILITY
  // ============================================================
  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  function getPacificNow() {
    const parts = new Intl.DateTimeFormat('en-US', {
      timeZone: PACIFIC_TZ,
      weekday: 'long',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    }).formatToParts(new Date());
    const toValue = (type) => (parts.find((p) => p.type === type) || {}).value || '';
    const weekday = toValue('weekday');
    const hour = parseInt(toValue('hour') || '0', 10);
    const minute = parseInt(toValue('minute') || '0', 10);
    const dayPeriod = (toValue('dayPeriod') || '').toUpperCase();
    let h24 = hour % 12;
    if (dayPeriod === 'PM') h24 += 12;
    return { weekday, minutes: (h24 * 60) + minute };
  }

  function normalizeHoursText(value) {
    return String(value || '')
      .replace(/[\u202f\u2009\u00a0]/g, ' ')
      .replace(/[‐‑‒–—]/g, '-')
      .replace(/\s+/g, ' ')
      .trim();
  }

  function parseTimeToken(token, fallbackPeriod) {
    const cleaned = normalizeHoursText(token).replace(/\./g, '');
    const match = cleaned.match(/(\d{1,2})(?::(\d{2}))?\s*([AaPp][Mm])?/);
    if (!match) return null;
    const hour = parseInt(match[1], 10);
    const minute = parseInt(match[2] || '0', 10);
    const period = (match[3] ? match[3].toUpperCase() : (fallbackPeriod || '')).toUpperCase();
    if (!period || (period !== 'AM' && period !== 'PM')) return null;
    let h24 = hour % 12;
    if (period === 'PM') h24 += 12;
    return { minutes: (h24 * 60) + minute, period };
  }

  function getTodayHoursEntry(hours) {
    if (!Array.isArray(hours) || hours.length === 0) return null;
    const { weekday } = getPacificNow();
    const prefix = `${weekday}:`.toLowerCase();
    const line = hours.find((entry) => typeof entry === 'string' && entry.toLowerCase().startsWith(prefix));
    return line || null;
  }

  function parseTodayRanges(todayEntry) {
    if (!todayEntry) return null;
    const normalized = normalizeHoursText(todayEntry);
    const splitIdx = normalized.indexOf(':');
    if (splitIdx < 0) return null;
    const schedule = normalized.slice(splitIdx + 1).trim();
    if (!schedule) return null;
    if (/open 24 hours/i.test(schedule)) return { state: 'open', ranges: '24h', display: schedule };
    if (/^closed$/i.test(schedule)) return { state: 'closed', ranges: [], display: schedule };

    const ranges = [];
    for (const part of schedule.split(',')) {
      const segment = part.trim();
      const rangeMatch = segment.match(/(.+?)\s*-\s*(.+)/);
      if (!rangeMatch) continue;
      const end = parseTimeToken(rangeMatch[2], null);
      const start = parseTimeToken(rangeMatch[1], end ? end.period : null);
      if (!start || !end) continue;
      ranges.push({ start: start.minutes, end: end.minutes });
    }
    if (!ranges.length) return { state: 'unknown', ranges: [], display: schedule };
    return { state: 'range', ranges, display: schedule };
  }

  function isOpenAtNow(ranges) {
    const { minutes: now } = getPacificNow();
    for (const range of ranges) {
      if (range.start === range.end) return true;
      if (range.start < range.end) {
        if (now >= range.start && now < range.end) return true;
      } else if (now >= range.start || now < range.end) {
        return true;
      }
    }
    return false;
  }

  function getHoursState(venue) {
    const parsed = parseTodayRanges(getTodayHoursEntry(venue.h));
    if (!parsed) return 'unknown';
    if (parsed.state === 'open' || parsed.state === 'closed' || parsed.state === 'unknown') return parsed.state;
    return isOpenAtNow(parsed.ranges) ? 'open' : 'closed';
  }

  function getHoursLabel(state) {
    if (state === 'open') return 'Open now';
    if (state === 'closed') return 'Closed now';
    return 'Hours unknown';
  }

  function getHoursRank(state) {
    if (state === 'open') return 0;
    if (state === 'unknown') return 1;
    return 2;
  }

  function getTodayHoursDisplay(venue) {
    const parsed = parseTodayRanges(getTodayHoursEntry(venue.h));
    if (!parsed) return null;
    return parsed.display || null;
  }

  function escapeHTML(value) {
    return String(value || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function isValidCountyCoord(coord) {
    if (!Array.isArray(coord) || coord.length < 2) return false;
    const lon = Number(coord[0]);
    const lat = Number(coord[1]);
    if (!Number.isFinite(lon) || !Number.isFinite(lat)) return false;
    return lon >= -125 && lon <= -114 && lat >= 35 && lat <= 43;
  }

  function sanitizeCountyOutline(geojson) {
    if (!geojson || !Array.isArray(geojson.features)) return null;
    const cleanedFeatures = geojson.features.map((feature) => {
      if (!feature || !feature.geometry) return null;
      const { type, coordinates } = feature.geometry;
      if (type === 'Polygon' && Array.isArray(coordinates) && Array.isArray(coordinates[0])) {
        const outer = coordinates[0].filter(isValidCountyCoord);
        if (outer.length < 4) return null;
        return {
          ...feature,
          geometry: { type: 'Polygon', coordinates: [outer] }
        };
      }
      if (type === 'MultiPolygon' && Array.isArray(coordinates)) {
        const polygons = coordinates
          .map((poly) => {
            if (!Array.isArray(poly) || !Array.isArray(poly[0])) return null;
            const outer = poly[0].filter(isValidCountyCoord);
            if (outer.length < 4) return null;
            return [outer];
          })
          .filter(Boolean);
        if (!polygons.length) return null;
        return {
          ...feature,
          geometry: { type: 'MultiPolygon', coordinates: polygons }
        };
      }
      return null;
    }).filter(Boolean);

    if (!cleanedFeatures.length) return null;
    return {
      type: 'FeatureCollection',
      features: cleanedFeatures
    };
  }

  function normalizeEventToken(value) {
    return String(value || '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '');
  }

  function makeEventVenueKey(name, city) {
    return `${normalizeEventToken(name)}|${normalizeEventToken(city)}`;
  }

  function parseEventDate(value) {
    const dt = new Date(value);
    return Number.isNaN(dt.getTime()) ? null : dt;
  }

  function isEventUpcoming(event) {
    const start = parseEventDate(event.start_iso);
    const end = parseEventDate(event.end_iso) || start;
    if (!start || !end) return false;
    return end.getTime() >= Date.now();
  }

  function isEventWithinDays(event, days) {
    const start = parseEventDate(event.start_iso);
    const end = parseEventDate(event.end_iso) || start;
    if (!start || !end) return false;
    const now = Date.now();
    const max = now + (days * 24 * 60 * 60 * 1000);
    const startTs = start.getTime();
    const endTs = end.getTime();
    return endTs >= now && startTs <= max;
  }

  function isWeekendEvent(event) {
    const start = parseEventDate(event.start_iso);
    if (!start) return false;
    const tz = event.timezone || PACIFIC_TZ;
    const weekday = new Intl.DateTimeFormat('en-US', { timeZone: tz, weekday: 'short' }).format(start);
    return weekday === 'Sat' || weekday === 'Sun';
  }

  function getDateKeyInTimezone(date, tz) {
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: tz,
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date);
    const year = parts.find((p) => p.type === 'year')?.value || '0000';
    const month = parts.find((p) => p.type === 'month')?.value || '00';
    const day = parts.find((p) => p.type === 'day')?.value || '00';
    return `${year}-${month}-${day}`;
  }

  function isEventToday(event) {
    const start = parseEventDate(event.start_iso);
    const end = parseEventDate(event.end_iso) || start;
    if (!start || !end) return false;
    const tz = event.timezone || PACIFIC_TZ;
    const todayKey = getDateKeyInTimezone(new Date(), tz);
    const startKey = getDateKeyInTimezone(start, tz);
    const endKey = getDateKeyInTimezone(end, tz);
    return todayKey >= startKey && todayKey <= endKey;
  }

  function choosePreferredEventAssetIndex(indices) {
    const categoryPriority = {
      'Performance Spaces': 0,
      'Arts Organizations': 1,
      'Fairs & Festivals': 2,
      'Galleries & Museums': 3,
      'Preservation & Culture': 4,
      'Historic Landmarks': 5,
      'Cultural Resources': 6,
      'Public Art': 7,
      'Eat, Drink & Stay': 8,
      'Walks & Trails': 9
    };
    return indices
      .slice()
      .sort((a, b) => {
        const ac = DATA[a] && DATA[a].l ? DATA[a].l : '';
        const bc = DATA[b] && DATA[b].l ? DATA[b].l : '';
        const ap = Object.prototype.hasOwnProperty.call(categoryPriority, ac) ? categoryPriority[ac] : 99;
        const bp = Object.prototype.hasOwnProperty.call(categoryPriority, bc) ? categoryPriority[bc] : 99;
        if (ap !== bp) return ap - bp;
        return a - b;
      })[0];
  }

  function resolveAssetIndex(venue) {
    let idx = DATA.indexOf(venue);
    if (idx >= 0) return idx;
    idx = DATA.findIndex((d) => d && venue && d.n === venue.n && d.c === venue.c && d.l === venue.l);
    return idx >= 0 ? idx : null;
  }

  function buildVenueEventIndex() {
    matchedEventsByAsset = new Map();
    unmatchedEvents = [];

    const byPid = new Map();
    const byKey = new Map();
    DATA.forEach((asset, idx) => {
      if (asset && typeof asset.pid === 'string' && asset.pid.trim()) {
        if (!byPid.has(asset.pid)) byPid.set(asset.pid, []);
        byPid.get(asset.pid).push(idx);
      }
      const key = makeEventVenueKey(asset && asset.n, asset && asset.c);
      if (key !== '|') {
        if (!byKey.has(key)) byKey.set(key, []);
        byKey.get(key).push(idx);
      }
    });

    const sourceEvents = (EVENT_INDEX && Array.isArray(EVENT_INDEX.events))
      ? EVENT_INDEX.events
      : EVENTS;
    const normalized = [];

    sourceEvents.forEach((raw) => {
      if (!raw || typeof raw !== 'object') return;
      const event = { ...raw };
      let matchedIdx = Number.isInteger(event.matched_asset_idx) ? event.matched_asset_idx : null;
      let matchMethod = event.match_method || 'none';

      if (matchedIdx === null) {
        const pid = event.venue_pid;
        if (typeof pid === 'string' && byPid.has(pid)) {
          matchedIdx = choosePreferredEventAssetIndex(byPid.get(pid));
          matchMethod = 'pid';
        } else {
          const key = makeEventVenueKey(event.venue_name, event.venue_city);
          if (byKey.has(key)) {
            matchedIdx = choosePreferredEventAssetIndex(byKey.get(key));
            matchMethod = 'name_city';
          }
        }
      }

      event.matched_asset_idx = matchedIdx;
      event.match_method = matchMethod;
      event.is_unmatched = matchedIdx === null;
      event._start_ts = parseEventDate(event.start_iso) ? parseEventDate(event.start_iso).getTime() : 0;
      event._end_ts = parseEventDate(event.end_iso) ? parseEventDate(event.end_iso).getTime() : 0;
      normalized.push(event);
    });

    normalized.sort((a, b) => {
      if (a._start_ts !== b._start_ts) return a._start_ts - b._start_ts;
      return String(a.event_id || '').localeCompare(String(b.event_id || ''));
    });

    EVENTS = normalized;
    EVENTS.forEach((event) => {
      if (Number.isInteger(event.matched_asset_idx)) {
        const idx = event.matched_asset_idx;
        if (!matchedEventsByAsset.has(idx)) matchedEventsByAsset.set(idx, []);
        matchedEventsByAsset.get(idx).push(event);
      } else {
        unmatchedEvents.push(event);
      }
    });
  }

  function getUpcomingEventsForAssetIdx(assetIdx, days = EVENT_WINDOW_DAYS) {
    if (!Number.isInteger(assetIdx)) return [];
    const events = matchedEventsByAsset.get(assetIdx) || [];
    return events.filter((event) => isEventWithinDays(event, days));
  }

  function getEventCountForAsset14d(assetIdx) {
    return getUpcomingEventsForAssetIdx(assetIdx, EVENT_WINDOW_DAYS).length;
  }

  function formatEventDateRange(event) {
    const start = parseEventDate(event.start_iso);
    const end = parseEventDate(event.end_iso);
    if (!start || !end) return 'Schedule pending';
    const tz = event.timezone || PACIFIC_TZ;
    const dayFmt = new Intl.DateTimeFormat('en-US', { timeZone: tz, weekday: 'short', month: 'short', day: 'numeric' });
    const timeFmt = new Intl.DateTimeFormat('en-US', { timeZone: tz, hour: 'numeric', minute: '2-digit' });
    return `${dayFmt.format(start)} • ${timeFmt.format(start)}-${timeFmt.format(end)}`;
  }

  function eventMatchesCategoryFilter(event) {
    if (eventCategoryFilter === 'all') return true;
    if (!Number.isInteger(event.matched_asset_idx)) return false;
    const asset = DATA[event.matched_asset_idx];
    return !!asset && asset.l === eventCategoryFilter;
  }

  function getEventDisplayDescription(event) {
    const raw = String(event.description || '')
      .replace(/<[^>]*>/g, ' ')
      .replace(/\s+/g, ' ')
      .trim();
    if (raw) return raw;
    if (Array.isArray(event.tags) && event.tags.length) {
      return `Type: ${event.tags.slice(0, 2).join(' • ')}`;
    }
    return 'Details available in the event link.';
  }

  function getFilteredMapEvents() {
    let events = EVENTS.filter((event) => isEventUpcoming(event));
    if (eventDateFilter === 'today') {
      events = events.filter((event) => isEventToday(event));
    } else if (eventDateFilter === 'weekend') {
      events = events.filter((event) => isWeekendEvent(event));
    } else if (eventDateFilter === '14d') {
      events = events.filter((event) => isEventWithinDays(event, EVENT_WINDOW_DAYS));
    }
    events = events.filter((event) => eventMatchesCategoryFilter(event));
    return events;
  }

  function setEventDateFilter(filterValue) {
    eventDateFilter = filterValue;
    eventsListPage = 0;
    buildMapEventsList();
    updateMapEventsFilterUI();
  }

  function updateMapEventsFilterUI() {
    const chips = document.querySelectorAll('[data-event-filter]');
    chips.forEach((chip) => {
      chip.classList.toggle('active', chip.dataset.eventFilter === eventDateFilter);
    });
  }

  function buildMapEventsCategorySelect() {
    const select = document.getElementById('mapEventsCategory');
    if (!select) return;
    const seen = new Set();
    const categories = DATA
      .map((d) => d && d.l)
      .filter((name) => typeof name === 'string' && name && !seen.has(name) && seen.add(name));

    select.innerHTML = '<option value="all">All categories</option>' +
      categories.map((name) => {
        const label = (CATS[name] && CATS[name].short) || name;
        return `<option value="${escapeHTML(name)}">${escapeHTML(label)}</option>`;
      }).join('');
    select.value = eventCategoryFilter;
  }

  function updateMapEventsCategoryUI() {
    const select = document.getElementById('mapEventsCategory');
    if (select && select.value !== eventCategoryFilter) {
      select.value = eventCategoryFilter;
    }
  }

  function setEventCategoryFilter(categoryValue) {
    eventCategoryFilter = categoryValue && categoryValue !== 'all' ? categoryValue : 'all';
    eventsListPage = 0;
    updateMapEventsCategoryUI();
    buildMapEventsList();
  }

  function focusEvent(eventId) {
    const event = EVENTS.find((item) => item.event_id === eventId);
    if (!event || !Number.isInteger(event.matched_asset_idx)) return;
    const venue = DATA[event.matched_asset_idx];
    if (!venue || !venue.x || !venue.y) return;
    document.getElementById('mapSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    map.flyTo({
      center: [venue.x, venue.y],
      zoom: Math.max(map.getZoom(), 14),
      pitch: Math.max(map.getPitch(), 48),
      bearing: map.getBearing(),
      duration: 850,
      essential: true
    });
    openDetail(venue);
  }

  function stopEventsRotation() {
    if (eventsRotateRaf) {
      cancelAnimationFrame(eventsRotateRaf);
      eventsRotateRaf = null;
    }
    if (eventsResumeTimer) {
      clearTimeout(eventsResumeTimer);
      eventsResumeTimer = null;
    }
    eventsRotateLastTs = 0;
  }

  function queueEventsRotationResume(totalCards, delayMs = 520) {
    if (eventsResumeTimer) clearTimeout(eventsResumeTimer);
    eventsResumeTimer = setTimeout(() => {
      eventsResumeTimer = null;
      startEventsRotation(totalCards);
    }, delayMs);
  }

  function getEventsCarouselVisibleSlots() {
    if (window.matchMedia('(max-width: 600px)').matches) return 1;
    if (window.matchMedia('(max-width: 900px)').matches) return 2;
    return 3;
  }

  function getEventsCarouselStep(listEl) {
    const first = listEl ? listEl.querySelector('.map-event-item') : null;
    if (!first) return listEl ? listEl.clientWidth : 0;
    const styles = getComputedStyle(listEl);
    const gap = parseFloat(styles.columnGap || styles.gap || '0') || 0;
    return first.getBoundingClientRect().width + gap;
  }

  function updateEventsSpotlightPageLabel(totalCards) {
    const listEl = document.getElementById('mapEventsList');
    const pageEl = document.getElementById('mapEventsPage');
    if (!listEl || !pageEl) return;
    if (!totalCards) {
      pageEl.textContent = 'Spotlight 0 / 0';
      eventsListPage = 0;
      return;
    }
    const step = getEventsCarouselStep(listEl);
    const idx = step > 0 ? Math.round(listEl.scrollLeft / step) : 0;
    const normalized = Math.max(0, Math.min(totalCards - 1, idx));
    eventsListPage = normalized;
    pageEl.textContent = `Spotlight ${normalized + 1} / ${totalCards}`;
  }

  function stepEventsSpotlight(direction = 1, smooth = true) {
    const listEl = document.getElementById('mapEventsList');
    if (!listEl) return false;
    const cards = listEl.querySelectorAll('.map-event-item');
    const totalCards = cards.length;
    const visibleSlots = getEventsCarouselVisibleSlots();
    if (totalCards <= visibleSlots) return false;

    const step = getEventsCarouselStep(listEl);
    if (step <= 0) return false;
    const maxLeft = Math.max(0, listEl.scrollWidth - listEl.clientWidth);
    if (maxLeft <= 1) return false;
    const current = listEl.scrollLeft;

    if (direction > 0) {
      if (current + step >= maxLeft - 2) {
        listEl.scrollTo({ left: 0, behavior: 'auto' });
      } else {
        listEl.scrollTo({ left: current + step, behavior: smooth ? 'smooth' : 'auto' });
      }
    } else {
      if (current <= 2) {
        listEl.scrollTo({ left: maxLeft, behavior: 'auto' });
      } else {
        listEl.scrollTo({ left: Math.max(0, current - step), behavior: smooth ? 'smooth' : 'auto' });
      }
    }

    setTimeout(() => updateEventsSpotlightPageLabel(totalCards), smooth ? 420 : 0);
    return true;
  }

  function startEventsRotation(totalCards) {
    stopEventsRotation();
    if (totalCards <= getEventsCarouselVisibleSlots()) return;
    const listEl = document.getElementById('mapEventsList');
    if (!listEl) return;
    const details = document.getElementById('mapEventsDetails');
    if (details && !details.open) return;

    const speedPxPerSecond = 22;
    let lastLabelUpdate = 0;

    const tick = (ts) => {
      const panel = document.getElementById('mapEventsDetails');
      if (panel && !panel.open) {
        stopEventsRotation();
        return;
      }
      if (!eventsRotateLastTs) eventsRotateLastTs = ts;
      const dt = Math.min(0.05, (ts - eventsRotateLastTs) / 1000);
      eventsRotateLastTs = ts;

      const maxLeft = Math.max(0, listEl.scrollWidth - listEl.clientWidth);
      if (maxLeft <= 1) {
        stopEventsRotation();
        return;
      }

      let nextLeft = listEl.scrollLeft + speedPxPerSecond * dt;
      if (nextLeft >= maxLeft) nextLeft = 0;
      listEl.scrollLeft = nextLeft;

      if (ts - lastLabelUpdate >= 170) {
        updateEventsSpotlightPageLabel(totalCards);
        lastLabelUpdate = ts;
      }
      eventsRotateRaf = requestAnimationFrame(tick);
    };

    eventsRotateRaf = requestAnimationFrame(tick);
  }

  function buildMapEventsList(options = {}) {
    const { keepPosition = false, skipRotationRestart = false } = options;
    const listEl = document.getElementById('mapEventsList');
    const allListEl = document.getElementById('mapEventsAllList');
    const countEl = document.getElementById('mapEventsCount');
    const scopeEl = document.getElementById('mapEventsScope');
    const prevBtn = document.getElementById('mapEventsPrev');
    const nextBtn = document.getElementById('mapEventsNext');
    const pageEl = document.getElementById('mapEventsPage');
    if (!listEl || !allListEl || !countEl || !pageEl) return;
    updateMapEventsFilterUI();
    updateMapEventsCategoryUI();

    const filtered = getFilteredMapEvents();
    const scopeLabel = eventCategoryFilter === 'all'
      ? 'All categories'
      : `Category: ${((CATS[eventCategoryFilter] && CATS[eventCategoryFilter].short) || eventCategoryFilter)}`;

    countEl.textContent = `${filtered.length} event${filtered.length === 1 ? '' : 's'}`;
    if (scopeEl) scopeEl.textContent = scopeLabel;

    if (!filtered.length) {
      const msg = 'No upcoming events for this filter.';
      listEl.innerHTML = `<div class="map-events-empty">${msg}</div>`;
      allListEl.innerHTML = `<div class="map-events-empty">${msg}</div>`;
      pageEl.textContent = 'Spotlight 0 / 0';
      if (prevBtn) prevBtn.disabled = true;
      if (nextBtn) nextBtn.disabled = true;
      stopEventsRotation();
      return;
    }

    listEl.innerHTML = filtered.map((event) => {
      const mapped = Number.isInteger(event.matched_asset_idx);
      const title = escapeHTML(event.title || 'Untitled event');
      const venueName = escapeHTML(event.venue_name || 'Venue TBD');
      const eventTime = escapeHTML(formatEventDateRange(event));
      const rawDesc = getEventDisplayDescription(event);
      const shortDesc = escapeHTML(rawDesc.length > 180 ? `${rawDesc.slice(0, 177)}...` : rawDesc);
      const imageURL = typeof event.image_url === 'string' ? event.image_url.trim() : '';
      const imageHTML = imageURL
        ? `<img class="map-event-image" src="${escapeHTML(imageURL)}" alt="${title}" loading="lazy" onerror="this.outerHTML='<div class=&quot;map-event-image placeholder&quot;>No image</div>'">`
        : '<div class="map-event-image placeholder">No image</div>';
      const ticket = typeof event.ticket_url === 'string' && event.ticket_url
        ? `<a class="map-event-link" href="${escapeHTML(event.ticket_url)}" target="_blank" rel="noopener">Tickets / Details</a>`
        : '';
      const badge = mapped ? '' : '<span class="map-event-badge">Unmapped</span>';
      return `
        <div class="map-event-item ${mapped ? 'mapped' : 'unmapped'}" data-event-id="${escapeHTML(event.event_id || '')}">
          ${imageHTML}
          <div class="map-event-title">${title}</div>
          <div class="map-event-desc">${shortDesc}</div>
          <div class="map-event-meta">
            <span>${eventTime}</span>
            <span class="map-event-venue">${venueName}</span>
            ${badge}
          </div>
          ${ticket}
        </div>
      `;
    }).join('');

    if (!keepPosition) {
      listEl.scrollTo({ left: 0, behavior: 'auto' });
    }

    allListEl.innerHTML = filtered.map((event) => {
      const mapped = Number.isInteger(event.matched_asset_idx);
      const title = escapeHTML(event.title || 'Untitled event');
      const venueName = escapeHTML(event.venue_name || 'Venue TBD');
      const eventTime = escapeHTML(formatEventDateRange(event));
      const ticket = typeof event.ticket_url === 'string' && event.ticket_url
        ? `<a class="map-event-link" href="${escapeHTML(event.ticket_url)}" target="_blank" rel="noopener">Tickets / Details</a>`
        : '';
      const badge = mapped ? '' : '<span class="map-event-badge">Unmapped</span>';
      return `
        <div class="map-event-row ${mapped ? 'mapped' : 'unmapped'}" data-event-id="${escapeHTML(event.event_id || '')}">
          <div class="map-event-row-title">${title}</div>
          <div class="map-event-row-meta">
            <span>${eventTime}</span>
            <span class="map-event-venue">${venueName}</span>
            ${badge}
          </div>
          ${ticket}
        </div>
      `;
    }).join('');

    const canStep = filtered.length > getEventsCarouselVisibleSlots();
    if (prevBtn) prevBtn.disabled = !canStep;
    if (nextBtn) nextBtn.disabled = !canStep;
    updateEventsSpotlightPageLabel(filtered.length);
    if (!skipRotationRestart) startEventsRotation(filtered.length);
  }

  function renderDetailEvents(venue) {
    const wrapper = document.getElementById('detailEvents');
    if (!wrapper) return;
    const idx = resolveAssetIndex(venue);
    if (!Number.isInteger(idx)) {
      wrapper.innerHTML = '';
      return;
    }
    const upcoming = getUpcomingEventsForAssetIdx(idx, EVENT_WINDOW_DAYS);
    if (!upcoming.length) {
      wrapper.innerHTML = '<div class="detail-events-title">Upcoming Events</div><div class="detail-events-empty">No curated events in the next 14 days.</div>';
      return;
    }
    const cards = upcoming.slice(0, 5).map((event) => {
      const title = escapeHTML(event.title || 'Untitled event');
      const time = escapeHTML(formatEventDateRange(event));
      const link = typeof event.ticket_url === 'string' && event.ticket_url
        ? `<a class="detail-event-link" href="${escapeHTML(event.ticket_url)}" target="_blank" rel="noopener">Tickets / Details</a>`
        : '';
      return `<div class="detail-event-card"><div class="detail-event-title">${title}</div><div class="detail-event-time">${time}</div>${link}</div>`;
    }).join('');
    wrapper.innerHTML = `<div class="detail-events-title">Upcoming Events</div>${cards}`;
  }

  // ============================================================
  // EXPERIENCE SELECTOR
  // ============================================================
  function buildExperienceSelector() {
    const addonsWrap = document.getElementById('mapAddons');
    const guidesSection = document.getElementById('mapGuides');
    const corridorSection = document.getElementById('corridorAddon');
    const exploreSection = document.getElementById('experienceAddon');
    const corridorContainer = document.getElementById('corridorCards');
    const experienceContainer = document.getElementById('experienceCards');
    const guidesCountEl = document.getElementById('mapGuidesCount');
    const corridorCountEl = document.getElementById('corridorAddonCount');
    const experienceCountEl = document.getElementById('experienceAddonCount');

    if (!EXPERIENCES.length) {
      if (addonsWrap) addonsWrap.style.display = 'none';
      if (guidesSection) guidesSection.style.display = 'none';
      if (corridorSection) corridorSection.style.display = 'none';
      if (exploreSection) exploreSection.style.display = 'none';
      return;
    }

    const corridors = EXPERIENCES.filter(e => e.type === 'corridor');
    const experiences = EXPERIENCES.filter(e => e.type !== 'corridor');
    if (corridorContainer) corridorContainer.innerHTML = '';
    if (experienceContainer) experienceContainer.innerHTML = '';

    const hasAny = corridors.length || experiences.length;
    if (addonsWrap) addonsWrap.style.display = hasAny ? '' : 'none';
    if (guidesSection) {
      guidesSection.style.display = hasAny ? '' : 'none';
      guidesSection.open = false;
    }

    // Hide sections if empty
    if (corridorSection) {
      corridorSection.style.display = corridors.length ? '' : 'none';
      corridorSection.open = false;
    }
    if (exploreSection) {
      exploreSection.style.display = experiences.length ? '' : 'none';
      exploreSection.open = false;
    }
    if (guidesCountEl) guidesCountEl.textContent = `${corridors.length + experiences.length} guides`;
    if (corridorCountEl) corridorCountEl.textContent = `${corridors.length} route${corridors.length === 1 ? '' : 's'}`;
    if (experienceCountEl) experienceCountEl.textContent = `${experiences.length} route${experiences.length === 1 ? '' : 's'}`;

    function makeCard(exp, container) {
      const card = document.createElement('div');
      card.className = 'experience-card';
      card.dataset.slug = exp.slug;
      card.dataset.expType = exp.type || 'experience';
      card.style.setProperty('--exp-color', exp.color);
      card.innerHTML = `
        <div class="experience-card-dot" style="background:${exp.color}; color:${exp.color}"></div>
        <div class="experience-card-info">
          <div class="experience-card-title">${exp.title}</div>
          <div class="experience-card-meta">${exp.stops.length} stops</div>
        </div>
        <div class="experience-card-close">&times;</div>
      `;
      card.style.cssText += `--exp-color:${exp.color}`;
      card.addEventListener('click', () => {
        if (activeExperience && activeExperience.slug === exp.slug) {
          deactivateExperience();
        } else {
          activateExperience(exp);
        }
      });
      container.appendChild(card);
    }

    corridors.forEach(exp => makeCard(exp, corridorContainer));
    experiences.forEach(exp => makeCard(exp, experienceContainer));
  }

  // ============================================================
  // RESOLVE STOPS
  // ============================================================
  function resolveStops(experience) {
    return experience.stops.map(stop => {
      const match = DATA.find(d =>
        d.n && d.n.toLowerCase().includes(stop.asset.toLowerCase())
      );
      return { ...stop, data: match || null };
    }).filter(s => s.data);
  }

  // ============================================================
  // MAPLIBRE INITIALIZATION (Steps 2 + 3)
  // ============================================================
  function initMapLibre() {
    const useCooperativeGestures = false;
    const styleUrl = MAPTILER_KEY !== 'GET_YOUR_FREE_KEY_AT_MAPTILER_COM'
      ? `https://api.maptiler.com/maps/landscape/style.json?key=${MAPTILER_KEY}`
      : {
          version: 8,
          name: 'Dark Fallback',
          sources: {
            'carto-dark': {
              type: 'raster',
              tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'],
              tileSize: 256,
              attribution: '&copy; OpenStreetMap &copy; CARTO'
            }
          },
          layers: [{
            id: 'carto-dark-layer',
            type: 'raster',
            source: 'carto-dark',
            minzoom: 0,
            maxzoom: 19
          }]
        };

    map = new maplibregl.Map({
      container: 'map',
      style: styleUrl,
      center: [-120.8, 39.22],
      zoom: 9,
      pitch: 35,
      bearing: -15,
      cooperativeGestures: useCooperativeGestures,
      antialias: true,
      maxPitch: 70
    });
    window.__culturalMap = map;

    map.addControl(new maplibregl.NavigationControl({
      visualizePitch: true
    }), 'top-right');

    hoverPopup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
      offset: 15,
      maxWidth: '280px'
    });

    map.on('load', () => {
      // Override style's pitch/bearing with our cinematic defaults
      map.jumpTo({ pitch: 35, bearing: -15 });

      // Add 3D terrain if MapTiler key is available
      if (MAPTILER_KEY !== 'GET_YOUR_FREE_KEY_AT_MAPTILER_COM') {
        map.addSource('terrain-dem', {
          type: 'raster-dem',
          url: `https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=${MAPTILER_KEY}`,
          encoding: 'mapbox'
        });

        // Add terrain control button (lets user toggle terrain)
        map.addControl(new maplibregl.TerrainControl({
          source: 'terrain-dem',
          exaggeration: 2
        }));

        // Enable terrain
        const isMobile = window.matchMedia('(max-width: 600px)').matches;
        if (!isMobile) {
          map.setTerrain({
            source: 'terrain-dem',
            exaggeration: 2
          });
        }

        console.log('[Terrain] Source added, terrain set, exaggeration: 2');
        console.log('[Terrain] Current terrain:', map.getTerrain());

        // Store original paint values for theme reset
        storeOriginalPaints();
      }

      addCountyOutlineLayer();

      // Add asset data as GeoJSON
      addAssetLayers();
    });
  }

  function addCountyOutlineLayer() {
    if (!map || !COUNTY_OUTLINE || !Array.isArray(COUNTY_OUTLINE.features) || !COUNTY_OUTLINE.features.length) {
      return;
    }
    if (map.getLayer('county-outline-core')) return;

    if (!map.getSource('county-outline')) {
      map.addSource('county-outline', {
        type: 'geojson',
        data: COUNTY_OUTLINE
      });
    }

    map.addLayer({
      id: 'county-outline-glow',
      type: 'line',
      source: 'county-outline',
      paint: {
        'line-color': 'rgba(74,107,124,0.52)',
        'line-width': [
          'interpolate',
          ['linear'],
          ['zoom'],
          8, 4.5,
          12, 7,
          15, 9.5
        ],
        'line-opacity': 0.65,
        'line-blur': 1.2
      }
    });

    map.addLayer({
      id: 'county-outline-core',
      type: 'line',
      source: 'county-outline',
      paint: {
        'line-color': '#2b566f',
        'line-width': [
          'interpolate',
          ['linear'],
          ['zoom'],
          8, 1.7,
          12, 2.4,
          15, 3.2
        ],
        'line-opacity': 0.92
      }
    });
  }

  function storeOriginalPaints() {
    try {
      const layers = map.getStyle().layers || [];
      layers.forEach(layer => {
        if (layer.paint) {
          originalPaintValues[layer.id] = { ...layer.paint };
        }
      });
    } catch (e) { /* style may not be fully loaded */ }
  }

  // ============================================================
  // ASSET LAYERS (Step 3)
  // ============================================================
  function buildAssetsGeoJSON() {
    return {
      type: 'FeatureCollection',
      features: DATA.map((d, i) => {
        const lon = Number(d.x);
        const lat = Number(d.y);
        if (!Number.isFinite(lon) || !Number.isFinite(lat)) return null;
        const hoursState = getHoursState(d);
        const eventCount14d = getEventCountForAsset14d(i);
        const rawLabel = d.n || '';
        const labelName = rawLabel.length > 26 ? `${rawLabel.slice(0, 23)}...` : rawLabel;
        return {
          type: 'Feature',
          id: i,
          properties: {
            name: d.n || '',
            label_name: labelName,
            layer: d.l || '',
            city: d.c || '',
            address: d.a || '',
            description: d.d || '',
            phone: d.p || '',
            website: d.w || '',
            hours_state: hoursState,
            hours_label: getHoursLabel(hoursState),
            event_count_14d: eventCount14d,
            has_events_14d: eventCount14d > 0,
            color: (CATS[d.l] || { color: '#999' }).color,
            idx: i
          },
          geometry: {
            type: 'Point',
            coordinates: [lon, lat]
          }
        };
      }).filter(Boolean)
    };
  }

  function refreshAssetSourceHoursStates() {
    const source = map && map.getSource('assets');
    if (!source || typeof source.setData !== 'function') return;
    clearMapLabelStates();
    source.setData(buildAssetsGeoJSON());
    requestAnimationFrame(() => {
      updateMapProgressiveLabels();
      updateMobileLabelLayerVisibility();
    });
  }

  function buildFeatureTooltipHTML(props) {
    const cfg = CATS[props.layer] || { color: '#999' };
    const imgInfo = IMAGE_DATA[props.name];
    const wcSlug = cfg.watercolor || 'landmarks';
    const eventCount14d = Number(props.event_count_14d || 0);
    const eventLine = eventCount14d > 0
      ? `<div class="tooltip-event">${eventCount14d} event${eventCount14d === 1 ? '' : 's'} in next ${EVENT_WINDOW_DAYS} days</div>`
      : '';
    const imgHTML = imgInfo
      ? `<img class="tooltip-img" src="${imgInfo.img}" alt="${imgInfo.alt || props.name}" onerror="this.parentNode.removeChild(this)">`
      : `<div class="tooltip-placeholder" style="background:linear-gradient(135deg, ${cfg.color}, ${cfg.color}dd)"><img src="img/watercolor/${wcSlug}.png" class="tooltip-watercolor" alt="" onerror="this.style.display='none'"></div>`;
    return `${imgHTML}<div class="tooltip-body"><strong>${props.name}</strong><div class="tooltip-cat"><span class="tooltip-cat-dot" style="background:${cfg.color}"></span>${props.layer}</div>${props.city ? '<div class="tooltip-city">' + props.city + ', CA</div>' : ''}${eventLine}</div>`;
  }

  function clearIdlePreviewHoverState() {
    if (idlePreviewFeatureId !== null && map && map.getSource('assets')) {
      map.setFeatureState({ source: 'assets', id: idlePreviewFeatureId }, { hover: false });
    }
    idlePreviewFeatureId = null;
  }

  function stopIdlePreview() {
    if (idlePreviewTimer) {
      clearTimeout(idlePreviewTimer);
      idlePreviewTimer = null;
    }
    clearIdlePreviewHoverState();
    if (hoveredFeatureId === null && hoverPopup) hoverPopup.remove();
  }

  function clearMapLabelStates() {
    labeledFeatureIds.clear();
    if (smartLabelLayer) smartLabelLayer.innerHTML = '';
  }

  function ensureSmartLabelLayer() {
    if (!smartLabelsEnabled || smartLabelLayer) return;
    const mapEl = document.getElementById('map');
    if (!mapEl) return;
    const layer = document.createElement('div');
    layer.className = 'smart-label-layer';
    layer.id = 'smartLabelLayer';
    layer.addEventListener('click', (event) => {
      const card = event.target.closest('.smart-label-card');
      if (!card) return;
      const idx = Number(card.getAttribute('data-idx'));
      if (!Number.isFinite(idx) || idx < 0 || idx >= DATA.length) return;
      const d = DATA[idx];
      if (!d || !d.x || !d.y) return;
      openDetail(d);
      map.flyTo({
        center: [d.x, d.y],
        zoom: Math.max(map.getZoom(), 14),
        pitch: map.getPitch(),
        bearing: map.getBearing(),
        duration: 550,
        essential: true
      });
    });
    mapEl.appendChild(layer);
    smartLabelLayer = layer;
  }

  function scheduleSmartLabelUpdate() {
    if (!smartLabelsEnabled) return;
    if (smartLabelFrame) return;
    smartLabelFrame = requestAnimationFrame(() => {
      smartLabelFrame = null;
      updateMapProgressiveLabels();
    });
  }

  function boxesOverlap(a, b, padding = 8) {
    return !(
      (a.x + a.w + padding) < b.x ||
      (b.x + b.w + padding) < a.x ||
      (a.y + a.h + padding) < b.y ||
      (b.y + b.h + padding) < a.y
    );
  }

  function updateMapProgressiveLabels() {
    if (!map || !map.getLayer('assets-circle') || !map.getSource('assets')) return;
    ensureSmartLabelLayer();
    if (activeExperience) {
      clearMapLabelStates();
      return;
    }
    if (!smartLabelsEnabled || !smartLabelLayer) return;

    const rendered = map.queryRenderedFeatures({ layers: ['assets-circle'] }) || [];
    const seen = new Set();
    const unique = [];
    rendered.forEach((f) => {
      if (!f || f.id === undefined || f.id === null || seen.has(f.id)) return;
      seen.add(f.id);
      unique.push(f);
    });

    const visibleCount = unique.length;
    if (!visibleCount || visibleCount > LABEL_MAX_VISIBLE) {
      clearMapLabelStates();
      return;
    }

    const limit = visibleCount <= LABEL_ALL_THRESHOLD ? visibleCount : Math.min(LABEL_SUBSET_COUNT, visibleCount);
    const center = map.getCenter();

    unique.sort((a, b) => {
      if (openNowMode) {
        const ra = (a.properties && a.properties.hours_state) === 'open' ? 0 : 1;
        const rb = (b.properties && b.properties.hours_state) === 'open' ? 0 : 1;
        if (ra !== rb) return ra - rb;
      }
      const ac = (a.geometry && a.geometry.type === 'Point' && Array.isArray(a.geometry.coordinates)) ? a.geometry.coordinates : [center.lng, center.lat];
      const bc = (b.geometry && b.geometry.type === 'Point' && Array.isArray(b.geometry.coordinates)) ? b.geometry.coordinates : [center.lng, center.lat];
      const da = new maplibregl.LngLat(ac[0], ac[1]).distanceTo(center);
      const db = new maplibregl.LngLat(bc[0], bc[1]).distanceTo(center);
      return da - db;
    });

    const candidateFeatures = unique
      .map((feature) => {
        const coords = (feature.geometry && feature.geometry.type === 'Point' && Array.isArray(feature.geometry.coordinates))
          ? feature.geometry.coordinates
          : null;
        if (!coords) return null;
        const point = map.project(coords);
        return { feature, point };
      })
      .filter(Boolean);

    const spreadPx = visibleCount <= LABEL_ALL_THRESHOLD ? 34 : 56;
    const distributed = [];
    candidateFeatures.forEach((entry) => {
      if (distributed.length >= limit) return;
      const tooClose = distributed.some((picked) => {
        const dx = picked.point.x - entry.point.x;
        const dy = picked.point.y - entry.point.y;
        return Math.hypot(dx, dy) < spreadPx;
      });
      if (!tooClose) distributed.push(entry);
    });
    if (distributed.length < limit) {
      candidateFeatures.forEach((entry) => {
        if (distributed.length >= limit) return;
        if (!distributed.includes(entry)) distributed.push(entry);
      });
    }
    const chosen = distributed.slice(0, limit).map((entry) => entry.feature);
    const mapBox = map.getCanvas().getBoundingClientRect();
    const mapW = mapBox.width;
    const mapH = mapBox.height;
    const placed = [];
    let html = '';

    chosen.forEach((feature) => {
      const props = feature.properties || {};
      const idx = Number(props.idx);
      const coords = (feature.geometry && feature.geometry.type === 'Point' && Array.isArray(feature.geometry.coordinates))
        ? feature.geometry.coordinates
        : null;
      if (!coords) return;
      const projected = map.project(coords);
      const anchorX = projected.x;
      const anchorY = projected.y;
      if (anchorX < -24 || anchorX > mapW + 24 || anchorY < -24 || anchorY > mapH + 24) return;

      const name = String(props.name || '').trim();
      if (!name) return;
      const cfg = CATS[props.layer] || { color: '#6f6a60' };
      const width = Math.min(176, Math.max(78, (name.length * 6.1) + 22));
      const height = 24;
      const slots = [
        [0, -14],
        [18, -18],
        [-18, -18],
        [24, -8],
        [-24, -8],
        [0, 8],
        [30, 4],
        [-30, 4],
        [42, -12],
        [-42, -12],
        [46, 2],
        [-46, 2]
      ];
      const rings = [0, 8, 14, 22, 32, 44, 58];
      let placedBox = null;

      for (const ring of rings) {
        for (const slot of slots) {
          const centerX = anchorX + slot[0] + (slot[0] < 0 ? -ring : ring);
          const centerY = anchorY + slot[1] + (slot[1] < 0 ? -ring * 0.55 : ring * 0.45);
          const x = Math.max(8, Math.min(mapW - width - 8, centerX - (width / 2)));
          const y = Math.max(10, Math.min(mapH - height - 10, centerY - height));
          const candidate = { x, y, w: width, h: height };
          const hasOverlap = placed.some((b) => boxesOverlap(candidate, b, 4));
          if (!hasOverlap) {
            placedBox = candidate;
            break;
          }
        }
        if (placedBox) break;
      }

      if (!placedBox) return;
      placed.push(placedBox);
      const safeName = escapeHTML(name);
      html += `<button type="button" class="smart-label-card" data-idx="${idx}" style="left:${(placedBox.x + placedBox.w/2).toFixed(1)}px;top:${(placedBox.y + placedBox.h).toFixed(1)}px;border-left-color:${cfg.color};"><span class="smart-label-dot" style="background:${cfg.color};"></span><span class="smart-label-name">${safeName}</span></button>`;
    });

    smartLabelLayer.innerHTML = html;
  }

  function getVisibleAssetFeatureCount() {
    if (!map || !map.getLayer('assets-circle')) return 0;
    const rendered = map.queryRenderedFeatures({ layers: ['assets-circle'] }) || [];
    const seen = new Set();
    rendered.forEach((feature) => {
      if (!feature || feature.id === undefined || feature.id === null) return;
      seen.add(feature.id);
    });
    return seen.size;
  }

  function updateMobileLabelLayerVisibility() {
    if (!map || !isCoarsePointer || !map.getLayer('assets-mobile-labels')) return;
    const visibleCount = getVisibleAssetFeatureCount();
    const canShow = !activeExperience
      && map.getZoom() >= MOBILE_LABEL_MIN_ZOOM
      && visibleCount <= MOBILE_LABEL_MAX_VISIBLE
      && visibleCount > 0;
    map.setLayoutProperty('assets-mobile-labels', 'visibility', canShow ? 'visible' : 'none');
  }

  function markMapInteracted() {
    hasUserInteractedWithMap = true;
    stopIdlePreview();
  }

  function scheduleIdlePreview() {
    if (!map || hasUserInteractedWithMap || activeExperience || !map.getLayer('assets-circle')) return;
    if (idlePreviewTimer) clearTimeout(idlePreviewTimer);
    idlePreviewTimer = setTimeout(runIdlePreviewStep, 1200 + Math.random() * 1200);
  }

  function runIdlePreviewStep() {
    if (!map || hasUserInteractedWithMap || activeExperience || !map.getLayer('assets-circle')) return;
    const visible = map.queryRenderedFeatures({ layers: ['assets-circle'] }) || [];
    const unique = [];
    const seenIds = new Set();
    for (const f of visible) {
      if (f && f.id !== undefined && f.id !== null && !seenIds.has(f.id)) {
        seenIds.add(f.id);
        unique.push(f);
      }
    }
    if (!unique.length) {
      scheduleIdlePreview();
      return;
    }

    const pickPool = unique.slice(0, Math.min(unique.length, 28));
    const feature = pickPool[Math.floor(Math.random() * pickPool.length)];
    clearIdlePreviewHoverState();
    if (hoveredFeatureId !== null) {
      map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: false });
      hoveredFeatureId = null;
    }
    idlePreviewFeatureId = feature.id;
    map.setFeatureState({ source: 'assets', id: idlePreviewFeatureId }, { hover: true });

    const coords = (feature.geometry && feature.geometry.type === 'Point' && Array.isArray(feature.geometry.coordinates))
      ? feature.geometry.coordinates
      : map.getCenter().toArray();

    hoverPopup
      .setLngLat(coords)
      .setHTML(buildFeatureTooltipHTML(feature.properties || {}))
      .addTo(map);

    idlePreviewTimer = setTimeout(() => {
      clearIdlePreviewHoverState();
      if (!hasUserInteractedWithMap) hoverPopup.remove();
      scheduleIdlePreview();
    }, 1150 + Math.random() * 450);
  }

  function addAssetLayers() {
    const geojson = buildAssetsGeoJSON();

    map.addSource('assets', { type: 'geojson', data: geojson });

    map.addLayer({
      id: 'assets-circle',
      type: 'circle',
      source: 'assets',
      paint: {
        'circle-radius': [
          'case',
          ['boolean', ['feature-state', 'hover'], false], 8,
          5
        ],
        'circle-color': ['get', 'color'],
        'circle-opacity': 0.85,
        'circle-stroke-color': 'rgba(255,255,255,0.6)',
        'circle-stroke-width': 1.5,
        'circle-stroke-opacity': 1
      }
    });

    map.addLayer({
      id: 'assets-hit',
      type: 'circle',
      source: 'assets',
      paint: {
        'circle-radius': [
          'interpolate',
          ['linear'],
          ['zoom'],
          7, 10,
          10, 12,
          14, 14
        ],
        'circle-color': '#000000',
        'circle-opacity': 0,
        'circle-stroke-opacity': 0
      }
    });

    if (isCoarsePointer) {
      map.addLayer({
        id: 'assets-mobile-labels',
        type: 'symbol',
        source: 'assets',
        layout: {
          'text-field': ['get', 'label_name'],
          'text-font': ['Open Sans Semibold', 'Arial Unicode MS Regular'],
          'text-size': [
            'interpolate',
            ['linear'],
            ['zoom'],
            MOBILE_LABEL_MIN_ZOOM, MOBILE_LABEL_SIZE_BASE,
            13, 11.5,
            15, MOBILE_LABEL_SIZE_LARGE
          ],
          'text-anchor': 'top',
          'text-offset': [0, 1],
          'text-max-width': 12,
          'text-optional': true,
          'text-allow-overlap': false,
          'text-ignore-placement': false,
          'visibility': 'none'
        },
        paint: {
          'text-color': 'rgba(42,68,86,0.92)',
          'text-halo-color': 'rgba(244,239,230,0.96)',
          'text-halo-width': 1.15,
          'text-halo-blur': 0.5,
          'text-opacity': 0.92
        }
      });
    }

    // Hover interaction
    map.on('mousemove', 'assets-hit', (e) => {
      markMapInteracted();
      map.getCanvas().style.cursor = 'pointer';
      if (e.features.length === 0) return;
      const f = e.features[0];

      // Clear previous hover
      if (hoveredFeatureId !== null) {
        map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: false });
      }
      hoveredFeatureId = f.id;
      map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: true });
      const coords = (f.geometry && f.geometry.type === 'Point' && Array.isArray(f.geometry.coordinates))
        ? f.geometry.coordinates
        : [e.lngLat.lng, e.lngLat.lat];

      hoverPopup
        .setLngLat(coords)
        .setHTML(buildFeatureTooltipHTML(f.properties || {}))
        .addTo(map);
    });

    map.on('mouseleave', 'assets-hit', () => {
      map.getCanvas().style.cursor = '';
      if (hoveredFeatureId !== null) {
        map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: false });
        hoveredFeatureId = null;
      }
      hoverPopup.remove();
    });

    if (isCoarsePointer && map.getLayer('assets-mobile-labels')) {
      map.on('click', 'assets-mobile-labels', (e) => {
        if (!e.features || e.features.length === 0) return;
        const feature = e.features[0];
        const featureIdx = Number(feature.properties && feature.properties.idx);
        const venue = Number.isInteger(featureIdx) ? DATA[featureIdx] : null;
        if (!venue || !venue.x || !venue.y) return;
        openDetail(venue);
        map.flyTo({
          center: [venue.x, venue.y],
          zoom: Math.max(map.getZoom(), 13.2),
          pitch: Math.max(map.getPitch(), 45),
          bearing: map.getBearing(),
          duration: 620,
          essential: true
        });
      });
      map.on('mouseenter', 'assets-mobile-labels', () => { map.getCanvas().style.cursor = 'pointer'; });
      map.on('mouseleave', 'assets-mobile-labels', () => { map.getCanvas().style.cursor = ''; });
    }

    // Click interaction — mobile: instant panel; desktop: cinematic flyTo + brief tooltip
    let clickFlyId = 0;
    const isMobileClick = window.matchMedia('(max-width: 900px)').matches;
    map.on('click', 'assets-hit', (e) => {
      markMapInteracted();
      if (e.features.length === 0) return;
      const f = e.features[0];
      const featureIdx = Number(f.properties && f.properties.idx);
      const d = Number.isInteger(featureIdx) ? DATA[featureIdx] : DATA.find(item => item.n === f.properties.name);
      if (!d) return;

      cancelTour();
      hoverPopup.remove();
      const thisClick = ++clickFlyId;

      if (isMobileClick) {
        // Mobile: open detail panel immediately, fly in background
        openDetail(d);
        map.flyTo({
          center: [d.x, d.y],
          zoom: Math.max(map.getZoom(), 13),
          pitch: Math.max(map.getPitch(), 45),
          bearing: map.getBearing(),
          duration: 800,
          essential: true
        });
      } else {
        // Desktop: avoid zooming out if user is already inspecting this area
        const currentCenter = map.getCenter();
        const markerLngLat = new maplibregl.LngLat(d.x, d.y);
        const distanceMeters = currentCenter.distanceTo(markerLngLat);
        const currentZoom = map.getZoom();
        const shouldFly = distanceMeters > 220 || currentZoom < 14.5;

        if (shouldFly) {
          map.flyTo({
            center: [d.x, d.y],
            zoom: Math.max(currentZoom, 14.5),
            pitch: Math.max(map.getPitch(), 50),
            bearing: map.getBearing(),
            duration: 900,
            essential: true
          });
          map.once('moveend', () => {
            if (thisClick !== clickFlyId) return;
            showTourPopup({ data: d });
            setTimeout(() => {
              if (thisClick !== clickFlyId) return;
              openDetail(d);
              setTimeout(() => hideTourPopup(), 450);
            }, 500);
          });
        } else {
          showTourPopup({ data: d });
          setTimeout(() => {
            if (thisClick !== clickFlyId) return;
            openDetail(d);
            setTimeout(() => hideTourPopup(), 420);
          }, 250);
        }
      }
    });

    map.on('dragstart', markMapInteracted);
    map.on('zoomstart', markMapInteracted);
    map.on('rotatestart', markMapInteracted);
    map.on('pitchstart', markMapInteracted);
    map.on('move', scheduleSmartLabelUpdate);
    map.on('pitch', scheduleSmartLabelUpdate);
    map.on('rotate', scheduleSmartLabelUpdate);
    map.on('resize', scheduleSmartLabelUpdate);
    const refreshLabels = () => {
      updateMapProgressiveLabels();
      updateMobileLabelLayerVisibility();
    };
    map.on('moveend', refreshLabels);
    map.on('zoomend', refreshLabels);
    map.on('idle', refreshLabels);
    map.getCanvas().addEventListener('wheel', markMapInteracted, { passive: true });
    map.getCanvas().addEventListener('mousedown', markMapInteracted);
    map.getCanvas().addEventListener('touchstart', markMapInteracted, { passive: true });

    // Apply initial filter if any
    updateMapFilters();
    refreshLabels();
    scheduleIdlePreview();
  }

  function applyMapVisualState() {
    if (!map.getLayer('assets-circle') || activeExperience) return;
    const hasCategoryFilter = activeCategories.size > 0;
    const baseRadius = hasCategoryFilter ? 7 : 5;
    const hoverRadius = hasCategoryFilter ? 10 : 8;

    if (openNowMode) {
      map.setPaintProperty('assets-circle', 'circle-radius', [
        'case',
        ['boolean', ['feature-state', 'hover'], false], hoverRadius,
        ['==', ['get', 'hours_state'], 'open'], baseRadius + 1.6,
        Math.max(baseRadius - 0.8, 3.8)
      ]);
      map.setPaintProperty('assets-circle', 'circle-color', [
        'case',
        ['==', ['get', 'hours_state'], 'open'], ['get', 'color'],
        'rgba(26,22,18,0.16)'
      ]);
      map.setPaintProperty('assets-circle', 'circle-opacity', [
        'case',
        ['==', ['get', 'hours_state'], 'open'], 0.96,
        0.34
      ]);
      map.setPaintProperty('assets-circle', 'circle-stroke-color', [
        'case',
        ['==', ['get', 'hours_state'], 'open'], '#2fa35b',
        'rgba(26,22,18,0.55)'
      ]);
      map.setPaintProperty('assets-circle', 'circle-stroke-width', [
        'case',
        ['==', ['get', 'hours_state'], 'open'], 2.8,
        1.15
      ]);
      map.setPaintProperty('assets-circle', 'circle-stroke-opacity', [
        'case',
        ['==', ['get', 'hours_state'], 'open'], 1,
        0.62
      ]);
      if (map.getLayer('assets-mobile-labels')) {
        map.setPaintProperty('assets-mobile-labels', 'text-opacity', [
          'case',
          ['==', ['get', 'hours_state'], 'open'], 0.95,
          0.42
        ]);
      }
      return;
    }

    map.setPaintProperty('assets-circle', 'circle-radius', [
      'case',
      ['boolean', ['feature-state', 'hover'], false], hoverRadius,
      baseRadius
    ]);
    map.setPaintProperty('assets-circle', 'circle-color', ['get', 'color']);
    map.setPaintProperty('assets-circle', 'circle-opacity', 0.85);
    map.setPaintProperty('assets-circle', 'circle-stroke-color', 'rgba(255,255,255,0.6)');
    map.setPaintProperty('assets-circle', 'circle-stroke-width', 1.5);
    map.setPaintProperty('assets-circle', 'circle-stroke-opacity', 1);
    if (map.getLayer('assets-mobile-labels')) {
      map.setPaintProperty('assets-mobile-labels', 'text-opacity', 0.92);
    }
  }

  function updateMapFilters(options = {}) {
    const { recenter = false } = options;
    if (!map.getLayer('assets-circle')) return;
    const openNowExpr = ['!=', ['get', 'hours_state'], 'closed'];
    const eventsExpr = ['==', ['get', 'has_events_14d'], true];
    const clauses = [];

    if (activeCategories.size > 0) {
      const selected = Array.from(activeCategories);
      const categoryExpr =
        selected.length === 1
          ? ['==', ['get', 'layer'], selected[0]]
          : ['in', ['get', 'layer'], ['literal', selected]];
      clauses.push(categoryExpr);
    }
    if (openNowMode) clauses.push(openNowExpr);
    if (events14dMode) clauses.push(eventsExpr);

    const combinedExpr = clauses.length === 0
      ? null
      : (clauses.length === 1 ? clauses[0] : ['all', ...clauses]);

    map.setFilter('assets-circle', combinedExpr);
    if (map.getLayer('assets-hit')) {
      map.setFilter('assets-hit', combinedExpr);
    }
    if (map.getLayer('assets-mobile-labels')) {
      map.setFilter('assets-mobile-labels', combinedExpr);
    }
    applyMapVisualState();

    if (recenter) {
      const filtered = DATA.filter((d, idx) => {
        const categoryOk = activeCategories.size === 0 || activeCategories.has(d.l);
        const openOk = !openNowMode || getHoursState(d) !== 'closed';
        const eventsOk = !events14dMode || getEventCountForAsset14d(idx) > 0;
        return categoryOk && openOk && eventsOk && d.x && d.y;
      });
      if (filtered.length) {
        const bounds = filtered.reduce((b, d) => b.extend([d.x, d.y]),
          new maplibregl.LngLatBounds([filtered[0].x, filtered[0].y], [filtered[0].x, filtered[0].y])
        );
        map.fitBounds(bounds, { padding: 50, maxZoom: 14 });
      } else if (activeCategories.size === 0 && !openNowMode && !events14dMode) {
        map.flyTo({ center: [-120.8, 39.22], zoom: 9, pitch: 0, bearing: 0, duration: 1000 });
      }
    }

    if (!recenter) {
      updateMapProgressiveLabels();
    }
    updateMobileLabelLayerVisibility();
  }

  // ============================================================
  // EXPERIENCE SYSTEM (Steps 4 + 5 + 6)
  // ============================================================
  function activateExperience(experience) {
    activeExperience = experience;
    clearMapLabelStates();
    updateMobileLabelLayerVisibility();
    const guidesSection = document.getElementById('mapGuides');
    const corridorSection = document.getElementById('corridorAddon');
    const exploreSection = document.getElementById('experienceAddon');
    if (guidesSection) guidesSection.open = true;
    if (experience.type === 'corridor') {
      if (corridorSection) corridorSection.open = true;
    } else if (exploreSection) {
      exploreSection.open = true;
    }

    const resolved = resolveStops(experience);
    if (!resolved.length) return;
    currentResolvedStops = resolved;

    // Update selector UI
    document.querySelectorAll('.experience-card').forEach(c => {
      c.classList.toggle('active', c.dataset.slug === experience.slug);
    });

    // Pulse active card dot via GSAP
    if (dotPulseTween) dotPulseTween.kill();
    const activeDot = document.querySelector(`.experience-card.active .experience-card-dot`);
    if (activeDot) {
      dotPulseTween = gsap.to(activeDot, {
        boxShadow: `0 0 14px ${experience.color}`,
        scale: 1.2,
        duration: 0.7,
        yoyo: true,
        repeat: -1,
        ease: 'sine.inOut'
      });
    }

    // Apply theme if present
    if (experience.theme) applyTheme(experience.theme, experience.color);

    // Dim all asset markers
    if (map.getLayer('assets-circle')) {
      map.setPaintProperty('assets-circle', 'circle-opacity', 0.12);
      map.setPaintProperty('assets-circle', 'circle-stroke-opacity', 0.08);
      map.setPaintProperty('assets-circle', 'circle-radius', 3);
    }

    // Clear previous corridor layers
    clearCorridorLayers();

    // Build route coordinates
    const routeCoords = resolved.map(s => [s.data.x, s.data.y]);
    const routeColor = experience.theme ? experience.theme.routeColor : experience.color;
    const accentColor = experience.theme ? experience.theme.accent : experience.color;

    // Add glow route (static)
    map.addSource('corridor-route-glow', {
      type: 'geojson',
      data: { type: 'Feature', geometry: { type: 'LineString', coordinates: routeCoords } }
    });
    map.addLayer({
      id: 'corridor-route-glow',
      type: 'line',
      source: 'corridor-route-glow',
      paint: {
        'line-color': routeColor,
        'line-width': 10,
        'line-opacity': 0.12,
        'line-blur': 8
      }
    });

    // Add animated route (progressive reveal via Turf)
    map.addSource('corridor-route-animated', {
      type: 'geojson',
      data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [routeCoords[0]] } }
    });
    map.addLayer({
      id: 'corridor-route-animated',
      type: 'line',
      source: 'corridor-route-animated',
      paint: {
        'line-color': routeColor,
        'line-width': 3,
        'line-opacity': 0.75,
        'line-dasharray': [2, 3]
      }
    });

    // Animate route drawing
    animateRoute(routeCoords, 2500);

    // Add stop circle layers
    const stopsGeoJSON = {
      type: 'FeatureCollection',
      features: resolved.map(s => ({
        type: 'Feature',
        properties: { order: s.order, name: s.data.n },
        geometry: { type: 'Point', coordinates: [s.data.x, s.data.y] }
      }))
    };

    map.addSource('corridor-stops', { type: 'geojson', data: stopsGeoJSON });

    // Glow ring
    map.addLayer({
      id: 'corridor-stops-glow',
      type: 'circle',
      source: 'corridor-stops',
      paint: {
        'circle-radius': 18,
        'circle-color': accentColor,
        'circle-opacity': 0.08
      }
    });

    // Main stop dot
    map.addLayer({
      id: 'corridor-stops-main',
      type: 'circle',
      source: 'corridor-stops',
      paint: {
        'circle-radius': 8,
        'circle-color': accentColor,
        'circle-opacity': 0.9,
        'circle-stroke-color': '#ffffff',
        'circle-stroke-width': 2
      }
    });

    // Add numbered badges as WebGL symbol layer (no DOM lag)
    map.addLayer({
      id: 'corridor-stops-labels',
      type: 'symbol',
      source: 'corridor-stops',
      layout: {
        'text-field': ['to-string', ['get', 'order']],
        'text-size': 11,
        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
        'text-allow-overlap': true,
        'text-ignore-placement': true,
        'text-anchor': 'center'
      },
      paint: {
        'text-color': '#ffffff',
        'text-halo-color': accentColor,
        'text-halo-width': 8,
        'text-halo-blur': 0
      }
    });

    // Click handler for stop labels
    map.on('click', 'corridor-stops-labels', (e) => {
      if (e.features && e.features[0]) {
        const name = e.features[0].properties.name;
        const match = DATA.find(d => d.n === name);
        if (match) openDetail(match);
      }
    });
    map.on('mouseenter', 'corridor-stops-labels', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'corridor-stops-labels', () => { map.getCanvas().style.cursor = ''; });

    // Build corridor info panel
    buildCorridorPanel(experience, resolved);

    // Fit map to corridor bounds with cinematic pitch
    const bounds = resolved.reduce((b, s) => b.extend([s.data.x, s.data.y]),
      new maplibregl.LngLatBounds([resolved[0].data.x, resolved[0].data.y], [resolved[0].data.x, resolved[0].data.y])
    );
    map.fitBounds(bounds, { padding: 80, maxZoom: 13, pitch: 30, duration: 2000 });
  }

  function animateRoute(coordinates, duration) {
    if (coordinates.length < 2) return;
    const line = turf.lineString(coordinates);
    const totalLength = turf.length(line, { units: 'kilometers' });
    if (totalLength === 0) return;

    const startTime = performance.now();

    function tick(timestamp) {
      const elapsed = timestamp - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic

      const currentLength = Math.max(totalLength * eased, 0.001);
      try {
        const sliced = turf.lineSliceAlong(line, 0, currentLength, { units: 'kilometers' });
        if (map.getSource('corridor-route-animated')) {
          map.getSource('corridor-route-animated').setData(sliced);
        }
      } catch (e) { /* turf edge case */ }

      if (progress < 1) {
        routeAnimationId = requestAnimationFrame(tick);
      }
    }

    routeAnimationId = requestAnimationFrame(tick);
  }

  // Tour popup (shown at each stop during auto-tour)
  let tourPopup = null;

  function showTourPopup(stop) {
    if (!tourPopup) {
      tourPopup = new maplibregl.Popup({ closeButton: false, closeOnClick: false, offset: 15, maxWidth: '260px' });
    }
    const d = stop.data;
    const cfg = CATS[d.l] || { color: '#999' };
    const imgInfo = IMAGE_DATA[d.n];
    const wcSlug = cfg.watercolor || 'landmarks';
    const imgHTML = imgInfo
      ? `<img class="tooltip-img" src="${imgInfo.img}" alt="${imgInfo.alt || d.n}" onerror="this.parentNode.removeChild(this)">`
      : `<div class="tooltip-placeholder" style="background:linear-gradient(135deg, ${cfg.color}, ${cfg.color}dd)"><img src="img/watercolor/${wcSlug}.png" class="tooltip-watercolor" alt="" onerror="this.style.display='none'"></div>`;
    const stopNum = stop.index != null ? `<span style="background:${cfg.color};color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;margin-right:0.3rem;">${stop.index + 1}</span>` : '';
    tourPopup
      .setLngLat([d.x, d.y])
      .setHTML(`${imgHTML}<div class="tooltip-body"><strong>${stopNum}${d.n}</strong><div class="tooltip-cat"><span class="tooltip-cat-dot" style="background:${cfg.color}"></span>${d.l}</div>${d.c ? '<div class="tooltip-city">' + d.c + ', CA</div>' : ''}</div>`)
      .addTo(map);
  }

  function hideTourPopup() {
    if (tourPopup) tourPopup.remove();
  }

  // Cinematic flyTo for stops
  function flyToStop(stop, index) {
    const resolved = currentResolvedStops;
    let bearing = 0;

    // Calculate bearing toward next stop
    if (index < resolved.length - 1) {
      const next = resolved[index + 1];
      bearing = turf.bearing(
        turf.point([stop.data.x, stop.data.y]),
        turf.point([next.data.x, next.data.y])
      );
    } else if (index > 0) {
      const prev = resolved[index - 1];
      bearing = turf.bearing(
        turf.point([prev.data.x, prev.data.y]),
        turf.point([stop.data.x, stop.data.y])
      );
    }

    const mobile = window.matchMedia('(max-width: 900px)').matches;
    map.flyTo({
      center: [stop.data.x, stop.data.y],
      zoom: mobile ? 13 : 14.5,
      pitch: mobile ? 45 : 55,
      bearing: bearing,
      duration: mobile ? 1200 : 2000,
      essential: true
    });
  }

  // Auto-tour
  async function autoTour(resolved) {
    // Cancel any existing tour
    cancelTour();

    const tourBtn = document.querySelector('.corridor-tour-btn');
    if (tourBtn) tourBtn.classList.add('touring');

    for (let i = 0; i < resolved.length; i++) {
      hideTourPopup();
      const stop = resolved[i];
      stop.index = i;
      flyToStop(stop, i);

      // Wait for the camera to arrive, then show tooltip
      await new Promise(r => {
        const onEnd = () => {
          map.off('moveend', onEnd);
          activeMoveendHandler = null;  // Clear reference
          r();
        };
        activeMoveendHandler = onEnd;  // Store reference
        map.on('moveend', onEnd);
        // Safety timeout in case moveend doesn't fire
        const mobile = window.matchMedia('(max-width: 900px)').matches;
        const tid = setTimeout(() => {
          map.off('moveend', onEnd);
          activeMoveendHandler = null;  // Clear reference
          r();
        }, mobile ? 2000 : 4000);
        tourTimeouts.push(tid);
      });

      showTourPopup(stop);

      // Dwell at the stop with tooltip visible
      await new Promise(r => {
        const mobile = window.matchMedia('(max-width: 900px)').matches;
        const tid = setTimeout(r, mobile ? 1500 : 2500);
        tourTimeouts.push(tid);
      });
    }

    hideTourPopup();

    // Zoom out to show full corridor
    const bounds = resolved.reduce((b, s) => b.extend([s.data.x, s.data.y]),
      new maplibregl.LngLatBounds([resolved[0].data.x, resolved[0].data.y], [resolved[0].data.x, resolved[0].data.y])
    );
    map.fitBounds(bounds, { padding: 60, pitch: 30, duration: 2000 });

    if (tourBtn) tourBtn.classList.remove('touring');
  }

  function cancelTour() {
    tourTimeouts.forEach(t => clearTimeout(t));
    tourTimeouts = [];
    hideTourPopup();

    // CRITICAL: Remove any active moveend listener
    if (activeMoveendHandler) {
      map.off('moveend', activeMoveendHandler);
      activeMoveendHandler = null;
    }

    const tourBtn = document.querySelector('.corridor-tour-btn');
    if (tourBtn) tourBtn.classList.remove('touring');
  }

  function deactivateExperience() {
    activeExperience = null;
    currentResolvedStops = [];
    cancelTour();

    // Update selector UI
    document.querySelectorAll('.experience-card').forEach(c => c.classList.remove('active'));

    // Kill pulse
    if (dotPulseTween) { dotPulseTween.kill(); dotPulseTween = null; }
    document.querySelectorAll('.experience-card-dot').forEach(d => {
      gsap.set(d, { clearProps: 'all' });
    });

    // Remove theme
    removeTheme();

    // Remove corridor layers
    clearCorridorLayers();

    // Hide panel with GSAP
    const panel = document.getElementById('corridorPanel');
    gsap.to(panel, {
      opacity: 0, y: 12, duration: 0.3,
      onComplete: () => {
        panel.classList.remove('visible');
        panel.style.cssText = '';
      }
    });

    // Restore asset markers
    if (map.getLayer('assets-circle')) {
      map.setPaintProperty('assets-circle', 'circle-opacity', 0.85);
      map.setPaintProperty('assets-circle', 'circle-stroke-opacity', 1);
      updateMapFilters();
      updateMapProgressiveLabels();
      updateMobileLabelLayerVisibility();
    }
  }

  function clearCorridorLayers() {
    // Cancel route animation
    if (routeAnimationId) { cancelAnimationFrame(routeAnimationId); routeAnimationId = null; }

    // Remove MapLibre layers and sources
    ['corridor-route-glow', 'corridor-route-animated', 'corridor-stops-labels', 'corridor-stops-glow', 'corridor-stops-main'].forEach(id => {
      if (map.getLayer(id)) map.removeLayer(id);
    });
    ['corridor-route-glow', 'corridor-route-animated', 'corridor-stops'].forEach(id => {
      if (map.getSource(id)) map.removeSource(id);
    });
  }

  // ============================================================
  // THEME SWITCHING (Step 7)
  // ============================================================
  function applyTheme(theme, fallbackColor) {
    const root = document.documentElement;
    root.style.setProperty('--theme-accent', theme.accent || fallbackColor);
    root.style.setProperty('--theme-route', theme.routeColor || fallbackColor);

    // MapLibre basemap paint manipulation — warm the map tiles
    if (theme.basemap === 'terrain' && MAPTILER_KEY !== 'GET_YOUR_FREE_KEY_AT_MAPTILER_COM') {
      try {
        const layers = map.getStyle().layers || [];
        layers.forEach(layer => {
          if (layer.id === 'background' || layer.id.includes('land') || layer.id.includes('earth')) {
            if (layer.type === 'background') {
              map.setPaintProperty(layer.id, 'background-color', theme.background || '#f2ece4');
            } else if (layer.type === 'fill') {
              map.setPaintProperty(layer.id, 'fill-color', theme.background || '#f2ece4');
            }
          }
          if (layer.id.includes('water') && layer.type === 'fill') {
            map.setPaintProperty(layer.id, 'fill-color', '#b8d4e3');
          }
          if (layer.type === 'symbol') {
            try { map.setPaintProperty(layer.id, 'text-color', theme.text || '#2c2c2c'); } catch (e) {}
          }
        });
      } catch (e) { /* style manipulation error */ }
    }

    // Add subtle teal tint to map section to signal corridor mode
    const mapSection = document.getElementById('mapSection');
    const accentColor = theme.accent || fallbackColor;
    mapSection.style.background = hexToRgba(accentColor, 0.06);
    mapSection.classList.add('themed');
  }

  function removeTheme() {
    const root = document.documentElement;
    root.style.removeProperty('--theme-accent');
    root.style.removeProperty('--theme-route');

    // Restore MapLibre basemap
    if (MAPTILER_KEY !== 'GET_YOUR_FREE_KEY_AT_MAPTILER_COM') {
      try {
        const layers = map.getStyle().layers || [];
        layers.forEach(layer => {
          if (originalPaintValues[layer.id]) {
            const orig = originalPaintValues[layer.id];
            if (layer.type === 'background' && orig['background-color']) {
              map.setPaintProperty(layer.id, 'background-color', orig['background-color']);
            }
            if (layer.type === 'fill' && orig['fill-color']) {
              map.setPaintProperty(layer.id, 'fill-color', orig['fill-color']);
            }
            if (layer.type === 'symbol' && orig['text-color']) {
              try { map.setPaintProperty(layer.id, 'text-color', orig['text-color']); } catch (e) {}
            }
          }
        });
      } catch (e) { /* style manipulation error */ }
    }

    // Restore DOM
    document.getElementById('mapSection').style.background = '';
    document.getElementById('mapSection').classList.remove('themed');
  }

  // ============================================================
  // CORRIDOR INFO PANEL (GSAP animated)
  // ============================================================
  function buildCorridorPanel(experience, resolved) {
    const panel = document.getElementById('corridorPanel');
    const accentColor = experience.theme ? experience.theme.accent : experience.color;

    let stopsHTML = '';
    resolved.forEach((stop, i) => {
      stopsHTML += `
        <div class="corridor-stop" data-stop-idx="${i}">
          <div class="corridor-stop-num" style="background:${accentColor};color:#fff;">${stop.order}</div>
          <div class="corridor-stop-info">
            <div class="corridor-stop-name">${stop.data.n}</div>
            <div class="corridor-stop-note">${stop.note}</div>
          </div>
        </div>
      `;
      if (stop.connector && i < resolved.length - 1) {
        stopsHTML += `<div class="corridor-connector" style="color:${hexToRgba(accentColor, 0.4)}">${stop.connector}</div>`;
      }
    });

    panel.innerHTML = `
      <div class="corridor-panel-header">
        <div class="corridor-panel-eyebrow" style="color:${accentColor}">Curated Experience &bull; ${resolved.length} stops</div>
        <div class="corridor-panel-title">${experience.title}</div>
        <button class="corridor-tour-btn">&#9654; Tour</button>
        <div class="corridor-panel-desc">${experience.description}</div>
      </div>
      <div class="corridor-panel-stops">${stopsHTML}</div>
    `;

    // Bind stop clicks to cinematic flyTo
    panel.querySelectorAll('.corridor-stop').forEach(el => {
      el.addEventListener('click', () => {
        const idx = parseInt(el.dataset.stopIdx);
        const stop = resolved[idx];
        if (stop && stop.data) {
          flyToStop(stop, idx);
        }
      });
    });

    // Bind tour button
    const tourBtn = panel.querySelector('.corridor-tour-btn');
    if (tourBtn) {
      tourBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (tourBtn.classList.contains('touring')) {
          cancelTour();
        } else {
          autoTour(resolved);
        }
      });
    }

    // GSAP panel entrance
    panel.classList.add('visible');
    gsap.fromTo(panel,
      { opacity: 0, y: 20 },
      { opacity: 1, y: 0, duration: 0.5, ease: 'power3.out' }
    );

    // Stagger stop items
    gsap.fromTo('.corridor-stop',
      { opacity: 0, x: -10 },
      { opacity: 1, x: 0, duration: 0.3, stagger: 0.06, ease: 'power2.out', delay: 0.3 }
    );
  }

  // ============================================================
  // CATEGORY GRID
  // ============================================================
  function buildCategoryGrid() {
    const grid = document.getElementById('categoryGrid');
    const counts = {};
    DATA.forEach(d => { counts[d.l] = (counts[d.l] || 0) + 1; });

    const sorted = Object.entries(CATS).sort((a, b) => (counts[b[0]] || 0) - (counts[a[0]] || 0));

    sorted.forEach(([name, cfg]) => {
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.dataset.category = name;
      card.style.setProperty('--cat-color', cfg.color);
      const wcSlug = cfg.watercolor || 'landmarks';
      card.innerHTML = `
        <div class="cat-icon" style="background:${hexToRgba(cfg.color, 0.1)}; color:${cfg.color}">
          <img src="img/watercolor/${wcSlug}.png" alt="" class="cat-icon-watercolor" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
          <span class="cat-icon-svg" style="display:none">${ICONS[name] || ''}</span>
        </div>
        <div class="cat-card-info">
          <div class="cat-card-count">${counts[name] || 0}</div>
          <div class="cat-card-name">${name}</div>
          <div class="cat-card-active-label">Filtered</div>
        </div>
      `;
      card.addEventListener('click', () => {
        setCategory(name);
        document.getElementById('mapSection').scrollIntoView({ behavior: 'smooth' });
      });
      grid.appendChild(card);
      cardElements.push({ el: card, name });
    });
  }

  // ============================================================
  // FILTER BAR
  // ============================================================
  function buildFilterBar() {
    const bar = document.getElementById('filterBar');
    bar.innerHTML = '';

    const categoryGroup = document.createElement('div');
    categoryGroup.className = 'map-filter-group category-group';
    const categoryLabel = document.createElement('span');
    categoryLabel.className = 'map-filter-group-label';
    categoryLabel.textContent = 'Categories';
    categoryGroup.appendChild(categoryLabel);

    const allPill = document.createElement('button');
    allPill.className = 'filter-pill all-pill active';
    allPill.textContent = 'All';
    allPill.addEventListener('click', () => setCategory(null));
    categoryGroup.appendChild(allPill);

    Object.entries(CATS).forEach(([name, cfg]) => {
      const pill = document.createElement('button');
      pill.className = 'filter-pill';
      pill.dataset.category = name;
      pill.style.setProperty('--pill-color', cfg.color);
      pill.innerHTML = `<span class="filter-dot" style="background:${cfg.color}"></span>${cfg.short}`;
      pill.addEventListener('click', () => setCategory(name));
      categoryGroup.appendChild(pill);
    });
    bar.appendChild(categoryGroup);

    const statusGroup = document.createElement('div');
    statusGroup.className = 'map-filter-group status-group';
    const statusLabel = document.createElement('span');
    statusLabel.className = 'map-filter-group-label';
    statusLabel.textContent = 'Status';
    statusGroup.appendChild(statusLabel);

    const openNowPill = document.createElement('button');
    openNowPill.id = 'openNowPill';
    openNowPill.className = 'filter-pill open-now-pill';
    openNowPill.style.setProperty('--pill-color', '#2fa35b');
    openNowPill.innerHTML = '<span class="status-toggle-indicator" aria-hidden="true"></span><span class="status-icon" aria-hidden="true">◷</span><span class="status-text">Open now mode</span><span class="status-state-badge" id="openNowStateBadge">Off</span>';
    openNowPill.addEventListener('click', () => setOpenNowMode(!openNowMode));
    statusGroup.appendChild(openNowPill);

    const eventsPill = document.createElement('button');
    eventsPill.id = 'events14dPill';
    eventsPill.className = 'filter-pill events-pill';
    eventsPill.style.setProperty('--pill-color', '#b4581d');
    eventsPill.innerHTML = '<span class="status-toggle-indicator" aria-hidden="true"></span><span class="status-icon" aria-hidden="true">◫</span><span class="status-text">Events (14d)</span><span class="status-state-badge" id="events14dStateBadge">Off</span>';
    eventsPill.addEventListener('click', () => setEvents14dMode(!events14dMode));
    statusGroup.appendChild(eventsPill);

    const legend = document.createElement('div');
    legend.className = 'hours-legend';
    legend.id = 'hoursLegend';
    legend.innerHTML = `
      <span class="hours-legend-item"><span class="hours-legend-dot open"></span>Open</span>
      <span class="hours-legend-item"><span class="hours-legend-dot unknown"></span>Unknown</span>
    `;
    statusGroup.appendChild(legend);
    bar.appendChild(statusGroup);

    renderOpenNowUI();
    renderEvents14dUI();
    syncMapFilterToggleMeta();
  }

  function buildMapLegend() {
    const panel = document.getElementById('mapLegendPanel');
    if (!panel) return;
    panel.innerHTML = '';
    Object.entries(CATS).forEach(([name, cfg]) => {
      const item = document.createElement('div');
      item.className = 'map-legend-item';
      item.innerHTML = `<span class="map-legend-swatch" style="background:${cfg.color}"></span><span>${cfg.short || name}</span>`;
      panel.appendChild(item);
    });
  }

  function setMapFiltersExpanded(expanded) {
    mapFiltersExpanded = !!expanded;
    const overlay = document.querySelector('.map-overlay-controls');
    const toggle = document.getElementById('mapFilterToggle');
    if (overlay) overlay.classList.toggle('expanded', mapFiltersExpanded);
    if (toggle) toggle.setAttribute('aria-expanded', mapFiltersExpanded ? 'true' : 'false');
  }

  function setMapLegendExpanded(expanded) {
    mapLegendExpanded = !!expanded;
    const overlay = document.querySelector('.map-overlay-controls');
    const toggle = document.getElementById('mapLegendToggle');
    if (overlay) overlay.classList.toggle('legend-expanded', mapLegendExpanded);
    if (toggle) toggle.setAttribute('aria-expanded', mapLegendExpanded ? 'true' : 'false');
  }

  function syncMapFilterToggleMeta() {
    const meta = document.getElementById('mapFilterToggleMeta');
    if (!meta) return;
    const parts = [];
    if (activeCategories.size > 0) {
      const selected = Array.from(activeCategories);
      if (selected.length === 1) {
        const cfg = CATS[selected[0]];
        parts.push((cfg && cfg.short) ? cfg.short : selected[0]);
      } else {
        parts.push(`${selected.length} cats`);
      }
    } else {
      parts.push('All');
    }
    if (openNowMode) parts.push('Open');
    if (events14dMode) parts.push('Events');
    meta.textContent = parts.join(' • ');
  }

  function renderOpenNowUI() {
    const openNowPill = document.getElementById('openNowPill');
    const openNowStateBadge = document.getElementById('openNowStateBadge');
    const legend = document.getElementById('hoursLegend');
    if (openNowPill) {
      openNowPill.classList.toggle('active', openNowMode);
      openNowPill.setAttribute('aria-pressed', openNowMode ? 'true' : 'false');
      openNowPill.setAttribute('aria-label', openNowMode ? 'Disable open now status mode' : 'Enable open now status mode');
      openNowPill.setAttribute('title', openNowMode ? 'Click to disable open now status mode' : 'Click to enable open now status mode');
    }
    if (openNowStateBadge) {
      openNowStateBadge.textContent = openNowMode ? 'On' : 'Off';
    }
    if (legend) legend.classList.toggle('visible', openNowMode);
    syncMapFilterToggleMeta();
  }

  function renderEvents14dUI() {
    const eventsPill = document.getElementById('events14dPill');
    const eventsStateBadge = document.getElementById('events14dStateBadge');
    if (eventsPill) {
      eventsPill.classList.toggle('active', events14dMode);
      eventsPill.setAttribute('aria-pressed', events14dMode ? 'true' : 'false');
      eventsPill.setAttribute('aria-label', events14dMode ? 'Disable events-in-14-days mode' : 'Enable events-in-14-days mode');
      eventsPill.setAttribute('title', events14dMode ? 'Click to disable events-in-14-days mode' : 'Click to enable events-in-14-days mode');
    }
    if (eventsStateBadge) {
      eventsStateBadge.textContent = events14dMode ? 'On' : 'Off';
    }
    syncMapFilterToggleMeta();
  }

  function setOpenNowMode(enabled) {
    markMapInteracted();
    openNowMode = !!enabled;
    if (openNowMode) refreshAssetSourceHoursStates();
    renderOpenNowUI();
    updateActiveBanner();
    updateMapFilters({ recenter: false });
    listPage = 0;
    buildList();
  }

  function setEvents14dMode(enabled) {
    markMapInteracted();
    events14dMode = !!enabled;
    renderEvents14dUI();
    updateActiveBanner();
    updateMapFilters({ recenter: false });
    listPage = 0;
    buildList();
  }

  // ============================================================
  // ACTIVE BANNER
  // ============================================================
  function updateActiveBanner() {
    const banner = document.getElementById('mapActiveBanner');
    if (activeCategories.size > 0 || openNowMode || events14dMode) {
      const selected = Array.from(activeCategories);
      const count = DATA.filter((d) => {
        const idx = DATA.indexOf(d);
        const categoryOk = activeCategories.size === 0 || activeCategories.has(d.l);
        const openOk = !openNowMode || getHoursState(d) !== 'closed';
        const eventsOk = !events14dMode || getEventCountForAsset14d(idx) > 0;
        return categoryOk && openOk && eventsOk;
      }).length;
      const oneCategory = selected.length === 1 ? selected[0] : null;
      const cfg = oneCategory ? (CATS[oneCategory] || {}) : null;
      document.getElementById('mapActiveDot').style.background = oneCategory ? cfg.color : 'rgba(26,22,18,0.55)';
      document.getElementById('mapActiveCount').textContent = count;
      const label = oneCategory || (selected.length > 1 ? `${selected.length} categories` : (events14dMode ? 'venues with events' : 'all assets'));
      document.getElementById('mapActiveName').textContent = label;
      banner.classList.add('visible');
    } else {
      banner.classList.remove('visible');
    }
  }

  // ============================================================
  // SET CATEGORY
  // ============================================================
  function setCategory(cat, options = {}) {
    markMapInteracted();
    const { exclusive = false } = options;
    if (cat === null) {
      activeCategories.clear();
    } else if (exclusive) {
      activeCategories = new Set([cat]);
    } else if (activeCategories.has(cat)) {
      activeCategories.delete(cat);
    } else {
      activeCategories.add(cat);
    }

    document.querySelectorAll('.filter-pill').forEach(p => {
      if (p.classList.contains('open-now-pill') || p.classList.contains('events-pill')) return;
      if (p.classList.contains('all-pill')) {
        p.classList.toggle('active', activeCategories.size === 0);
      } else {
        p.classList.toggle('active', activeCategories.has(p.dataset.category));
      }
    });

    cardElements.forEach(({ el, name }) => {
      const isActive = activeCategories.has(name);
      el.classList.toggle('active', isActive);
      if (activeCategories.size > 0 && !isActive) {
        el.style.opacity = '0.45';
      } else {
        el.style.opacity = '1';
      }
    });

    renderOpenNowUI();
    updateActiveBanner();
    updateMapFilters();
    listPage = 0;
    eventsListPage = 0;
    buildList();
    buildMapEventsList();
  }

  // ============================================================
  // DETAIL PANEL (GSAP animated)
  // ============================================================
  function openDetail(d) {
    const panel = document.getElementById('detailPanel');
    const overlay = document.getElementById('panelOverlay');
    const cfg = CATS[d.l] || { color: '#999' };

    document.getElementById('detailCatBar').style.background = cfg.color;

    const heroEl = document.getElementById('detailHero');
    const imgInfo = IMAGE_DATA[d.n];
    const wcSlug = cfg.watercolor || 'landmarks';
    if (imgInfo) {
      heroEl.innerHTML = `<img class="detail-hero-img" src="${imgInfo.img}" alt="${imgInfo.alt || d.n}" onerror="this.parentNode.innerHTML='<div class=\\'detail-hero-placeholder\\' style=\\'background:linear-gradient(135deg, ${cfg.color}40, ${cfg.color}20)\\'><img src=\\'img/watercolor/${wcSlug}.png\\' class=\\'detail-hero-watercolor\\' alt=\\'\\'></div>'">`;
    } else {
      heroEl.innerHTML = `<div class="detail-hero-placeholder" style="background:linear-gradient(135deg, ${cfg.color}40, ${cfg.color}20)"><img src="img/watercolor/${wcSlug}.png" class="detail-hero-watercolor" alt="" onerror="this.style.display='none'"></div>`;
    }

    document.getElementById('detailTag').innerHTML = `<span style="display:inline-flex;align-items:center;gap:0.4rem;">${ICONS[d.l] ? '<span style="width:14px;height:14px;display:inline-block;vertical-align:middle;">' + ICONS[d.l] + '</span>' : ''} ${d.l}</span>`;
    document.getElementById('detailTag').style.color = cfg.color;

    // "In X Experiences" badge
    const expBadge = document.getElementById('detailExpBadge');
    const matchingExps = EXPERIENCES.filter(exp => exp.stops.some(s => s.asset === d.n));
    if (matchingExps.length > 0) {
      expBadge.innerHTML = matchingExps.map(exp => {
        const expColor = exp.theme ? exp.theme.accent : exp.color;
        return `<span class="detail-exp-pill" style="color:${expColor}" data-exp-slug="${exp.slug}"><span class="detail-exp-pill-dot" style="background:${expColor}"></span>${exp.title}</span>`;
      }).join('');
      expBadge.querySelectorAll('.detail-exp-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          closeDetail();
          const slug = pill.dataset.expSlug;
          const exp = EXPERIENCES.find(e => e.slug === slug);
          if (exp) {
            activateExperience(exp);
            document.getElementById('mapSection').scrollIntoView({ behavior: 'smooth' });
          }
        });
      });
    } else {
      expBadge.innerHTML = '';
    }

    document.getElementById('detailName').textContent = d.n;
    document.getElementById('detailDesc').textContent = d.d || 'No description available.';
    document.getElementById('detailDesc').style.display = d.d ? 'block' : 'none';

    let metaHTML = '';
    const hoursState = getHoursState(d);
    const todayHours = getTodayHoursDisplay(d);
    const assetIdx = resolveAssetIndex(d);
    const eventCount14d = Number.isInteger(assetIdx) ? getEventCountForAsset14d(assetIdx) : 0;
    metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9716;</span><div class="detail-meta-value"><span class="hours-pill hours-${hoursState}">${getHoursLabel(hoursState)}</span>${todayHours ? `<div class="detail-hours-today">Today: ${escapeHTML(todayHours)}</div>` : ''}</div></div>`;
    if (eventCount14d > 0) {
      metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9680;</span><div class="detail-meta-value"><span class="hours-pill" style="color:#934512;background:rgba(180,88,29,0.12);border-color:rgba(180,88,29,0.48)">${eventCount14d} event${eventCount14d === 1 ? '' : 's'} in ${EVENT_WINDOW_DAYS}d</span></div></div>`;
    }
    if (d.a) metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9675;</span><div class="detail-meta-value">${d.a}${d.c ? ', ' + d.c + ', CA' : ''}</div></div>`;
    if (d.p) metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9743;</span><div class="detail-meta-value"><a href="tel:${d.p}">${d.p}</a></div></div>`;
    if (d.w) {
      let url = d.w.trim();
      if (!url.startsWith('http')) url = 'https://' + url;
      const display = url.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '');
      metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9741;</span><div class="detail-meta-value"><a href="${url}" target="_blank" rel="noopener">${display}</a></div></div>`;
    }
    if (d.x && d.y) {
      metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9906;</span><div class="detail-meta-value"><a href="https://www.google.com/maps?q=${d.y},${d.x}" target="_blank" rel="noopener">View on Google Maps</a></div></div>`;
    }

    document.getElementById('detailMeta').innerHTML = metaHTML;
    renderDetailEvents(d);

    // "View on map" fly-to button
    const existingFlyto = panel.querySelector('.detail-flyto');
    if (existingFlyto) existingFlyto.remove();
    if (d.x && d.y) {
      const flyBtn = document.createElement('button');
      flyBtn.className = 'detail-flyto';
      flyBtn.innerHTML = '<span class="detail-flyto-icon">&#9906;</span> View on map';
      flyBtn.addEventListener('click', () => {
        closeDetail();
        document.getElementById('mapSection').scrollIntoView({ behavior: 'smooth' });
        setTimeout(() => {
          map.flyTo({ center: [d.x, d.y], zoom: 15, pitch: 50, bearing: -20, duration: 2000 });
        }, 600);
      });
      document.querySelector('.detail-content').appendChild(flyBtn);
    }

    // GSAP slide-in
    overlay.classList.add('open');
    gsap.to(overlay, { opacity: 1, duration: 0.3 });
    gsap.to(panel, { right: 0, duration: 0.45, ease: 'power3.out' });
    panel.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeDetail() {
    const panel = document.getElementById('detailPanel');
    const overlay = document.getElementById('panelOverlay');

    gsap.to(panel, {
      right: -460, duration: 0.35, ease: 'power2.in',
      onComplete: () => panel.classList.remove('open')
    });
    gsap.to(overlay, {
      opacity: 0, duration: 0.25,
      onComplete: () => { overlay.classList.remove('open'); }
    });
    document.body.style.overflow = '';
  }

  // ============================================================
  // EXPLORE LIST
  // ============================================================
  function getFilteredData() {
    let filtered = activeCategories.size > 0
      ? DATA.filter(d => activeCategories.has(d.l))
      : [...DATA];
    const query = (document.getElementById('searchInput').value || '').toLowerCase().trim();
    if (query) {
      filtered = filtered.filter(d =>
        (d.n && d.n.toLowerCase().includes(query)) ||
        (d.c && d.c.toLowerCase().includes(query)) ||
        (d.d && d.d.toLowerCase().includes(query)) ||
        (d.l && d.l.toLowerCase().includes(query))
      );
    }
    if (openNowMode) {
      filtered = filtered.filter((d) => getHoursState(d) !== 'closed');
      filtered = filtered.sort((a, b) => {
        const rankDelta = getHoursRank(getHoursState(a)) - getHoursRank(getHoursState(b));
        if (rankDelta !== 0) return rankDelta;
        return (a.n || '').localeCompare(b.n || '');
      });
    }
    if (events14dMode) {
      filtered = filtered.filter((d) => {
        const idx = DATA.indexOf(d);
        return getEventCountForAsset14d(idx) > 0;
      });
      filtered = filtered.sort((a, b) => {
        const ai = DATA.indexOf(a);
        const bi = DATA.indexOf(b);
        const diff = getEventCountForAsset14d(bi) - getEventCountForAsset14d(ai);
        if (diff !== 0) return diff;
        return (a.n || '').localeCompare(b.n || '');
      });
    }
    return filtered;
  }

  function getSearchMatchedEvents(query) {
    const q = (query || '').toLowerCase().trim();
    if (!q) return [];
    const events = getFilteredMapEvents();
    return events.filter((event) => {
      const tags = Array.isArray(event.tags) ? event.tags.join(' ') : '';
      return (
        String(event.title || '').toLowerCase().includes(q) ||
        String(event.venue_name || '').toLowerCase().includes(q) ||
        String(event.venue_city || '').toLowerCase().includes(q) ||
        String(event.description || '').toLowerCase().includes(q) ||
        tags.toLowerCase().includes(q)
      );
    });
  }

  function renderSearchEventMatches(query) {
    const wrap = document.getElementById('exploreEventResults');
    if (!wrap) return;
    const q = (query || '').trim();
    if (!q) {
      wrap.hidden = true;
      wrap.innerHTML = '';
      return;
    }

    const matches = getSearchMatchedEvents(q).slice(0, 6);
    if (!matches.length) {
      wrap.hidden = true;
      wrap.innerHTML = '';
      return;
    }

    const items = matches.map((event) => {
      const mapped = Number.isInteger(event.matched_asset_idx);
      const title = escapeHTML(event.title || 'Untitled event');
      const when = escapeHTML(formatEventDateRange(event));
      const venue = escapeHTML(event.venue_name || 'Venue TBD');
      const badge = mapped ? '' : '<span class="map-event-badge">Unmapped</span>';
      const link = typeof event.ticket_url === 'string' && event.ticket_url
        ? `<a class="explore-search-event-link" href="${escapeHTML(event.ticket_url)}" target="_blank" rel="noopener">Event link</a>`
        : '';
      return `
        <div class="explore-search-event ${mapped ? 'mapped' : ''}" data-event-id="${escapeHTML(event.event_id || '')}">
          <div class="explore-search-event-title">${title}</div>
          <div class="explore-search-event-meta">
            <span>${when}</span>
            <span>${venue}</span>
            ${badge}
          </div>
          ${link}
        </div>
      `;
    }).join('');

    wrap.innerHTML = `
      <div class="explore-search-events-header">
        <div class="explore-search-events-title">Matching Events</div>
        <div class="explore-search-events-count">${matches.length} shown</div>
      </div>
      <div class="explore-search-events-list">${items}</div>
    `;
    wrap.hidden = false;
  }

  function buildExploreCats() {
    const grid = document.getElementById('exploreCats');
    if (!grid) return;
    grid.innerHTML = '';
    const counts = {};
    DATA.forEach(d => { counts[d.l] = (counts[d.l] || 0) + 1; });
    Object.entries(CATS).forEach(([name, cfg]) => {
      const card = document.createElement('div');
      card.className = 'explore-cat-card';
      card.style.setProperty('--card-color', cfg.color);
      card.innerHTML = `
        <img class="explore-cat-card-img" src="img/watercolor/${cfg.watercolor || 'landmarks'}.png" alt="">
        <div class="explore-cat-card-name">${cfg.short || name}</div>
        <div class="explore-cat-card-count">${counts[name] || 0} places</div>
      `;
      card.addEventListener('click', () => {
        exploreSetCategory(name);
      });
      grid.appendChild(card);
    });
  }

  function exploreSetCategory(cat) {
    const wrapper = document.getElementById('exploreListWrapper');
    const catGrid = document.getElementById('exploreCats');
    const cards = document.querySelectorAll('.explore-cat-card');

    if (cat) {
      wrapper.classList.add('visible');
      catGrid.style.display = 'none';
      cards.forEach(c => c.classList.remove('active'));
      // Also sync map filter pills
      setCategory(cat, { exclusive: true });
    } else {
      wrapper.classList.remove('visible');
      catGrid.style.display = '';
      document.getElementById('searchInput').value = '';
      setCategory(null);
    }
    listPage = 0;
    buildList();
    document.getElementById('exploreSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function buildList() {
    const list = document.getElementById('exploreList');
    const wrapper = document.getElementById('exploreListWrapper');
    const searchVal = document.getElementById('searchInput').value.trim();
    renderSearchEventMatches(searchVal);

    // Show list if search is active even without category
    if (searchVal && activeCategories.size === 0) {
      wrapper.classList.add('visible');
      document.getElementById('exploreCats').style.display = 'none';
    }

    const filtered = getFilteredData();
    const end = (listPage + 1) * LIST_PAGE_SIZE;
    const visible = filtered.slice(0, end);

    const scopeParts = [];
    if (activeCategories.size > 0) {
      const selected = Array.from(activeCategories);
      scopeParts.push(selected.length === 1 ? selected[0] : `${selected.length} categories`);
    }
    if (openNowMode) scopeParts.push('Status: Open now (open highlighted, unknown dimmed)');
    if (events14dMode) scopeParts.push(`Events: next ${EVENT_WINDOW_DAYS} days`);
    document.getElementById('resultsCount').textContent =
      `Showing ${Math.min(end, filtered.length)} of ${filtered.length} assets` +
      (scopeParts.length ? ` • ${scopeParts.join(' • ')}` : '');

    list.innerHTML = '';
    visible.forEach(d => {
      const cfg = CATS[d.l] || { color: '#999' };
      const imgInfo = IMAGE_DATA[d.n];
      const wcSlug = cfg.watercolor || 'landmarks';
      const thumbSrc = imgInfo ? imgInfo.img : `img/watercolor/${wcSlug}.png`;
      const item = document.createElement('div');
      item.className = 'explore-item';
      item.style.setProperty('--row-color', cfg.color);
      const hoursState = getHoursState(d);
      const assetIdx = DATA.indexOf(d);
      const eventCount14d = getEventCountForAsset14d(assetIdx);
      if (openNowMode) {
        item.classList.add('hours-mode', `hours-${hoursState}`);
      }
      const desc = d.d ? d.d.replace(/<[^>]*>/g, '').slice(0, 120) : '';
      item.innerHTML = `
        <div class="explore-item-bar" style="background:${cfg.color}"></div>
        <img class="explore-item-thumb" src="${thumbSrc}" alt="" loading="lazy" onerror="this.src='img/watercolor/${wcSlug}.png'">
        <div class="explore-item-info">
          <div class="explore-item-name">${d.n}</div>
          ${desc ? `<div class="explore-item-desc">${desc}</div>` : ''}
          <div class="explore-item-meta">
            <span class="explore-item-city">${d.c || d.a || ''}</span>
            <span class="explore-item-cat" style="color:${cfg.color}">
              <span class="explore-item-cat-dot" style="background:${cfg.color}"></span>
              ${cfg.short || d.l}
            </span>
            ${openNowMode ? `<span class="hours-pill hours-${hoursState} explore-item-hours">${getHoursLabel(hoursState)}</span>` : ''}
            ${events14dMode && eventCount14d > 0 ? `<span class="hours-pill explore-item-hours" style="color:#934512;background:rgba(180,88,29,0.12);border-color:rgba(180,88,29,0.48)">${eventCount14d} event${eventCount14d === 1 ? '' : 's'}</span>` : ''}
          </div>
        </div>
        <span class="explore-item-arrow">&rarr;</span>
      `;
      item.addEventListener('click', () => openDetail(d));
      list.appendChild(item);
    });

    document.getElementById('loadMoreBtn').style.display = end >= filtered.length ? 'none' : 'block';

    // GSAP staggered entrance
    gsap.fromTo('#exploreList .explore-item',
      { opacity: 0, x: -8 },
      { opacity: 1, x: 0, duration: 0.2, stagger: 0.015, ease: 'power2.out' }
    );
  }

  // ============================================================
  // EVENTS
  // ============================================================
  function bindEvents() {
    document.getElementById('detailClose').addEventListener('click', closeDetail);
    document.getElementById('panelOverlay').addEventListener('click', closeDetail);
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeDetail();
        setMapFiltersExpanded(false);
        setMapLegendExpanded(false);
      }
    });

    const overlayControls = document.querySelector('.map-overlay-controls');
    const filterToggle = document.getElementById('mapFilterToggle');
    const legendToggle = document.getElementById('mapLegendToggle');
    if (overlayControls) {
      overlayControls.addEventListener('click', (e) => e.stopPropagation());
    }
    if (filterToggle) {
      filterToggle.addEventListener('click', () => {
        markMapInteracted();
        setMapFiltersExpanded(!mapFiltersExpanded);
      });
    }
    if (legendToggle) {
      legendToggle.addEventListener('click', () => {
        markMapInteracted();
        setMapLegendExpanded(!mapLegendExpanded);
      });
    }
    document.addEventListener('click', () => {
      if (mapFiltersExpanded) setMapFiltersExpanded(false);
      if (mapLegendExpanded) setMapLegendExpanded(false);
    });

    document.getElementById('searchInput').addEventListener('input', () => {
      const val = document.getElementById('searchInput').value.trim();
      const wrapper = document.getElementById('exploreListWrapper');
      const catGrid = document.getElementById('exploreCats');
      if (val) {
        wrapper.classList.add('visible');
        catGrid.style.display = 'none';
      } else if (activeCategories.size === 0) {
        wrapper.classList.remove('visible');
        catGrid.style.display = '';
      }
      listPage = 0;
      buildList();
    });

    document.getElementById('loadMoreBtn').addEventListener('click', () => {
      listPage++;
      buildList();
    });

    document.getElementById('exploreListBack').addEventListener('click', () => {
      exploreSetCategory(null);
    });

    const eventsFilters = document.getElementById('mapEventsFilters');
    if (eventsFilters) {
      eventsFilters.addEventListener('click', (e) => {
        const chip = e.target.closest('[data-event-filter]');
        if (!chip) return;
        setEventDateFilter(chip.dataset.eventFilter);
      });
    }

    const eventsCategorySelect = document.getElementById('mapEventsCategory');
    if (eventsCategorySelect) {
      eventsCategorySelect.addEventListener('change', () => {
        setEventCategoryFilter(eventsCategorySelect.value);
      });
    }

    const eventsPrevBtn = document.getElementById('mapEventsPrev');
    if (eventsPrevBtn) {
      eventsPrevBtn.addEventListener('click', () => {
        stopEventsRotation();
        const filtered = getFilteredMapEvents();
        if (stepEventsSpotlight(-1, true)) {
          queueEventsRotationResume(filtered.length);
        }
      });
    }

    const eventsNextBtn = document.getElementById('mapEventsNext');
    if (eventsNextBtn) {
      eventsNextBtn.addEventListener('click', () => {
        stopEventsRotation();
        const filtered = getFilteredMapEvents();
        if (stepEventsSpotlight(1, true)) {
          queueEventsRotationResume(filtered.length);
        }
      });
    }

    const eventsList = document.getElementById('mapEventsList');
    if (eventsList) {
      let eventsScrollLabelFrame = null;
      eventsList.addEventListener('mouseenter', stopEventsRotation);
      eventsList.addEventListener('mouseleave', () => {
        const filtered = getFilteredMapEvents();
        startEventsRotation(filtered.length);
      });
      eventsList.addEventListener('scroll', () => {
        if (eventsScrollLabelFrame !== null) return;
        eventsScrollLabelFrame = requestAnimationFrame(() => {
          eventsScrollLabelFrame = null;
          updateEventsSpotlightPageLabel(getFilteredMapEvents().length);
        });
      }, { passive: true });
      eventsList.addEventListener('click', (e) => {
        const link = e.target.closest('.map-event-link');
        if (link) {
          e.stopPropagation();
          return;
        }
        const card = e.target.closest('.map-event-item.mapped');
        if (!card) return;
        const eventId = card.getAttribute('data-event-id');
        if (!eventId) return;
        focusEvent(eventId);
      });
    }

    const allEventsList = document.getElementById('mapEventsAllList');
    if (allEventsList) {
      allEventsList.addEventListener('click', (e) => {
        const link = e.target.closest('.map-event-link');
        if (link) {
          e.stopPropagation();
          return;
        }
        const card = e.target.closest('.map-event-row.mapped');
        if (!card) return;
        const eventId = card.getAttribute('data-event-id');
        if (!eventId) return;
        focusEvent(eventId);
      });
    }

    const eventsDetails = document.getElementById('mapEventsDetails');
    if (eventsDetails) {
      eventsDetails.addEventListener('toggle', () => {
        if (eventsDetails.open) {
          buildMapEventsList({ keepPosition: true });
        } else {
          stopEventsRotation();
        }
      });
    }

    const searchEventsList = document.getElementById('exploreEventResults');
    if (searchEventsList) {
      searchEventsList.addEventListener('click', (e) => {
        const link = e.target.closest('.explore-search-event-link');
        if (link) {
          e.stopPropagation();
          return;
        }
        const card = e.target.closest('.explore-search-event.mapped');
        if (!card) return;
        const eventId = card.getAttribute('data-event-id');
        if (!eventId) return;
        focusEvent(eventId);
      });
    }

    document.getElementById('mapActiveClear').addEventListener('click', () => {
      setCategory(null);
      if (openNowMode) setOpenNowMode(false);
      if (events14dMode) setEvents14dMode(false);
    });
  }

  // ============================================================
  // SCROLL REVEAL (GSAP)
  // ============================================================
  function initScrollReveal() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          gsap.fromTo(entry.target,
            { opacity: 0, y: 30 },
            { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' }
          );
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.15 });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
  }

})();
</script>
</body>
</html>
