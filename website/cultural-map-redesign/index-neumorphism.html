<!DOCTYPE html>
<!--
  Nevada County Arts Council Cultural Asset Map
  Neumorphism Design Variant

  This variant applies soft neumorphic design principles:
  - Soft gray background (#e0e5ec)
  - Raised and inset shadow effects
  - Minimal borders, tactile appearance
  - Low contrast, muted colors

  Source: index-maplibre.html
-->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Culture of Nevada County â€” Neumorphism</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="preconnect" href="https://api.maptiler.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  /* Heritage Neumorphism - Warm, vintage civic aesthetic */
  --neuro-bg: #F4EFE6;
  --neuro-light: rgba(255,250,240,0.8);
  --neuro-dark: rgba(80,60,40,0.2);

  /* Heritage palette - Badge-aligned colors */
  --ink: #4A6B7C;              /* Slate navy from badge "CULTURAL ASSETS" */
  --cream: #F4EFE6;            /* Warm parchment background */
  --parchment: #E8DFD0;        /* Badge cream background */
  --gold: #D4AF37;             /* Rich gold from badge border/text */
  --gold-bright: #E0BB4A;      /* Brighter gold hover */
  --rust: #B85C38;             /* Warm rust accent */
  --deep-green: #5C7A5C;       /* Forest green from badge photo */
  --slate: #A89070;            /* Warm brown from badge landscape */
  --red-accent: #A0522D;       /* Terracotta */
  --blue-wash: #87CEEB;        /* Sky blue from badge photo */

  /* Heritage category colors - badge-derived palette */
  --cat-landmarks: #A0522D;       /* Terracotta/brick */
  --cat-eat: #D4AF37;             /* Rich gold from badge */
  --cat-arts: #5C7A5C;            /* Forest green from badge */
  --cat-cultural: #4A6B7C;        /* Slate navy from badge */
  --cat-fairs: #B85C38;           /* Aged rust */
  --cat-galleries: #7A6B7D;       /* Dusty plum/museum */
  --cat-walks: #7A9E7E;           /* Mountain green from badge */
  --cat-publicart: #D4AF37;       /* Rich gold from badge */
  --cat-performance: #87CEEB;     /* Sky blue from badge */
  --cat-preservation: #8B7355;    /* Warm brown from badge */

  --font-display: 'Playfair Display', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;

  /* Heritage Neumorphic shadows - warm brown tones */
  --shadow-raised: 6px 6px 12px rgba(80,60,40,0.2), -6px -6px 12px rgba(255,250,240,0.8);
  --shadow-inset: inset 3px 3px 6px rgba(80,60,40,0.2), inset -3px -3px 6px rgba(255,250,240,0.8);
  --shadow-soft: 4px 4px 8px rgba(80,60,40,0.15), -4px -4px 8px rgba(255,250,240,0.7);
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  font-weight: 500;
  background: var(--neuro-bg);
  color: var(--ink);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ========== HERO ========== */
.hero {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 5rem 3rem 3rem;
  background: var(--neuro-bg);
  overflow: hidden;
  position: relative;
}

.hero-badge {
  position: relative;
  z-index: 1;
  width: 500px;
  max-width: 80vw;
  opacity: 0;
  transform: scale(0.95);
  animation: badgeReveal 1.2s cubic-bezier(0.22, 1, 0.36, 1) 0.2s forwards;
  margin-bottom: 2.5rem;
  padding: 1rem;
  border-radius: 20px;
  background: var(--neuro-bg);
  box-shadow: var(--shadow-raised);
}

@keyframes badgeReveal {
  to { opacity: 1; transform: scale(1); }
}

.hero-content {
  position: relative;
  z-index: 1;
  max-width: 600px;
}

.hero-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--rust);
  margin-bottom: 1rem;
  opacity: 0;
  transform: translateY(15px);
  animation: fadeUp 0.8s ease 0.6s forwards;
}

.hero-title {
  font-family: var(--font-display);
  font-weight: 700;
  font-size: clamp(1.8rem, 4vw, 2.8rem);
  line-height: 1.1;
  color: var(--ink);
  margin-bottom: 1rem;
  opacity: 0;
  transform: translateY(15px);
  animation: fadeUp 0.8s ease 0.8s forwards;
}

.hero-title em {
  font-style: italic;
  color: var(--gold);
}

.hero-sub {
  font-size: clamp(0.9rem, 1.5vw, 1.05rem);
  line-height: 1.7;
  color: var(--slate);
  max-width: 480px;
  margin: 0 auto;
  font-weight: 300;
  opacity: 0;
  transform: translateY(15px);
  animation: fadeUp 0.8s ease 1s forwards;
}

@media (max-width: 600px) {
  .hero { padding: 3.5rem 1.5rem 2rem; }
  .hero-badge { width: 240px; }
}

/* ========== SECTION INTRO ========== */
.section-intro {
  padding: 5rem 3rem;
  max-width: 760px;
  margin: 0 auto;
  display: block;
  position: relative;
  z-index: 1;
  border-top: none;
}

/* Full-width neumorphic background behind centered intro */
.section-intro::before {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100vw;
  background: var(--neuro-bg);
  z-index: -1;
}

.section-intro .col-right { display: none; }

/* Removed paper texture for neumorphism */

.section-intro > * { position: relative; z-index: 1; }

/* Section divider watercolor decorations */
.section-watercolor {
  position: absolute;
  pointer-events: none;
  z-index: 0;
  opacity: 0.06;
}

/* hero watercolors now in layout, not absolute positioned */

.explore-section {
  position: relative;
}

.explore-section .section-watercolor {
  top: -1rem;
  left: 2rem;
  width: 180px;
  opacity: 0.05;
}

.colophon {
  position: relative;
}

.colophon .section-watercolor {
  top: 50%;
  right: 3rem;
  transform: translateY(-50%);
  width: 150px;
  opacity: 0.04;
}

.section-intro .col-left {
  position: static;
}

.section-tag {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--rust);
  margin-bottom: 1rem;
}

.section-heading {
  font-family: var(--font-display);
  font-size: clamp(2rem, 4vw, 3.5rem);
  font-weight: 700;
  line-height: 1.1;
  color: var(--ink);
  margin-bottom: 1.5rem;
}

.section-body {
  font-size: 1.05rem;
  line-height: 1.75;
  color: var(--slate);
  max-width: 520px;
}

.section-body p + p { margin-top: 1rem; }

/* ========== CATEGORY CARDS ========== */
.categories-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
}

.cat-card {
  padding: 1.25rem 1.25rem 1.25rem 1rem;
  border: none;
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
  overflow: visible;
  background: var(--neuro-bg);
  display: flex;
  align-items: center;
  gap: 0.85rem;
  border-radius: 12px;
  box-shadow: var(--shadow-raised);
}

.cat-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 4px;
  height: 100%;
  background: var(--cat-color, var(--gold));
  transform: scaleY(0);
  transform-origin: bottom;
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  border-radius: 12px 0 0 12px;
}

.cat-card::after {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--cat-color, var(--gold));
  opacity: 0;
  transition: opacity 0.35s ease;
  z-index: 0;
  border-radius: 12px;
}

.cat-card:hover::before,
.cat-card.active::before { transform: scaleY(1); }

.cat-card:hover::after { opacity: 0.02; }
.cat-card.active::after { opacity: 0.04; }

.cat-card:hover, .cat-card.active {
  border-color: transparent;
  box-shadow: var(--shadow-inset);
  transform: translateY(2px);
}

.cat-card > * { position: relative; z-index: 1; }

.cat-icon {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  background: var(--neuro-bg);
  box-shadow: var(--shadow-soft);
}

.cat-card:hover .cat-icon { transform: scale(1.1); }
.cat-card.active .cat-icon { transform: scale(1.15); }

.cat-icon svg {
  width: 18px;
  height: 18px;
}

.cat-icon-watercolor {
  width: 32px;
  height: 32px;
  object-fit: contain;
}

.cat-icon-svg { display: flex; align-items: center; justify-content: center; }

.cat-card-info { flex: 1; min-width: 0; }

.cat-card-count {
  font-family: var(--font-display);
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--cat-color, var(--ink));
  line-height: 1;
  transition: color 0.2s ease;
}

.cat-card-name {
  font-size: 0.72rem;
  font-weight: 500;
  color: var(--slate);
  margin-top: 0.2rem;
  letter-spacing: 0.02em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.cat-card-active-label {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  opacity: 0;
  transition: opacity 0.25s ease;
  margin-top: 0.15rem;
  color: var(--cat-color, var(--gold));
}

.cat-card.active .cat-card-active-label { opacity: 1; }

/* ========== MAP SECTION ========== */
.map-section {
  background: var(--neuro-bg);
  padding: 0;
  position: relative;
  z-index: 1;
  transition: background 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

.map-header {
  padding: 4rem 3rem 2rem;
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}

.map-title {
  font-family: var(--font-display);
  font-size: clamp(1.5rem, 3vw, 2.5rem);
  color: var(--ink);
  font-weight: 700;
  transition: color 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

.map-filter-bar {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  justify-content: flex-end;
  max-width: 600px;
}

.filter-pill {
  font-family: var(--font-body);
  font-size: 0.7rem;
  font-weight: 500;
  padding: 0.45rem 0.9rem 0.45rem 0.7rem;
  border: none;
  background: var(--neuro-bg);
  color: var(--slate);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  letter-spacing: 0.02em;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  border-radius: 20px;
  box-shadow: var(--shadow-raised);
}

.filter-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--pill-color, var(--slate));
  flex-shrink: 0;
  transition: all 0.3s ease;
  opacity: 0.5;
}

.filter-pill:hover {
  color: var(--ink);
  transform: translateY(-2px);
  box-shadow: 5px 5px 10px var(--neuro-dark), -5px -5px 10px var(--neuro-light);
}

.filter-pill:hover .filter-dot { opacity: 1; transform: scale(1.2); }

.filter-pill.active {
  background: var(--neuro-bg);
  color: var(--pill-color, var(--gold));
  font-weight: 600;
  box-shadow: var(--shadow-inset);
}

.filter-pill.active .filter-dot {
  background: var(--pill-color, var(--gold));
  opacity: 1;
}

.filter-pill.all-pill { padding-left: 0.9rem; }

.filter-pill.all-pill.active {
  background: var(--neuro-bg);
  color: var(--ink);
  box-shadow: var(--shadow-inset);
}

.map-active-banner {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 3rem;
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.4s ease, opacity 0.3s ease;
  opacity: 0;
}

.map-active-banner.visible {
  max-height: 60px;
  opacity: 1;
}

.map-active-banner-inner {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 0;
}

.map-active-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  animation: dotPulse 2s ease-in-out infinite;
}

@keyframes dotPulse {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.3); }
}

.map-active-text {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.08em;
  color: rgba(26,22,18,0.5);
}

.map-active-text strong {
  color: var(--ink);
  font-weight: 600;
}

.map-active-clear {
  font-family: var(--font-body);
  font-size: 0.65rem;
  color: rgba(26,22,18,0.4);
  background: none;
  border: 1px solid rgba(26,22,18,0.15);
  padding: 0.25rem 0.6rem;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-left: auto;
}

.map-active-clear:hover {
  color: var(--ink);
  border-color: rgba(26,22,18,0.4);
}

.map-container {
  height: 70vh;
  min-height: 500px;
  position: relative;
  margin: 2rem;
  padding: 1.5rem;
  border: 4px solid var(--ink);
  border-radius: 20px;
  background: var(--neuro-bg);
  box-shadow: var(--shadow-inset);
}

#map {
  width: 100%;
  height: 100%;
  border-radius: 16px;
  overflow: hidden;
}

/* MapLibre control overrides */
.maplibregl-ctrl-group {
  background: var(--ink) !important;
  border: 1px solid rgba(245,240,232,0.15) !important;
  border-radius: 0 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
}

.maplibregl-ctrl-group button {
  width: 32px !important;
  height: 32px !important;
}

.maplibregl-ctrl-group button + button {
  border-top: 1px solid rgba(245,240,232,0.1) !important;
}

.maplibregl-ctrl-group button .maplibregl-ctrl-icon {
  filter: invert(1) brightness(0.85);
}

.maplibregl-ctrl-attrib {
  background: rgba(26,22,18,0.7) !important;
  color: rgba(245,240,232,0.4) !important;
  font-size: 10px !important;
}

.maplibregl-ctrl-attrib a { color: var(--gold) !important; }

/* Rich tooltip popups - Heritage Neumorphism */
.maplibregl-popup-content {
  background: var(--parchment) !important;
  color: var(--ink) !important;
  border: 3px solid var(--gold) !important;
  border-radius: 20px !important;
  padding: 0 !important;
  font-family: var(--font-body) !important;
  box-shadow: var(--shadow-raised) !important;
  max-width: 280px !important;
  min-width: 200px !important;
  overflow: hidden !important;
  animation: tooltipIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes tooltipIn {
  from { opacity: 0; transform: translateY(8px) scale(0.92); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

.maplibregl-popup-tip {
  border-top-color: var(--gold) !important;
  filter: drop-shadow(2px 2px 3px rgba(80,60,40,0.15));
}

.maplibregl-popup-anchor-bottom .maplibregl-popup-tip {
  border-top-color: var(--gold) !important;
}

.maplibregl-popup-close-button { display: none; }

.tooltip-img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  display: block;
  position: relative;
}

.tooltip-img::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent 40%, rgba(74,107,124,0.3) 100%);
  pointer-events: none;
}
.tooltip-placeholder {
  width: 100%;
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.tooltip-placeholder svg {
  width: 36px;
  height: 36px;
  fill: currentColor;
  opacity: 0.5;
}
.tooltip-watercolor {
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0.25;
  position: absolute;
  inset: 0;
  padding: 10px;
}
.tooltip-body {
  padding: 0.65rem 0.85rem 0.75rem;
  background: var(--neuro-bg);
  border-radius: 0 0 17px 17px;
}
.tooltip-body strong {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: var(--ink);
}
.tooltip-body .tooltip-cat {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  opacity: 0.75;
  font-size: 0.72rem;
  font-weight: 500;
}
.tooltip-body .tooltip-cat-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
  box-shadow: var(--shadow-soft);
}
.tooltip-body .tooltip-city {
  opacity: 0.6;
  font-size: 0.7rem;
  margin-top: 0.2rem;
  font-weight: 400;
}

/* Detail panel image */
.detail-hero-img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  display: block;
}
.detail-hero-placeholder {
  width: 100%;
  height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.detail-hero-placeholder svg {
  width: 48px;
  height: 48px;
  fill: currentColor;
  opacity: 0.35;
}
.detail-hero-watercolor {
  width: 100%;
  height: 100%;
  object-fit: contain;
  opacity: 0.4;
  padding: 20px;
}

/* ========== DETAIL PANEL ========== */
.detail-panel {
  position: fixed;
  right: -460px;
  top: 0;
  width: 440px;
  max-width: 90vw;
  height: 100vh;
  background: var(--neuro-bg);
  z-index: 10000;
  box-shadow: -12px 12px 24px var(--neuro-dark), 12px -12px 24px var(--neuro-light);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.detail-panel.open { right: 0; }

.detail-panel-overlay {
  position: fixed;
  inset: 0;
  background: rgba(26,22,18,0.5);
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s ease;
}

.detail-panel-overlay.open {
  opacity: 1;
  pointer-events: auto;
}

.detail-close {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  width: 36px;
  height: 36px;
  background: var(--neuro-bg);
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  color: var(--ink);
  transition: all 0.2s ease;
  z-index: 2;
  border-radius: 50%;
  box-shadow: var(--shadow-raised);
}

.detail-close:hover {
  box-shadow: var(--shadow-inset);
  transform: scale(0.95);
}

.detail-category-bar {
  height: 4px;
  width: 100%;
  flex-shrink: 0;
}

.detail-content {
  padding: 3rem 2.5rem;
  flex: 1;
}

.detail-tag {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 1rem;
}

.detail-experiences-badge {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  margin-bottom: 0.75rem;
}

.detail-experiences-badge:empty { display: none; }

.detail-exp-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.05em;
  padding: 0.2rem 0.5rem;
  border: 1px solid;
  border-color: currentColor;
  opacity: 0.7;
  cursor: pointer;
  transition: all 0.2s ease;
}

.detail-exp-pill:hover { opacity: 1; }

.detail-exp-pill-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.detail-name {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 700;
  line-height: 1.15;
  margin-bottom: 1.5rem;
  padding-right: 2rem;
}

.detail-description {
  font-size: 0.95rem;
  line-height: 1.7;
  color: var(--slate);
  margin-bottom: 2rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid rgba(26,22,18,0.08);
}

.detail-description::first-letter {
  font-family: var(--font-display);
  font-size: 2.5em;
  float: left;
  line-height: 0.8;
  margin-right: 0.1em;
  margin-top: 0.05em;
  color: var(--gold);
}

.detail-meta {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.detail-meta-row {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
}

.detail-meta-icon {
  font-size: 0.85rem;
  width: 20px;
  text-align: center;
  flex-shrink: 0;
  margin-top: 2px;
  opacity: 0.5;
}

.detail-meta-value {
  font-size: 0.85rem;
  line-height: 1.5;
  color: var(--slate);
}

.detail-meta-value a {
  color: var(--blue-wash);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s ease;
}

.detail-meta-value a:hover { border-bottom-color: var(--blue-wash); }

.detail-flyto {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
  margin-top: 1.5rem;
  padding: 0.75rem 1rem;
  font-family: var(--font-body);
  font-size: 0.8rem;
  font-weight: 500;
  background: var(--parchment);
  border: 1px solid rgba(26,22,18,0.1);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
  color: var(--ink);
}

.detail-flyto:hover {
  background: var(--ink);
  color: var(--cream);
  border-color: var(--ink);
}

.detail-flyto-icon {
  font-size: 1rem;
}

/* ========== MUSE EDITORIAL CARDS ========== */
.muse-section {
  position: relative;
  z-index: 1;
  padding: 4rem 2rem 5rem;
  max-width: 1000px;
  margin: 0 auto;
}

.muse-section::before {
  content: '';
  position: absolute;
  top: 0; bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100vw;
  background: var(--parchment);
  z-index: -1;
}

.muse-section-header {
  margin-bottom: 3rem;
}

.muse-section-tag {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--rust);
  margin-bottom: 0.5rem;
}

.muse-section-title {
  font-family: var(--font-display);
  font-size: clamp(1.4rem, 2.5vw, 1.8rem);
  font-weight: 700;
  color: var(--ink);
  margin: 0;
}

.muse-cards {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
}

.muse-card {
  background: rgba(255,255,255,0.6);
  border: 1px solid rgba(26,22,18,0.06);
  border-radius: 8px;
  padding: 2rem 1.8rem;
  cursor: pointer;
  list-style: none;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
}

.muse-card:nth-child(2) {
  margin-top: 2.5rem;
}

.muse-card:nth-child(3) {
  margin-top: -1rem;
}

.muse-card:hover {
  background: rgba(255,255,255,0.9);
  border-color: rgba(26,22,18,0.12);
  box-shadow: 0 8px 32px rgba(26,22,18,0.06);
}

.muse-card > summary {
  list-style: none;
  cursor: pointer;
  display: block;
}

.muse-card > summary::-webkit-details-marker { display: none; }

.muse-card-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--slate);
  margin-bottom: 0.75rem;
}

.muse-card-title {
  font-family: var(--font-display);
  font-size: clamp(1.05rem, 1.8vw, 1.25rem);
  font-weight: 700;
  color: var(--ink);
  line-height: 1.3;
  margin-bottom: 1rem;
}

.muse-card-quote {
  font-family: var(--font-display);
  font-size: 0.9rem;
  font-style: italic;
  line-height: 1.65;
  color: rgba(26,22,18,0.7);
  margin-bottom: 0.75rem;
}

.muse-card-author {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.05em;
  color: var(--slate);
}

.muse-card-toggle {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--rust);
  margin-top: 1rem;
  transition: color 0.2s ease;
}

.muse-card > summary:hover .muse-card-toggle {
  color: var(--gold);
}

.muse-card[open] .muse-card-toggle { display: none; }

.muse-card-body {
  padding-top: 1.5rem;
  margin-top: 1rem;
  border-top: 1px solid rgba(26,22,18,0.08);
  font-size: 0.88rem;
  line-height: 1.8;
  color: rgba(26,22,18,0.7);
}

.muse-card-body p {
  margin-bottom: 1rem;
}

.muse-card-body p:last-child {
  margin-bottom: 0;
}

/* Corridor sub-sections within the Cultural Corridors card */
.muse-corridor {
  border-top: 1px solid rgba(26,22,18,0.08);
}

.muse-corridor:last-child {
  border-bottom: 1px solid rgba(26,22,18,0.08);
}

.muse-corridor summary {
  font-family: var(--font-display);
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--ink);
  padding: 1rem 0;
  cursor: pointer;
  list-style: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: color 0.2s ease;
}

.muse-corridor summary::-webkit-details-marker { display: none; }

.muse-corridor summary::after {
  content: '+';
  font-family: var(--font-body);
  font-weight: 300;
  font-size: 1.2rem;
  color: var(--slate);
  transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  flex-shrink: 0;
  margin-left: 1rem;
}

.muse-corridor[open] summary::after {
  transform: rotate(45deg);
}

.muse-corridor summary:hover {
  color: var(--rust);
}

.muse-corridor-body {
  padding: 0 0 1.2rem;
  font-size: 0.85rem;
  line-height: 1.8;
  color: rgba(26,22,18,0.7);
}

.muse-corridor-body p {
  margin-bottom: 0.8rem;
}

.muse-corridor-body p:last-child {
  margin-bottom: 0;
}

@media (max-width: 700px) {
  .muse-section { padding: 2.5rem 1.5rem 3rem; }
  .muse-cards { grid-template-columns: 1fr; }
  .muse-card:nth-child(2) { margin-top: 0; }
  .muse-card:nth-child(3) { margin-top: 0; }
}

/* ========== EXPLORE LIST ========== */
.explore-section {
  padding: 6rem 3rem;
  max-width: 1400px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* Full-width neumorphic background behind centered explore */
.explore-section::before {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100vw;
  background: var(--neuro-bg);
  z-index: -1;
}

.explore-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 3rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.explore-search {
  font-family: var(--font-body);
  font-size: 0.9rem;
  padding: 0.7rem 1.2rem;
  border: none;
  background: var(--neuro-bg);
  width: 320px;
  max-width: 100%;
  outline: none;
  transition: all 0.3s ease;
  border-radius: 12px;
  box-shadow: var(--shadow-inset);
  color: var(--ink);
}

.explore-search:focus {
  box-shadow: inset 4px 4px 8px var(--neuro-dark), inset -4px -4px 8px var(--neuro-light);
}

.explore-search::placeholder { color: var(--slate); opacity: 0.5; }

.explore-results-count {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--slate);
  letter-spacing: 0.1em;
  margin-bottom: 1rem;
}

.explore-categories {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  margin-bottom: 2rem;
  max-width: 900px;
  margin-left: auto;
  margin-right: auto;
}

.explore-cat-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.6rem;
  padding: 1.5rem 1rem;
  background: white;
  border: 1px solid rgba(26,22,18,0.06);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.explore-cat-card::before {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--card-color);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.explore-cat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(26,22,18,0.08);
  border-color: rgba(26,22,18,0.12);
}

.explore-cat-card:hover::before {
  opacity: 1;
}

.explore-cat-card.active {
  border-color: var(--card-color);
  box-shadow: 0 2px 16px rgba(26,22,18,0.1);
}

.explore-cat-card.active::before {
  opacity: 1;
}

.explore-cat-card-img {
  width: 48px;
  height: 48px;
  object-fit: contain;
}

.explore-cat-card-name {
  font-family: var(--font-body);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--ink);
  line-height: 1.3;
}

.explore-cat-card-count {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  color: var(--slate);
  letter-spacing: 0.05em;
}

.explore-list-wrapper {
  display: none;
}

.explore-list-wrapper.visible {
  display: block;
}

.explore-list-back {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.05em;
  color: var(--slate);
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
  margin-bottom: 1.5rem;
  transition: color 0.2s ease;
}

.explore-list-back:hover {
  color: var(--ink);
}

.explore-list-back::before {
  content: '\2190  ';
}

.explore-list {
  display: grid;
  gap: 0;
  border-top: 1px solid rgba(26,22,18,0.1);
}

.explore-item {
  display: grid;
  grid-template-columns: 4px 56px 1fr auto 32px;
  gap: 1rem;
  align-items: center;
  padding: 1rem 0;
  border-bottom: 1px solid rgba(26,22,18,0.06);
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
}

.explore-item-thumb {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  object-fit: cover;
  background: var(--neuro-bg);
  flex-shrink: 0;
  box-shadow: var(--shadow-soft);
}

.explore-item:hover {
  padding-left: 0.5rem;
  background: linear-gradient(90deg, var(--row-color, transparent) 0%, rgba(200,148,62,0.03) 2%, rgba(200,148,62,0.03) 100%);
}

.explore-item-bar {
  width: 4px;
  height: 100%;
  min-height: 20px;
  border-radius: 2px;
  opacity: 0.35;
  transition: opacity 0.25s ease, height 0.25s ease;
}

.explore-item:hover .explore-item-bar {
  opacity: 1;
}

.explore-item-info {
  min-width: 0;
}

.explore-item-name {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.15rem;
}

.explore-item-desc {
  font-size: 0.78rem;
  color: var(--slate);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
  margin-bottom: 0.25rem;
}

.explore-item-meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.explore-item-city {
  font-size: 0.75rem;
  color: rgba(26,22,18,0.4);
}

.explore-item-cat {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 0.2rem 0.5rem;
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  white-space: nowrap;
  border: 1px solid;
  border-color: currentColor;
  opacity: 0.5;
  transition: opacity 0.2s ease;
}

.explore-item:hover .explore-item-cat { opacity: 1; }

.explore-item-cat-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
}

.explore-item-arrow {
  font-size: 1.1rem;
  color: rgba(26,22,18,0.15);
  transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
}

.explore-item:hover .explore-item-arrow {
  color: var(--row-color, var(--gold));
  transform: translateX(4px);
}

.load-more-btn {
  display: block;
  margin: 2rem auto 0;
  padding: 0.8rem 2rem;
  font-family: var(--font-body);
  font-size: 0.85rem;
  font-weight: 500;
  background: var(--neuro-bg);
  border: none;
  cursor: pointer;
  transition: all 0.25s ease;
  color: var(--ink);
  border-radius: 12px;
  box-shadow: var(--shadow-raised);
}

.load-more-btn:hover {
  box-shadow: var(--shadow-inset);
  transform: translateY(2px);
}

/* ========== COLOPHON ========== */
.colophon {
  position: relative;
  z-index: 1;
  background: var(--neuro-bg);
  padding: 5rem 3rem 3rem;
  color: var(--slate);
  font-size: 0.8rem;
  line-height: 1.8;
}

.colophon-inner {
  max-width: 900px;
  margin: 0 auto;
}

.colophon-heading {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 400;
  color: rgba(245,240,232,0.7);
  margin-bottom: 2rem;
  letter-spacing: 0.02em;
}

.colophon-sections {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem 4rem;
  margin-bottom: 3rem;
}

.colophon-label {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(245,240,232,0.25);
  margin-bottom: 0.5rem;
}

.colophon a {
  color: var(--gold);
  text-decoration: none;
}

.colophon a:hover {
  color: var(--gold-bright);
}

.colophon-rule {
  border: none;
  border-top: 1px solid rgba(245,240,232,0.08);
  margin: 0 0 1.5rem;
}

.colophon-bottom {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  flex-wrap: wrap;
  gap: 1rem;
  font-size: 0.7rem;
  color: rgba(245,240,232,0.2);
}

.colophon-bottom a {
  color: rgba(245,240,232,0.3);
}

@media (max-width: 600px) {
  .colophon-sections { grid-template-columns: 1fr; gap: 2rem; }
}

/* ========== EXPERIENCE SELECTOR ========== */
.experience-bar {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 3rem 1rem;
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
}

.experience-card {
  display: flex;
  align-items: center;
  gap: 0.65rem;
  padding: 0.55rem 1rem;
  border: none;
  background: var(--neuro-bg);
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
  overflow: visible;
  border-radius: 12px;
  box-shadow: var(--shadow-raised);
}

.experience-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 3px;
  height: 100%;
  background: var(--exp-color, var(--gold));
  transform: scaleY(0);
  transform-origin: bottom;
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  border-radius: 12px 0 0 12px;
}

.experience-card:hover::before,
.experience-card.active::before { transform: scaleY(1); }

.experience-card:hover {
  transform: translateY(-2px);
  box-shadow: 5px 5px 10px var(--neuro-dark), -5px -5px 10px var(--neuro-light);
}

.experience-card.active {
  box-shadow: var(--shadow-inset);
}

.experience-card-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
  transition: all 0.3s ease;
}

.experience-card.active .experience-card-dot {
  box-shadow: 0 0 8px currentColor;
}

.experience-card-info {
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
}

.experience-card-title {
  font-family: var(--font-body);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--ink);
  transition: color 0.3s ease;
}

.experience-card-meta {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.4);
  transition: color 0.3s ease;
}

.experience-card-close {
  display: none;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  font-size: 0.7rem;
  color: rgba(26,22,18,0.4);
  transition: color 0.2s ease;
}

.experience-card.active .experience-card-close { display: flex; }
.experience-card-close:hover { color: var(--ink); }

.experience-bar {
  flex-wrap: wrap;
  align-items: center;
}

.corridor-cards, .experience-cards {
  display: contents;
}

.experience-label {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(26,22,18,0.35);
  padding: 0.55rem 0.25rem;
  align-self: center;
}

.corridor-label {
  color: #2a8c8c;
  font-size: 0.65rem;
  font-weight: 600;
  letter-spacing: 0.15em;
}

.experience-label .muse-tag {
  font-size: 0.5rem;
  color: rgba(26,22,18,0.25);
  font-weight: 400;
  margin-left: 0.3rem;
}

/* ========== CORRIDOR INFO PANEL ========== */
.corridor-panel {
  position: absolute;
  bottom: 1.5rem;
  left: 1.5rem;
  z-index: 1000;
  background: rgba(26,22,18,0.92);
  border: 1px solid rgba(245,240,232,0.12);
  border-radius: 10px;
  padding: 0;
  max-width: 340px;
  max-height: 50vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  opacity: 0;
  transform: translateY(12px);
  pointer-events: none;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.corridor-panel.visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.corridor-panel-header {
  padding: 1.25rem 1.25rem 0.75rem;
  border-bottom: 1px solid rgba(245,240,232,0.08);
  flex-shrink: 0;
}

.corridor-panel-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 0.3rem;
}

.corridor-panel-title {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--cream);
  line-height: 1.2;
}

.corridor-panel-desc {
  font-size: 0.75rem;
  color: rgba(245,240,232,0.5);
  line-height: 1.5;
  margin-top: 0.5rem;
}

.corridor-panel-stops {
  overflow-y: auto;
  padding: 0.5rem 0;
  flex: 1;
  scrollbar-width: thin;
  scrollbar-color: rgba(245,240,232,0.15) transparent;
}

.corridor-panel-stops::-webkit-scrollbar { width: 3px; }
.corridor-panel-stops::-webkit-scrollbar-track { background: transparent; }
.corridor-panel-stops::-webkit-scrollbar-thumb { background: rgba(245,240,232,0.15); border-radius: 2px; }

.corridor-stop {
  display: flex;
  gap: 0.75rem;
  padding: 0.6rem 1.25rem;
  cursor: pointer;
  transition: background 0.2s ease;
}

.corridor-stop:hover { background: rgba(245,240,232,0.05); }

.corridor-stop-num {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  font-weight: 700;
  flex-shrink: 0;
  margin-top: 1px;
}

.corridor-stop-info { flex: 1; min-width: 0; }

.corridor-stop-name {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--cream);
  line-height: 1.3;
}

.corridor-stop-note {
  font-size: 0.7rem;
  color: rgba(245,240,232,0.4);
  line-height: 1.4;
  margin-top: 0.15rem;
}

.corridor-connector {
  padding: 0.15rem 1.25rem 0.15rem 3.1rem;
  font-family: var(--font-display);
  font-style: italic;
  font-size: 0.68rem;
  color: rgba(245,240,232,0.2);
  line-height: 1.4;
}

/* Tour button */
.corridor-tour-btn {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  background: none;
  border: 1px solid rgba(245,240,232,0.2);
  color: rgba(245,240,232,0.5);
  padding: 0.3rem 0.7rem;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
}

.corridor-tour-btn:hover {
  color: var(--cream);
  border-color: rgba(245,240,232,0.4);
}

.corridor-tour-btn.touring {
  color: var(--gold);
  border-color: var(--gold);
}

/* Stop number markers on map */
.stop-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.stop-badge:hover { transform: scale(1.15); }

/* ========== THEME TRANSITIONS ========== */
:root {
  --theme-accent: var(--gold);
  --theme-bg: var(--parchment);
  --theme-text: var(--ink);
  --theme-dimmed: rgba(26,22,18,0.12);
  --theme-route: var(--gold);
  --theme-transition: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

/* ========== ANIMATIONS ========== */
@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 1; }
}

.reveal {
  opacity: 0;
  transform: translateY(30px);
}

.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
  .section-intro { padding: 3rem 1.5rem; }
  .map-header { flex-direction: column; gap: 1rem; padding: 2rem 1.5rem 1rem; align-items: flex-start; }
  .map-filter-bar { justify-content: flex-start; }
  .experience-bar { padding: 0 1.5rem 1rem; }
  .corridor-panel {
    max-width: 100%;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 12px 12px 0 0;
    max-height: none;
    height: auto;
  }
  .corridor-panel-header {
    padding: 0.75rem 1rem 0.5rem;
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0 0.75rem;
    border-bottom: none;
  }
  .corridor-panel-eyebrow { margin-bottom: 0; }
  .corridor-panel-title { font-size: 0.9rem; }
  .corridor-panel-desc { display: none; }
  .corridor-panel-stops {
    display: flex;
    flex-direction: row;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding: 0 0.5rem 0.65rem;
    gap: 0.5rem;
    scrollbar-width: none;
  }
  .corridor-panel-stops::-webkit-scrollbar { display: none; }
  .corridor-stop {
    flex: 0 0 200px;
    scroll-snap-align: start;
    padding: 0.5rem 0.75rem;
    border: 1px solid rgba(245,240,232,0.1);
    border-radius: 8px;
    background: rgba(245,240,232,0.04);
  }
  .corridor-stop-note {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .corridor-connector { display: none; }
  .explore-section { padding: 3rem 1.5rem; }
  .explore-categories { grid-template-columns: repeat(3, 1fr); }
  .explore-item { grid-template-columns: 4px 44px 1fr 24px; gap: 0.5rem; padding: 0.75rem 0; }
  .explore-item-thumb { width: 44px; height: 44px; border-radius: 6px; }
  .explore-item-desc { display: none; }
}

@media (max-width: 600px) {
  .detail-panel { width: 100vw; }
  .map-container { height: 60vh; min-height: 400px; margin: 1rem; padding: 0.75rem; border-width: 3px; }
  .corridor-stop { flex: 0 0 170px; }
  .corridor-stop-name { font-size: 0.75rem; }
  .corridor-stop-note { font-size: 0.65rem; -webkit-line-clamp: 1; }
}
</style>
</head>
<body>

<!-- ====== HERO ====== -->
<section class="hero">
  <img src="img/Cultural+Assets+Banner.webp" alt="Nevada County Cultural Assets" class="hero-badge" fetchpriority="high">
  <div class="hero-content">
    <div class="hero-eyebrow">Nevada County, California</div>
    <h1 class="hero-title">The Culture of <em>Gold Country</em></h1>
    <p class="hero-sub">An interactive atlas of 687 cultural assets across the Sierra foothills.</p>
  </div>
</section>

<!-- ====== INTRO + CATEGORIES ====== -->
<section class="section-intro">
  <div class="col-left reveal">
    <div class="section-tag">01 / The Landscape</div>
    <h2 class="section-heading">A county where culture runs deeper than gold</h2>
    <div class="section-body">
      <p>Nevada County sits at the crossroads of Gold Rush history and living artistic tradition. Its towns, from the Victorian streets of Nevada City to the mountain corridors of Truckee, hold an extraordinary density of cultural assets.</p>
      <p>219 historic landmarks. 67 arts organizations. 52 annual fairs and festivals. Performance spaces carved from 19th-century foundries. Public art on every other block. This is not a county that treats culture as decoration. It is the infrastructure.</p>
    </div>
  </div>
  <div class="col-right reveal" style="transition-delay: 0.15s">
    <div class="section-tag">Categories</div>
    <div class="categories-grid" id="categoryGrid"></div>
  </div>
</section>

<!-- ====== MAP ====== -->
<section class="map-section" id="mapSection">
  <div class="map-header">
    <h2 class="map-title">Explore the Map</h2>
    <div class="map-filter-bar" id="filterBar"></div>
  </div>
  <div class="experience-bar" id="experienceBar">
    <span class="experience-label corridor-label">Cultural Corridors <span class="muse-tag">from MUSE '26</span></span>
    <div class="corridor-cards" id="corridorCards"></div>
    <span class="experience-label" style="margin-left: 0.5rem;">Explore</span>
    <div class="experience-cards" id="experienceCards"></div>
  </div>
  <div class="map-active-banner" id="mapActiveBanner">
    <div class="map-active-banner-inner">
      <div class="map-active-dot" id="mapActiveDot"></div>
      <div class="map-active-text">Showing <strong id="mapActiveCount">0</strong> <span id="mapActiveName">assets</span></div>
      <button class="map-active-clear" id="mapActiveClear">Clear filter</button>
    </div>
  </div>
  <div class="map-container">
    <div id="map"></div>
    <div class="corridor-panel" id="corridorPanel"></div>
  </div>
</section>

<!-- ====== MUSE EDITORIAL ====== -->
<div class="muse-section">
  <div class="muse-section-header reveal">
    <div class="muse-section-tag">from MUSE &rsquo;26 &middot; Issue 03</div>
    <h2 class="muse-section-title">Voices from Gold Country</h2>
  </div>

  <div class="muse-cards">

    <!-- Card 1: Cultural Corridors -->
    <details class="muse-card">
      <summary>
        <div class="muse-card-eyebrow">Routes &amp; Heritage</div>
        <div class="muse-card-title">Our Cultural Corridors</div>
        <div class="muse-card-quote">&ldquo;Nevada County&rsquo;s highways are more than just roads&mdash;they are cultural corridors, weaving together stories of California&rsquo;s First Peoples, Gold Rush miners, artists, and dreamers.&rdquo;</div>
        <div class="muse-card-author">&mdash; Jesse Locks</div>
        <span class="muse-card-toggle">Read more &darr;</span>
      </summary>
      <div class="muse-card-body">
        <p>Highways 49, 20, and 40&mdash;each with its own distinct heritage&mdash;form a network that connects the county&rsquo;s vibrant California Cultural Districts and historic landmarks, while offering breathtaking views of rolling foothills, towering pines, and High Sierra vistas.</p>
        <div class="muse-corridors">
          <details class="muse-corridor">
            <summary>Highway 40 &mdash; the Lincoln Highway</summary>
            <div class="muse-corridor-body">
              <p>Before Interstate 80 sped travelers through the Sierra, there was &ldquo;Old Highway 40&rdquo;&mdash;part of America&rsquo;s first transcontinental road. Ancient petroglyphs near Donner Summit, etched into granite thousands of years ago by the Martis People, offer a glimpse into the lives of the region&rsquo;s earliest inhabitants.</p>
              <p>From Clair Tappan Lodge to Rainbow Lodge, and the &ldquo;20 Mile Museum&rdquo; from Donner Lake to Cisco Grove, every curve tells a story of migration, innovation, and the spirit of the Sierra.</p>
            </div>
          </details>
          <details class="muse-corridor">
            <summary>Highway 20 &mdash; wagon trail to modern artery</summary>
            <div class="muse-corridor-body">
              <p>Stretching east to west, Highway 20 traces its roots to the 19th-century California Trail. The historic Washington Hotel, built in 1857, continues to serve as the community hub. Further south is Rough and Ready, founded in 1849&mdash;its mining heritage lives on in street names like Tornado, Gamble, and To Hell and Back Lane.</p>
            </div>
          </details>
          <details class="muse-corridor">
            <summary>Highway 49 &mdash; the golden chain of history</summary>
            <div class="muse-corridor-body">
              <p>The Golden Chain Highway links historic Gold Rush towns. Empire Mine State Historic Park in Grass Valley is one of the oldest, deepest, and richest gold mines in California. On the San Juan Ridge, the North Columbia Schoolhouse Cultural Center&mdash;a restored 1875 schoolhouse built by miners for their children&mdash;now hosts the internationally renowned Sierra Storytelling Festival.</p>
            </div>
          </details>
        </div>
      </div>
    </details>

    <!-- Card 2: Rural is the New Cool -->
    <details class="muse-card">
      <summary>
        <div class="muse-card-eyebrow">Community &amp; Place</div>
        <div class="muse-card-title">Rural is the New Cool</div>
        <div class="muse-card-quote">&ldquo;Few areas in Northern California, and beyond, can match the density of creativity we boast. Visitors come for our trails, wild spaces, and dreamy foothills&mdash;yet our cultural scene remains one of our most captivating surprises.&rdquo;</div>
        <div class="muse-card-author">&mdash; Diana Arbex, GV-NC Cultural District</div>
        <span class="muse-card-toggle">Read more &darr;</span>
      </summary>
      <div class="muse-card-body">
        <p>Our cultural richness is a reflection of the Nisenan and Washoe Peoples, whose traditions and enduring presence continue to shape our region. That richness is also carried forth by visionaries like Pulitzer Prize&ndash;winning poet Gary Snyder, whose arrival in the 1960s helped seed a generation of creatives.</p>
        <p>Drive north on Highway 49 to North Columbia Schoolhouse Cultural Center, and you will feel time slow down. Stop at Mother Truckers for one of its signature t-shirts illustrated by the late Randi Griffin. On arriving at &ldquo;the Schoolhouse,&rdquo; you&rsquo;ll find the Ridge&rsquo;s cultural epicenter&mdash;its walls hold decades of stories, folk music, poetry, and art.</p>
        <p>Back in Nevada City, download the Tree Tour in the STORY app and experience heirloom trees planted by Gold Rush horticulturist Felix Gillet. Visit the Crystal Rainbow Rock Shop, Winnie Superette&mdash;an Asian market hung with contemporary art&mdash;and Communal Caf&eacute; for coffee among locals.</p>
      </div>
    </details>

    <!-- Card 3: Art in Nature -->
    <details class="muse-card">
      <summary>
        <div class="muse-card-eyebrow">Arts &amp; Landscape</div>
        <div class="muse-card-title">Off the Wall: Art in Nature</div>
        <div class="muse-card-quote">&ldquo;Art in nature is such a beautiful process. We listen and we watch and we feel what is happening in the environment, and then we create from there.&rdquo;</div>
        <div class="muse-card-author">&mdash; Jenny Hale, place-based artist</div>
        <span class="muse-card-toggle">Read more &darr;</span>
      </summary>
      <div class="muse-card-body">
        <p>Each June, on trails across Nevada County, stars sway from low branches&mdash;the work of artists from Neighborhood Center of the Arts, created for Bear Yuba Land Trust&rsquo;s Summer Star Hike Challenge. With over 50 miles of trails and 26,000 acres conserved, that&rsquo;s quite the canvas.</p>
        <p>Since 2023, Art in Nature commissions have included Mekdela Maskal&rsquo;s naturally dyed prayer flags, Peggy Wright&rsquo;s nest of intertwined debris, and Andres Amador&rsquo;s &ldquo;Connections&rdquo;&mdash;a mycelium-like path through fallen trees on Hirschman&rsquo;s trail. For the Nisenan Gateway at Wildflower Ridge, artist Jenny Hale collaborated with the Nevada City Rancheria Nisenan Tribe to create a willow-and-cedar gateway honoring the land&rsquo;s original use as a Native trail.</p>
      </div>
    </details>

    <!-- Card 4: Living Like a Local - Truckee -->
    <details class="muse-card">
      <summary>
        <div class="muse-card-eyebrow">Truckee Cultural District</div>
        <div class="muse-card-title">Mountain Heart, Small-Town Soul</div>
        <div class="muse-card-quote">&ldquo;Our community&rsquo;s character is wrapped up in a certain sturdiness and a willingness to go out into nature regardless of how bad&mdash;or for some, how wonderful&mdash;that bad weather is.&rdquo;</div>
        <div class="muse-card-author">&mdash; Mayor Jan Zabriskie, Town of Truckee</div>
        <span class="muse-card-toggle">Read more &darr;</span>
      </summary>
      <div class="muse-card-body">
        <p>In 2024, Visit Truckee-Tahoe unveiled a new brand: &ldquo;Mountain Heart. Small Town Soul.&rdquo;&mdash;reflecting a community that is passionate and protective, pioneering and progressive, charming and a little funky. Visitors want to feel like locals, care about leaving a lighter footprint, and prefer scenery over a scene.</p>
        <p>For coffee, try Mountain Brew Coffee. For wine with a little funk, visit Truckee River Winery or The Pour House. Downtown galleries&mdash;Mountain Arts Collective, Piper J Gallery, Riverside Studios&mdash;offer a sampling of the creative talent in the district. And if you&rsquo;re staying up late, the historic Pastime Club vibrates after hours with pool, shuffleboard, and live entertainment.</p>
      </div>
    </details>

  </div>
</div>

<!-- ====== LIST ====== -->
<section class="explore-section" id="exploreSection">
  <div class="explore-header reveal">
    <div>
      <div class="section-tag">03 / Directory</div>
      <h2 class="section-heading">Explore by Category</h2>
    </div>
    <input type="text" class="explore-search" id="searchInput" placeholder="Search 687 assets by name, city, or keyword...">
  </div>
  <div class="explore-categories" id="exploreCats"></div>
  <div class="explore-list-wrapper" id="exploreListWrapper">
    <button class="explore-list-back" id="exploreListBack">All categories</button>
    <div class="explore-results-count" id="resultsCount"></div>
    <div class="explore-list" id="exploreList"></div>
    <button class="load-more-btn" id="loadMoreBtn">Show more</button>
  </div>
</section>

<!-- ====== DETAIL PANEL ====== -->
<div class="detail-panel-overlay" id="panelOverlay"></div>
<div class="detail-panel" id="detailPanel">
  <div class="detail-category-bar" id="detailCatBar"></div>
  <button class="detail-close" id="detailClose">&times;</button>
  <div id="detailHero"></div>
  <div class="detail-content">
    <div class="detail-tag" id="detailTag"></div>
    <div class="detail-experiences-badge" id="detailExpBadge"></div>
    <h3 class="detail-name" id="detailName"></h3>
    <div class="detail-description" id="detailDesc"></div>
    <div class="detail-meta" id="detailMeta"></div>
  </div>
</div>

<!-- ====== COLOPHON ====== -->
<footer class="colophon">
  <div class="colophon-inner">
    <div class="colophon-heading">About This Project</div>
    <div class="colophon-sections">
      <div>
        <div class="colophon-label">Data</div>
        687 cultural assets across 10 categories, sourced from the
        <a href="https://www.nevadacountyarts.org/cultural-asset-map" target="_blank">Nevada County Arts Council Cultural Asset Map</a>.
        Last updated December 2024.
      </div>
      <div>
        <div class="colophon-label">Editorial</div>
        Cultural Corridors content adapted from <em>MUSE</em> Issue 03, 2026 â€”
        "Our Cultural Corridors" by Jesse Locks.
        Illustration by Milada Belohlavek &amp; Ron Pitcher.
        Published by <a href="https://www.nevadacountyarts.org" target="_blank">Nevada County Arts Council</a>.
      </div>
      <div>
        <div class="colophon-label">Design</div>
        "Quiet Graphics" visual identity inspired by the Arts Council's
        original 2019 presentation. Watercolor illustrations honor
        that unrealized vision. Landscape basemap by <a href="https://www.maptiler.com" target="_blank">MapTiler</a>.
      </div>
      <div>
        <div class="colophon-label">Built by</div>
        <a href="https://www.thenorthstarhouse.org" target="_blank">Kaelen Jennings</a> â€” Development Consultant,
        North Star Historic Conservancy. Built with MapLibre GL JS, Turf.js, and GSAP.
        Assisted by Claude Code from Anthropic.
      </div>
    </div>
    <hr class="colophon-rule">
    <div class="colophon-bottom">
      <span>&copy; 2026 Nevada County Arts Council</span>
      <a href="index.html">View Leaflet version</a>
    </div>
  </div>
</footer>

<script src="https://unpkg.com/maplibre-gl@4.5.0/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
(function() {
  'use strict';

  // ============================================================
  // CONFIG
  // ============================================================
  const MAPTILER_KEY = 'LrWxywMynJX4Y3SvVJby';

  // SVG icons per category (inline, 18x18 viewBox)
  const ICONS = {
    'Historic Landmarks': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2L2 7h14L9 2z"/><rect x="4" y="7" width="10" height="8"/><rect x="7" y="10" width="4" height="5"/><line x1="2" y1="15" x2="16" y2="15"/></svg>',
    'Eat, Drink & Stay': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M3 2v6c0 2 2 3 4 3v5M14 2v4c0 1.5-1.5 2.5-3 2.5V14m0 0v2m0-2h0M14 2c0 2-1 3-3 3"/><circle cx="7" cy="14" r="1.5"/></svg>',
    'Arts Organizations': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><circle cx="9" cy="9" r="6"/><path d="M6 9c0-2 1.5-3.5 3-3.5s3 1.5 3 3.5-1.5 3.5-3 3.5S6 11 6 9z"/><path d="M9 5.5v7"/></svg>',
    'Cultural Resources': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="3" y="2" width="12" height="14" rx="1"/><line x1="6" y1="5" x2="12" y2="5"/><line x1="6" y1="8" x2="12" y2="8"/><line x1="6" y1="11" x2="10" y2="11"/></svg>',
    'Fairs & Festivals': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2l1.5 3 3.5.5-2.5 2.5.5 3.5L9 10l-3 1.5.5-3.5L4 5.5l3.5-.5z"/></svg>',
    'Galleries & Museums': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="2" y="4" width="14" height="11" rx="1"/><path d="M2 8h14"/><circle cx="7" cy="11" r="2"/><path d="M11 9l3 4"/></svg>',
    'Walks & Trails': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M3 15c2-3 4-5 6-8s3-3 6-5"/><circle cx="14" cy="4" r="1.5"/><path d="M5 13l-2 1m4-3l-2 1"/></svg>',
    'Public Art': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 3c-4 0-6 3-6 6 0 2 1 3 2 3 1.5 0 1.5-2 3-2s1.5 2 3 2 2-1 2-3c0-3-2-6-4-6z"/><circle cx="6" cy="8" r="1" fill="currentColor"/><circle cx="10" cy="7" r="1" fill="currentColor"/><circle cx="8" cy="10" r="1" fill="currentColor"/></svg>',
    'Performance Spaces': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M4 3h10l2 3v1H2V6l2-3z"/><path d="M3 7v7c0 1 1 2 2 2h8c1 0 2-1 2-2V7"/><path d="M7 10h4v3H7z"/></svg>',
    'Preservation & Culture': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2C6 2 3 5 3 9c0 3 2 5.5 4 6.5L9 16l2-.5c2-1 4-3.5 4-6.5 0-4-3-7-6-7z"/><path d="M9 6v4l2.5 1.5"/></svg>',
  };

  // Category config
  const CATS = {
    'Historic Landmarks':        { color: '#8b2500', short: 'Landmarks', watercolor: 'landmarks' },
    'Eat, Drink & Stay':         { color: '#a67830', short: 'Eat & Drink', watercolor: 'eat-drink' },
    'Arts Organizations':        { color: '#2d4a3e', short: 'Arts Orgs', watercolor: 'arts' },
    'Cultural Resources':        { color: '#3a5f7c', short: 'Cultural', watercolor: 'cultural' },
    'Fairs & Festivals':         { color: '#a0522d', short: 'Festivals', watercolor: 'fairs' },
    'Galleries & Museums':       { color: '#6b4e71', short: 'Galleries', watercolor: 'galleries' },
    'Walks & Trails':            { color: '#4a7c5f', short: 'Trails', watercolor: 'walks' },
    'Public Art':                { color: '#c45d3e', short: 'Public Art', watercolor: 'publicart' },
    'Performance Spaces':        { color: '#2a6496', short: 'Performance', watercolor: 'performance' },
    'Preservation & Culture':    { color: '#5c5020', short: 'Preservation', watercolor: 'preservation' },
  };

  // ============================================================
  // STATE
  // ============================================================
  let DATA = [];
  let IMAGE_DATA = {};
  let EXPERIENCES = [];
  let map;
  let activeCategory = null;
  let activeExperience = null;
  let cardElements = [];
  let listPage = 0;
  const LIST_PAGE_SIZE = 30;

  // Experience overlay state
  let corridorMarkers = [];
  let currentResolvedStops = [];
  let routeAnimationId = null;
  let tourTimeouts = [];
  let activeMoveendHandler = null;  // Track for cleanup
  let dotPulseTween = null;
  let originalPaintValues = {};

  // Hover popup
  let hoverPopup = null;
  let hoveredFeatureId = null;

  // ============================================================
  // LOAD DATA
  // ============================================================
  Promise.all([
    fetch('data.json').then(r => r.json()),
    fetch('image_data.json').then(r => r.json()).catch(() => ({})),
    fetch('experiences.json').then(r => r.json()).catch(() => [])
  ]).then(([data, images, experiences]) => {
    DATA = data;
    IMAGE_DATA = images;
    EXPERIENCES = experiences;
    init();
  }).catch(err => {
    console.error('Failed to load data:', err);
  });

  function init() {
    animateStats();
    buildCategoryGrid();
    buildFilterBar();
    buildExperienceSelector();
    initMapLibre();
    buildExploreCats();
    buildList();
    initScrollReveal();
    bindEvents();
    preloadWatercolors();
  }

  // Preload watercolor images â€” deferred until browser is idle
  function preloadWatercolors() {
    const load = () => {
      Object.values(CATS).forEach(cfg => {
        if (cfg.watercolor) {
          const img = new Image();
          img.src = `img/watercolor/${cfg.watercolor}.png`;
        }
      });
    };
    if ('requestIdleCallback' in window) {
      requestIdleCallback(load);
    } else {
      setTimeout(load, 3000);
    }
  }

  // ============================================================
  // STATS COUNTER (GSAP)
  // ============================================================
  function animateStats() {
    if (!document.getElementById('stat-total')) return;
    const cities = new Set(DATA.map(d => d.c).filter(Boolean));
    const targets = { total: 0, cats: 0, cities: 0 };
    gsap.to(targets, {
      total: DATA.length,
      cats: Object.keys(CATS).length,
      cities: cities.size,
      duration: 1.5,
      ease: 'power2.out',
      delay: 1.2,
      onUpdate: () => {
        document.getElementById('stat-total').textContent = Math.round(targets.total);
        document.getElementById('stat-cats').textContent = Math.round(targets.cats);
        document.getElementById('stat-cities').textContent = Math.round(targets.cities);
      }
    });
  }

  // ============================================================
  // UTILITY
  // ============================================================
  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  // ============================================================
  // EXPERIENCE SELECTOR
  // ============================================================
  function buildExperienceSelector() {
    const bar = document.getElementById('experienceBar');
    const corridorContainer = document.getElementById('corridorCards');
    const experienceContainer = document.getElementById('experienceCards');
    if (!EXPERIENCES.length) { bar.style.display = 'none'; return; }

    const corridors = EXPERIENCES.filter(e => e.type === 'corridor');
    const experiences = EXPERIENCES.filter(e => e.type !== 'corridor');

    // Hide sections if empty
    if (!corridors.length) {
      corridorContainer.previousElementSibling.style.display = 'none';
    }
    if (!experiences.length) {
      experienceContainer.previousElementSibling.style.display = 'none';
    }

    function makeCard(exp, container) {
      const card = document.createElement('div');
      card.className = 'experience-card';
      card.dataset.slug = exp.slug;
      card.style.setProperty('--exp-color', exp.color);
      card.innerHTML = `
        <div class="experience-card-dot" style="background:${exp.color}; color:${exp.color}"></div>
        <div class="experience-card-info">
          <div class="experience-card-title">${exp.title}</div>
          <div class="experience-card-meta">${exp.stops.length} stops</div>
        </div>
        <div class="experience-card-close">&times;</div>
      `;
      card.style.cssText += `--exp-color:${exp.color}`;
      card.addEventListener('click', () => {
        if (activeExperience && activeExperience.slug === exp.slug) {
          deactivateExperience();
        } else {
          activateExperience(exp);
        }
      });
      container.appendChild(card);
    }

    corridors.forEach(exp => makeCard(exp, corridorContainer));
    experiences.forEach(exp => makeCard(exp, experienceContainer));
  }

  // ============================================================
  // RESOLVE STOPS
  // ============================================================
  function resolveStops(experience) {
    return experience.stops.map(stop => {
      const match = DATA.find(d =>
        d.n && d.n.toLowerCase().includes(stop.asset.toLowerCase())
      );
      return { ...stop, data: match || null };
    }).filter(s => s.data);
  }

  // ============================================================
  // MAPLIBRE INITIALIZATION (Steps 2 + 3)
  // ============================================================
  function initMapLibre() {
    const styleUrl = MAPTILER_KEY !== 'GET_YOUR_FREE_KEY_AT_MAPTILER_COM'
      ? `https://api.maptiler.com/maps/landscape/style.json?key=${MAPTILER_KEY}`
      : {
          version: 8,
          name: 'Dark Fallback',
          sources: {
            'carto-dark': {
              type: 'raster',
              tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'],
              tileSize: 256,
              attribution: '&copy; OpenStreetMap &copy; CARTO'
            }
          },
          layers: [{
            id: 'carto-dark-layer',
            type: 'raster',
            source: 'carto-dark',
            minzoom: 0,
            maxzoom: 19
          }]
        };

    map = new maplibregl.Map({
      container: 'map',
      style: styleUrl,
      center: [-120.8, 39.22],
      zoom: 9,
      pitch: 35,
      bearing: -15,
      antialias: true,
      maxPitch: 70
    });

    map.addControl(new maplibregl.NavigationControl({
      visualizePitch: true
    }), 'top-right');

    hoverPopup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false,
      offset: 15,
      maxWidth: '280px'
    });

    map.on('load', () => {
      // Override style's pitch/bearing with our cinematic defaults
      map.jumpTo({ pitch: 35, bearing: -15 });

      // Add 3D terrain if MapTiler key is available
      if (MAPTILER_KEY !== 'GET_YOUR_FREE_KEY_AT_MAPTILER_COM') {
        map.addSource('terrain-dem', {
          type: 'raster-dem',
          url: `https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=${MAPTILER_KEY}`,
          encoding: 'mapbox'
        });

        // Add terrain control button (lets user toggle terrain)
        map.addControl(new maplibregl.TerrainControl({
          source: 'terrain-dem',
          exaggeration: 2
        }));

        // Enable terrain
        const isMobile = window.matchMedia('(max-width: 600px)').matches;
        if (!isMobile) {
          map.setTerrain({
            source: 'terrain-dem',
            exaggeration: 2
          });
        }

        map.addLayer({
          id: 'sky',
          type: 'sky',
          paint: {
            'sky-type': 'atmosphere',
            'sky-atmosphere-sun': [0.0, 90.0],
            'sky-atmosphere-sun-intensity': 15
          }
        });

        console.log('[Terrain] Source added, terrain set, exaggeration: 2');
        console.log('[Terrain] Current terrain:', map.getTerrain());

        // Store original paint values for theme reset
        storeOriginalPaints();
      }

      // Add asset data as GeoJSON
      addAssetLayers();
    });
  }

  function storeOriginalPaints() {
    try {
      const layers = map.getStyle().layers || [];
      layers.forEach(layer => {
        if (layer.paint) {
          originalPaintValues[layer.id] = { ...layer.paint };
        }
      });
    } catch (e) { /* style may not be fully loaded */ }
  }

  // ============================================================
  // ASSET LAYERS (Step 3)
  // ============================================================
  function addAssetLayers() {
    const geojson = {
      type: 'FeatureCollection',
      features: DATA.filter(d => d.x && d.y).map((d, i) => ({
        type: 'Feature',
        id: i,
        properties: {
          name: d.n || '',
          layer: d.l || '',
          city: d.c || '',
          address: d.a || '',
          description: d.d || '',
          phone: d.p || '',
          website: d.w || '',
          color: (CATS[d.l] || { color: '#999' }).color,
          idx: i
        },
        geometry: {
          type: 'Point',
          coordinates: [d.x, d.y]
        }
      }))
    };

    map.addSource('assets', { type: 'geojson', data: geojson });

    map.addLayer({
      id: 'assets-circle',
      type: 'circle',
      source: 'assets',
      paint: {
        'circle-radius': [
          'case',
          ['boolean', ['feature-state', 'hover'], false], 8,
          5
        ],
        'circle-color': ['get', 'color'],
        'circle-opacity': 0.85,
        'circle-stroke-color': 'rgba(255,255,255,0.6)',
        'circle-stroke-width': 1.5,
        'circle-stroke-opacity': 1
      }
    });

    // Hover interaction
    map.on('mousemove', 'assets-circle', (e) => {
      map.getCanvas().style.cursor = 'pointer';
      if (e.features.length === 0) return;
      const f = e.features[0];

      // Clear previous hover
      if (hoveredFeatureId !== null) {
        map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: false });
      }
      hoveredFeatureId = f.id;
      map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: true });

      // Build tooltip
      const props = f.properties;
      const cfg = CATS[props.layer] || { color: '#999' };
      const imgInfo = IMAGE_DATA[props.name];
      const wcSlug = cfg.watercolor || 'landmarks';
      const imgHTML = imgInfo
        ? `<img class="tooltip-img" src="${imgInfo.img}" alt="${imgInfo.alt || props.name}" onerror="this.parentNode.removeChild(this)">`
        : `<div class="tooltip-placeholder" style="background:linear-gradient(135deg, ${cfg.color}, ${cfg.color}dd)"><img src="img/watercolor/${wcSlug}.png" class="tooltip-watercolor" alt="" onerror="this.style.display='none'"></div>`;

      hoverPopup
        .setLngLat(e.lngLat)
        .setHTML(`${imgHTML}<div class="tooltip-body"><strong>${props.name}</strong><div class="tooltip-cat"><span class="tooltip-cat-dot" style="background:${cfg.color}"></span>${props.layer}</div>${props.city ? '<div class="tooltip-city">' + props.city + ', CA</div>' : ''}</div>`)
        .addTo(map);
    });

    map.on('mouseleave', 'assets-circle', () => {
      map.getCanvas().style.cursor = '';
      if (hoveredFeatureId !== null) {
        map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: false });
        hoveredFeatureId = null;
      }
      hoverPopup.remove();
    });

    // Click interaction â€” mobile: instant panel; desktop: cinematic flyTo + brief tooltip
    let clickFlyId = 0;
    const isMobileClick = window.matchMedia('(max-width: 900px)').matches;
    map.on('click', 'assets-circle', (e) => {
      if (e.features.length === 0) return;
      const f = e.features[0];
      const d = DATA.find(item => item.n === f.properties.name);
      if (!d) return;

      cancelTour();
      hoverPopup.remove();
      const thisClick = ++clickFlyId;

      if (isMobileClick) {
        // Mobile: open detail panel immediately, fly in background
        openDetail(d);
        map.flyTo({
          center: [d.x, d.y],
          zoom: 13,
          pitch: 45,
          duration: 800,
          essential: true
        });
      } else {
        // Desktop: cinematic fly, brief tooltip, then detail panel
        map.flyTo({
          center: [d.x, d.y],
          zoom: 14.5,
          pitch: 55,
          bearing: Math.random() * 40 - 20,
          duration: 1400,
          essential: true
        });
        map.once('moveend', () => {
          if (thisClick !== clickFlyId) return;
          showTourPopup({ data: d });
          setTimeout(() => {
            if (thisClick !== clickFlyId) return;
            openDetail(d);
            // Let tooltip linger while panel slides in, then fade it out
            setTimeout(() => hideTourPopup(), 600);
          }, 800);
        });
      }
    });

    // Apply initial filter if any
    updateMapFilters();
  }

  function updateMapFilters() {
    if (!map.getLayer('assets-circle')) return;

    if (activeCategory) {
      map.setFilter('assets-circle', ['==', ['get', 'layer'], activeCategory]);
      // Increase radius for filtered view
      map.setPaintProperty('assets-circle', 'circle-radius', [
        'case',
        ['boolean', ['feature-state', 'hover'], false], 10,
        7
      ]);
      // Fit bounds
      const filtered = DATA.filter(d => d.l === activeCategory && d.x && d.y);
      if (filtered.length) {
        const bounds = filtered.reduce((b, d) => b.extend([d.x, d.y]),
          new maplibregl.LngLatBounds([filtered[0].x, filtered[0].y], [filtered[0].x, filtered[0].y])
        );
        map.fitBounds(bounds, { padding: 50, maxZoom: 14 });
      }
    } else {
      map.setFilter('assets-circle', null);
      map.setPaintProperty('assets-circle', 'circle-radius', [
        'case',
        ['boolean', ['feature-state', 'hover'], false], 8,
        5
      ]);
      map.flyTo({ center: [-120.8, 39.22], zoom: 9, pitch: 0, bearing: 0, duration: 1000 });
    }
  }

  // ============================================================
  // EXPERIENCE SYSTEM (Steps 4 + 5 + 6)
  // ============================================================
  function activateExperience(experience) {
    activeExperience = experience;
    const resolved = resolveStops(experience);
    if (!resolved.length) return;
    currentResolvedStops = resolved;

    // Update selector UI
    document.querySelectorAll('.experience-card').forEach(c => {
      c.classList.toggle('active', c.dataset.slug === experience.slug);
    });

    // Pulse active card dot via GSAP
    if (dotPulseTween) dotPulseTween.kill();
    const activeDot = document.querySelector(`.experience-card.active .experience-card-dot`);
    if (activeDot) {
      dotPulseTween = gsap.to(activeDot, {
        boxShadow: `0 0 14px ${experience.color}`,
        scale: 1.2,
        duration: 0.7,
        yoyo: true,
        repeat: -1,
        ease: 'sine.inOut'
      });
    }

    // Apply theme if present
    if (experience.theme) applyTheme(experience.theme, experience.color);

    // Dim all asset markers
    if (map.getLayer('assets-circle')) {
      map.setPaintProperty('assets-circle', 'circle-opacity', 0.12);
      map.setPaintProperty('assets-circle', 'circle-stroke-opacity', 0.08);
      map.setPaintProperty('assets-circle', 'circle-radius', 3);
    }

    // Clear previous corridor layers
    clearCorridorLayers();

    // Build route coordinates
    const routeCoords = resolved.map(s => [s.data.x, s.data.y]);
    const routeColor = experience.theme ? experience.theme.routeColor : experience.color;
    const accentColor = experience.theme ? experience.theme.accent : experience.color;

    // Add glow route (static)
    map.addSource('corridor-route-glow', {
      type: 'geojson',
      data: { type: 'Feature', geometry: { type: 'LineString', coordinates: routeCoords } }
    });
    map.addLayer({
      id: 'corridor-route-glow',
      type: 'line',
      source: 'corridor-route-glow',
      paint: {
        'line-color': routeColor,
        'line-width': 10,
        'line-opacity': 0.12,
        'line-blur': 8
      }
    });

    // Add animated route (progressive reveal via Turf)
    map.addSource('corridor-route-animated', {
      type: 'geojson',
      data: { type: 'Feature', geometry: { type: 'LineString', coordinates: [routeCoords[0]] } }
    });
    map.addLayer({
      id: 'corridor-route-animated',
      type: 'line',
      source: 'corridor-route-animated',
      paint: {
        'line-color': routeColor,
        'line-width': 3,
        'line-opacity': 0.75,
        'line-dasharray': [2, 3]
      }
    });

    // Animate route drawing
    animateRoute(routeCoords, 2500);

    // Add stop circle layers
    const stopsGeoJSON = {
      type: 'FeatureCollection',
      features: resolved.map(s => ({
        type: 'Feature',
        properties: { order: s.order, name: s.data.n },
        geometry: { type: 'Point', coordinates: [s.data.x, s.data.y] }
      }))
    };

    map.addSource('corridor-stops', { type: 'geojson', data: stopsGeoJSON });

    // Glow ring
    map.addLayer({
      id: 'corridor-stops-glow',
      type: 'circle',
      source: 'corridor-stops',
      paint: {
        'circle-radius': 18,
        'circle-color': accentColor,
        'circle-opacity': 0.08
      }
    });

    // Main stop dot
    map.addLayer({
      id: 'corridor-stops-main',
      type: 'circle',
      source: 'corridor-stops',
      paint: {
        'circle-radius': 8,
        'circle-color': accentColor,
        'circle-opacity': 0.9,
        'circle-stroke-color': '#ffffff',
        'circle-stroke-width': 2
      }
    });

    // Add numbered badges as WebGL symbol layer (no DOM lag)
    map.addLayer({
      id: 'corridor-stops-labels',
      type: 'symbol',
      source: 'corridor-stops',
      layout: {
        'text-field': ['to-string', ['get', 'order']],
        'text-size': 11,
        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
        'text-allow-overlap': true,
        'text-ignore-placement': true,
        'text-anchor': 'center'
      },
      paint: {
        'text-color': '#ffffff',
        'text-halo-color': accentColor,
        'text-halo-width': 8,
        'text-halo-blur': 0
      }
    });

    // Click handler for stop labels
    map.on('click', 'corridor-stops-labels', (e) => {
      if (e.features && e.features[0]) {
        const name = e.features[0].properties.name;
        const match = DATA.find(d => d.n === name);
        if (match) openDetail(match);
      }
    });
    map.on('mouseenter', 'corridor-stops-labels', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'corridor-stops-labels', () => { map.getCanvas().style.cursor = ''; });

    // Build corridor info panel
    buildCorridorPanel(experience, resolved);

    // Fit map to corridor bounds with cinematic pitch
    const bounds = resolved.reduce((b, s) => b.extend([s.data.x, s.data.y]),
      new maplibregl.LngLatBounds([resolved[0].data.x, resolved[0].data.y], [resolved[0].data.x, resolved[0].data.y])
    );
    map.fitBounds(bounds, { padding: 80, maxZoom: 13, pitch: 30, duration: 2000 });
  }

  function animateRoute(coordinates, duration) {
    if (coordinates.length < 2) return;
    const line = turf.lineString(coordinates);
    const totalLength = turf.length(line, { units: 'kilometers' });
    if (totalLength === 0) return;

    const startTime = performance.now();

    function tick(timestamp) {
      const elapsed = timestamp - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic

      const currentLength = Math.max(totalLength * eased, 0.001);
      try {
        const sliced = turf.lineSliceAlong(line, 0, currentLength, { units: 'kilometers' });
        if (map.getSource('corridor-route-animated')) {
          map.getSource('corridor-route-animated').setData(sliced);
        }
      } catch (e) { /* turf edge case */ }

      if (progress < 1) {
        routeAnimationId = requestAnimationFrame(tick);
      }
    }

    routeAnimationId = requestAnimationFrame(tick);
  }

  // Tour popup (shown at each stop during auto-tour)
  let tourPopup = null;

  function showTourPopup(stop) {
    if (!tourPopup) {
      tourPopup = new maplibregl.Popup({ closeButton: false, closeOnClick: false, offset: 15, maxWidth: '260px' });
    }
    const d = stop.data;
    const cfg = CATS[d.l] || { color: '#999' };
    const imgInfo = IMAGE_DATA[d.n];
    const wcSlug = cfg.watercolor || 'landmarks';
    const imgHTML = imgInfo
      ? `<img class="tooltip-img" src="${imgInfo.img}" alt="${imgInfo.alt || d.n}" onerror="this.parentNode.removeChild(this)">`
      : `<div class="tooltip-placeholder" style="background:linear-gradient(135deg, ${cfg.color}, ${cfg.color}dd)"><img src="img/watercolor/${wcSlug}.png" class="tooltip-watercolor" alt="" onerror="this.style.display='none'"></div>`;
    const stopNum = stop.index != null ? `<span style="background:${cfg.color};color:#fff;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;margin-right:0.3rem;">${stop.index + 1}</span>` : '';
    tourPopup
      .setLngLat([d.x, d.y])
      .setHTML(`${imgHTML}<div class="tooltip-body"><strong>${stopNum}${d.n}</strong><div class="tooltip-cat"><span class="tooltip-cat-dot" style="background:${cfg.color}"></span>${d.l}</div>${d.c ? '<div class="tooltip-city">' + d.c + ', CA</div>' : ''}</div>`)
      .addTo(map);
  }

  function hideTourPopup() {
    if (tourPopup) tourPopup.remove();
  }

  // Cinematic flyTo for stops
  function flyToStop(stop, index) {
    const resolved = currentResolvedStops;
    let bearing = 0;

    // Calculate bearing toward next stop
    if (index < resolved.length - 1) {
      const next = resolved[index + 1];
      bearing = turf.bearing(
        turf.point([stop.data.x, stop.data.y]),
        turf.point([next.data.x, next.data.y])
      );
    } else if (index > 0) {
      const prev = resolved[index - 1];
      bearing = turf.bearing(
        turf.point([prev.data.x, prev.data.y]),
        turf.point([stop.data.x, stop.data.y])
      );
    }

    const mobile = window.matchMedia('(max-width: 900px)').matches;
    map.flyTo({
      center: [stop.data.x, stop.data.y],
      zoom: mobile ? 13 : 14.5,
      pitch: mobile ? 45 : 55,
      bearing: bearing,
      duration: mobile ? 1200 : 2000,
      essential: true
    });
  }

  // Auto-tour
  async function autoTour(resolved) {
    // Cancel any existing tour
    cancelTour();

    const tourBtn = document.querySelector('.corridor-tour-btn');
    if (tourBtn) tourBtn.classList.add('touring');

    for (let i = 0; i < resolved.length; i++) {
      hideTourPopup();
      const stop = resolved[i];
      stop.index = i;
      flyToStop(stop, i);

      // Wait for the camera to arrive, then show tooltip
      await new Promise(r => {
        const onEnd = () => {
          map.off('moveend', onEnd);
          activeMoveendHandler = null;  // Clear reference
          r();
        };
        activeMoveendHandler = onEnd;  // Store reference
        map.on('moveend', onEnd);
        // Safety timeout in case moveend doesn't fire
        const mobile = window.matchMedia('(max-width: 900px)').matches;
        const tid = setTimeout(() => {
          map.off('moveend', onEnd);
          activeMoveendHandler = null;  // Clear reference
          r();
        }, mobile ? 2000 : 4000);
        tourTimeouts.push(tid);
      });

      showTourPopup(stop);

      // Dwell at the stop with tooltip visible
      await new Promise(r => {
        const mobile = window.matchMedia('(max-width: 900px)').matches;
        const tid = setTimeout(r, mobile ? 1500 : 2500);
        tourTimeouts.push(tid);
      });
    }

    hideTourPopup();

    // Zoom out to show full corridor
    const bounds = resolved.reduce((b, s) => b.extend([s.data.x, s.data.y]),
      new maplibregl.LngLatBounds([resolved[0].data.x, resolved[0].data.y], [resolved[0].data.x, resolved[0].data.y])
    );
    map.fitBounds(bounds, { padding: 60, pitch: 30, duration: 2000 });

    if (tourBtn) tourBtn.classList.remove('touring');
  }

  function cancelTour() {
    tourTimeouts.forEach(t => clearTimeout(t));
    tourTimeouts = [];
    hideTourPopup();

    // CRITICAL: Remove any active moveend listener
    if (activeMoveendHandler) {
      map.off('moveend', activeMoveendHandler);
      activeMoveendHandler = null;
    }

    const tourBtn = document.querySelector('.corridor-tour-btn');
    if (tourBtn) tourBtn.classList.remove('touring');
  }

  function deactivateExperience() {
    activeExperience = null;
    currentResolvedStops = [];
    cancelTour();

    // Update selector UI
    document.querySelectorAll('.experience-card').forEach(c => c.classList.remove('active'));

    // Kill pulse
    if (dotPulseTween) { dotPulseTween.kill(); dotPulseTween = null; }
    document.querySelectorAll('.experience-card-dot').forEach(d => {
      gsap.set(d, { clearProps: 'all' });
    });

    // Remove theme
    removeTheme();

    // Remove corridor layers
    clearCorridorLayers();

    // Hide panel with GSAP
    const panel = document.getElementById('corridorPanel');
    gsap.to(panel, {
      opacity: 0, y: 12, duration: 0.3,
      onComplete: () => {
        panel.classList.remove('visible');
        panel.style.cssText = '';
      }
    });

    // Restore asset markers
    if (map.getLayer('assets-circle')) {
      map.setPaintProperty('assets-circle', 'circle-opacity', 0.85);
      map.setPaintProperty('assets-circle', 'circle-stroke-opacity', 1);
      updateMapFilters();
    }
  }

  function clearCorridorLayers() {
    // Cancel route animation
    if (routeAnimationId) { cancelAnimationFrame(routeAnimationId); routeAnimationId = null; }

    // Remove MapLibre layers and sources
    ['corridor-route-glow', 'corridor-route-animated', 'corridor-stops-labels', 'corridor-stops-glow', 'corridor-stops-main'].forEach(id => {
      if (map.getLayer(id)) map.removeLayer(id);
    });
    ['corridor-route-glow', 'corridor-route-animated', 'corridor-stops'].forEach(id => {
      if (map.getSource(id)) map.removeSource(id);
    });
  }

  // ============================================================
  // THEME SWITCHING (Step 7)
  // ============================================================
  function applyTheme(theme, fallbackColor) {
    const root = document.documentElement;
    root.style.setProperty('--theme-accent', theme.accent || fallbackColor);
    root.style.setProperty('--theme-route', theme.routeColor || fallbackColor);

    // MapLibre basemap paint manipulation â€” warm the map tiles
    if (theme.basemap === 'terrain' && MAPTILER_KEY !== 'GET_YOUR_FREE_KEY_AT_MAPTILER_COM') {
      try {
        const layers = map.getStyle().layers || [];
        layers.forEach(layer => {
          if (layer.id === 'background' || layer.id.includes('land') || layer.id.includes('earth')) {
            if (layer.type === 'background') {
              map.setPaintProperty(layer.id, 'background-color', theme.background || '#f2ece4');
            } else if (layer.type === 'fill') {
              map.setPaintProperty(layer.id, 'fill-color', theme.background || '#f2ece4');
            }
          }
          if (layer.id.includes('water') && layer.type === 'fill') {
            map.setPaintProperty(layer.id, 'fill-color', '#b8d4e3');
          }
          if (layer.type === 'symbol') {
            try { map.setPaintProperty(layer.id, 'text-color', theme.text || '#2c2c2c'); } catch (e) {}
          }
        });
      } catch (e) { /* style manipulation error */ }
    }

    // Add subtle teal tint to map section to signal corridor mode
    const mapSection = document.getElementById('mapSection');
    const accentColor = theme.accent || fallbackColor;
    mapSection.style.background = hexToRgba(accentColor, 0.06);
    mapSection.classList.add('themed');
  }

  function removeTheme() {
    const root = document.documentElement;
    root.style.removeProperty('--theme-accent');
    root.style.removeProperty('--theme-route');

    // Restore MapLibre basemap
    if (MAPTILER_KEY !== 'GET_YOUR_FREE_KEY_AT_MAPTILER_COM') {
      try {
        const layers = map.getStyle().layers || [];
        layers.forEach(layer => {
          if (originalPaintValues[layer.id]) {
            const orig = originalPaintValues[layer.id];
            if (layer.type === 'background' && orig['background-color']) {
              map.setPaintProperty(layer.id, 'background-color', orig['background-color']);
            }
            if (layer.type === 'fill' && orig['fill-color']) {
              map.setPaintProperty(layer.id, 'fill-color', orig['fill-color']);
            }
            if (layer.type === 'symbol' && orig['text-color']) {
              try { map.setPaintProperty(layer.id, 'text-color', orig['text-color']); } catch (e) {}
            }
          }
        });
      } catch (e) { /* style manipulation error */ }
    }

    // Restore DOM
    document.getElementById('mapSection').style.background = '';
    document.getElementById('mapSection').classList.remove('themed');
  }

  // ============================================================
  // CORRIDOR INFO PANEL (GSAP animated)
  // ============================================================
  function buildCorridorPanel(experience, resolved) {
    const panel = document.getElementById('corridorPanel');
    const accentColor = experience.theme ? experience.theme.accent : experience.color;

    let stopsHTML = '';
    resolved.forEach((stop, i) => {
      stopsHTML += `
        <div class="corridor-stop" data-stop-idx="${i}">
          <div class="corridor-stop-num" style="background:${accentColor};color:#fff;">${stop.order}</div>
          <div class="corridor-stop-info">
            <div class="corridor-stop-name">${stop.data.n}</div>
            <div class="corridor-stop-note">${stop.note}</div>
          </div>
        </div>
      `;
      if (stop.connector && i < resolved.length - 1) {
        stopsHTML += `<div class="corridor-connector" style="color:${hexToRgba(accentColor, 0.4)}">${stop.connector}</div>`;
      }
    });

    panel.innerHTML = `
      <div class="corridor-panel-header">
        <div class="corridor-panel-eyebrow" style="color:${accentColor}">Curated Experience &bull; ${resolved.length} stops</div>
        <div class="corridor-panel-title">${experience.title}</div>
        <button class="corridor-tour-btn">&#9654; Tour</button>
        <div class="corridor-panel-desc">${experience.description}</div>
      </div>
      <div class="corridor-panel-stops">${stopsHTML}</div>
    `;

    // Bind stop clicks to cinematic flyTo
    panel.querySelectorAll('.corridor-stop').forEach(el => {
      el.addEventListener('click', () => {
        const idx = parseInt(el.dataset.stopIdx);
        const stop = resolved[idx];
        if (stop && stop.data) {
          flyToStop(stop, idx);
        }
      });
    });

    // Bind tour button
    const tourBtn = panel.querySelector('.corridor-tour-btn');
    if (tourBtn) {
      tourBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (tourBtn.classList.contains('touring')) {
          cancelTour();
        } else {
          autoTour(resolved);
        }
      });
    }

    // GSAP panel entrance
    panel.classList.add('visible');
    gsap.fromTo(panel,
      { opacity: 0, y: 20 },
      { opacity: 1, y: 0, duration: 0.5, ease: 'power3.out' }
    );

    // Stagger stop items
    gsap.fromTo('.corridor-stop',
      { opacity: 0, x: -10 },
      { opacity: 1, x: 0, duration: 0.3, stagger: 0.06, ease: 'power2.out', delay: 0.3 }
    );
  }

  // ============================================================
  // CATEGORY GRID
  // ============================================================
  function buildCategoryGrid() {
    const grid = document.getElementById('categoryGrid');
    const counts = {};
    DATA.forEach(d => { counts[d.l] = (counts[d.l] || 0) + 1; });

    const sorted = Object.entries(CATS).sort((a, b) => (counts[b[0]] || 0) - (counts[a[0]] || 0));

    sorted.forEach(([name, cfg]) => {
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.dataset.category = name;
      card.style.setProperty('--cat-color', cfg.color);
      const wcSlug = cfg.watercolor || 'landmarks';
      card.innerHTML = `
        <div class="cat-icon" style="background:${hexToRgba(cfg.color, 0.1)}; color:${cfg.color}">
          <img src="img/watercolor/${wcSlug}.png" alt="" class="cat-icon-watercolor" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
          <span class="cat-icon-svg" style="display:none">${ICONS[name] || ''}</span>
        </div>
        <div class="cat-card-info">
          <div class="cat-card-count">${counts[name] || 0}</div>
          <div class="cat-card-name">${name}</div>
          <div class="cat-card-active-label">Filtered</div>
        </div>
      `;
      card.addEventListener('click', () => {
        setCategory(name === activeCategory ? null : name);
        document.getElementById('mapSection').scrollIntoView({ behavior: 'smooth' });
      });
      grid.appendChild(card);
      cardElements.push({ el: card, name });
    });
  }

  // ============================================================
  // FILTER BAR
  // ============================================================
  function buildFilterBar() {
    const bar = document.getElementById('filterBar');

    const allPill = document.createElement('button');
    allPill.className = 'filter-pill all-pill active';
    allPill.textContent = 'All';
    allPill.addEventListener('click', () => setCategory(null));
    bar.appendChild(allPill);

    Object.entries(CATS).forEach(([name, cfg]) => {
      const pill = document.createElement('button');
      pill.className = 'filter-pill';
      pill.dataset.category = name;
      pill.style.setProperty('--pill-color', cfg.color);
      pill.innerHTML = `<span class="filter-dot" style="background:${cfg.color}"></span>${cfg.short}`;
      pill.addEventListener('click', () => setCategory(name === activeCategory ? null : name));
      bar.appendChild(pill);
    });
  }

  // ============================================================
  // ACTIVE BANNER
  // ============================================================
  function updateActiveBanner() {
    const banner = document.getElementById('mapActiveBanner');
    if (activeCategory) {
      const cfg = CATS[activeCategory];
      const count = DATA.filter(d => d.l === activeCategory).length;
      document.getElementById('mapActiveDot').style.background = cfg.color;
      document.getElementById('mapActiveCount').textContent = count;
      document.getElementById('mapActiveName').textContent = activeCategory;
      banner.classList.add('visible');
    } else {
      banner.classList.remove('visible');
    }
  }

  // ============================================================
  // SET CATEGORY
  // ============================================================
  function setCategory(cat) {
    activeCategory = cat;

    document.querySelectorAll('.filter-pill').forEach(p => {
      if (p.classList.contains('all-pill')) {
        p.classList.toggle('active', cat === null);
      } else {
        p.classList.toggle('active', p.dataset.category === cat);
      }
    });

    cardElements.forEach(({ el, name }) => {
      el.classList.toggle('active', name === cat);
      if (cat && name !== cat) {
        el.style.opacity = '0.45';
      } else {
        el.style.opacity = '1';
      }
    });

    updateActiveBanner();
    updateMapFilters();
    listPage = 0;
    buildList();
  }

  // ============================================================
  // DETAIL PANEL (GSAP animated)
  // ============================================================
  function openDetail(d) {
    const panel = document.getElementById('detailPanel');
    const overlay = document.getElementById('panelOverlay');
    const cfg = CATS[d.l] || { color: '#999' };

    document.getElementById('detailCatBar').style.background = cfg.color;

    const heroEl = document.getElementById('detailHero');
    const imgInfo = IMAGE_DATA[d.n];
    const wcSlug = cfg.watercolor || 'landmarks';
    if (imgInfo) {
      heroEl.innerHTML = `<img class="detail-hero-img" src="${imgInfo.img}" alt="${imgInfo.alt || d.n}" onerror="this.parentNode.innerHTML='<div class=\\'detail-hero-placeholder\\' style=\\'background:linear-gradient(135deg, ${cfg.color}40, ${cfg.color}20)\\'><img src=\\'img/watercolor/${wcSlug}.png\\' class=\\'detail-hero-watercolor\\' alt=\\'\\'></div>'">`;
    } else {
      heroEl.innerHTML = `<div class="detail-hero-placeholder" style="background:linear-gradient(135deg, ${cfg.color}40, ${cfg.color}20)"><img src="img/watercolor/${wcSlug}.png" class="detail-hero-watercolor" alt="" onerror="this.style.display='none'"></div>`;
    }

    document.getElementById('detailTag').innerHTML = `<span style="display:inline-flex;align-items:center;gap:0.4rem;">${ICONS[d.l] ? '<span style="width:14px;height:14px;display:inline-block;vertical-align:middle;">' + ICONS[d.l] + '</span>' : ''} ${d.l}</span>`;
    document.getElementById('detailTag').style.color = cfg.color;

    // "In X Experiences" badge
    const expBadge = document.getElementById('detailExpBadge');
    const matchingExps = EXPERIENCES.filter(exp => exp.stops.some(s => s.asset === d.n));
    if (matchingExps.length > 0) {
      expBadge.innerHTML = matchingExps.map(exp => {
        const expColor = exp.theme ? exp.theme.accent : exp.color;
        return `<span class="detail-exp-pill" style="color:${expColor}" data-exp-slug="${exp.slug}"><span class="detail-exp-pill-dot" style="background:${expColor}"></span>${exp.title}</span>`;
      }).join('');
      expBadge.querySelectorAll('.detail-exp-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          closeDetail();
          const slug = pill.dataset.expSlug;
          const exp = EXPERIENCES.find(e => e.slug === slug);
          if (exp) {
            activateExperience(exp);
            document.getElementById('mapSection').scrollIntoView({ behavior: 'smooth' });
          }
        });
      });
    } else {
      expBadge.innerHTML = '';
    }

    document.getElementById('detailName').textContent = d.n;
    document.getElementById('detailDesc').textContent = d.d || 'No description available.';
    document.getElementById('detailDesc').style.display = d.d ? 'block' : 'none';

    let metaHTML = '';
    if (d.a) metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9675;</span><div class="detail-meta-value">${d.a}${d.c ? ', ' + d.c + ', CA' : ''}</div></div>`;
    if (d.p) metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9743;</span><div class="detail-meta-value"><a href="tel:${d.p}">${d.p}</a></div></div>`;
    if (d.w) {
      let url = d.w.trim();
      if (!url.startsWith('http')) url = 'https://' + url;
      const display = url.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '');
      metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9741;</span><div class="detail-meta-value"><a href="${url}" target="_blank" rel="noopener">${display}</a></div></div>`;
    }
    if (d.x && d.y) {
      metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9906;</span><div class="detail-meta-value"><a href="https://www.google.com/maps?q=${d.y},${d.x}" target="_blank" rel="noopener">View on Google Maps</a></div></div>`;
    }

    document.getElementById('detailMeta').innerHTML = metaHTML;

    // "View on map" fly-to button
    const existingFlyto = panel.querySelector('.detail-flyto');
    if (existingFlyto) existingFlyto.remove();
    if (d.x && d.y) {
      const flyBtn = document.createElement('button');
      flyBtn.className = 'detail-flyto';
      flyBtn.innerHTML = '<span class="detail-flyto-icon">&#9906;</span> View on map';
      flyBtn.addEventListener('click', () => {
        closeDetail();
        document.getElementById('mapSection').scrollIntoView({ behavior: 'smooth' });
        setTimeout(() => {
          map.flyTo({ center: [d.x, d.y], zoom: 15, pitch: 50, bearing: -20, duration: 2000 });
        }, 600);
      });
      document.querySelector('.detail-content').appendChild(flyBtn);
    }

    // GSAP slide-in
    overlay.classList.add('open');
    gsap.to(overlay, { opacity: 1, duration: 0.3 });
    gsap.to(panel, { right: 0, duration: 0.45, ease: 'power3.out' });
    panel.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeDetail() {
    const panel = document.getElementById('detailPanel');
    const overlay = document.getElementById('panelOverlay');

    gsap.to(panel, {
      right: -460, duration: 0.35, ease: 'power2.in',
      onComplete: () => panel.classList.remove('open')
    });
    gsap.to(overlay, {
      opacity: 0, duration: 0.25,
      onComplete: () => { overlay.classList.remove('open'); }
    });
    document.body.style.overflow = '';
  }

  // ============================================================
  // EXPLORE LIST
  // ============================================================
  function getFilteredData() {
    let filtered = activeCategory ? DATA.filter(d => d.l === activeCategory) : [...DATA];
    const query = (document.getElementById('searchInput').value || '').toLowerCase().trim();
    if (query) {
      filtered = filtered.filter(d =>
        (d.n && d.n.toLowerCase().includes(query)) ||
        (d.c && d.c.toLowerCase().includes(query)) ||
        (d.d && d.d.toLowerCase().includes(query)) ||
        (d.l && d.l.toLowerCase().includes(query))
      );
    }
    return filtered;
  }

  function buildExploreCats() {
    const grid = document.getElementById('exploreCats');
    if (!grid) return;
    grid.innerHTML = '';
    const counts = {};
    DATA.forEach(d => { counts[d.l] = (counts[d.l] || 0) + 1; });
    Object.entries(CATS).forEach(([name, cfg]) => {
      const card = document.createElement('div');
      card.className = 'explore-cat-card';
      card.style.setProperty('--card-color', cfg.color);
      card.innerHTML = `
        <img class="explore-cat-card-img" src="img/watercolor/${cfg.watercolor || 'landmarks'}.png" alt="">
        <div class="explore-cat-card-name">${cfg.short || name}</div>
        <div class="explore-cat-card-count">${counts[name] || 0} places</div>
      `;
      card.addEventListener('click', () => {
        exploreSetCategory(name);
      });
      grid.appendChild(card);
    });
  }

  function exploreSetCategory(cat) {
    const wrapper = document.getElementById('exploreListWrapper');
    const catGrid = document.getElementById('exploreCats');
    const cards = document.querySelectorAll('.explore-cat-card');

    if (cat) {
      activeCategory = cat;
      wrapper.classList.add('visible');
      catGrid.style.display = 'none';
      cards.forEach(c => c.classList.remove('active'));
      // Also sync map filter pills
      setCategory(cat);
    } else {
      activeCategory = null;
      wrapper.classList.remove('visible');
      catGrid.style.display = '';
      document.getElementById('searchInput').value = '';
      setCategory(null);
    }
    listPage = 0;
    buildList();
    document.getElementById('exploreSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function buildList() {
    const list = document.getElementById('exploreList');
    const wrapper = document.getElementById('exploreListWrapper');
    const searchVal = document.getElementById('searchInput').value.trim();

    // Show list if search is active even without category
    if (searchVal && !activeCategory) {
      wrapper.classList.add('visible');
      document.getElementById('exploreCats').style.display = 'none';
    }

    const filtered = getFilteredData();
    const end = (listPage + 1) * LIST_PAGE_SIZE;
    const visible = filtered.slice(0, end);

    document.getElementById('resultsCount').textContent =
      `Showing ${Math.min(end, filtered.length)} of ${filtered.length} assets` +
      (activeCategory ? ` in ${activeCategory}` : '');

    list.innerHTML = '';
    visible.forEach(d => {
      const cfg = CATS[d.l] || { color: '#999' };
      const imgInfo = IMAGE_DATA[d.n];
      const wcSlug = cfg.watercolor || 'landmarks';
      const thumbSrc = imgInfo ? imgInfo.img : `img/watercolor/${wcSlug}.png`;
      const item = document.createElement('div');
      item.className = 'explore-item';
      item.style.setProperty('--row-color', cfg.color);
      const desc = d.d ? d.d.replace(/<[^>]*>/g, '').slice(0, 120) : '';
      item.innerHTML = `
        <div class="explore-item-bar" style="background:${cfg.color}"></div>
        <img class="explore-item-thumb" src="${thumbSrc}" alt="" loading="lazy" onerror="this.src='img/watercolor/${wcSlug}.png'">
        <div class="explore-item-info">
          <div class="explore-item-name">${d.n}</div>
          ${desc ? `<div class="explore-item-desc">${desc}</div>` : ''}
          <div class="explore-item-meta">
            <span class="explore-item-city">${d.c || d.a || ''}</span>
            <span class="explore-item-cat" style="color:${cfg.color}">
              <span class="explore-item-cat-dot" style="background:${cfg.color}"></span>
              ${cfg.short || d.l}
            </span>
          </div>
        </div>
        <span class="explore-item-arrow">&rarr;</span>
      `;
      item.addEventListener('click', () => openDetail(d));
      list.appendChild(item);
    });

    document.getElementById('loadMoreBtn').style.display = end >= filtered.length ? 'none' : 'block';

    // GSAP staggered entrance
    gsap.fromTo('#exploreList .explore-item',
      { opacity: 0, x: -8 },
      { opacity: 1, x: 0, duration: 0.2, stagger: 0.015, ease: 'power2.out' }
    );
  }

  // ============================================================
  // EVENTS
  // ============================================================
  function bindEvents() {
    document.getElementById('detailClose').addEventListener('click', closeDetail);
    document.getElementById('panelOverlay').addEventListener('click', closeDetail);
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });

    document.getElementById('searchInput').addEventListener('input', () => {
      const val = document.getElementById('searchInput').value.trim();
      const wrapper = document.getElementById('exploreListWrapper');
      const catGrid = document.getElementById('exploreCats');
      if (val) {
        wrapper.classList.add('visible');
        catGrid.style.display = 'none';
      } else if (!activeCategory) {
        wrapper.classList.remove('visible');
        catGrid.style.display = '';
      }
      listPage = 0;
      buildList();
    });

    document.getElementById('loadMoreBtn').addEventListener('click', () => {
      listPage++;
      buildList();
    });

    document.getElementById('exploreListBack').addEventListener('click', () => {
      exploreSetCategory(null);
    });

    document.getElementById('mapActiveClear').addEventListener('click', () => {
      setCategory(null);
    });
  }

  // ============================================================
  // SCROLL REVEAL (GSAP)
  // ============================================================
  function initScrollReveal() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          gsap.fromTo(entry.target,
            { opacity: 0, y: 30 },
            { opacity: 1, y: 0, duration: 0.8, ease: 'power3.out' }
          );
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.15 });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
  }

})();
</script>
</body>
</html>
