<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Culture of Nevada County</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --ink: #1a1612;
  --cream: #f5f0e8;
  --parchment: #ede6d8;
  --gold: #c8943e;
  --gold-bright: #daa94e;
  --rust: #a0522d;
  --deep-green: #2d4a3e;
  --slate: #4a4a4a;
  --red-accent: #8b2500;
  --blue-wash: #3a5f7c;

  --cat-landmarks: #8b2500;
  --cat-eat: #c8943e;
  --cat-arts: #2d4a3e;
  --cat-cultural: #3a5f7c;
  --cat-fairs: #a0522d;
  --cat-galleries: #6b4e71;
  --cat-walks: #4a7c5f;
  --cat-publicart: #c45d3e;
  --cat-performance: #2a6496;
  --cat-preservation: #7a6b3a;

  --font-display: 'Playfair Display', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}

html { scroll-behavior: smooth; }

body {
  font-family: var(--font-body);
  background: var(--cream);
  color: var(--ink);
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ========== HERO ========== */
.hero {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  padding: 4rem 3rem;
  position: relative;
  background: var(--ink);
  overflow: hidden;
}

.hero::before {
  content: '';
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse 120% 80% at 80% 20%, rgba(200,148,62,0.15) 0%, transparent 60%),
    radial-gradient(ellipse 80% 60% at 20% 80%, rgba(45,74,62,0.2) 0%, transparent 50%),
    linear-gradient(175deg, rgba(26,22,18,0) 40%, rgba(26,22,18,0.9) 100%);
  z-index: 1;
}

.hero::after {
  content: '';
  position: absolute;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  z-index: 2;
  pointer-events: none;
}

.hero-content { position: relative; z-index: 3; max-width: 1400px; }

.hero-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 1.5rem;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeUp 0.8s ease 0.3s forwards;
}

.hero-title {
  font-family: var(--font-display);
  font-weight: 900;
  font-size: clamp(3.5rem, 10vw, 9rem);
  line-height: 0.92;
  color: var(--cream);
  margin-bottom: 2rem;
  max-width: 900px;
  opacity: 0;
  transform: translateY(30px);
  animation: fadeUp 1s ease 0.5s forwards;
}

.hero-title em {
  font-style: italic;
  color: var(--gold);
  display: inline-block;
}

.hero-sub {
  font-size: clamp(1rem, 2vw, 1.35rem);
  line-height: 1.6;
  color: rgba(245,240,232,0.65);
  max-width: 560px;
  font-weight: 300;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeUp 0.8s ease 0.8s forwards;
}

.hero-stats {
  display: flex;
  gap: 3rem;
  margin-top: 4rem;
  padding-top: 2rem;
  border-top: 1px solid rgba(200,148,62,0.25);
  opacity: 0;
  animation: fadeUp 0.8s ease 1.1s forwards;
}

.hero-stat-number {
  font-family: var(--font-display);
  font-size: 3.5rem;
  font-weight: 700;
  color: var(--gold-bright);
  line-height: 1;
}

.hero-stat-label {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: rgba(245,240,232,0.4);
  margin-top: 0.5rem;
}

.scroll-cue {
  position: absolute;
  bottom: 2rem;
  right: 3rem;
  z-index: 3;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  opacity: 0;
  animation: fadeUp 0.8s ease 1.5s forwards;
}

.scroll-cue span {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(245,240,232,0.3);
  writing-mode: vertical-rl;
}

.scroll-line {
  width: 1px;
  height: 60px;
  background: linear-gradient(to bottom, var(--gold), transparent);
  animation: pulse 2s ease-in-out infinite;
}

/* ========== SECTION INTRO ========== */
.section-intro {
  padding: 8rem 3rem;
  max-width: 1400px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6rem;
  align-items: start;
}

.section-intro .col-left {
  position: sticky;
  top: 4rem;
}

.section-tag {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--rust);
  margin-bottom: 1rem;
}

.section-heading {
  font-family: var(--font-display);
  font-size: clamp(2rem, 4vw, 3.5rem);
  font-weight: 700;
  line-height: 1.1;
  color: var(--ink);
  margin-bottom: 1.5rem;
}

.section-body {
  font-size: 1.05rem;
  line-height: 1.75;
  color: var(--slate);
  max-width: 520px;
}

.section-body p + p { margin-top: 1rem; }

/* ========== CATEGORY CARDS ========== */
.categories-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
}

.cat-card {
  padding: 1.25rem 1.25rem 1.25rem 1rem;
  border: 1px solid rgba(26,22,18,0.08);
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
  overflow: hidden;
  background: var(--cream);
  display: flex;
  align-items: center;
  gap: 0.85rem;
}

.cat-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 4px;
  height: 100%;
  background: var(--cat-color, var(--gold));
  transform: scaleY(0);
  transform-origin: bottom;
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
}

.cat-card::after {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--cat-color, var(--gold));
  opacity: 0;
  transition: opacity 0.35s ease;
  z-index: 0;
}

.cat-card:hover::before,
.cat-card.active::before { transform: scaleY(1); }

.cat-card:hover::after { opacity: 0.04; }
.cat-card.active::after { opacity: 0.08; }

.cat-card:hover, .cat-card.active {
  border-color: transparent;
  box-shadow: 0 4px 24px rgba(26,22,18,0.1);
  transform: translateX(4px);
}

.cat-card > * { position: relative; z-index: 1; }

.cat-icon {
  width: 38px;
  height: 38px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
}

.cat-card:hover .cat-icon { transform: scale(1.1); }
.cat-card.active .cat-icon { transform: scale(1.15); }

.cat-icon svg {
  width: 18px;
  height: 18px;
}

.cat-card-info { flex: 1; min-width: 0; }

.cat-card-count {
  font-family: var(--font-display);
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--cat-color, var(--ink));
  line-height: 1;
  transition: color 0.2s ease;
}

.cat-card-name {
  font-size: 0.72rem;
  font-weight: 500;
  color: var(--slate);
  margin-top: 0.2rem;
  letter-spacing: 0.02em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.cat-card-active-label {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  opacity: 0;
  transition: opacity 0.25s ease;
  margin-top: 0.15rem;
  color: var(--cat-color, var(--gold));
}

.cat-card.active .cat-card-active-label { opacity: 1; }

/* ========== MAP SECTION ========== */
.map-section {
  background: var(--ink);
  padding: 0;
  position: relative;
}

.map-header {
  padding: 4rem 3rem 2rem;
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}

.map-title {
  font-family: var(--font-display);
  font-size: clamp(1.5rem, 3vw, 2.5rem);
  color: var(--cream);
  font-weight: 700;
}

.map-filter-bar {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  justify-content: flex-end;
  max-width: 600px;
}

.filter-pill {
  font-family: var(--font-body);
  font-size: 0.7rem;
  font-weight: 500;
  padding: 0.45rem 0.9rem 0.45rem 0.7rem;
  border: 1px solid rgba(245,240,232,0.12);
  background: transparent;
  color: rgba(245,240,232,0.45);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
  letter-spacing: 0.02em;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.filter-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--pill-color, rgba(245,240,232,0.3));
  flex-shrink: 0;
  transition: all 0.3s ease;
  opacity: 0.5;
}

.filter-pill:hover {
  border-color: rgba(245,240,232,0.3);
  color: rgba(245,240,232,0.85);
  transform: translateY(-1px);
}

.filter-pill:hover .filter-dot { opacity: 1; transform: scale(1.2); }

.filter-pill.active {
  background: var(--pill-color, var(--gold));
  border-color: var(--pill-color, var(--gold));
  color: var(--ink);
  font-weight: 600;
  transform: translateY(-1px);
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
}

.filter-pill.active .filter-dot {
  background: var(--ink);
  opacity: 0.4;
}

.filter-pill.all-pill { padding-left: 0.9rem; }

.filter-pill.all-pill.active {
  background: var(--cream);
  border-color: var(--cream);
  color: var(--ink);
  box-shadow: 0 2px 12px rgba(245,240,232,0.15);
}

.map-active-banner {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 3rem;
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.4s ease, opacity 0.3s ease;
  opacity: 0;
}

.map-active-banner.visible {
  max-height: 60px;
  opacity: 1;
}

.map-active-banner-inner {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 0;
}

.map-active-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  animation: dotPulse 2s ease-in-out infinite;
}

@keyframes dotPulse {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.3); }
}

.map-active-text {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  letter-spacing: 0.08em;
  color: rgba(245,240,232,0.5);
}

.map-active-text strong {
  color: var(--cream);
  font-weight: 600;
}

.map-active-clear {
  font-family: var(--font-body);
  font-size: 0.65rem;
  color: rgba(245,240,232,0.35);
  background: none;
  border: 1px solid rgba(245,240,232,0.15);
  padding: 0.25rem 0.6rem;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-left: auto;
}

.map-active-clear:hover {
  color: var(--cream);
  border-color: rgba(245,240,232,0.4);
}

.map-container {
  height: 70vh;
  min-height: 500px;
  position: relative;
}

#map {
  width: 100%;
  height: 100%;
}

/* Leaflet overrides */
.leaflet-control-zoom { border: none !important; }
.leaflet-control-zoom a {
  background: var(--ink) !important;
  color: var(--cream) !important;
  border: 1px solid rgba(245,240,232,0.15) !important;
  width: 32px !important;
  height: 32px !important;
  line-height: 32px !important;
  font-size: 16px !important;
}
.leaflet-control-zoom a:hover {
  background: rgba(26,22,18,0.8) !important;
}
.leaflet-control-attribution {
  background: rgba(26,22,18,0.7) !important;
  color: rgba(245,240,232,0.4) !important;
  font-size: 10px !important;
}
.leaflet-control-attribution a { color: var(--gold) !important; }

/* Map tooltips */
.map-tooltip {
  background: var(--ink) !important;
  color: var(--cream) !important;
  border: 1px solid rgba(245,240,232,0.15) !important;
  border-radius: 0 !important;
  padding: 0 !important;
  font-family: var(--font-body) !important;
  font-size: 0.78rem !important;
  line-height: 1.4 !important;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5) !important;
  max-width: 280px !important;
  min-width: 200px !important;
  overflow: hidden !important;
}
.map-tooltip strong { font-weight: 600; }
.map-tooltip .leaflet-tooltip-tip {
  border-top-color: var(--ink) !important;
}
.leaflet-tooltip-top .leaflet-tooltip-tip {
  border-top-color: var(--ink) !important;
}

/* Rich tooltip content */
.tooltip-img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  display: block;
}
.tooltip-placeholder {
  width: 100%;
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0.6;
}
.tooltip-placeholder svg {
  width: 36px;
  height: 36px;
  fill: currentColor;
  opacity: 0.5;
}
.tooltip-body {
  padding: 0.5rem 0.75rem 0.6rem;
}
.tooltip-body strong {
  display: block;
  font-size: 0.82rem;
  margin-bottom: 0.2rem;
}
.tooltip-body .tooltip-cat {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  opacity: 0.65;
  font-size: 0.72rem;
}
.tooltip-body .tooltip-cat-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}
.tooltip-body .tooltip-city {
  opacity: 0.5;
  font-size: 0.7rem;
  margin-top: 0.15rem;
}

/* Detail panel image */
.detail-hero-img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  display: block;
}
.detail-hero-placeholder {
  width: 100%;
  height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.detail-hero-placeholder svg {
  width: 48px;
  height: 48px;
  fill: currentColor;
  opacity: 0.35;
}

.custom-marker {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.8);
  transition: all 0.2s ease;
  cursor: pointer;
}

.custom-marker:hover {
  transform: scale(1.8);
  z-index: 9999 !important;
}

/* ========== DETAIL PANEL ========== */
.detail-panel {
  position: fixed;
  right: -460px;
  top: 0;
  width: 440px;
  max-width: 90vw;
  height: 100vh;
  background: var(--cream);
  z-index: 10000;
  transition: right 0.45s cubic-bezier(0.22, 1, 0.36, 1);
  box-shadow: -10px 0 40px rgba(0,0,0,0.2);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.detail-panel.open { right: 0; }

.detail-panel-overlay {
  position: fixed;
  inset: 0;
  background: rgba(26,22,18,0.5);
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.35s ease;
}

.detail-panel-overlay.open {
  opacity: 1;
  pointer-events: auto;
}

.detail-close {
  position: absolute;
  top: 1.5rem;
  right: 1.5rem;
  width: 36px;
  height: 36px;
  background: none;
  border: 1px solid rgba(26,22,18,0.15);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  color: var(--ink);
  transition: all 0.2s ease;
  z-index: 2;
}

.detail-close:hover {
  background: var(--ink);
  color: var(--cream);
}

.detail-category-bar {
  height: 4px;
  width: 100%;
  flex-shrink: 0;
}

.detail-content {
  padding: 3rem 2.5rem;
  flex: 1;
}

.detail-tag {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 1rem;
}

.detail-name {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 700;
  line-height: 1.15;
  margin-bottom: 1.5rem;
  padding-right: 2rem;
}

.detail-description {
  font-size: 0.95rem;
  line-height: 1.7;
  color: var(--slate);
  margin-bottom: 2rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid rgba(26,22,18,0.08);
}

.detail-meta {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.detail-meta-row {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
}

.detail-meta-icon {
  font-size: 0.85rem;
  width: 20px;
  text-align: center;
  flex-shrink: 0;
  margin-top: 2px;
  opacity: 0.5;
}

.detail-meta-value {
  font-size: 0.85rem;
  line-height: 1.5;
  color: var(--slate);
}

.detail-meta-value a {
  color: var(--blue-wash);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s ease;
}

.detail-meta-value a:hover { border-bottom-color: var(--blue-wash); }

/* ========== EXPLORE LIST ========== */
.explore-section {
  padding: 6rem 3rem;
  max-width: 1400px;
  margin: 0 auto;
}

.explore-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 3rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.explore-search {
  font-family: var(--font-body);
  font-size: 0.9rem;
  padding: 0.7rem 1.2rem;
  border: 1px solid rgba(26,22,18,0.15);
  background: white;
  width: 320px;
  max-width: 100%;
  outline: none;
  transition: border-color 0.2s ease;
}

.explore-search:focus { border-color: var(--gold); }

.explore-search::placeholder { color: rgba(26,22,18,0.3); }

.explore-results-count {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--slate);
  letter-spacing: 0.1em;
  margin-bottom: 1rem;
}

.explore-list {
  display: grid;
  gap: 0;
  border-top: 1px solid rgba(26,22,18,0.1);
}

.explore-item {
  display: grid;
  grid-template-columns: 4px 3fr 2fr 1fr 40px;
  gap: 1rem;
  align-items: center;
  padding: 0.9rem 0 0.9rem 0;
  border-bottom: 1px solid rgba(26,22,18,0.06);
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
}

.explore-item:hover {
  padding-left: 0.5rem;
  background: linear-gradient(90deg, var(--row-color, transparent) 0%, rgba(200,148,62,0.03) 2%, rgba(200,148,62,0.03) 100%);
}

.explore-item-bar {
  width: 4px;
  height: 100%;
  min-height: 20px;
  border-radius: 2px;
  opacity: 0.35;
  transition: opacity 0.25s ease, height 0.25s ease;
}

.explore-item:hover .explore-item-bar {
  opacity: 1;
}

.explore-item-name {
  font-weight: 500;
  font-size: 0.9rem;
}

.explore-item-city {
  font-size: 0.8rem;
  color: var(--slate);
}

.explore-item-cat {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 0.3rem 0.6rem;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  white-space: nowrap;
  border: 1px solid;
  border-color: currentColor;
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

.explore-item:hover .explore-item-cat { opacity: 1; }

.explore-item-cat-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.explore-item-arrow {
  font-size: 1.1rem;
  color: rgba(26,22,18,0.15);
  transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
}

.explore-item:hover .explore-item-arrow {
  color: var(--row-color, var(--gold));
  transform: translateX(6px);
}

.load-more-btn {
  display: block;
  margin: 2rem auto 0;
  padding: 0.8rem 2rem;
  font-family: var(--font-body);
  font-size: 0.85rem;
  font-weight: 500;
  background: none;
  border: 1px solid rgba(26,22,18,0.2);
  cursor: pointer;
  transition: all 0.25s ease;
  color: var(--ink);
}

.load-more-btn:hover {
  background: var(--ink);
  color: var(--cream);
}

/* ========== COLOPHON ========== */
.colophon {
  background: var(--ink);
  padding: 4rem 3rem;
  color: rgba(245,240,232,0.3);
  font-size: 0.75rem;
  line-height: 1.8;
}

.colophon-inner {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 2rem;
}

.colophon a {
  color: var(--gold);
  text-decoration: none;
}

.colophon-credits {
  font-family: var(--font-mono);
  font-size: 0.65rem;
  letter-spacing: 0.05em;
}

/* ========== EXPERIENCE SELECTOR ========== */
.experience-bar {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 3rem 1rem;
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
}

.experience-card {
  display: flex;
  align-items: center;
  gap: 0.65rem;
  padding: 0.55rem 1rem;
  border: 1px solid rgba(245,240,232,0.1);
  background: rgba(245,240,232,0.04);
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.22, 1, 0.36, 1);
  position: relative;
  overflow: hidden;
}

.experience-card::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  width: 3px;
  height: 100%;
  background: var(--exp-color, var(--gold));
  transform: scaleY(0);
  transform-origin: bottom;
  transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1);
}

.experience-card:hover::before,
.experience-card.active::before { transform: scaleY(1); }

.experience-card:hover {
  border-color: rgba(245,240,232,0.25);
  background: rgba(245,240,232,0.08);
  transform: translateY(-1px);
}

.experience-card.active {
  border-color: rgba(245,240,232,0.3);
  background: rgba(245,240,232,0.1);
  box-shadow: 0 2px 16px rgba(0,0,0,0.3);
}

.experience-card-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
  transition: all 0.3s ease;
}

.experience-card.active .experience-card-dot {
  box-shadow: 0 0 8px currentColor;
}

.experience-card-info {
  display: flex;
  flex-direction: column;
  gap: 0.1rem;
}

.experience-card-title {
  font-family: var(--font-body);
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--cream);
  transition: color 0.3s ease;
}

.experience-card-meta {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(245,240,232,0.35);
  transition: color 0.3s ease;
}

.experience-card-close {
  display: none;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  font-size: 0.7rem;
  color: rgba(245,240,232,0.4);
  transition: color 0.2s ease;
}

.experience-card.active .experience-card-close { display: flex; }
.experience-card-close:hover { color: var(--cream); }

.experience-label {
  font-family: var(--font-mono);
  font-size: 0.6rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: rgba(245,240,232,0.3);
  padding: 0.55rem 0.25rem;
  align-self: center;
}

/* ========== CORRIDOR INFO PANEL ========== */
.corridor-panel {
  position: absolute;
  bottom: 1.5rem;
  left: 1.5rem;
  z-index: 1000;
  background: rgba(26,22,18,0.92);
  border: 1px solid rgba(245,240,232,0.12);
  border-radius: 10px;
  padding: 0;
  max-width: 340px;
  max-height: 50vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  opacity: 0;
  transform: translateY(12px);
  transition: all 0.45s cubic-bezier(0.22, 1, 0.36, 1);
  pointer-events: none;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.corridor-panel.visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.corridor-panel-header {
  padding: 1.25rem 1.25rem 0.75rem;
  border-bottom: 1px solid rgba(245,240,232,0.08);
  flex-shrink: 0;
}

.corridor-panel-eyebrow {
  font-family: var(--font-mono);
  font-size: 0.55rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 0.3rem;
}

.corridor-panel-title {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--cream);
  line-height: 1.2;
}

.corridor-panel-desc {
  font-size: 0.75rem;
  color: rgba(245,240,232,0.5);
  line-height: 1.5;
  margin-top: 0.5rem;
}

.corridor-panel-stops {
  overflow-y: auto;
  padding: 0.5rem 0;
  flex: 1;
  scrollbar-width: thin;
  scrollbar-color: rgba(245,240,232,0.15) transparent;
}

.corridor-panel-stops::-webkit-scrollbar { width: 3px; }
.corridor-panel-stops::-webkit-scrollbar-track { background: transparent; }
.corridor-panel-stops::-webkit-scrollbar-thumb { background: rgba(245,240,232,0.15); border-radius: 2px; }

.corridor-stop {
  display: flex;
  gap: 0.75rem;
  padding: 0.6rem 1.25rem;
  cursor: pointer;
  transition: background 0.2s ease;
}

.corridor-stop:hover { background: rgba(245,240,232,0.05); }

.corridor-stop-num {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 0.65rem;
  font-weight: 700;
  flex-shrink: 0;
  margin-top: 1px;
}

.corridor-stop-info { flex: 1; min-width: 0; }

.corridor-stop-name {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--cream);
  line-height: 1.3;
}

.corridor-stop-note {
  font-size: 0.7rem;
  color: rgba(245,240,232,0.4);
  line-height: 1.4;
  margin-top: 0.15rem;
}

.corridor-connector {
  padding: 0.15rem 1.25rem 0.15rem 3.1rem;
  font-family: var(--font-display);
  font-style: italic;
  font-size: 0.68rem;
  color: rgba(245,240,232,0.2);
  line-height: 1.4;
}

/* ========== THEME TRANSITIONS ========== */
:root {
  --theme-accent: var(--gold);
  --theme-bg: var(--ink);
  --theme-text: var(--cream);
  --theme-dimmed: rgba(245,240,232,0.15);
  --theme-route: var(--gold);
  --theme-transition: 0.6s cubic-bezier(0.22, 1, 0.36, 1);
}

.map-section {
  transition: background var(--theme-transition);
}

.map-title,
.map-active-text strong {
  transition: color var(--theme-transition);
}

/* Basemap crossfade */
.basemap-overlay {
  position: absolute;
  inset: 0;
  z-index: 0;
  opacity: 0;
  transition: opacity var(--theme-transition);
  pointer-events: none;
}

.basemap-overlay.visible { opacity: 1; }

/* Stop number markers on map */
.stop-badge {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
}

.stop-badge:hover { transform: scale(1.15); }

/* Route line animation */
@keyframes dashFlow {
  to { stroke-dashoffset: -24; }
}

/* ========== ANIMATIONS ========== */
@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 1; }
}

.reveal {
  opacity: 0;
  transform: translateY(30px);
  transition: all 0.8s cubic-bezier(0.22, 1, 0.36, 1);
}

.reveal.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
  .hero { padding: 3rem 1.5rem; }
  .hero-stats { gap: 2rem; flex-wrap: wrap; }
  .section-intro { grid-template-columns: 1fr; gap: 3rem; padding: 4rem 1.5rem; }
  .section-intro .col-left { position: static; }
  .categories-grid { grid-template-columns: repeat(2, 1fr); }
  .map-header { flex-direction: column; gap: 1rem; padding: 2rem 1.5rem 1rem; align-items: flex-start; }
  .map-filter-bar { justify-content: flex-start; }
  .experience-bar { padding: 0 1.5rem 1rem; }
  .corridor-panel {
    max-width: 100%;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 12px 12px 0 0;
    max-height: none;
    height: auto;
  }
  .corridor-panel-header {
    padding: 0.75rem 1rem 0.5rem;
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0 0.75rem;
    border-bottom: none;
  }
  .corridor-panel-eyebrow { margin-bottom: 0; }
  .corridor-panel-title { font-size: 0.9rem; }
  .corridor-panel-desc { display: none; }
  .corridor-panel-stops {
    display: flex;
    flex-direction: row;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding: 0 0.5rem 0.65rem;
    gap: 0.5rem;
    scrollbar-width: none;
  }
  .corridor-panel-stops::-webkit-scrollbar { display: none; }
  .corridor-stop {
    flex: 0 0 200px;
    scroll-snap-align: start;
    padding: 0.5rem 0.75rem;
    border: 1px solid rgba(245,240,232,0.1);
    border-radius: 8px;
    background: rgba(245,240,232,0.04);
  }
  .corridor-stop-note {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .corridor-connector { display: none; }
  .explore-section { padding: 3rem 1.5rem; }
  .explore-item { grid-template-columns: 4px 1fr; gap: 0.5rem; padding: 0.75rem 0; }
  .explore-item-arrow, .explore-item-city { display: none; }
  .scroll-cue { display: none; }
}

@media (max-width: 600px) {
  .hero-stat-number { font-size: 2.5rem; }
  .categories-grid { grid-template-columns: 1fr; }
  .detail-panel { width: 100vw; }
  .map-container { height: 60vh; min-height: 400px; }
  .corridor-stop { flex: 0 0 170px; }
  .corridor-stop-name { font-size: 0.75rem; }
  .corridor-stop-note { font-size: 0.65rem; -webkit-line-clamp: 1; }
}
</style>
</head>
<body>

<!-- ====== HERO ====== -->
<section class="hero">
  <div class="hero-content">
    <div class="hero-eyebrow">Nevada County, California</div>
    <h1 class="hero-title">The Culture<br>of <em>Gold Country</em></h1>
    <p class="hero-sub">From the rolling foothills of the Sierra to the peaks of Donner Pass, 687 cultural assets map the creative pulse of one of California's most storied regions.</p>
    <div class="hero-stats">
      <div>
        <div class="hero-stat-number" id="stat-total">0</div>
        <div class="hero-stat-label">Cultural Assets</div>
      </div>
      <div>
        <div class="hero-stat-number" id="stat-cats">0</div>
        <div class="hero-stat-label">Categories</div>
      </div>
      <div>
        <div class="hero-stat-number" id="stat-cities">0</div>
        <div class="hero-stat-label">Communities</div>
      </div>
    </div>
  </div>
  <div class="scroll-cue">
    <span>Explore</span>
    <div class="scroll-line"></div>
  </div>
</section>

<!-- ====== INTRO + CATEGORIES ====== -->
<section class="section-intro">
  <div class="col-left reveal">
    <div class="section-tag">01 / The Landscape</div>
    <h2 class="section-heading">A county where culture runs deeper than gold</h2>
    <div class="section-body">
      <p>Nevada County sits at the crossroads of Gold Rush history and living artistic tradition. Its towns, from the Victorian streets of Nevada City to the mountain corridors of Truckee, hold an extraordinary density of cultural assets.</p>
      <p>219 historic landmarks. 67 arts organizations. 52 annual fairs and festivals. Performance spaces carved from 19th-century foundries. Public art on every other block. This is not a county that treats culture as decoration. It is the infrastructure.</p>
    </div>
  </div>
  <div class="col-right reveal" style="transition-delay: 0.15s">
    <div class="section-tag">Categories</div>
    <div class="categories-grid" id="categoryGrid"></div>
  </div>
</section>

<!-- ====== MAP ====== -->
<section class="map-section" id="mapSection">
  <div class="map-header">
    <h2 class="map-title">Explore the Map</h2>
    <div class="map-filter-bar" id="filterBar"></div>
  </div>
  <div class="experience-bar" id="experienceBar">
    <span class="experience-label">Experiences</span>
  </div>
  <div class="map-active-banner" id="mapActiveBanner">
    <div class="map-active-banner-inner">
      <div class="map-active-dot" id="mapActiveDot"></div>
      <div class="map-active-text">Showing <strong id="mapActiveCount">0</strong> <span id="mapActiveName">assets</span></div>
      <button class="map-active-clear" id="mapActiveClear">Clear filter</button>
    </div>
  </div>
  <div class="map-container">
    <div id="map"></div>
    <div class="corridor-panel" id="corridorPanel"></div>
  </div>
</section>

<!-- ====== LIST ====== -->
<section class="explore-section" id="exploreSection">
  <div class="explore-header reveal">
    <div>
      <div class="section-tag">03 / Directory</div>
      <h2 class="section-heading">All Assets</h2>
    </div>
    <input type="text" class="explore-search" id="searchInput" placeholder="Search by name, city, or keyword...">
  </div>
  <div class="explore-results-count" id="resultsCount"></div>
  <div class="explore-list" id="exploreList"></div>
  <button class="load-more-btn" id="loadMoreBtn">Show more</button>
</section>

<!-- ====== DETAIL PANEL ====== -->
<div class="detail-panel-overlay" id="panelOverlay"></div>
<div class="detail-panel" id="detailPanel">
  <div class="detail-category-bar" id="detailCatBar"></div>
  <button class="detail-close" id="detailClose">&times;</button>
  <div id="detailHero"></div>
  <div class="detail-content">
    <div class="detail-tag" id="detailTag"></div>
    <h3 class="detail-name" id="detailName"></h3>
    <div class="detail-description" id="detailDesc"></div>
    <div class="detail-meta" id="detailMeta"></div>
  </div>
</div>

<!-- ====== COLOPHON ====== -->
<footer class="colophon">
  <div class="colophon-inner">
    <div>
      Data sourced from the <a href="https://www.nevadacountyarts.org/cultural-asset-map" target="_blank">Nevada County Arts Council Cultural Asset Map</a>.<br>
      687 features across 10 categories. Last updated December 2024.<br>
      <a href="index-maplibre.html">View 3D version with terrain &amp; cinematic camera</a>
    </div>
    <div class="colophon-credits">
      Designed and built by Claude Code<br>
      from Anthropic
    </div>
  </div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function() {
  'use strict';

  // SVG icons per category (inline, 18x18 viewBox)
  const ICONS = {
    'Historic Landmarks': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2L2 7h14L9 2z"/><rect x="4" y="7" width="10" height="8"/><rect x="7" y="10" width="4" height="5"/><line x1="2" y1="15" x2="16" y2="15"/></svg>',
    'Eat, Drink & Stay': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M3 2v6c0 2 2 3 4 3v5M14 2v4c0 1.5-1.5 2.5-3 2.5V14m0 0v2m0-2h0M14 2c0 2-1 3-3 3"/><circle cx="7" cy="14" r="1.5"/></svg>',
    'Arts Organizations': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><circle cx="9" cy="9" r="6"/><path d="M6 9c0-2 1.5-3.5 3-3.5s3 1.5 3 3.5-1.5 3.5-3 3.5S6 11 6 9z"/><path d="M9 5.5v7"/></svg>',
    'Cultural Resources': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="3" y="2" width="12" height="14" rx="1"/><line x1="6" y1="5" x2="12" y2="5"/><line x1="6" y1="8" x2="12" y2="8"/><line x1="6" y1="11" x2="10" y2="11"/></svg>',
    'Fairs & Festivals': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2l1.5 3 3.5.5-2.5 2.5.5 3.5L9 10l-3 1.5.5-3.5L4 5.5l3.5-.5z"/></svg>',
    'Galleries & Museums': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><rect x="2" y="4" width="14" height="11" rx="1"/><path d="M2 8h14"/><circle cx="7" cy="11" r="2"/><path d="M11 9l3 4"/></svg>',
    'Walks & Trails': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M3 15c2-3 4-5 6-8s3-3 6-5"/><circle cx="14" cy="4" r="1.5"/><path d="M5 13l-2 1m4-3l-2 1"/></svg>',
    'Public Art': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 3c-4 0-6 3-6 6 0 2 1 3 2 3 1.5 0 1.5-2 3-2s1.5 2 3 2 2-1 2-3c0-3-2-6-4-6z"/><circle cx="6" cy="8" r="1" fill="currentColor"/><circle cx="10" cy="7" r="1" fill="currentColor"/><circle cx="8" cy="10" r="1" fill="currentColor"/></svg>',
    'Performance Spaces': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M4 3h10l2 3v1H2V6l2-3z"/><path d="M3 7v7c0 1 1 2 2 2h8c1 0 2-1 2-2V7"/><path d="M7 10h4v3H7z"/></svg>',
    'Preservation & Culture': '<svg viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="1.4"><path d="M9 2C6 2 3 5 3 9c0 3 2 5.5 4 6.5L9 16l2-.5c2-1 4-3.5 4-6.5 0-4-3-7-6-7z"/><path d="M9 6v4l2.5 1.5"/></svg>',
  };

  // Category config
  const CATS = {
    'Historic Landmarks':        { color: '#8b2500', short: 'Landmarks' },
    'Eat, Drink & Stay':         { color: '#c8943e', short: 'Eat & Drink' },
    'Arts Organizations':        { color: '#2d4a3e', short: 'Arts Orgs' },
    'Cultural Resources':        { color: '#3a5f7c', short: 'Cultural' },
    'Fairs & Festivals':         { color: '#a0522d', short: 'Festivals' },
    'Galleries & Museums':       { color: '#6b4e71', short: 'Galleries' },
    'Walks & Trails':            { color: '#4a7c5f', short: 'Trails' },
    'Public Art':                { color: '#c45d3e', short: 'Public Art' },
    'Performance Spaces':        { color: '#2a6496', short: 'Performance' },
    'Preservation & Culture':    { color: '#7a6b3a', short: 'Preservation' },
  };

  let DATA = [];
  let IMAGE_DATA = {};
  let EXPERIENCES = [];
  let map, markersLayer;
  let activeCategory = null;
  let activeExperience = null;
  let cardElements = [];
  let listPage = 0;
  const LIST_PAGE_SIZE = 30;

  // Experience overlay layers
  let corridorRouteLayer = null;
  let corridorStopLayer = null;
  let corridorNumberLayer = null;
  let altBasemap = null;
  let defaultBasemap = null;

  // ---- Load data ----
  Promise.all([
    fetch('data.json').then(r => r.json()),
    fetch('image_data.json').then(r => r.json()).catch(() => ({})),
    fetch('experiences.json').then(r => r.json()).catch(() => [])
  ]).then(([data, images, experiences]) => {
    DATA = data;
    IMAGE_DATA = images;
    EXPERIENCES = experiences;
    init();
  }).catch(err => {
    console.error('Failed to load data:', err);
  });

  function init() {
    animateStats();
    buildCategoryGrid();
    buildFilterBar();
    buildExperienceSelector();
    initMap();
    buildList();
    initScrollReveal();
    bindEvents();
  }

  // ---- Stats counter ----
  function animateStats() {
    const cities = new Set(DATA.map(d => d.c).filter(Boolean));
    animateNumber('stat-total', DATA.length, 1200);
    animateNumber('stat-cats', Object.keys(CATS).length, 800);
    animateNumber('stat-cities', cities.size, 900);
  }

  function animateNumber(id, target, duration) {
    const el = document.getElementById(id);
    const start = performance.now();
    function tick(now) {
      const progress = Math.min((now - start) / duration, 1);
      const eased = 1 - Math.pow(1 - progress, 3);
      el.textContent = Math.round(target * eased);
      if (progress < 1) requestAnimationFrame(tick);
    }
    setTimeout(() => requestAnimationFrame(tick), 1100);
  }

  // ---- Hex to rgba helper ----
  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
  }

  // ---- Experience selector ----
  function buildExperienceSelector() {
    const bar = document.getElementById('experienceBar');
    if (!EXPERIENCES.length) { bar.style.display = 'none'; return; }

    EXPERIENCES.forEach(exp => {
      const card = document.createElement('div');
      card.className = 'experience-card';
      card.dataset.slug = exp.slug;
      card.style.setProperty('--exp-color', exp.color);
      card.querySelector?.('::before')?.style;
      card.innerHTML = `
        <div class="experience-card-dot" style="background:${exp.color}; color:${exp.color}"></div>
        <div class="experience-card-info">
          <div class="experience-card-title">${exp.title}</div>
          <div class="experience-card-meta">${exp.stops.length} stops</div>
        </div>
        <div class="experience-card-close">&times;</div>
      `;
      // Set the left-bar color
      card.style.cssText += `--exp-color:${exp.color}`;

      card.addEventListener('click', () => {
        if (activeExperience && activeExperience.slug === exp.slug) {
          deactivateExperience();
        } else {
          activateExperience(exp);
        }
      });
      bar.appendChild(card);
    });
  }

  // ---- Resolve experience stops to data coordinates ----
  function resolveStops(experience) {
    return experience.stops.map(stop => {
      // Find matching asset by partial name match
      const match = DATA.find(d =>
        d.n && d.n.toLowerCase().includes(stop.asset.toLowerCase())
      );
      return { ...stop, data: match || null };
    }).filter(s => s.data);
  }

  // ---- Activate experience ----
  function activateExperience(experience) {
    activeExperience = experience;
    const resolved = resolveStops(experience);
    if (!resolved.length) return;

    // Update selector UI
    document.querySelectorAll('.experience-card').forEach(c => {
      c.classList.toggle('active', c.dataset.slug === experience.slug);
    });

    // Apply theme if present
    if (experience.theme) applyTheme(experience.theme, experience.color);

    // Dim all existing markers
    markersLayer.eachLayer(marker => {
      if (marker.setStyle) {
        marker.setStyle({
          fillOpacity: 0.12,
          opacity: 0.08,
          weight: 0.5
        });
        marker.setRadius(3);
      }
    });

    // Clear previous corridor layers
    clearCorridorLayers();

    // Create corridor layers
    corridorRouteLayer = L.layerGroup().addTo(map);
    corridorStopLayer = L.layerGroup().addTo(map);
    corridorNumberLayer = L.layerGroup().addTo(map);

    // Draw route line
    const routeCoords = resolved.map(s => [s.data.y, s.data.x]);
    const routeColor = experience.theme ? experience.theme.routeColor : experience.color;
    const accentColor = experience.theme ? experience.theme.accent : experience.color;

    // Glow under the route
    L.polyline(routeCoords, {
      color: routeColor,
      weight: 10,
      opacity: 0.12,
      lineCap: 'round',
      lineJoin: 'round'
    }).addTo(corridorRouteLayer);

    // Main dashed route
    const routeLine = L.polyline(routeCoords, {
      color: routeColor,
      weight: 3,
      opacity: 0.65,
      dashArray: '8, 12',
      lineCap: 'round',
      lineJoin: 'round'
    }).addTo(corridorRouteLayer);

    // Animate dash flow via SVG
    const routeEl = routeLine.getElement();
    if (routeEl) {
      routeEl.style.animation = 'dashFlow 1.5s linear infinite';
    }

    // Draw stop markers
    resolved.forEach(stop => {
      const d = stop.data;

      // Outer glow ring
      L.circleMarker([d.y, d.x], {
        radius: 18,
        fillColor: accentColor,
        fillOpacity: 0.08,
        color: accentColor,
        weight: 1,
        opacity: 0.2
      }).addTo(corridorStopLayer);

      // Main stop marker
      const stopMarker = L.circleMarker([d.y, d.x], {
        radius: 8,
        fillColor: accentColor,
        fillOpacity: 0.9,
        color: '#ffffff',
        weight: 2
      }).addTo(corridorStopLayer);

      // Tooltip
      stopMarker.bindTooltip(`
        <div class="tooltip-body">
          <div style="font-family:var(--font-mono);font-size:9px;letter-spacing:0.1em;color:${accentColor};margin-bottom:3px;">STOP ${stop.order}</div>
          <strong>${d.n}</strong>
          <div style="font-size:11px;color:#888;margin-top:4px;max-width:200px;">${stop.note}</div>
        </div>
      `, { direction: 'top', offset: [0, -16], className: 'map-tooltip', opacity: 1 });

      stopMarker.on('click', () => openDetail(d));

      // Numbered badge
      const icon = L.divIcon({
        className: '',
        html: `<div class="stop-badge" style="background:${accentColor};color:#fff;">${stop.order}</div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
      L.marker([d.y, d.x], { icon, interactive: false }).addTo(corridorNumberLayer);
    });

    // Build corridor info panel
    buildCorridorPanel(experience, resolved);

    // Fit map to corridor bounds
    const bounds = L.latLngBounds(resolved.map(s => [s.data.y, s.data.x]));
    map.fitBounds(bounds, { padding: [60, 60], maxZoom: 13 });
  }

  // ---- Deactivate experience ----
  function deactivateExperience() {
    activeExperience = null;

    // Update selector UI
    document.querySelectorAll('.experience-card').forEach(c => c.classList.remove('active'));

    // Remove theme
    removeTheme();

    // Remove corridor layers
    clearCorridorLayers();

    // Hide panel
    document.getElementById('corridorPanel').classList.remove('visible');

    // Restore markers
    updateMap();
  }

  function clearCorridorLayers() {
    if (corridorRouteLayer) { map.removeLayer(corridorRouteLayer); corridorRouteLayer = null; }
    if (corridorStopLayer) { map.removeLayer(corridorStopLayer); corridorStopLayer = null; }
    if (corridorNumberLayer) { map.removeLayer(corridorNumberLayer); corridorNumberLayer = null; }
  }

  // ---- Theme switching ----
  function applyTheme(theme, fallbackColor) {
    const root = document.documentElement;
    root.style.setProperty('--theme-accent', theme.accent || fallbackColor);
    root.style.setProperty('--theme-route', theme.routeColor || fallbackColor);

    // Swap basemap
    if (theme.basemap === 'terrain' && altBasemap) {
      altBasemap.setOpacity(1);
      defaultBasemap.setOpacity(0);
    }

    // Shift map section chrome
    const mapSection = document.getElementById('mapSection');
    mapSection.style.transition = 'background 0.6s ease';
    mapSection.style.background = theme.background || '';

    // Update text colors in map header
    const mapTitle = document.querySelector('.map-title');
    if (mapTitle) {
      mapTitle.style.transition = 'color 0.6s ease';
      mapTitle.style.color = theme.text || '';
    }

    // Update filter pills for light background
    document.querySelectorAll('.filter-pill').forEach(p => {
      if (!p.classList.contains('active')) {
        p.style.transition = 'all 0.6s ease';
        p.style.color = theme.text ? hexToRgba(theme.text, 0.5) : '';
        p.style.borderColor = theme.text ? hexToRgba(theme.text, 0.15) : '';
      }
    });

    // Experience bar label
    const expLabel = document.querySelector('.experience-label');
    if (expLabel) {
      expLabel.style.transition = 'color 0.6s ease';
      expLabel.style.color = theme.text ? hexToRgba(theme.text, 0.4) : '';
    }

    // Experience cards
    document.querySelectorAll('.experience-card').forEach(c => {
      c.style.transition = 'all 0.6s ease';
      c.style.borderColor = theme.text ? hexToRgba(theme.text, 0.12) : '';
      c.style.background = theme.text ? hexToRgba(theme.text, 0.04) : '';
    });
    document.querySelectorAll('.experience-card-title').forEach(t => {
      t.style.transition = 'color 0.6s ease';
      t.style.color = theme.text || '';
    });

    // Corridor panel theme
    const panel = document.getElementById('corridorPanel');
    if (panel) {
      panel.style.transition = 'all 0.6s ease';
      panel.style.background = theme.text ? hexToRgba(theme.text, 0.92) : '';
      panel.style.borderColor = theme.text ? hexToRgba(theme.text, 0.12) : '';
    }
  }

  function removeTheme() {
    const root = document.documentElement;
    root.style.removeProperty('--theme-accent');
    root.style.removeProperty('--theme-route');

    // Restore basemap
    if (altBasemap) {
      altBasemap.setOpacity(0);
      defaultBasemap.setOpacity(1);
    }

    // Restore map section
    const mapSection = document.getElementById('mapSection');
    mapSection.style.background = '';
    const mapTitle = document.querySelector('.map-title');
    if (mapTitle) mapTitle.style.color = '';

    // Restore pills
    document.querySelectorAll('.filter-pill').forEach(p => {
      p.style.color = '';
      p.style.borderColor = '';
    });

    // Restore experience bar
    const expLabel = document.querySelector('.experience-label');
    if (expLabel) expLabel.style.color = '';
    document.querySelectorAll('.experience-card').forEach(c => {
      c.style.borderColor = '';
      c.style.background = '';
    });
    document.querySelectorAll('.experience-card-title').forEach(t => {
      t.style.color = '';
    });

    // Restore panel
    const panel = document.getElementById('corridorPanel');
    if (panel) { panel.style.background = ''; panel.style.borderColor = ''; }
  }

  // ---- Corridor info panel ----
  function buildCorridorPanel(experience, resolved) {
    const panel = document.getElementById('corridorPanel');
    const accentColor = experience.theme ? experience.theme.accent : experience.color;

    let stopsHTML = '';
    resolved.forEach((stop, i) => {
      stopsHTML += `
        <div class="corridor-stop" data-stop-idx="${i}">
          <div class="corridor-stop-num" style="background:${accentColor};color:#fff;">${stop.order}</div>
          <div class="corridor-stop-info">
            <div class="corridor-stop-name">${stop.data.n}</div>
            <div class="corridor-stop-note">${stop.note}</div>
          </div>
        </div>
      `;
      if (stop.connector && i < resolved.length - 1) {
        stopsHTML += `<div class="corridor-connector" style="color:${hexToRgba(accentColor, 0.4)}">${stop.connector}</div>`;
      }
    });

    panel.innerHTML = `
      <div class="corridor-panel-header">
        <div class="corridor-panel-eyebrow" style="color:${accentColor}">Curated Experience &bull; ${resolved.length} stops</div>
        <div class="corridor-panel-title">${experience.title}</div>
        <div class="corridor-panel-desc">${experience.description}</div>
      </div>
      <div class="corridor-panel-stops">${stopsHTML}</div>
    `;

    // Bind stop clicks to fly to location
    panel.querySelectorAll('.corridor-stop').forEach(el => {
      el.addEventListener('click', () => {
        const idx = parseInt(el.dataset.stopIdx);
        const stop = resolved[idx];
        if (stop && stop.data) {
          map.flyTo([stop.data.y, stop.data.x], 15, { duration: 0.8 });
        }
      });
    });

    // Show panel with slight delay for visual sequence
    setTimeout(() => panel.classList.add('visible'), 200);
  }

  // ---- Category grid (with icons) ----
  function buildCategoryGrid() {
    const grid = document.getElementById('categoryGrid');
    const counts = {};
    DATA.forEach(d => { counts[d.l] = (counts[d.l] || 0) + 1; });

    const sorted = Object.entries(CATS).sort((a, b) => (counts[b[0]] || 0) - (counts[a[0]] || 0));

    sorted.forEach(([name, cfg]) => {
      const card = document.createElement('div');
      card.className = 'cat-card';
      card.dataset.category = name;
      card.style.setProperty('--cat-color', cfg.color);
      card.innerHTML = `
        <div class="cat-icon" style="background:${hexToRgba(cfg.color, 0.12)}; color:${cfg.color}">
          ${ICONS[name] || ''}
        </div>
        <div class="cat-card-info">
          <div class="cat-card-count">${counts[name] || 0}</div>
          <div class="cat-card-name">${name}</div>
          <div class="cat-card-active-label">Filtered</div>
        </div>
      `;
      card.addEventListener('click', () => {
        setCategory(name === activeCategory ? null : name);
        document.getElementById('mapSection').scrollIntoView({ behavior: 'smooth' });
      });
      grid.appendChild(card);
      cardElements.push({ el: card, name });
    });
  }

  // ---- Filter bar (with color dots) ----
  function buildFilterBar() {
    const bar = document.getElementById('filterBar');

    const allPill = document.createElement('button');
    allPill.className = 'filter-pill all-pill active';
    allPill.textContent = 'All';
    allPill.addEventListener('click', () => setCategory(null));
    bar.appendChild(allPill);

    Object.entries(CATS).forEach(([name, cfg]) => {
      const pill = document.createElement('button');
      pill.className = 'filter-pill';
      pill.dataset.category = name;
      pill.style.setProperty('--pill-color', cfg.color);
      pill.innerHTML = `<span class="filter-dot" style="background:${cfg.color}"></span>${cfg.short}`;
      pill.addEventListener('click', () => setCategory(name === activeCategory ? null : name));
      bar.appendChild(pill);
    });
  }

  // ---- Active banner ----
  function updateActiveBanner() {
    const banner = document.getElementById('mapActiveBanner');
    if (activeCategory) {
      const cfg = CATS[activeCategory];
      const count = DATA.filter(d => d.l === activeCategory).length;
      document.getElementById('mapActiveDot').style.background = cfg.color;
      document.getElementById('mapActiveCount').textContent = count;
      document.getElementById('mapActiveName').textContent = activeCategory;
      banner.classList.add('visible');
    } else {
      banner.classList.remove('visible');
    }
  }

  // ---- Set category (syncs all UI) ----
  function setCategory(cat) {
    activeCategory = cat;

    // Update filter pills
    document.querySelectorAll('.filter-pill').forEach(p => {
      if (p.classList.contains('all-pill')) {
        p.classList.toggle('active', cat === null);
      } else {
        p.classList.toggle('active', p.dataset.category === cat);
      }
    });

    // Update category cards
    cardElements.forEach(({ el, name }) => {
      el.classList.toggle('active', name === cat);
      // Dim non-active cards when a filter is on
      if (cat && name !== cat) {
        el.style.opacity = '0.45';
      } else {
        el.style.opacity = '1';
      }
    });

    updateActiveBanner();
    updateMap();
    listPage = 0;
    buildList();
  }

  // ---- Map ----
  function initMap() {
    map = L.map('map', {
      zoomControl: true,
      attributionControl: true
    }).setView([39.22, -120.8], 10);

    // Default dark basemap
    defaultBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // Alternate light basemap for themed experiences (hidden by default)
    altBasemap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd',
      maxZoom: 19,
      opacity: 0
    }).addTo(map);

    markersLayer = L.layerGroup().addTo(map);
    updateMap();
  }

  function updateMap() {
    markersLayer.clearLayers();
    const filtered = activeCategory ? DATA.filter(d => d.l === activeCategory) : DATA;

    // Determine if markers should be dimmed (experience active)
    const dimmed = !!activeExperience;
    const dimColor = activeExperience && activeExperience.theme
      ? activeExperience.theme.dimmedMarker || 'rgba(180,170,160,0.3)'
      : 'rgba(245,240,232,0.15)';

    filtered.forEach(d => {
      if (!d.x || !d.y) return;
      const cfg = CATS[d.l] || { color: '#999' };
      const marker = L.circleMarker([d.y, d.x], {
        radius: dimmed ? 3 : (activeCategory ? 7 : 5),
        fillColor: dimmed ? dimColor : cfg.color,
        fillOpacity: dimmed ? 0.35 : 0.85,
        color: dimmed ? 'rgba(0,0,0,0)' : 'rgba(255,255,255,0.6)',
        weight: dimmed ? 0 : 1.5
      });

      // Rich tooltip on hover
      const imgInfo = IMAGE_DATA[d.n];
      const imgHTML = imgInfo
        ? `<img class="tooltip-img" src="${imgInfo.img}" alt="${imgInfo.alt || d.n}" onerror="this.parentNode.removeChild(this)">`
        : `<div class="tooltip-placeholder" style="background:${cfg.color}">${ICONS[d.l] || ''}</div>`;
      marker.bindTooltip(
        `${imgHTML}<div class="tooltip-body"><strong>${d.n}</strong><div class="tooltip-cat"><span class="tooltip-cat-dot" style="background:${cfg.color}"></span>${d.l}</div>${d.c ? '<div class="tooltip-city">' + d.c + ', CA</div>' : ''}</div>`,
        {
          direction: 'top',
          offset: [0, -12],
          className: 'map-tooltip',
          opacity: 1
        }
      );

      // Grow on hover
      marker.on('mouseover', function() {
        this.setRadius(activeCategory ? 10 : 8);
        this.setStyle({ fillOpacity: 1, weight: 2.5 });
      });
      marker.on('mouseout', function() {
        this.setRadius(activeCategory ? 7 : 5);
        this.setStyle({ fillOpacity: 0.85, weight: 1.5 });
      });
      marker.on('click', () => openDetail(d));
      markersLayer.addLayer(marker);
    });

    // Fit bounds if filtered
    if (filtered.length > 0 && activeCategory) {
      const bounds = L.latLngBounds(filtered.filter(d => d.x && d.y).map(d => [d.y, d.x]));
      map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
    } else if (!activeCategory) {
      map.setView([39.22, -120.8], 10);
    }
  }

  // ---- Detail panel ----
  function openDetail(d) {
    const panel = document.getElementById('detailPanel');
    const overlay = document.getElementById('panelOverlay');
    const cfg = CATS[d.l] || { color: '#999' };

    document.getElementById('detailCatBar').style.background = cfg.color;

    // Hero image
    const heroEl = document.getElementById('detailHero');
    const imgInfo = IMAGE_DATA[d.n];
    if (imgInfo) {
      heroEl.innerHTML = `<img class="detail-hero-img" src="${imgInfo.img}" alt="${imgInfo.alt || d.n}" onerror="this.parentNode.innerHTML='<div class=\\'detail-hero-placeholder\\' style=\\'background:${cfg.color}\\'>${(ICONS[d.l]||'').replace(/'/g,"&#39;")}</div>'">`;
    } else {
      heroEl.innerHTML = `<div class="detail-hero-placeholder" style="background:${cfg.color}">${ICONS[d.l] || ''}</div>`;
    }

    document.getElementById('detailTag').innerHTML = `<span style="display:inline-flex;align-items:center;gap:0.4rem;">${ICONS[d.l] ? '<span style="width:14px;height:14px;display:inline-block;vertical-align:middle;">' + ICONS[d.l] + '</span>' : ''} ${d.l}</span>`;
    document.getElementById('detailTag').style.color = cfg.color;
    document.getElementById('detailName').textContent = d.n;
    document.getElementById('detailDesc').textContent = d.d || 'No description available.';
    document.getElementById('detailDesc').style.display = d.d ? 'block' : 'none';

    let metaHTML = '';
    if (d.a) metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9675;</span><div class="detail-meta-value">${d.a}${d.c ? ', ' + d.c + ', CA' : ''}</div></div>`;
    if (d.p) metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9743;</span><div class="detail-meta-value"><a href="tel:${d.p}">${d.p}</a></div></div>`;
    if (d.w) {
      let url = d.w.trim();
      if (!url.startsWith('http')) url = 'https://' + url;
      const display = url.replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '');
      metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9741;</span><div class="detail-meta-value"><a href="${url}" target="_blank" rel="noopener">${display}</a></div></div>`;
    }
    if (d.x && d.y) {
      metaHTML += `<div class="detail-meta-row"><span class="detail-meta-icon">&#9906;</span><div class="detail-meta-value"><a href="https://www.google.com/maps?q=${d.y},${d.x}" target="_blank" rel="noopener">View on Google Maps</a></div></div>`;
    }

    document.getElementById('detailMeta').innerHTML = metaHTML;
    panel.classList.add('open');
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
  }

  function closeDetail() {
    document.getElementById('detailPanel').classList.remove('open');
    document.getElementById('panelOverlay').classList.remove('open');
    document.body.style.overflow = '';
  }

  // ---- Explore list ----
  function getFilteredData() {
    let filtered = activeCategory ? DATA.filter(d => d.l === activeCategory) : [...DATA];
    const query = (document.getElementById('searchInput').value || '').toLowerCase().trim();
    if (query) {
      filtered = filtered.filter(d =>
        (d.n && d.n.toLowerCase().includes(query)) ||
        (d.c && d.c.toLowerCase().includes(query)) ||
        (d.d && d.d.toLowerCase().includes(query)) ||
        (d.l && d.l.toLowerCase().includes(query))
      );
    }
    return filtered;
  }

  function buildList() {
    const list = document.getElementById('exploreList');
    const filtered = getFilteredData();
    const end = (listPage + 1) * LIST_PAGE_SIZE;
    const visible = filtered.slice(0, end);

    document.getElementById('resultsCount').textContent =
      `Showing ${Math.min(end, filtered.length)} of ${filtered.length} assets` +
      (activeCategory ? ` in ${activeCategory}` : '');

    list.innerHTML = '';
    visible.forEach(d => {
      const cfg = CATS[d.l] || { color: '#999' };
      const item = document.createElement('div');
      item.className = 'explore-item';
      item.style.setProperty('--row-color', cfg.color);
      item.innerHTML = `
        <div class="explore-item-bar" style="background:${cfg.color}"></div>
        <div class="explore-item-name">${d.n}</div>
        <div class="explore-item-city">${d.c || d.a || ''}</div>
        <span class="explore-item-cat" style="color:${cfg.color}">
          <span class="explore-item-cat-dot" style="background:${cfg.color}"></span>
          ${cfg.short || d.l}
        </span>
        <span class="explore-item-arrow">&rarr;</span>
      `;
      item.addEventListener('click', () => openDetail(d));
      list.appendChild(item);
    });

    document.getElementById('loadMoreBtn').style.display = end >= filtered.length ? 'none' : 'block';
  }

  // ---- Events ----
  function bindEvents() {
    document.getElementById('detailClose').addEventListener('click', closeDetail);
    document.getElementById('panelOverlay').addEventListener('click', closeDetail);
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });

    document.getElementById('searchInput').addEventListener('input', () => {
      listPage = 0;
      buildList();
    });

    document.getElementById('loadMoreBtn').addEventListener('click', () => {
      listPage++;
      buildList();
    });

    document.getElementById('mapActiveClear').addEventListener('click', () => {
      setCategory(null);
    });
  }

  // ---- Scroll reveal ----
  function initScrollReveal() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.15 });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
  }

})();
</script>
</body>
</html>
