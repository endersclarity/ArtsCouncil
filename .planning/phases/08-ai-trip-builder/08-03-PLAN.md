---
phase: 08-ai-trip-builder
plan: 03
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - website/cultural-map-redesign-stitch-lab/api/chat.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-chat-controller.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-chat-view.js
autonomous: true
requirements: [SC-3]

must_haves:
  truths:
    - "When dream board has items, the chat FAB shows trip-planning style cards ('1-day plan', '2-day plan', 'Just organize my list')"
    - "Clicking a style card sends a trip-planning prompt pre-seeded with dream board place names"
    - "The chatbot responds with a structured {{ITINERARY}} block containing DAY and STOP lines"
    - "The {{ITINERARY}} block is parsed into a valid itinerary-schema-compatible trip object"
    - "The parsed trip is saved to localStorage via tripbuilder-model"
    - "Dream board contents are passed to the API as user-message context (not system prompt modification)"
    - "The system prompt instructs Gemini to use exact asset names from the knowledge pack directory"
    - "Malformed {{ITINERARY}} blocks fail gracefully with a 'let me try again' fallback message"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/api/chat.js"
      provides: "Trip-planning system prompt extension + dream board context injection"
      min_lines: 30
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-chat-controller.js"
      provides: "{{ITINERARY}} parser + dream board payload + trip save"
      min_lines: 120
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-chat-view.js"
      provides: "Trip-planning style cards + itinerary card rendering in chat"
      min_lines: 60
  key_links:
    - from: "index-maplibre-chat-controller.js"
      to: "api/chat.js"
      via: "fetch('/api/chat') with dreamBoard array in request body"
      pattern: "dreamBoard"
    - from: "api/chat.js"
      to: "Gemini API"
      via: "Dream board context appended to last user message content"
      pattern: "saved these places"
    - from: "index-maplibre-chat-controller.js"
      to: "index-maplibre-tripbuilder-model.js"
      via: "CulturalMapTripBuilderModel.saveTrip() after parsing {{ITINERARY}}"
      pattern: "saveTrip"
    - from: "index-maplibre-chat-controller.js"
      to: "parseItineraryBlock()"
      via: "Regex match for {{ITINERARY|...|...}} in response text"
      pattern: "ITINERARY"
---

<objective>
Extend the AI concierge with trip-planning mode: Gemini system prompt for itinerary generation, {{ITINERARY}} response block parser, dream board context injection, and chat UI style cards.

Purpose: SC-3 requires the chatbot to generate structured itineraries from dream board contents via {{ITINERARY}} response blocks. This plan handles the full server+client pipeline.

Output: Modified api/chat.js with trip-planning prompt, modified chat-controller.js with {{ITINERARY}} parser and dream board pre-seeding, modified chat-view.js with trip-planning style cards.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-trip-builder/08-RESEARCH.md
@.planning/phases/08-ai-trip-builder/08-CONTEXT.md
@.planning/phases/05-ai-concierge/05-01-SUMMARY.md
@.planning/phases/05-ai-concierge/05-02-SUMMARY.md
@.planning/phases/08-ai-trip-builder/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend api/chat.js with trip-planning system prompt and dream board context</name>
  <files>
    website/cultural-map-redesign-stitch-lab/api/chat.js
  </files>
  <action>
Read the existing `api/chat.js` to understand the current system prompt structure (built at module scope as `const SYSTEM_PROMPT = buildSystemPrompt()`).

**1. Extend buildSystemPrompt() (~25 lines added to the existing function):**

Add a "Trip Planning Mode" section to the system prompt. This section instructs Gemini on when and how to produce {{ITINERARY}} response blocks. Add after the existing instructions but before the closing of the prompt:

```
## Trip Planning Mode

When a user asks you to plan a trip, create an itinerary, or organize their saved places, respond with a structured {{ITINERARY}} block.

Format:
{{ITINERARY|Trip Title|N-day
DAY|Day Label
STOP|Exact Place Name|HH:MM|duration_minutes|Brief narrative about this stop.
DAY|Day Label
STOP|Exact Place Name|HH:MM|duration_minutes|Brief narrative.
}}

Rules:
- Place names MUST match the directory exactly (case-insensitive). Use the names from the asset list below, not official/full names.
- Time format: 24-hour (e.g., 09:00, 14:30)
- Duration: integer minutes (e.g., 60, 90, 120)
- Narrative: 1-2 sentences, conversational tone, mention what makes the stop special
- Day labels: descriptive (e.g., "Day 1 ‚Äî Downtown Nevada City", "Day 2 ‚Äî Grass Valley Heritage")
- Typical pacing: 3-5 stops per day, 30-90 min between stops for travel
- If the user has saved places, incorporate them. If they ask for a 1-day plan, pick the best 4-5 from their list.
- If they ask to "just organize my list," create a logical day-by-day plan using ALL their saved places.
- Include a brief conversational intro before the {{ITINERARY}} block and a short closing after it.
- Do NOT wrap the {{ITINERARY}} block in markdown code fences.
```

**2. Dream board context injection (~10 lines in the request handler):**

In the POST handler, after sanitizing the messages array but before sending to Gemini:

```javascript
var dreamBoard = req.body.dreamBoard;
if (Array.isArray(dreamBoard) && dreamBoard.length > 0) {
  var safeNames = dreamBoard.slice(0, 50).map(function(n) { return sanitize(String(n)); });
  var contextNote = '\n\nThe user has saved these places to their trip dream board:\n' +
    safeNames.map(function(n) { return '- ' + n; }).join('\n') +
    '\n\nIncorporate these places when planning an itinerary. If they say "plan my trip" or click a planning card, use these as the starting set.';
  // Append to last user message content (preserves system prompt cache)
  var lastMsg = sanitized[sanitized.length - 1];
  sanitized[sanitized.length - 1] = {
    role: lastMsg.role,
    content: lastMsg.content + contextNote
  };
}
```

**Important:** Do NOT modify the `SYSTEM_PROMPT` constant per-request. The system prompt is built once at cold start for Gemini prompt cache efficiency. Dream board context goes in the user message.

**3. Validate the dreamBoard field:**
Add `dreamBoard` to the expected request body fields. Sanitize each entry as a string. Limit to 50 entries (safety cap).
  </action>
  <verify>
1. Deploy to local dev or test with `vercel dev`:
   - POST to /api/chat with `{ messages: [{ role: "user", content: "Plan a 1-day trip" }], dreamBoard: ["Empire Mine", "Broad Street Bistro"], sessionHash: "test123" }`
   - Response should contain an {{ITINERARY}} block with the dream board places
2. POST without dreamBoard field still works (existing behavior unchanged)
3. The system prompt includes "Trip Planning Mode" section
  </verify>
  <done>
api/chat.js system prompt includes trip-planning format instructions. Dream board context is injected into user messages (not system prompt). Gemini produces {{ITINERARY}} blocks when asked to plan trips. Existing chat behavior is unchanged when no dream board is provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add {{ITINERARY}} parser to chat controller + style cards to chat view</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-chat-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-chat-view.js
  </files>
  <action>
**chat-controller.js modifications (~120 lines):**

Read the existing `parseResponse()` function (processes `[[asset|pid]]` links, `{{MUSE|id|quote}}` blocks, `**bold**`, `\n` to `<br>`).

**1. Add `parseItineraryBlock(rawContent)` function** (see research doc code example):
- Input: the text between `{{ITINERARY|` and `}}`
- Split by newlines, trim each line, filter empties
- First line: split by `|` ‚Üí `header[0]` = title, `header[1]` = duration
- Build trip object matching itinerary schema exactly (see research Pattern 1):
  ```javascript
  var trip = {
    id: 'usr-' + Math.floor(Date.now() / 1000),
    title: header[0] || 'My Trip',
    subtitle: '',
    duration: header[1] || '1-day',
    season: 'year-round',
    heroImage: '',
    description: '',
    created: Date.now(),
    modified: Date.now(),
    theme: { accent: '#c8943e', routeColor: '#7a9e7e', background: '#f5f0e8' },
    days: []
  };
  ```
- Iterate remaining lines:
  - `DAY|label` ‚Üí push new day object `{ label: parts[1], stops: [] }`
  - `STOP|asset|time|duration|narrative` ‚Üí push stop to current day. Use `parts.slice(4).join('|')` for narrative (handles pipes in text). Default time to '09:00', duration to 60.
  - Skip unparseable lines silently (lenient parser)
- Recalculate `trip.duration` from `trip.days.length + '-day'`
- Return trip if it has at least 1 day with 1 stop, otherwise null

**2. Extend `parseResponse()` to detect {{ITINERARY}} blocks:**

Add AFTER `{{MUSE}}` processing but BEFORE `**bold**` conversion:

```javascript
// Handle {{ITINERARY}} blocks
var itinRegex = /\{\{ITINERARY\|([^}]*(?:\n[^}]*)*)\}\}/;
var itinMatch = html.match(itinRegex);
if (itinMatch) {
  var rawBlock = itinMatch[1];
  // Strip markdown code fences if present
  rawBlock = rawBlock.replace(/```[a-z]*\n?/g, '').replace(/```/g, '');
  var trip = parseItineraryBlock(rawBlock);
  if (trip) {
    // Save trip to localStorage
    if (window.CulturalMapTripBuilderModel) {
      window.CulturalMapTripBuilderModel.saveTrip(trip);
    }
    // Replace the {{ITINERARY}} block with a rendered card
    var cardHTML = buildItineraryChatCard(trip);
    html = html.replace(itinRegex, cardHTML);
  } else {
    // Parsing failed ‚Äî show fallback
    html = html.replace(itinRegex, '<div class="chat-itin-error">I had trouble formatting that itinerary. Let me try again ‚Äî could you rephrase your request?</div>');
  }
}
```

**3. Add `buildItineraryChatCard(trip)` function (~30 lines):**
Renders a compact itinerary summary card inside the chat bubble:
```html
<div class="chat-itin-card" data-trip-id="{trip.id}">
  <div class="chat-itin-title">{trip.title}</div>
  <div class="chat-itin-meta">{trip.duration} ¬∑ {totalStops} stops</div>
  <div class="chat-itin-days">{for each day: label + stop count}</div>
  <a href="trip.html" class="chat-itin-cta">View & Edit on Trip Page</a>
</div>
```
Style with gold accent border-left, cream background, Playfair Display title.

**4. Add dream board pre-seeding to fetch payload (~15 lines):**
In the function that calls `fetch('/api/chat', ...)`, before the fetch:
```javascript
var payload = { messages: messages, sessionHash: sessionHash };
// Pre-seed dream board context
if (window.CulturalMapDreamboardModel) {
  var store = window.CulturalMapDreamboardModel.getStore();
  var names = (store.places || []).map(function(p) { return p.asset; });
  var eventNames = (store.events || []).map(function(e) { return e.venue + ' (' + e.title + ')'; });
  payload.dreamBoard = names.concat(eventNames);
}
```

**5. Handle `?chat=trip` deep link parameter:**
In the chat controller's init or the main app's deep link handler, check for `?chat=trip` URL parameter. If present:
- Auto-open the chat panel
- If `?plan=1day`, auto-send "Plan me a 1-day trip using my saved places"
- If `?plan=2day`, auto-send "Plan me a 2-day trip using my saved places"
- If `?plan=organize`, auto-send "Organize all my saved places into a logical trip plan"
- If just `?chat=trip` with no plan param, open chat with trip planning style cards visible

**chat-view.js modifications (~60 lines):**

**1. Add trip-planning style cards:**
In the welcome message or when the chat opens, if `CulturalMapDreamboardModel.getItemCount() > 0`, show style cards below the welcome text:
```html
<div class="chat-trip-cards">
  <div class="chat-trip-card style-card" data-plan="1day">
    <span class="card-icon">üìÖ</span>
    <span class="card-label">1-Day Plan</span>
  </div>
  <div class="chat-trip-card style-card" data-plan="2day">
    <span class="card-icon">üóìÔ∏è</span>
    <span class="card-label">2-Day Plan</span>
  </div>
  <div class="chat-trip-card style-card" data-plan="organize">
    <span class="card-icon">‚ú®</span>
    <span class="card-label">Just Organize My List</span>
  </div>
</div>
```
Cards styled as horizontal row, gold border, cream background, clickable.

**2. Add CSS for chat itinerary card and trip style cards (~30 lines):**
- `.chat-itin-card`: border-left 3px solid #c8943e, background #f5f0e8, padding 12px, border-radius 8px
- `.chat-itin-cta`: gold text link, underline on hover
- `.chat-trip-cards`: flex row, gap 8px, padding 8px 0
- `.chat-trip-card`: border 1px solid #c8943e, border-radius 8px, padding 8px 12px, cursor pointer, hover background #f5f0e8
- `.chat-itin-error`: italic, muted color, padding 8px

**3. Bind style card clicks:**
Add delegated click handler for `.style-card` elements. On click, read `data-plan` attribute and send the corresponding prompt text through the chat controller's send function.
  </action>
  <verify>
1. On localhost:8001, bookmark 3-4 venues, then open the chat
2. Chat welcome should show "1-Day Plan", "2-Day Plan", "Just Organize My List" style cards
3. Click "1-Day Plan" ‚Äî chat sends a trip planning request
4. Response should contain an {{ITINERARY}} block rendered as a gold-accented card with "View & Edit on Trip Page" link
5. Check `localStorage.getItem('ncac-user-trips')` ‚Äî the parsed trip should be saved
6. Test with `?chat=trip&plan=1day` URL ‚Äî chat opens and auto-sends the 1-day plan prompt
7. Test with no dream board items ‚Äî style cards should NOT appear (no items to plan with)
  </verify>
  <done>
The AI concierge has trip-planning mode: style cards appear when dream board has items, dream board contents pre-seed the Gemini context, {{ITINERARY}} blocks are parsed into schema-compatible trip objects and saved to localStorage, and a compact itinerary card with "View & Edit" link renders in the chat. Deep link support allows trip.html CTAs to open the chat in planning mode.
  </done>
</task>

</tasks>

<verification>
1. End-to-end flow: bookmark 4 places -> open chat -> click "1-Day Plan" -> receive {{ITINERARY}} response -> see rendered card in chat -> click "View & Edit" -> navigate to trip.html with saved trip
2. Dream board context appears in the Gemini request (check network tab: dreamBoard array in POST body)
3. Malformed {{ITINERARY}} shows graceful fallback message, not a crash
4. Existing chat behavior (non-trip questions) is completely unchanged
5. Style cards only appear when dream board has >0 items
6. Parsed trip matches itinerary schema (has id, title, days, stops with asset/time/duration/narrative)
</verification>

<success_criteria>
The chatbot generates structured itineraries from dream board contents. Users see trip-planning style cards in the chat, can trigger planning with one click, and get a parsed itinerary saved to localStorage. The {{ITINERARY}} parser is lenient and handles edge cases. This plan runs in parallel with 08-02 (no file overlap).
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-trip-builder/08-03-SUMMARY.md`
</output>
