---
phase: 08-ai-trip-builder
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - website/cultural-map-redesign-stitch-lab/trip.html
  - website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-model.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-view.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-controller.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-itinerary-controller.js
  - website/cultural-map-redesign-stitch-lab/events.html
  - website/cultural-map-redesign-stitch-lab/itineraries.html
  - website/cultural-map-redesign-stitch-lab/directory.html
autonomous: true
requirements: [SC-2, SC-5, SC-6, SC-7]

must_haves:
  truths:
    - "trip.html loads and shows the dream board zone with all bookmarked places and events as cards"
    - "Dream board cards are clickable to open venue detail (with X button intercepting for remove)"
    - "An empty dream board shows an inviting empty state with CTA to explore the hub"
    - "Multiple named trips can be saved and switched via a trip selector UI"
    - "Curated itineraries have a 'Make it mine' button that copies all stops into the dream board"
    - "After 'Make it mine', a toast appears with the count and a 'View Trip' link to trip.html"
    - "Past events on the dream board show reduced opacity and a 'Past' badge"
    - "trip.html has an inline MapLibre map showing dream board pins"
    - "Nav links on events.html, itineraries.html, and directory.html include 'My Trip' with badge"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/trip.html"
      provides: "Trip planning page with nav, two-zone layout, inline map container"
      min_lines: 200
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-model.js"
      provides: "localStorage CRUD for user trips, multi-trip management, URL encode/decode"
      min_lines: 150
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-view.js"
      provides: "Dream board zone rendering, itinerary zone, unplanned zone, empty states"
      min_lines: 180
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-controller.js"
      provides: "Wire dream board model/view, map initialization, storage events, 'Make it mine'"
      min_lines: 160
  key_links:
    - from: "index-maplibre-tripbuilder-controller.js"
      to: "index-maplibre-dreamboard-model.js"
      via: "CulturalMapDreamboardModel.getStore() for rendering dream board cards"
      pattern: "CulturalMapDreamboardModel\\.getStore"
    - from: "index-maplibre-tripbuilder-view.js"
      to: "data.json"
      via: "fetch() to resolve asset coordinates for map pins"
      pattern: "fetch.*data\\.json"
    - from: "trip.html"
      to: "index-maplibre-tripbuilder-controller.js"
      via: "Script tag load + DOMContentLoaded init"
      pattern: "tripbuilder-controller"
    - from: "index-maplibre-itinerary-controller.js"
      to: "index-maplibre-dreamboard-model.js"
      via: "'Make it mine' button adds itinerary stops to dream board"
      pattern: "addPlace.*stops"
---

<objective>
Build the trip planning page (trip.html) with dream board rendering, multi-trip management, curated itinerary cloning ("Make it mine"), and inline map.

Purpose: SC-2 requires a dedicated trip page with dream board and itinerary zones. SC-5 requires multi-trip support. SC-6 requires "Make it mine" on curated itineraries. SC-7 requires unplanned items to persist.

Output: trip.html page, 3 new JS modules (tripbuilder-model, tripbuilder-view, tripbuilder-controller), "Make it mine" button on curated itineraries, "My Trip" nav links on all subpages.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-trip-builder/08-RESEARCH.md
@.planning/phases/08-ai-trip-builder/08-CONTEXT.md
@.planning/phases/08-ai-trip-builder/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trip.html page shell + tripbuilder-model.js + tripbuilder-view.js</name>
  <files>
    website/cultural-map-redesign-stitch-lab/trip.html
    website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-model.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-view.js
  </files>
  <action>
**trip.html (~250 lines):**
Follow the pattern of `itineraries.html` and `directory.html` — standalone page with shared nav header, page-specific content, and shared footer.

Structure:
- Same `<head>` as other subpages: Google Fonts (Playfair Display, DM Sans), MapLibre GL CSS CDN, GSAP CDN, Luxon CDN, page CSS (inline or reference main CSS file)
- Header: match hub's `.mast-inner` cream/blur pattern with nav links (Hub, Directory, Events, Itineraries, **My Trip** active). Include trip badge span.
- Content area with id `trip-content`:
  - Trip selector bar: `<div id="trip-selector">` with trip name, rename button, switcher dropdown, "New Trip" button
  - Two-column layout (desktop >900px): left = dream board zone (`#dreamboard-zone`), right = itinerary zone (`#itinerary-zone`)
  - Below: unplanned zone (`#unplanned-zone`)
  - Below: inline map container (`#trip-map`, height 400px desktop, 300px mobile)
- Script tags (load order):
  1. `index-maplibre-config.js` (constants, MAPTILER_KEY)
  2. `index-maplibre-core-utils.js` (deep link codec, helpers)
  3. `index-maplibre-dreamboard-model.js` (from plan 08-01)
  4. `index-maplibre-dreamboard-view.js` (from plan 08-01)
  5. `index-maplibre-tripbuilder-model.js` (new)
  6. `index-maplibre-tripbuilder-view.js` (new)
  7. `index-maplibre-tripbuilder-controller.js` (new)
  8. `index-maplibre-itinerary-model.js` (for resolveItineraryStops)
  9. `index-maplibre-itinerary-view.js` (for renderDetailOverlay, renderStopCard)
  10. `index-maplibre-corridor-map.js` (for route rendering)
  11. `index-maplibre-itinerary-calendar.js` (for calendar export)
  12. `index-maplibre-analytics.js` (for event tracking)
- Init call: `document.addEventListener('DOMContentLoaded', function() { CulturalMapTripBuilderController.init(); })`
- Responsive: desktop 2-col (55%/45%), tablet tighter gutters, mobile (<600px) single column stacked

**tripbuilder-model.js (~180 lines):**
- `STORAGE_KEY = 'ncac-user-trips'`
- Schema: `{ version: 1, trips: [...], activeTrip: 'usr-...' }` — each trip is itinerary-schema-compatible (see research doc Pattern 1)
- `getStore()` / `saveStore(store)` — same localStorage pattern as dreamboard-model
- `createTrip(title)` — creates new trip with id `'usr-' + Math.floor(Date.now()/1000)`, gold theme (`accent: '#c8943e'`, routeColor: '#7a9e7e', background: '#f5f0e8'`), empty days array. Sets as activeTrip. Returns trip object.
- `getActiveTrip()` — returns the trip matching activeTrip id, or null
- `setActiveTrip(tripId)` — updates activeTrip pointer
- `getAllTrips()` — returns trips array (shallow copy)
- `deleteTrip(tripId)` — removes trip, sets activeTrip to first remaining or null
- `renameTrip(tripId, newTitle)` — updates trip.title + trip.modified
- `saveTrip(trip)` — upsert trip into trips array by id match, update modified timestamp
- `encodeForUrl(trip)` — compress trip to single-letter keys (`t` title, `d` days, `s` stops, `a` asset, `m` time, `r` duration), JSON.stringify, btoa. If result > 1800 chars, return null (too long warning).
- `decodeFromUrl(encoded)` — atob, JSON.parse, expand single-letter keys back to full trip schema. Wrap in try/catch, return null on failure.
- Expose as `window.CulturalMapTripBuilderModel`

**tripbuilder-view.js (~220 lines):**
- `renderDreamBoardZone(store, data)` — generates HTML for dream board zone:
  - Section header: "Dream Board" with item count
  - If empty: inviting empty state card with illustration and CTA "Start by exploring places on the hub" linking to index page
  - If items exist: grid of dream board cards. Each place card shows: category color bar (from `CATS[layer]`), venue name, city, small bookmark icon (filled gold), X remove button (absolute top-right). Each event card shows: event title, venue name, date (formatted via Luxon), category color, "Past" badge if date < now (reduced opacity 0.5, strikethrough date).
  - At 20+ items: gentle inline note "Great collection! Ready to let the concierge organize it?"
  - At 30 items: note "Dream board full — remove a place to add more"
  - Cards have `data-asset-name` for places and `data-event-title`+`data-event-date` for events
  - Cards have class `dreamboard-card` and are clickable (to open detail panel via deep link)
- `renderItineraryZone(trip)` — generates HTML for itinerary zone:
  - If no active trip or trip has no days: empty state "No itinerary yet" with "Plan this trip" CTA button (id `plan-trip-cta`) and quick-action style cards ("1-day plan", "2-day plan", "Just organize my list")
  - If trip has days: delegate to `CulturalMapItineraryView.renderDetailOverlay(trip, resolved)` for the actual itinerary rendering (reuse existing view — this is the key leverage point)
  - Below itinerary: gold accent bar and "Built with the Local Concierge" attribution text
- `renderUnplannedZone(dreamBoardItems, tripStops)` — generates HTML for "Still on your radar":
  - Compare dream board place names against trip stop asset names
  - Items not in the trip render as small thumbnail list (venue name + category pill, no elaborate cards)
  - If all items are in the trip: "Everything made the cut!" message
  - Section hidden if dream board is empty
- `renderTripSelector(trips, activeId)` — dropdown/tab switcher for multi-trip management:
  - Active trip name (editable on double-click), dropdown arrow for switching
  - "New Trip" button
  - Delete trip button (with confirm)
- `injectCSS()` — inject trip page styles (dream board cards, zones, responsive, gold accents, empty states)
- Expose as `window.CulturalMapTripBuilderView`
  </action>
  <verify>
1. `trip.html` loads at `http://localhost:8001/trip.html` without JS errors
2. Dream board zone shows bookmarked items (or empty state if none)
3. `CulturalMapTripBuilderModel.createTrip('Test')` creates a trip in localStorage
4. `CulturalMapTripBuilderModel.encodeForUrl(trip)` produces a base64 string, `decodeFromUrl` round-trips it
5. `CulturalMapTripBuilderView.renderDreamBoardZone(store, data)` returns valid HTML
  </verify>
  <done>
trip.html loads as a standalone page with proper nav, two-zone layout, and inline map container. tripbuilder-model handles multi-trip CRUD and URL encoding. tripbuilder-view renders dream board cards, itinerary zone (with empty states), unplanned zone, and trip selector.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tripbuilder-controller + "Make it mine" + activateUserTrip + subpage nav</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-itinerary-controller.js
    website/cultural-map-redesign-stitch-lab/events.html
    website/cultural-map-redesign-stitch-lab/itineraries.html
    website/cultural-map-redesign-stitch-lab/directory.html
  </files>
  <action>
**tripbuilder-controller.js (~200 lines):**
- `init()` — called on DOMContentLoaded from trip.html:
  1. Call `CulturalMapDreamboardView.injectCSS()` and `CulturalMapTripBuilderView.injectCSS()`
  2. Fetch `data.json` — store as `state.data`
  3. Read dream board via `CulturalMapDreamboardModel.getStore()`
  4. Read active trip via `CulturalMapTripBuilderModel.getActiveTrip()`
  5. If no trips exist, auto-create one: `CulturalMapTripBuilderModel.createTrip('My Trip')`
  6. Render dream board zone, itinerary zone, unplanned zone, trip selector
  7. Initialize inline MapLibre map in `#trip-map` container:
     - Use same MapTiler Landscape style and MAPTILER_KEY from config
     - Fit bounds to Nevada County (use county bbox from config or hardcode: `[-121.3, 39.0, -120.5, 39.55]`)
     - Add dream board pins as circle markers (gold color) using GeoJSON source built from resolved asset coordinates
     - If active trip has an itinerary, draw route via `activateItineraryOnMap()` reuse
  8. Bind event handlers (see below)
  9. Listen for `storage` event to re-render if dream board changes from another tab

- Event handlers (delegated on `#trip-content`):
  - `.dreamboard-card` click → navigate to hub with deep link `?pid=AssetName` to open detail panel
  - `.dreamboard-card .remove-btn` click → `e.stopPropagation()`, remove from dream board, re-render zone, update map pins, show toast
  - `#plan-trip-cta` click → open the AI concierge chat widget pre-seeded with dream board context. For v1: navigate to hub page with `?chat=trip` parameter that triggers the chat to open in trip-planning mode.
  - Quick-action style cards (`.style-card`) click → navigate to hub with `?chat=trip&plan=1day` (or `2day`, `organize`), which the chat controller reads and auto-sends the appropriate prompt
  - Trip selector dropdown change → `setActiveTrip()`, re-render all zones
  - "New Trip" button → `createTrip('Trip ' + (count+1))`, switch, re-render
  - Delete trip confirm → `deleteTrip()`, switch to next, re-render
  - Rename (double-click trip name) → prompt for new name, `renameTrip()`, re-render

- `refreshMap()` — clear existing pins/routes, add current dream board pins, if active trip has route draw it

**activateUserTrip() addition (index-maplibre-itinerary-controller.js, ~25 lines):**
Add a new exported method `activateUserTrip(trip)` to `CulturalMapItineraryController`:
```javascript
function activateUserTrip(trip) {
  if (!trip || !trip.days) return;
  var resolved = itineraryModel.resolveItineraryStops(trip, state.data);
  if (!resolved || !resolved.length) return;
  state.resolved[trip.id] = resolved;
  state.activeId = trip.id;
  // Render overlay (reuse existing view)
  var container = state.overlayContainer || document.getElementById('itineraryOverlay');
  if (container) {
    container.innerHTML = itineraryView.renderDetailOverlay(trip, resolved);
    container.classList.add('active');
  }
  // Draw route on map (reuse existing pipeline)
  activateItineraryOnMap(trip.id, resolved, trip);
}
```
Add `activateUserTrip` to the module's public API.

**"Make it mine" button (index-maplibre-itinerary-controller.js, ~15 lines):**
In the itinerary detail overlay binding (where close button and day tab clicks are bound), add a handler for a "Make it mine" button. The button HTML should be added by modifying the overlay rendering or injecting after render. On click:
1. Read all stops from the active curated itinerary's resolved stops
2. For each stop that has `.data` (resolved asset), call `CulturalMapDreamboardModel.addPlace(stop.data)`
3. Show toast: "{N} places added to your dream board" with a "View Trip" link (`<a href="trip.html">View Trip</a>`)
4. Update nav badge via `CulturalMapDreamboardView.updateBadge()`

The "Make it mine" button should appear in the itinerary overlay header, styled with gold outline to match trip branding.

**Subpage nav links (events.html, itineraries.html, directory.html, ~4 lines each):**
In each subpage's nav section, add a "My Trip" link (`<a href="trip.html">My Trip <span class="trip-badge" style="display:none"></span></a>`). Add a small inline script at the bottom that reads dream board count and updates the badge on page load:
```html
<script>
(function() {
  try {
    var raw = localStorage.getItem('ncac-dreamboard');
    var store = raw ? JSON.parse(raw) : null;
    var count = store ? (store.places || []).length + (store.events || []).length : 0;
    var badge = document.querySelector('.trip-badge');
    if (badge && count > 0) { badge.textContent = count; badge.style.display = ''; }
  } catch(e) {}
})();
</script>
```
  </action>
  <verify>
1. Navigate to `http://localhost:8001/trip.html` — dream board shows bookmarked items (or empty state)
2. Clicking a dream board card navigates to the hub and opens the detail panel
3. Clicking X on a dream board card removes it with toast, map pins update
4. Trip selector shows current trip name, "New Trip" creates a second trip
5. On itineraries page, open a curated itinerary — "Make it mine" button visible
6. Clicking "Make it mine" adds stops to dream board, shows toast with "View Trip" link
7. events.html, itineraries.html, directory.html all show "My Trip" nav link with badge
8. Inline map on trip.html renders with dream board pins
  </verify>
  <done>
trip.html is fully functional: dream board zone renders cards with remove/click behavior, trip selector handles multiple trips, inline map shows pins. "Make it mine" on curated itineraries copies stops to dream board. All subpages show "My Trip" nav with badge count. activateUserTrip() is available for plan 08-04 to render finalized trips.
  </done>
</task>

</tasks>

<verification>
1. trip.html loads standalone at localhost:8001/trip.html with no console errors
2. Dream board shows all localStorage items with correct category colors and remove buttons
3. Empty state shows when no items bookmarked, with CTA to hub
4. Multi-trip: create, rename, switch, delete all work correctly
5. "Make it mine" copies all curated itinerary stops into dream board
6. Inline map renders with MapTiler tiles and dream board pins as gold markers
7. All subpage nav links show "My Trip" with live badge count
8. Past events show reduced opacity and "Past" badge
</verification>

<success_criteria>
The trip planning page exists as a standalone destination where users see their collected places, manage multiple trips, and have clear CTAs to invoke the AI concierge. Curated itineraries can be cloned. The infrastructure for rendering finalized itineraries (plan 08-04) and chatbot integration (plan 08-03) is ready.
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-trip-builder/08-02-SUMMARY.md`
</output>
