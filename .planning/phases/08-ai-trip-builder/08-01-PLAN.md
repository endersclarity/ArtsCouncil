---
phase: 08-ai-trip-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - website/cultural-map-redesign-stitch-lab/index-maplibre-dreamboard-model.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-dreamboard-view.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-detail-view.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-explore-view.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-map-data-model.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html
autonomous: true
requirements: [SC-1]

must_haves:
  truths:
    - "Clicking a bookmark icon on the detail panel saves the venue to localStorage under 'ncac-dreamboard'"
    - "Clicking a bookmark icon on a directory card saves the venue to the dream board"
    - "Clicking a bookmark icon on an event card saves the event (with date/time) to the dream board"
    - "Hovering a map marker tooltip shows a bookmark icon that saves the venue"
    - "A 'My Trip' nav link with badge count appears in the top bar, count updates on add/remove"
    - "A toast notification confirms each add/remove action with undo support"
    - "Re-clicking a filled bookmark icon removes the item from the dream board"
    - "Both venues AND events are bookmarkable as separate entry types"
    - "Past events on the dream board show a visual 'Past' indicator (reduced opacity)"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-dreamboard-model.js"
      provides: "localStorage CRUD for dream board (places + events)"
      min_lines: 100
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-dreamboard-view.js"
      provides: "Bookmark icon rendering, toast notifications, badge count, first-use label"
      min_lines: 120
  key_links:
    - from: "index-maplibre-dreamboard-view.js"
      to: "index-maplibre-dreamboard-model.js"
      via: "CulturalMapDreamboardModel.addPlace/removePlace/hasPlace"
      pattern: "CulturalMapDreamboardModel\\."
    - from: "index-maplibre-detail-view.js"
      to: "index-maplibre-dreamboard-view.js"
      via: "Bookmark button HTML injected into detail panel header"
      pattern: "detail-bookmark-btn"
    - from: "index-maplibre-bindings.js"
      to: "index-maplibre-dreamboard-model.js"
      via: "Delegated click handlers for .detail-bookmark-btn and .card-bookmark-btn"
      pattern: "bookmark-btn"
---

<objective>
Create the dream board localStorage model and add bookmark icons to all user-facing surfaces (detail panel, directory cards, event cards, map tooltips, nav badge).

Purpose: SC-1 requires bookmark icons across all surfaces. This plan delivers the foundational data layer (localStorage CRUD) and the UI integration (bookmark buttons, toast, badge) that all subsequent plans depend on.

Output: Two new JS modules (dreamboard-model, dreamboard-view), bookmark icons on 4 surfaces, nav badge with count, toast notifications.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-trip-builder/08-RESEARCH.md
@.planning/phases/08-ai-trip-builder/08-CONTEXT.md
@.planning/phases/05-ai-concierge/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dream board model and view modules</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-dreamboard-model.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-dreamboard-view.js
  </files>
  <action>
Create two new IIFE modules following project conventions (ES5, window.CulturalMap* globals).

**dreamboard-model.js (~120 lines):**
- `STORAGE_KEY = 'ncac-dreamboard'`
- Schema: `{ version: 1, places: [...], events: [...] }` — see research doc Pattern 2 for exact schema
- `getStore()` — read + parse localStorage with try/catch fallback to empty store
- `saveStore(store)` — JSON.stringify + setItem with try/catch
- `addPlace(asset)` — accepts data.json asset object, deduplicates by `.n` (case-insensitive), enforces 30-item hard limit across places+events, pushes `{ asset: asset.n, layer: asset.l, city: asset.c, addedAt: Date.now(), source: 'detail' }`. Returns boolean success.
- `removePlace(assetName)` — filter by case-insensitive name match
- `hasPlace(assetName)` — returns boolean
- `addEvent(eventObj)` — accepts `{ title, venue, date, layer }`, deduplicates by title+date combo, pushes with `addedAt` and `source: 'event'`. Returns boolean.
- `removeEvent(title, date)` — filter by title+date match
- `hasEvent(title, date)` — returns boolean
- `getItemCount()` — places.length + events.length
- `getPlaces()` — returns places array (shallow copy)
- `getEvents()` — returns events array (shallow copy)
- `clearAll()` — reset to empty store
- Expose all as `window.CulturalMapDreamboardModel`

**dreamboard-view.js (~150 lines):**
- `renderBookmarkButton(assetName, size)` — returns bookmark SVG button HTML string. If `CulturalMapDreamboardModel.hasPlace(assetName)` is true, fill is gold (#c8943e), otherwise outline only (#8a8278). CSS class: `bookmark-btn`. Data attribute: `data-asset-name`. Size param defaults to 24.
- `renderEventBookmarkButton(title, date)` — same pattern for events. CSS class: `event-bookmark-btn`. Data attributes: `data-event-title`, `data-event-date`.
- `showToast(message, undoCallback)` — creates a fixed bottom-center toast div. Slide up via GSAP (y: 20->0, opacity: 0->1, 200ms). Auto-dismiss after 3s with fade. Includes "Undo" text link if callback provided. Background: `rgba(26,22,18,0.9)`, white text, DM Sans. Max one toast at a time. On mobile: full-width with 1rem padding.
- `updateBadge()` — reads `getItemCount()`, updates `.trip-badge` element text. If count > 0, show badge with GSAP scale pulse (1.0->1.25->1.0, 300ms, ease: 'back.out'). If 0, hide badge. Badge style: gold circle 18px, white number, DM Sans 0.68rem bold.
- `injectCSS()` — injects bookmark and toast CSS into `<head>` on first call (same pattern as itinerary-view.js). Styles: `.bookmark-btn` (cursor pointer, background none, border none, padding 4px, transition fill 200ms), `.bookmark-btn.active svg path` (fill: #c8943e), `.toast-container` (fixed bottom-center), `.trip-badge` (gold circle).
- `renderFirstUseLabel()` — returns "Save to Trip" text span. Only shown if `localStorage.getItem('ncac-bookmark-seen')` is falsy. After first bookmark action, set `ncac-bookmark-seen` to `'1'` and hide the label.
- Expose all as `window.CulturalMapDreamboardView`

Both modules use `'use strict'` inside their IIFEs.
  </action>
  <verify>
Open browser console on localhost:8001, verify:
1. `window.CulturalMapDreamboardModel` exists with all methods
2. `CulturalMapDreamboardModel.addPlace({n:'Test',l:'Historic Landmarks',c:'Grass Valley'})` returns true and `localStorage.getItem('ncac-dreamboard')` contains the entry
3. `CulturalMapDreamboardModel.hasPlace('Test')` returns true
4. `CulturalMapDreamboardModel.removePlace('Test')` removes it
5. `window.CulturalMapDreamboardView` exists with all methods
  </verify>
  <done>
dreamboard-model.js provides complete localStorage CRUD for places and events with dedup, hard limit, and version field. dreamboard-view.js provides bookmark button HTML generation, toast, badge update, and CSS injection. Both modules load without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add bookmark buttons to all surfaces and wire event handlers</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-detail-view.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-explore-view.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-map-data-model.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html
  </files>
  <action>
**1. Detail panel bookmark (index-maplibre-detail-view.js, ~20 lines):**
In the function that builds the detail panel header HTML (look for the panel title/name area), add a bookmark button next to the venue name. Use `CulturalMapDreamboardView.renderBookmarkButton(asset.n, 24)`. Include the first-use "Save to Trip" label via `renderFirstUseLabel()` on the first detail panel open.

**2. Directory/explore card bookmark (index-maplibre-explore-view.js, ~15 lines):**
In the card rendering function, add a small bookmark icon (size 20) in the top-right corner of each card. Use `CulturalMapDreamboardView.renderBookmarkButton(item.n, 20)` with CSS class `card-bookmark-btn` for positioning (absolute, top 8px, right 8px).

**3. Map tooltip bookmark (index-maplibre-map-data-model.js, ~5 lines):**
In `buildFeatureTooltipHTML()`, add a bookmark button (size 18) after the venue name in the tooltip. Use the same `renderBookmarkButton` pattern.

**4. Event card bookmark:** In whichever file renders event cards (check `index-maplibre-events-view.js`), add `CulturalMapDreamboardView.renderEventBookmarkButton(event.title, event.date)` with size 18 in the card corner.

**5. Nav badge (HTML entry point, ~8 lines):**
In the hub HTML entry point (`index-maplibre-hero-intent-stitch-frontend-design-pass.html`):
- Add `<script>` tags for the 2 new modules AFTER `index-maplibre-itinerary-controller.js` and BEFORE `index-maplibre-detail-view.js` in the script load order:
  ```html
  <script src="index-maplibre-dreamboard-model.js"></script>
  <script src="index-maplibre-dreamboard-view.js"></script>
  ```
- Add a "My Trip" nav link in the top navigation bar with a `<span class="trip-badge" style="display:none"></span>` badge element. Link href should be `trip.html`.

**6. Event handlers (index-maplibre-bindings.js, ~30 lines):**
Add delegated click handlers on `document.body` for:
- `.bookmark-btn` clicks: read `data-asset-name`, toggle via `addPlace`/`removePlace`, update button fill, call `showToast`, call `updateBadge`. On first successful add, set `ncac-bookmark-seen` to `'1'`.
- `.event-bookmark-btn` clicks: read `data-event-title` + `data-event-date`, toggle via `addEvent`/`removeEvent`, update button, toast, badge.
- Use `e.stopPropagation()` on bookmark clicks to prevent parent card/tooltip click propagation.

**7. Page-load badge init:**
In the main app init sequence (index-maplibre.js or bindings.js), call `CulturalMapDreamboardView.updateBadge()` on DOMContentLoaded to show the correct count on page load.

**8. Cross-tab sync:**
In bindings.js, add `window.addEventListener('storage', function(e) { if (e.key === 'ncac-dreamboard') CulturalMapDreamboardView.updateBadge(); })` to sync badge across tabs.
  </action>
  <verify>
On localhost:8001:
1. Open any venue detail panel — bookmark icon visible next to name, clicking it turns gold and shows toast "X added to your trip"
2. Click again — turns outline, shows toast "X removed from your trip"
3. Navigate to directory — cards show small bookmark icons in top-right
4. Hover a map marker — tooltip shows bookmark icon
5. "My Trip" nav link shows badge count matching the number of bookmarked items
6. Badge count updates immediately on add/remove
7. Opening a second tab and adding a bookmark updates badge in the first tab
  </verify>
  <done>
Bookmark icons appear on detail panels, directory cards, event cards, and map tooltips. Clicking toggles the bookmark state with toast feedback and badge count. Nav shows "My Trip" link with live badge. Cross-tab sync works via storage event.
  </done>
</task>

</tasks>

<verification>
1. `localStorage.getItem('ncac-dreamboard')` contains valid JSON after adding items
2. Adding 30+ items is blocked (hard limit) — addPlace returns false
3. Duplicate adds are rejected — same venue cannot appear twice
4. Badge shows correct count on fresh page load (reads localStorage)
5. Toast appears and auto-dismisses after 3 seconds
6. Undo link in toast reverses the add/remove action
7. All bookmark buttons use consistent visual treatment (gold filled when active, outline when inactive)
</verification>

<success_criteria>
Users can bookmark venues from any surface (detail panel, directory, map, events) and see a running count in the nav badge. All bookmarks persist in localStorage across page loads. Toast notifications confirm each action. The dream board model is ready for consumption by trip.html (plan 08-02) and the chatbot (plan 08-03).
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-trip-builder/08-01-SUMMARY.md`
</output>
