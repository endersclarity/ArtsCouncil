---
phase: 08-ai-trip-builder
plan: 04
type: execute
wave: 3
depends_on: [08-02, 08-03]
files_modified:
  - website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-controller.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-view.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-core-utils.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html
autonomous: false
requirements: [SC-4, SC-5, SC-7]

must_haves:
  truths:
    - "A finalized trip renders with day tabs, stop cards, map route, and calendar export — identical to curated itineraries"
    - "Finalized trip itinerary has gold accent and 'Built with the Local Concierge' attribution"
    - "Clicking 'View & Edit' from chat navigates to trip.html where the itinerary is rendered"
    - "Unplanned dream board items appear in 'Still on your radar' zone below the itinerary"
    - "Users can share a trip via URL (base64-encoded, <1800 chars) and recipients see the itinerary"
    - "Navigating to trip.html?trip=<encoded> loads and renders the shared trip"
    - "Analytics events fire for: trip created, itinerary generated, trip shared, calendar export"
    - "The trip page inline map shows the itinerary route with numbered stop markers and route line"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-controller.js"
      provides: "Finalized itinerary rendering pipeline, share URL generation, map route activation"
      min_lines: 200
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-view.js"
      provides: "Share button UI, 'Still on your radar' rendering, gold attribution bar"
      min_lines: 200
  key_links:
    - from: "index-maplibre-tripbuilder-controller.js"
      to: "index-maplibre-itinerary-controller.js"
      via: "activateUserTrip(trip) to render itinerary with existing pipeline"
      pattern: "activateUserTrip"
    - from: "index-maplibre-tripbuilder-controller.js"
      to: "index-maplibre-tripbuilder-model.js"
      via: "encodeForUrl(trip) for shareable link generation"
      pattern: "encodeForUrl"
    - from: "trip.html (URL params)"
      to: "index-maplibre-tripbuilder-controller.js"
      via: "?trip=<encoded> deep link parsed on init"
      pattern: "trip="
    - from: "index-maplibre-core-utils.js"
      to: "deep link codec"
      via: "'trip' added to scalars array"
      pattern: "scalars.*trip"
---

<objective>
Wire finalized itinerary rendering on trip.html (reusing existing itinerary view + map route pipeline), add shareable URL encoding, calendar export, "Still on your radar" zone, analytics events, and final polish.

Purpose: SC-4 requires finalized itineraries to render like curated ones with gold accent. SC-5 requires shareable URLs. SC-7 requires unplanned items to persist. This plan brings everything together.

Output: Complete trip planning experience — rendered itineraries on trip.html, share button, deep link support, analytics, and visual polish.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-trip-builder/08-RESEARCH.md
@.planning/phases/08-ai-trip-builder/08-CONTEXT.md
@.planning/phases/08-ai-trip-builder/08-01-SUMMARY.md
@.planning/phases/08-ai-trip-builder/08-02-SUMMARY.md
@.planning/phases/08-ai-trip-builder/08-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire finalized itinerary rendering + share URL + deep link + analytics</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-tripbuilder-view.js
    website/cultural-map-redesign-stitch-lab/index-maplibre.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-core-utils.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js
  </files>
  <action>
**1. Finalized itinerary rendering (tripbuilder-controller.js, ~40 lines):**

In the `init()` function (or a `renderItinerary()` helper), when the active trip has days with stops:
- Call `CulturalMapItineraryModel.resolveItineraryStops(trip, state.data)` to resolve asset references
- If resolved stops exist:
  - Render the itinerary zone using `CulturalMapItineraryView.renderDetailOverlay(trip, resolved)` — this is the existing view that renders day tabs, stop cards, time ranges, narratives, and calendar links. It works unchanged because the trip matches the itinerary schema.
  - Insert the rendered HTML into `#itinerary-zone`
  - Add gold attribution bar below: `<div class="trip-attribution">Built with the <strong>Local Concierge</strong></div>` (gold accent, italic, centered)
  - Bind day tab clicks within the itinerary zone (same handlers as itinerary-controller uses)
  - Bind calendar export links (they already use `buildStopCalendarUrl()` from itinerary-calendar.js)
- Activate route on inline map: use the corridor-map module to draw numbered stop markers and animated route line on the trip.html map instance. This requires:
  - Building a GeoJSON line from resolved stop coordinates (same as `flattenStopsForMap`)
  - Adding a route source and layer to the trip map
  - Adding numbered stop markers
  - Fitting bounds to the route
  - Follow the pattern in `activateItineraryOnMap()` but targeting the trip page's map instance instead of the hub map

**2. "Still on your radar" zone (tripbuilder-view.js, ~25 lines):**

Enhance `renderUnplannedZone()`:
- Build a Set of trip stop asset names (from all days, all stops, case-insensitive)
- Filter dream board places that are NOT in the trip stops set
- Render as simple list items: `<div class="unplanned-item"><span class="unplanned-dot" style="background:{catColor}"></span>{name} · {city}</div>`
- If all dream board items made it into the trip: show "Everything made the cut!" with a checkmark
- If no trip exists yet (itinerary zone is empty): hide the unplanned zone entirely

**3. Share URL generation (tripbuilder-controller.js + tripbuilder-view.js, ~30 lines):**

Add a "Share Trip" button in the itinerary zone header (only visible when trip has stops):
- On click: call `CulturalMapTripBuilderModel.encodeForUrl(trip)`
- If result is not null (under 1800 chars):
  - Build URL: `window.location.origin + '/trip.html?trip=' + encoded`
  - Copy to clipboard via `navigator.clipboard.writeText(url)` with fallback textarea method
  - Show toast: "Trip link copied! Share it with friends."
- If result is null (too long):
  - Show toast: "This trip is too long to share via link. Try a shorter itinerary."

**4. Deep link parsing (tripbuilder-controller.js init, ~15 lines):**

On trip.html load, check `URLSearchParams` for `trip` parameter:
```javascript
var params = new URLSearchParams(window.location.search);
var encoded = params.get('trip');
if (encoded) {
  var sharedTrip = CulturalMapTripBuilderModel.decodeFromUrl(encoded);
  if (sharedTrip) {
    // Save shared trip to localStorage (so it persists)
    CulturalMapTripBuilderModel.saveTrip(sharedTrip);
    CulturalMapTripBuilderModel.setActiveTrip(sharedTrip.id);
    // Re-render with the shared trip active
    renderAll();
  }
}
```

**5. Deep link codec (index-maplibre-core-utils.js, 2 lines):**

Add `'trip'` to the `scalars` array in both `parseDeepLinkSearch()` and `serializeDeepLinkSearch()`:
```javascript
// BEFORE:
var scalars = ['open', 'events14d', 'experience', 'itinerary', 'muse', 'pid', 'event', 'eventDate', 'eventCat', 'eventAudience'];
// AFTER:
var scalars = ['open', 'events14d', 'experience', 'itinerary', 'muse', 'pid', 'event', 'eventDate', 'eventCat', 'eventAudience', 'trip'];
```

**6. Hub deep link handler (index-maplibre.js, ~10 lines):**

In the main app's deep link initialization, add handling for `?chat=trip` parameter:
```javascript
var chatParam = parsed.chat || new URLSearchParams(window.location.search).get('chat');
if (chatParam === 'trip') {
  // Open chat widget
  if (window.CulturalMapChatWidget) {
    window.CulturalMapChatWidget.open();
  }
  var planParam = new URLSearchParams(window.location.search).get('plan');
  if (planParam && window.CulturalMapChatController) {
    var prompts = {
      '1day': 'Plan me a 1-day trip using my saved places',
      '2day': 'Plan me a 2-day trip using my saved places',
      'organize': 'Organize all my saved places into a logical trip plan'
    };
    if (prompts[planParam]) {
      setTimeout(function() { CulturalMapChatController.sendMessage(prompts[planParam]); }, 500);
    }
  }
}
```

**7. Analytics events (index-maplibre-analytics.js, ~20 lines):**

Add tracking calls for trip builder interactions. Use the existing `trackEvent(name, data)` pattern:
- `trip_bookmark_add` — when a place/event is bookmarked (add to bindings.js bookmark handler from 08-01)
- `trip_bookmark_remove` — when removed
- `trip_created` — when a new trip is created via tripbuilder-model
- `trip_itinerary_generated` — when {{ITINERARY}} is successfully parsed (in chat-controller)
- `trip_shared` — when share URL is copied
- `trip_calendar_export` — when a stop's calendar link is clicked on trip.html
- `trip_make_it_mine` — when "Make it mine" is clicked on a curated itinerary

Add these as named event constants in the analytics module. Instrument each call point.
  </action>
  <verify>
1. On trip.html, with a saved trip that has stops: itinerary renders with day tabs, stop cards, calendar links
2. Gold accent and "Built with the Local Concierge" attribution visible below itinerary
3. Map shows numbered stop markers and route line for the trip
4. "Share Trip" copies a URL to clipboard; opening that URL in an incognito tab loads the trip
5. Unplanned items appear in "Still on your radar" section
6. `?chat=trip&plan=1day` on the hub opens chat and auto-sends planning prompt
7. Analytics events appear in Umami (check network tab for tracking calls)
8. Deep link `trip.html?trip=<encoded>` loads and renders a shared trip
  </verify>
  <done>
Finalized trips render with full itinerary view (day tabs, stops, calendar), map route, gold attribution. Share URL works for trips under 12 stops. "Still on your radar" shows unplanned items. Analytics track all trip builder interactions. Deep links work for both hub chat and trip.html sharing.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end trip builder verification</name>
  <files>website/cultural-map-redesign-stitch-lab/trip.html</files>
  <action>
Human verification checkpoint. The complete AI Trip Builder feature has been built across plans 08-01 through 08-04: bookmark icons on all surfaces, dream board localStorage, trip.html with two-zone layout, AI concierge trip planning mode with {{ITINERARY}} parser, finalized itinerary rendering (reusing existing pipeline), inline map with route, calendar export, share via URL, multi-trip management, "Make it mine" on curated itineraries, analytics events.

Verify the following flows:

**Flow 1: Full additive flow**
1. Go to http://localhost:8001/ (hub page)
2. Click on 3-4 different venues to open detail panels — bookmark each one (gold icon)
3. Verify nav badge shows correct count (e.g., "4")
4. Open the chat (FAB button) — verify style cards appear ("1-Day Plan", "2-Day Plan", "Just Organize My List")
5. Click "1-Day Plan" — wait for response
6. Verify response contains an itinerary card with title, stop count, and "View & Edit on Trip Page" link
7. Click "View & Edit on Trip Page" — verify trip.html loads
8. Verify: dream board zone shows all 4 bookmarked places
9. Verify: itinerary zone shows the planned trip with day tabs, stop cards, time ranges
10. Verify: map shows numbered stop markers and route line
11. Verify: "Still on your radar" shows any places not included in the plan
12. Verify: gold "Built with the Local Concierge" attribution below itinerary

**Flow 2: Make it mine**
1. Go to itineraries page, open a curated itinerary
2. Click "Make it mine" — verify toast shows "{N} places added"
3. Navigate to trip.html — verify those places appear in the dream board

**Flow 3: Share**
1. On trip.html with a finalized trip, click "Share Trip"
2. Paste the URL in an incognito/private window
3. Verify the shared trip loads and renders correctly

**Flow 4: Mobile**
1. Resize browser to 375px width
2. Verify trip.html stacks correctly: dream board -> CTA -> itinerary -> unplanned -> map
3. Verify bookmark icons are tappable on mobile detail panels

**Flow 5: Analytics**
1. Open browser network tab, filter for analytics/umami
2. Bookmark a place — verify trip_bookmark_add event fires
3. Generate an itinerary — verify trip_itinerary_generated event fires
4. Share a trip — verify trip_shared event fires
  </action>
  <verify>All 5 verification flows pass without console errors. Type "approved" or describe issues found for targeted fixes.</verify>
  <done>User confirms the complete AI Trip Builder feature works end-to-end across all flows</done>
</task>

</tasks>

<verification>
1. Full end-to-end: bookmark -> chat -> plan -> render -> share -> load shared
2. Itinerary rendering reuses existing pipeline (identical to curated)
3. Map route with numbered stops renders on trip.html
4. Calendar export works for user trip stops
5. Share URL round-trips correctly (encode -> copy -> paste -> decode -> render)
6. URLs over 1800 chars show a warning instead of breaking
7. "Still on your radar" correctly identifies unplanned items
8. All 7 analytics events fire at their respective interaction points
9. Mobile layout is functional at 375px
10. No console errors throughout any flow
</verification>

<success_criteria>
The complete AI Trip Builder is functional: users can bookmark places from any surface, plan trips via AI concierge, see rendered itineraries with map routes, share trips via URL, and manage multiple trips. The feature reuses 500+ lines of existing itinerary rendering code unchanged. All success criteria SC-1 through SC-7 are met.
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-trip-builder/08-04-SUMMARY.md`
</output>
