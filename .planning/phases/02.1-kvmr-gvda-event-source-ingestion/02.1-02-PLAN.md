---
phase: 02.1-kvmr-gvda-event-source-ingestion
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - scripts/events/merge_events.py
  - .github/workflows/refresh-events.yml
autonomous: true

must_haves:
  truths:
    - "Merge pipeline accepts 5 source files (trumba, libcal, civicengage, kvmr, gvda) and produces a single deduplicated events-merged.json"
    - "GVDA events dedup against Arts Council Trumba events (~20 overlaps removed, Arts Council wins)"
    - "Source priority order is trumba > gvda > libcal > kvmr > civicengage"
    - "GitHub Actions workflow runs all 5 ingest scripts daily with continue-on-error for supplementary sources"
    - "End-to-end pipeline produces more total events than the previous 3-source pipeline"
  artifacts:
    - path: "scripts/events/merge_events.py"
      provides: "5-source merge pipeline"
      contains: "kvmr"
    - path: ".github/workflows/refresh-events.yml"
      provides: "Daily cron with 5 ingest steps"
      contains: "ingest_kvmr_ical"
  key_links:
    - from: "scripts/events/merge_events.py"
      to: "website/cultural-map-redesign/events-kvmr.json"
      via: "file read in load_source_events"
      pattern: "events-kvmr\\.json"
    - from: "scripts/events/merge_events.py"
      to: "website/cultural-map-redesign/events-gvda.json"
      via: "file read in load_source_events"
      pattern: "events-gvda\\.json"
    - from: ".github/workflows/refresh-events.yml"
      to: "scripts/events/ingest_kvmr_ical.py"
      via: "workflow step"
      pattern: "ingest_kvmr_ical"
    - from: ".github/workflows/refresh-events.yml"
      to: "scripts/events/ingest_trumba_json.py"
      via: "workflow step"
      pattern: "ingest_trumba_json"
---

<objective>
Extend the merge/dedup pipeline and GitHub Actions workflow to include KVMR and GVDA as 4th and 5th event sources.

Purpose: Wire the two new ingest scripts (from Plan 01) into the existing automated pipeline so events-merged.json includes all 5 sources on every daily cron run.

Output: Updated merge_events.py handling 5 sources with correct dedup priority, updated workflow YAML with 5 ingest steps.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-kvmr-gvda-event-source-ingestion/02.1-RESEARCH.md
@.planning/phases/02.1-kvmr-gvda-event-source-ingestion/02.1-01-SUMMARY.md
@scripts/events/merge_events.py
@.github/workflows/refresh-events.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend merge_events.py for 5 sources</name>
  <files>scripts/events/merge_events.py</files>
  <action>
Modify the existing merge_events.py to accept KVMR and GVDA source files alongside the existing 3. This is additive -- do NOT restructure the script.

1. **Add default file paths:**
   ```python
   DEFAULT_KVMR_FILE = Path("website/cultural-map-redesign/events-kvmr.json")
   DEFAULT_GVDA_FILE = Path("website/cultural-map-redesign/events-gvda.json")
   ```

2. **Update SOURCE_PRIORITY** (lower = preferred, Arts Council keeps top spot):
   ```python
   SOURCE_PRIORITY = {
       "trumba": 0,
       "gvda": 1,
       "libcal": 2,
       "kvmr": 3,
       "civicengage": 4,
   }
   ```

3. **Update get_source_type()** to recognize new prefixes:
   ```python
   if event_id.startswith("gvda-"):
       return "gvda"
   if event_id.startswith("kvmr-"):
       return "kvmr"
   ```
   Add these BEFORE the fallback section. Also add fallback for source_type "json" -> "gvda".

4. **Add CLI arguments** for the two new files (--kvmr-file, --gvda-file) following the existing pattern.

5. **In main():** Load the two new sources alongside existing ones:
   ```python
   kvmr_events = load_source_events(args.kvmr_file, "kvmr")
   gvda_events = load_source_events(args.gvda_file, "gvda")
   ```
   Add to source_counts dict. Add to all_events concatenation. Update the print summary to include all 5 sources.

6. **Update docstring** to mention all 5 sources.

7. **Do NOT change:** dedup logic, family classification, output format, flat output. The existing dedup handles cross-source matching automatically -- GVDA/Trumba overlap will be caught by title+venue fuzzy match on same date.
  </action>
  <verify>
Run the full pipeline locally:
```bash
python scripts/events/ingest_trumba_rss.py
python scripts/events/ingest_libcal_ical.py
python scripts/events/ingest_civicengage_rss.py || true
python scripts/events/ingest_kvmr_ical.py
python scripts/events/ingest_trumba_json.py
python scripts/events/merge_events.py
```
Verify:
- merge_events.py exits 0
- events-merged.json has source_counts with all 5 sources
- dedup_removed is >= 15 (GVDA/Trumba overlap)
- Total event count is higher than previous 3-source total (~120)
- `python -c "import json; d=json.load(open('website/cultural-map-redesign/events-merged.json')); print(d['source_counts'])"` shows all 5 sources
  </verify>
  <done>merge_events.py accepts 5 source files, deduplicates with correct priority (trumba > gvda > libcal > kvmr > civicengage), and produces events-merged.json with combined events from all sources.</done>
</task>

<task type="auto">
  <name>Task 2: Update GitHub Actions workflow for 5 sources</name>
  <files>.github/workflows/refresh-events.yml</files>
  <action>
Add two new ingest steps to the refresh-events workflow. Insert AFTER the CivicEngage step and BEFORE the merge step.

1. **Add KVMR ingest step:**
   ```yaml
   - name: Ingest KVMR iCal
     run: python scripts/events/ingest_kvmr_ical.py
     continue-on-error: true  # KVMR is supplementary source
   ```

2. **Add GVDA ingest step:**
   ```yaml
   - name: Ingest GVDA Trumba JSON
     run: python scripts/events/ingest_trumba_json.py
     continue-on-error: true  # GVDA is supplementary source
   ```

3. **Update commit message** in the git-auto-commit step:
   ```yaml
   commit_message: "chore(data): refresh events from Trumba + LibCal + CivicEngage + KVMR + GVDA"
   ```

4. **Update report step** to show the new total (no code change needed -- it reads events-merged.json which already has the combined data).

5. **Do NOT change:** cron schedule, Python version, checkout action, pip install, existing ingest steps, merge step, build_event_index step.
  </action>
  <verify>
Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/refresh-events.yml'))"` (or install PyYAML if needed).
Verify the workflow has exactly 5 ingest steps before the merge step.
Verify KVMR and GVDA steps both have `continue-on-error: true`.
  </verify>
  <done>GitHub Actions workflow runs all 5 ingest scripts daily, with continue-on-error for KVMR and GVDA (supplementary sources that should not break the pipeline if their feeds go down).</done>
</task>

</tasks>

<verification>
- Full pipeline runs end-to-end locally: all 5 ingest scripts -> merge -> index
- events-merged.json source_counts shows all 5 sources with non-zero counts for at least trumba, libcal, kvmr, gvda
- dedup_removed count indicates GVDA/Trumba overlap is being caught (~15-20)
- Total events > 120 (previous 3-source total)
- GitHub Actions YAML is valid and has correct step order
- No existing tests broken (run `node tests/test_*.js` if applicable)
</verification>

<success_criteria>
- `python scripts/events/merge_events.py` exits 0 with 5 sources loaded
- events-merged.json total events > 120 (was 120 with 3 sources)
- dedup_removed >= 15 (GVDA/Trumba overlap)
- GitHub Actions YAML has 5 ingest steps with correct continue-on-error flags
- Client-side code requires NO changes (already handles merged JSON with source badges)
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-kvmr-gvda-event-source-ingestion/02.1-02-SUMMARY.md`
</output>
