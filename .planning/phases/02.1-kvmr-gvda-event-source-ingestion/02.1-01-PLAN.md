---
phase: 02.1-kvmr-gvda-event-source-ingestion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/events/ingest_kvmr_ical.py
  - scripts/events/ingest_trumba_json.py
autonomous: true

must_haves:
  truths:
    - "KVMR iCal feed is fetched, parsed, and outputs canonical events JSON with kvmr- prefixed IDs"
    - "GVDA Trumba JSON feed is fetched, parsed, and outputs canonical events JSON with gvda- prefixed IDs"
    - "KVMR out-of-county events (Sacramento, etc.) are filtered out via city whitelist"
    - "GVDA HTML location fields are stripped to plain venue names"
    - "GVDA events use combined startDateTime + startTimeZoneOffset for correct Pacific timestamps"
    - "Both scripts apply 14-day window filter (skip past events and events beyond 14 days)"
  artifacts:
    - path: "scripts/events/ingest_kvmr_ical.py"
      provides: "KVMR iCal ingest script"
      min_lines: 100
    - path: "scripts/events/ingest_trumba_json.py"
      provides: "GVDA Trumba JSON ingest script"
      min_lines: 120
  key_links:
    - from: "scripts/events/ingest_kvmr_ical.py"
      to: "website/cultural-map-redesign/events-kvmr.json"
      via: "JSON file output"
      pattern: "events-kvmr\\.json"
    - from: "scripts/events/ingest_trumba_json.py"
      to: "website/cultural-map-redesign/events-gvda.json"
      via: "JSON file output"
      pattern: "events-gvda\\.json"
---

<objective>
Create two new event ingest scripts: one for KVMR community radio iCal feed, one for GVDA (Grass Valley Downtown Association) Trumba JSON feed.

Purpose: Close event coverage gaps before the Wednesday Feb 18 committee demo. Major events like Mardi Gras are missing from existing 3 sources but present in KVMR and GVDA feeds.

Output: Two Python scripts that each produce canonical events JSON matching the existing pipeline schema.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-kvmr-gvda-event-source-ingestion/02.1-RESEARCH.md
@scripts/events/ingest_libcal_ical.py
@scripts/events/ingest_trumba_rss.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KVMR iCal ingest script</name>
  <files>scripts/events/ingest_kvmr_ical.py</files>
  <action>
Clone `ingest_libcal_ical.py` and adapt for KVMR community radio iCal feed. Key changes:

1. **URL:** `https://www.kvmr.org/events/?ical=1`
2. **Output:** `website/cultural-map-redesign/events-kvmr.json`
3. **Event ID prefix:** `kvmr-{cleaned_uid}-{date}` (falling back to `kvmr-{datetime}-{slug}`)
4. **Source label:** `"KVMR"`
5. **Source type:** `"ical"`

6. **City filtering (CRITICAL):** KVMR lists out-of-county events (Sacramento, Roseville, etc.). Add a Nevada County city whitelist:
   ```python
   NC_CITIES = {
       "grass valley", "nevada city", "penn valley", "north san juan",
       "truckee", "chicago park", "alta sierra", "lake wildwood",
       "rough and ready", "cedar ridge", "washington", "north columbia",
       "camptonville", "downieville", "sierra city",
   }
   ```
   After parsing each event, call `infer_venue_city(location)`. If the returned city (lowercased) is not in NC_CITIES and is not empty string, SKIP the event. If city is empty string (unknown), KEEP it (benefit of the doubt for local events without address).

7. **Venue inference:** KVMR locations are formatted as "Venue Name, Street, City, State, ZIP, Country". Extract venue name as first comma-separated part. Infer city by scanning location string for NC_CITIES entries.

8. **Keep all other behavior identical to LibCal:** argparse CLI, 14-day window, recurring event expansion, timezone handling, duplicate ID handling, description truncation to 500 chars.

9. **Print summary to stderr** matching LibCal pattern but saying "KVMR" and including skipped-out-of-county count.
  </action>
  <verify>
Run `python scripts/events/ingest_kvmr_ical.py --help` to confirm CLI works.
Run `python scripts/events/ingest_kvmr_ical.py` and verify:
- Output file `website/cultural-map-redesign/events-kvmr.json` is created
- JSON has `generated_at` and `events` array
- All event_ids start with `kvmr-`
- No events have venue_city containing "Sacramento", "Roseville", "Auburn", or other out-of-county cities
- Events are within the 14-day window
  </verify>
  <done>KVMR iCal ingest script produces canonical JSON with kvmr- prefixed IDs, filters out-of-county events, and matches existing pipeline schema exactly.</done>
</task>

<task type="auto">
  <name>Task 2: Create GVDA Trumba JSON ingest script</name>
  <files>scripts/events/ingest_trumba_json.py</files>
  <action>
Create a NEW ingest script for GVDA's Trumba JSON feed. Do NOT clone the RSS ingest -- the JSON format is different and simpler. Use `ingest_libcal_ical.py` as the structural template (argparse, fail(), main() pattern) but with JSON-specific parsing.

1. **URL:** `https://www.trumba.com/calendars/GVDA.json`
2. **Output:** `website/cultural-map-redesign/events-gvda.json`
3. **Event ID:** `gvda-{eventID}` where eventID is the numeric Trumba ID from the JSON
4. **Source label:** `"Grass Valley Downtown Association"`
5. **Source type:** `"json"`

6. **DateTime parsing (CRITICAL):** GVDA JSON has `startDateTime: "2026-02-15T14:00:00"` (NO timezone) and `startTimeZoneOffset: "-0800"` as separate fields. Combine them:
   ```python
   def parse_gvda_datetime(dt_str: str, tz_offset: str) -> datetime:
       naive = datetime.fromisoformat(dt_str)
       # Use Pacific timezone directly (offset confirms it)
       return naive.replace(tzinfo=ZoneInfo("America/Los_Angeles"))
   ```
   Same for `endDateTime` + `endTimeZoneOffset`. If endDateTime is missing, default to start + 2 hours.

7. **Location/venue extraction (CRITICAL):** The `location` field contains HTML in some events:
   - Plain text: `"SDA Church"` -> use directly
   - HTML anchor: `'<a href="...">Nevada City Winery</a>'` -> extract text between `>` and `<`
   - Address-only: `'<a href="...">325 Spring Street Nevada City</a>'` -> starts with digit, use "Unknown venue"

   Also check `customFields` array for objects with `label` matching "Venue", "Event Location", or "Other Location" -- these are more reliable than the `location` field.

   ```python
   def parse_custom_fields(event: dict) -> dict:
       return {cf["label"]: cf.get("value", "") for cf in event.get("customFields", [])}
   ```

8. **City extraction:** Use customFields `"City/Area"` or `"City / Area"` (both variants exist). Fall back to scanning location text for Nevada County city names.

9. **14-day window filter:** Skip events where startDateTime is before now or after now + 14 days. The feed returns ~200 events including past ones.

10. **Tags:** Extract from customFields `"Type of Event"` if present. Split on comma if multiple.

11. **Ticket URL:** Extract from `permaURL` field (direct Trumba event link).

12. **Image URL:** Extract from `eventImage` field if present.

13. **Description:** Use `description` field, strip HTML tags with `re.sub(r'<[^>]+>', '', text)`, truncate to 500 chars.

14. **Family classification:** Check customFields `"Age Range"` -- if it contains "family" or "all ages" or "children", set `is_family: true`.

15. **CLI:** Same argparse pattern as other scripts (--json-url, --output-file, --window-days, --timezone, --timeout-seconds).

16. **Print summary to stderr** with event count, date range, and any parsing warnings.
  </action>
  <verify>
Run `python scripts/events/ingest_trumba_json.py --help` to confirm CLI works.
Run `python scripts/events/ingest_trumba_json.py` and verify:
- Output file `website/cultural-map-redesign/events-gvda.json` is created
- JSON has `generated_at` and `events` array
- All event_ids start with `gvda-`
- No events have start_iso dates in the past or beyond 14 days
- venue_name fields don't contain HTML tags
- Events have proper Pacific timezone offsets in start_iso
  </verify>
  <done>GVDA Trumba JSON ingest script produces canonical JSON with gvda- prefixed IDs, strips HTML from locations, combines datetime+offset correctly, and applies 14-day window filter.</done>
</task>

</tasks>

<verification>
- Both scripts produce valid JSON matching the canonical schema (event_id, title, start_iso, end_iso, timezone, venue_name, venue_city, source_type, source_ref, source_label, is_family, last_verified_at)
- KVMR script filters out-of-county events
- GVDA script handles HTML in location fields
- Both apply 14-day window
- No new pip dependencies needed (all libraries already in requirements.txt)
</verification>

<success_criteria>
- `python scripts/events/ingest_kvmr_ical.py` exits 0 and produces events-kvmr.json with >0 events
- `python scripts/events/ingest_trumba_json.py` exits 0 and produces events-gvda.json with >0 events
- Both output files pass JSON schema validation (have generated_at + events array)
- No out-of-county events in KVMR output
- No HTML tags in GVDA venue_name fields
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-kvmr-gvda-event-source-ingestion/02.1-01-SUMMARY.md`
</output>
