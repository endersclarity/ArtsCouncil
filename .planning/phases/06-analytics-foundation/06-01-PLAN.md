---
phase: 06-analytics-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html
  - website/cultural-map-redesign-stitch-lab/index-maplibre-detail-view.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-detail-controller.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-explore-controller.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-experience-controller.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-filter-ui.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre.js
autonomous: false

user_setup:
  - service: umami-cloud
    why: "Privacy-first analytics tracking (free Hobby plan)"
    env_vars: []
    dashboard_config:
      - task: "Sign up at https://umami.is and create account"
        location: "umami.is"
      - task: "Create site named 'Explore Nevada County' with domain cultural-map-redesign-stitch-lab.vercel.app"
        location: "Umami Cloud Dashboard > Websites > Add website"
      - task: "Copy the data-website-id from the tracking script snippet"
        location: "Umami Cloud Dashboard > Websites > Edit > Tracking code"
      - task: "Replace YOUR_WEBSITE_ID_HERE in the HTML <head> with the actual ID"
        location: "website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html"
      - task: "Enable Share URL for committee access"
        location: "Umami Cloud Dashboard > Websites > Edit > Share URL > Add"

must_haves:
  truths:
    - "Umami script tag is present in HTML head (loads on every page)"
    - "Provider-agnostic analytics module wraps all tracking calls via CulturalMapAnalytics.track()"
    - "Category filter clicks are tracked with category name"
    - "Detail panel opens are tracked with asset name and category"
    - "Open Now and Events 14d toggles are tracked"
    - "Experience and corridor activations are tracked with route name"
    - "Search queries are tracked with zero-result flag"
    - "Outbound links (website, phone, directions) are tracked and UTM-tagged"
    - "Deep link arrivals are tracked with param type"
    - "500ms dedup throttle prevents duplicate events from rapid toggling"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js"
      provides: "Analytics wrapper module with track() and tagOutboundUrl()"
      contains: "CulturalMapAnalytics"
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html"
      provides: "Umami script tag and analytics module script tag"
      contains: "cloud.umami.is/script.js"
  key_links:
    - from: "index-maplibre-analytics.js"
      to: "window.umami.track"
      via: "provider wrapper"
      pattern: "umami\\.track"
    - from: "index-maplibre-bindings.js"
      to: "CulturalMapAnalytics.track"
      via: "filter/toggle handlers"
      pattern: "CulturalMapAnalytics"
    - from: "index-maplibre-detail-view.js"
      to: "CulturalMapAnalytics.tagOutboundUrl"
      via: "UTM parameter injection"
      pattern: "tagOutboundUrl"
---

<objective>
Create the analytics wrapper module, add the Umami script tag, and instrument all 12+ interaction types across the stitch-lab codebase. This single plan covers the entire analytics foundation because the work is cohesive -- every tracking call depends on the wrapper module, and all instrumentation follows the same pattern (3-line addition per call site).

Purpose: Enable the committee to see what visitors care about and prove referral value to local businesses via Umami Cloud dashboards.
Output: One new JS module, one HTML script tag, and tracking calls wired into 7 existing modules.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-analytics-foundation/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics wrapper module and wire into HTML</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html
  </files>
  <action>
    Create `index-maplibre-analytics.js` as an IIFE module exposing `window.CulturalMapAnalytics` with two methods:

    1. `track(eventName, data)` — wraps `window.umami.track()` with 500ms dedup throttle. Dedup key = eventName + JSON.stringify(data). If same key fires within 500ms, silently drop. Guard: if `window.umami` is undefined, no-op (graceful when Umami blocked by ad blockers or not yet loaded).

    2. `tagOutboundUrl(url, campaign)` — appends UTM params to any URL. `utm_source=exploregvnc`, `utm_medium=referral`, `utm_campaign={campaign}`. Handle `?` vs `&` separator correctly (check if URL already has `?`).

    Use ES5 style (var, not const/let) consistent with existing codebase. Module is ~40-50 lines.

    Event naming convention: kebab-case `feature:action` pattern (e.g., `category:filter`, `detail:open`, `outbound:website`). Document the full taxonomy in a comment block at top of file.

    In the HTML entry point (`index-maplibre-hero-intent-stitch-frontend-design-pass.html`):
    - Add Umami script tag in `<head>`: `<script defer src="https://cloud.umami.is/script.js" data-website-id="YOUR_WEBSITE_ID_HERE"></script>`
    - Add analytics module script tag after `index-maplibre-core-utils.js` and before `index-maplibre-events-utils.js` (line ~416): `<script src="index-maplibre-analytics.js"></script>`
  </action>
  <verify>
    - File exists: `ls website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js`
    - Module pattern correct: `grep "CulturalMapAnalytics" website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js`
    - Umami script in head: `grep "cloud.umami.is" website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html`
    - Analytics script in body: `grep "index-maplibre-analytics.js" website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html`
    - Dedup throttle present: `grep "THROTTLE" website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js`
  </verify>
  <done>
    analytics.js exists with track() and tagOutboundUrl(), Umami script tag in HTML head with placeholder website-id, analytics module loaded in correct script order (after config/utils, before controllers)
  </done>
</task>

<task type="auto">
  <name>Task 2: Instrument all interaction tracking across existing modules</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-detail-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-detail-view.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-explore-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-experience-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-filter-ui.js
    website/cultural-map-redesign-stitch-lab/index-maplibre.js
  </files>
  <action>
    Add `CulturalMapAnalytics.track()` calls at each interaction point. Each addition is 3-5 lines (get analytics ref, null-check, call track). Use `var analytics = window.CulturalMapAnalytics;` pattern at each call site.

    **bindings.js** — Track these interactions in their existing handlers:
    - `category:filter` with `{ category: name }` when a category pill is clicked
    - `category:clear` with `{}` when "All" or clear is triggered
    - `toggle:open-now` with `{ state: "on"|"off" }` when Open Now pill is toggled
    - `toggle:events-14d` with `{ state: "on"|"off" }` when Events pill is toggled
    - `event:click` with `{ title, venue }` when an event card is clicked (truncate strings to 100 chars)
    - `editorial:expand` with `{ title }` when a MUSE editorial details element is toggled open

    **detail-controller.js** — In the function that opens the detail panel (likely `openDetail` or `showDetail`):
    - `detail:open` with `{ category: asset.l, name: (asset.n || '').substring(0, 100), city: asset.c }`

    **detail-view.js** — In the function that builds detail panel HTML (likely `buildDetailMetaHTML` or similar):
    - UTM-tag all outbound website links using `CulturalMapAnalytics.tagOutboundUrl(url, 'venue-detail')`
    - UTM-tag Google Maps directions links using `tagOutboundUrl(mapsUrl, 'directions')`
    - Add click event delegation on the detail panel for outbound tracking:
      - `outbound:website` with `{ venue, url }` for website clicks
      - `outbound:phone` with `{ venue }` for tel: links
      - `outbound:directions` with `{ venue }` for Google Maps links

    **explore-controller.js** — After search/filter produces results:
    - `search:query` with `{ query, results: count, zero_results: false }` for searches with results (query >= 2 chars)
    - `search:zero` with `{ query, zero_results: true }` for zero-result searches
    - Debounce search tracking at 800ms (separate from the general 500ms throttle — use a local setTimeout/clearTimeout pattern so search tracking fires only after user stops typing)

    **experience-controller.js** — In the experience activation function:
    - `experience:start` with `{ slug, title, type: "corridor"|"experience" }` when an experience or corridor is activated
    - `experience:tour` with `{ slug }` when auto-tour is started

    **filter-ui.js** — If category filter logic lives here instead of bindings.js, add tracking here. Check which file actually handles the category pill click and add tracking there (avoid duplicating). The research suggests filter-ui.js may also handle event tab/date filter changes:
    - Track event date filter changes if handler is here (Today/Weekend/2 Weeks chips)

    **index-maplibre.js** — In the deep link handler (where ?pid= or ?muse= or ?itinerary= params are parsed):
    - `deeplink:arrive` with `{ type: "pid"|"muse"|"itinerary", value }` when a deep link is detected on page load

    **IMPORTANT:** Do NOT track chat interactions — those stay in Supabase only per locked decision.
    **IMPORTANT:** Do NOT track scroll, hover, map pan/zoom, or tooltip display — those waste the 100k/mo event budget.
    **IMPORTANT:** Truncate all venue names to 100 chars and URLs to 200 chars in event properties.
  </action>
  <verify>
    - Tracking calls present in each module:
      - `grep -c "CulturalMapAnalytics" website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js` (expect 4+)
      - `grep -c "CulturalMapAnalytics" website/cultural-map-redesign-stitch-lab/index-maplibre-detail-controller.js` (expect 1+)
      - `grep -c "CulturalMapAnalytics" website/cultural-map-redesign-stitch-lab/index-maplibre-detail-view.js` (expect 2+)
      - `grep -c "CulturalMapAnalytics" website/cultural-map-redesign-stitch-lab/index-maplibre-explore-controller.js` (expect 1+)
      - `grep -c "CulturalMapAnalytics" website/cultural-map-redesign-stitch-lab/index-maplibre-experience-controller.js` (expect 1+)
      - `grep -c "CulturalMapAnalytics" website/cultural-map-redesign-stitch-lab/index-maplibre.js` (expect 1+)
    - UTM tagging present: `grep "tagOutboundUrl" website/cultural-map-redesign-stitch-lab/index-maplibre-detail-view.js`
    - No chat tracking: `grep -c "CulturalMapAnalytics" website/cultural-map-redesign-stitch-lab/index-maplibre-chat-*.js` (expect 0)
    - Open site in browser, open DevTools console. Confirm no JS errors on load.
  </verify>
  <done>
    All 12+ interaction types instrumented: category:filter, category:clear, toggle:open-now, toggle:events-14d, marker:click (if handler accessible), detail:open, experience:start, experience:tour, event:click, search:query, search:zero, editorial:expand, outbound:website, outbound:phone, outbound:directions, deeplink:arrive. UTM params appended to outbound links. No chat tracking. No scroll/hover/pan tracking.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Create Umami Cloud account and configure dashboard</name>
  <action>
    Claude cannot create external accounts. User must:
    1. Go to https://umami.is and sign up for a free Hobby plan account
    2. Create a website: name "Explore Nevada County", domain "cultural-map-redesign-stitch-lab.vercel.app"
    3. Copy the `data-website-id` value from the tracking script snippet
    4. Replace `YOUR_WEBSITE_ID_HERE` in `website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html` with the actual ID
    5. Enable Share URL: Settings > Websites > Edit the site > Share URL > Add. Select Overview, Events, and UTM views. Copy the share link.
    6. Deploy: `cd website/cultural-map-redesign-stitch-lab && vercel --prod`
    7. Visit the deployed site, click around (filter categories, open detail panels, click outbound links), then check Umami dashboard to confirm events appear
  </action>
  <files>website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.html</files>
  <verify>Visit the deployed stitch-lab URL. Open Umami dashboard. Click category filters, open a detail panel, search for something. Confirm events appear in Umami Events view within 30 seconds.</verify>
  <done>Umami dashboard shows tracked events from the live deployed site. Share URL is accessible without login.</done>
  <resume-signal>Type "verified" once Umami dashboard shows events from the deployed site, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. `index-maplibre-analytics.js` exists with CulturalMapAnalytics.track() and tagOutboundUrl()
2. Umami script tag in HTML `<head>` with real website-id
3. Analytics module loaded in correct script order (after config, before controllers)
4. 12+ interaction types fire tracking calls through the wrapper
5. Outbound links carry UTM parameters (utm_source=exploregvnc)
6. 500ms dedup throttle prevents event flooding
7. No tracking on chat, scroll, hover, or map pan/zoom
8. Umami Cloud dashboard shows real events from deployed site
9. Share URL accessible without Umami account for committee members
</verification>

<success_criteria>
- Umami dashboard shows page views and visitor counts with zero cookie consent UI (ANLYT-01)
- CulturalMapAnalytics wrapper module centralizes all tracking (ANLYT-02)
- Category filter, Open Now, experience start, event click, search, editorial expand, deep link each appear as distinct events (ANLYT-03 through ANLYT-09, ANLYT-12)
- Outbound clicks tracked with UTM parameters (ANLYT-10, ANLYT-11)
- Rapid toggling does not flood dashboard (ANLYT-13)
- Committee can access shared dashboard URL without an account (ANLYT-14)
</success_criteria>

<output>
After completion, create `.planning/phases/06-analytics-foundation/06-01-SUMMARY.md`
</output>
