---
phase: 02-tier-2-events
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/events/ingest_libcal_ical.py
  - scripts/events/ingest_civicengage_rss.py
  - scripts/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Running ingest_libcal_ical.py fetches the LibCal iCal feed and outputs events-libcal.json with 10+ events"
    - "Running ingest_civicengage_rss.py fetches CivicEngage RSS feeds and outputs events-civicengage.json"
    - "Both scripts produce events in the same canonical schema as ingest_trumba_rss.py"
    - "Each event has source_type, source_ref, source_label, and is_family fields"
    - "LibCal recurring events (RRULE) are expanded within the 14-day window"
  artifacts:
    - path: "scripts/events/ingest_libcal_ical.py"
      provides: "LibCal iCal ingest pipeline"
      min_lines: 100
    - path: "scripts/events/ingest_civicengage_rss.py"
      provides: "CivicEngage RSS ingest pipeline"
      min_lines: 80
    - path: "scripts/requirements.txt"
      provides: "Updated Python dependencies"
      contains: "rapidfuzz"
  key_links:
    - from: "scripts/events/ingest_libcal_ical.py"
      to: "website/cultural-map-redesign/events-libcal.json"
      via: "file output"
      pattern: "events-libcal\\.json"
    - from: "scripts/events/ingest_civicengage_rss.py"
      to: "website/cultural-map-redesign/events-civicengage.json"
      via: "file output"
      pattern: "events-civicengage\\.json"
---

<objective>
Create two new ingest scripts -- one for Nevada County Library's LibCal iCal feed and one for CivicEngage municipal RSS feeds -- following the exact conventions of the existing `ingest_trumba_rss.py`.

Purpose: These scripts are the data sources that feed into the merge pipeline (Plan 02). Without them, there's nothing to merge.
Output: Two runnable Python scripts that each produce a JSON file of normalized events.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tier-2-events/02-RESEARCH.md
@scripts/events/ingest_trumba_rss.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: LibCal iCal ingest script with RRULE expansion</name>
  <files>scripts/events/ingest_libcal_ical.py, scripts/requirements.txt</files>
  <action>
Create `scripts/events/ingest_libcal_ical.py` following the exact pattern of `ingest_trumba_rss.py`:
- argparse CLI with `--ical-url` (default: `https://nevadacountyca.libcal.com/ical_subscribe.php?src=p&cid=20247`), `--output-file` (default: `website/cultural-map-redesign/events-libcal.json`), `--window-days` (default: 14), `--timezone` (default: `America/Los_Angeles`)
- Fetch iCal feed via `requests.get()` with 30s timeout
- Parse with `icalendar.Calendar.from_ical()`
- Expand recurring events using `recurring_ical_events.of(cal).between(now, now + window_days)`. Install: `pip install recurring-ical-events`
- For each VEVENT: extract summary, location, description, dtstart, dtend, uid
- Handle date-only (all-day) vs datetime events. Ensure all datetimes are timezone-aware in America/Los_Angeles
- Generate `event_id` as `libcal-{uid}` (strip the `@libcal.com` suffix from UID if present)
- Infer `venue_city` from LOCATION field: if contains "Truckee" -> "Truckee", "Madelyn Helling" or "Nevada City" -> "Nevada City", "Grass Valley" -> "Grass Valley", else "Nevada City" (library HQ default)
- Set `source_type: "ical"`, `source_ref: <feed_url>`, `source_label: "Nevada County Library"`
- Set `is_family: false` placeholder (Plan 02 merge script handles classification)
- Include `generated_at` ISO timestamp in the output wrapper: `{"generated_at": "...", "events": [...]}`
- Output sorted by `start_iso` then `event_id`
- Print summary to stderr: "Fetched N events from LibCal (M recurring expanded)"

Update `scripts/requirements.txt` to add:
```
icalendar>=6.0.0
feedparser>=6.0.0
rapidfuzz>=3.0.0
recurring-ical-events>=3.0.0
```
  </action>
  <verify>
Run: `pip install -r scripts/requirements.txt && python scripts/events/ingest_libcal_ical.py --output-file /tmp/events-libcal.json && python -c "import json; d=json.load(open('/tmp/events-libcal.json')); print(f'Events: {len(d[\"events\"])}, Generated: {d[\"generated_at\"]}'); e=d['events'][0]; assert all(k in e for k in ['event_id','title','start_iso','end_iso','timezone','venue_name','venue_city','source_type','source_label','is_family']), f'Missing keys: {e.keys()}'"`
  </verify>
  <done>Script fetches LibCal iCal, expands RRULEs, outputs 10+ events in canonical schema with all required fields. requirements.txt includes all new dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: CivicEngage RSS ingest script</name>
  <files>scripts/events/ingest_civicengage_rss.py</files>
  <action>
Create `scripts/events/ingest_civicengage_rss.py` following the same pattern:
- argparse CLI with `--feeds` (JSON string of feed configs, default: list of Nevada City Events Calendar URL), `--output-file` (default: `website/cultural-map-redesign/events-civicengage.json`), `--window-days` (default: 14), `--timezone` (default: `America/Los_Angeles`)
- Default feeds config:
  ```python
  DEFAULT_FEEDS = [
      {"url": "https://www.nevadacityca.gov/RSSFeed.aspx?ModID=58&CID=Events-Calendar-24", "label": "City of Nevada City"},
  ]
  ```
  Note: Skip Nevada County government calendar (Board of Supervisors meetings are not cultural events per research recommendation). Only include Nevada City events calendar.
- For each feed: fetch via `feedparser.parse()`, iterate entries
- Parse dates: try `entry.published_parsed` first, then fall back to parsing `entry.get('calendarEvent_startDate')` or similar custom namespace fields. Use `time.mktime()` + `datetime.fromtimestamp()` with timezone
- Filter to events within the window (now to now + window_days)
- Generate `event_id` as `civic-{YYYYMMDD}-{slugified_title_30chars}`
- Extract venue from description or custom fields if available, else set `venue_name` to source label
- Set `source_type: "rss"`, `source_ref: <feed_url>`, `source_label: <from feed config>`
- Set `is_family: false` placeholder
- Include `generated_at` wrapper same as LibCal script
- Output sorted by `start_iso` then `event_id`
- Print summary to stderr per feed: "Fetched N events from {label}"
- Handle empty feeds gracefully (0 events is valid, not an error -- CivicEngage volume is low)
  </action>
  <verify>
Run: `python scripts/events/ingest_civicengage_rss.py --output-file /tmp/events-civicengage.json && python -c "import json; d=json.load(open('/tmp/events-civicengage.json')); print(f'Events: {len(d[\"events\"])}, Generated: {d[\"generated_at\"]}')"`
  </verify>
  <done>Script fetches CivicEngage RSS, outputs 0+ events in canonical schema. Empty output is acceptable (low-volume source). Script does not error on empty feeds.</done>
</task>

</tasks>

<verification>
1. Both scripts run without errors: `python scripts/events/ingest_libcal_ical.py` and `python scripts/events/ingest_civicengage_rss.py`
2. Output JSON files have `generated_at` and `events` array
3. Every event object has all canonical fields: event_id, title, start_iso, end_iso, timezone, venue_name, venue_city, source_type, source_ref, source_label, is_family
4. LibCal produces 10+ events (recurring expansion working)
5. All start_iso values are in America/Los_Angeles timezone
6. No duplicate event_ids within a single source output
</verification>

<success_criteria>
Two ingest scripts produce per-source JSON files that the merge pipeline (Plan 02) can consume. Each follows the conventions of ingest_trumba_rss.py. requirements.txt is updated with all new dependencies.
</success_criteria>

<output>
After completion, create `.planning/phases/02-tier-2-events/02-01-SUMMARY.md`
</output>
