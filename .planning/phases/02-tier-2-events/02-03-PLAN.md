---
phase: 02-tier-2-events
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - website/cultural-map-redesign/index-maplibre.js
  - website/cultural-map-redesign/index-maplibre-events-model.js
  - website/cultural-map-redesign/index-maplibre-events-view.js
  - website/cultural-map-redesign/index-maplibre-events-filter-ui.js
  - website/cultural-map-redesign/index-maplibre-hero-intent.html
  - website/cultural-map-redesign/index-maplibre.css
autonomous: true

must_haves:
  truths:
    - "Events from LibCal and CivicEngage appear alongside Trumba events in the carousel and list views"
    - "Each event card shows a source attribution badge when source_label is present"
    - "A Family & Kids filter chip narrows events to family-friendly events only"
    - "If events-merged.json is unavailable or stale (>48h), events fall back to events.json (Trumba RSS)"
    - "Existing event functionality (date filters, category filters, search, carousel) still works"
  artifacts:
    - path: "website/cultural-map-redesign/index-maplibre.js"
      provides: "Fallback-aware event loading"
      contains: "events-merged.json"
    - path: "website/cultural-map-redesign/index-maplibre-events-view.js"
      provides: "Source badge rendering in event cards"
      contains: "source_label"
    - path: "website/cultural-map-redesign/index-maplibre-events-filter-ui.js"
      provides: "Family filter chip handling"
      contains: "family"
    - path: "website/cultural-map-redesign/index-maplibre-hero-intent.html"
      provides: "Family & Kids filter chip button"
      contains: "family"
  key_links:
    - from: "website/cultural-map-redesign/index-maplibre.js"
      to: "website/cultural-map-redesign/events-merged.json"
      via: "fetch with fallback"
      pattern: "events-merged\\.json"
    - from: "website/cultural-map-redesign/index-maplibre-events-view.js"
      to: "source_label field"
      via: "badge rendering"
      pattern: "source_label"
    - from: "website/cultural-map-redesign/index-maplibre-events-model.js"
      to: "is_family field"
      via: "filter logic"
      pattern: "is_family"
---

<objective>
Wire the merged event data into the client: fallback-aware loading, source attribution badges on event cards, and a "Family & Kids" filter chip.

Purpose: This is where users actually see the expanded event coverage. The pipeline (Plans 01-02) produces the data; this plan renders it.
Output: Modified JS modules and HTML with source badges, family filter, and fallback loading.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-tier-2-events/02-RESEARCH.md
@.planning/phases/02-tier-2-events/02-02-SUMMARY.md
@website/cultural-map-redesign/index-maplibre.js
@website/cultural-map-redesign/index-maplibre-events-model.js
@website/cultural-map-redesign/index-maplibre-events-view.js
@website/cultural-map-redesign/index-maplibre-events-filter-ui.js
@website/cultural-map-redesign/index-maplibre-hero-intent.html
@website/cultural-map-redesign/index-maplibre.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fallback-aware event loading and family filter logic</name>
  <files>website/cultural-map-redesign/index-maplibre.js, website/cultural-map-redesign/index-maplibre-events-model.js</files>
  <action>
**In `index-maplibre.js`** -- modify the event data loading (currently line ~202: `fetch('events.json')`):

Replace the single `fetch('events.json')` with a fallback chain:
```javascript
// Try merged events first, fall back to Trumba-only
fetch('events-merged.json')
  .then(function(r) {
    if (!r.ok) return Promise.reject('no merged');
    return r.json();
  })
  .then(function(merged) {
    // Check staleness: if generated_at is older than 48 hours, fall back
    var generatedAt = merged && merged.generated_at;
    if (generatedAt) {
      var age = Date.now() - new Date(generatedAt).getTime();
      if (age > 48 * 60 * 60 * 1000) {
        console.warn('events-merged.json is stale (' + Math.round(age / 3600000) + 'h old), falling back to events.json');
        return Promise.reject('stale');
      }
    }
    console.log('Loaded merged events:', (merged.events || []).length, 'from', JSON.stringify(merged.source_counts || {}));
    return merged.events || [];
  })
  .catch(function() {
    console.warn('Falling back to events.json (Trumba only)');
    return fetch('events.json').then(function(r) { return r.json(); });
  })
```

The rest of the data loading (events.index.json, etc.) remains unchanged. The events array format is identical whether from merged or Trumba-only.

**In `index-maplibre-events-model.js`** -- add family filter support:

Find the function that applies date filters (look for where `eventDateFilter` is checked, likely in `getFilteredMapEvents` or equivalent). Add a new filter case:

```javascript
// After existing date filters (all, today, weekend, 14d):
if (eventDateFilter === 'family') {
  filtered = filtered.filter(function(event) {
    return event.is_family === true;
  });
}
```

This is additive -- existing filters continue to work unchanged. The `family` filter is a separate chip, not a date filter, but it uses the same chip UI mechanism for simplicity (the `data-event-filter` system already supports arbitrary string values).

Important: Do NOT modify the event schema expectations. The model already handles arbitrary fields gracefully. New fields (`source_label`, `source_labels`, `is_family`) are simply ignored by existing code when absent.
  </action>
  <verify>
Start local server and verify:
1. `python -m http.server 8000` from repo root
2. Open `http://localhost:8000/website/cultural-map-redesign/index-maplibre-hero-intent.html`
3. Check browser console for "Loaded merged events" or "Falling back to events.json" message
4. If events-merged.json exists locally (from Plan 02), verify event count is higher than Trumba-only
5. Delete events-merged.json temporarily and reload -- should see "Falling back" message and events still load
  </verify>
  <done>Event loading tries events-merged.json first with 48h staleness check, falls back to events.json. Family filter logic added to events model. Existing date filters unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Source badges, family filter chip, and CSS</name>
  <files>website/cultural-map-redesign/index-maplibre-events-view.js, website/cultural-map-redesign/index-maplibre-events-filter-ui.js, website/cultural-map-redesign/index-maplibre-hero-intent.html, website/cultural-map-redesign/index-maplibre.css</files>
  <action>
**In `index-maplibre-events-view.js`** -- add source badge to event cards:

In `getEventsCardsHTML()` (around line 23-63), after the existing `seriesBadge` and `distanceBadge` variables, add:
```javascript
var sourceLabel = event.source_label || '';
var sourceBadge = sourceLabel && sourceLabel !== 'Nevada County Arts Council'
  ? '<span class="map-event-badge source">' + escapeHTML(sourceLabel) + '</span>'
  : '';
```
Note: Don't show a badge for Trumba events (they're the default source -- showing "Nevada County Arts Council" on every existing event would be noisy). Only show badges for LibCal and CivicEngage events.

Insert `${sourceBadge}` in the card meta section, after `${distanceBadge}`.

Also add the same source badge to `getEventsRowsHTML()` (the list/table view) in the same position.

**In `index-maplibre-hero-intent.html`** -- add the Family & Kids chip:

After the existing filter chips (all, today, weekend, 14d), add:
```html
<button class="map-events-chip" type="button" data-event-filter="family">Family & Kids</button>
```

**In `index-maplibre-events-filter-ui.js`** -- no code changes needed. The existing `updateMapEventsFilterUI()` already handles arbitrary `data-event-filter` values via `chip.dataset.eventFilter === eventDateFilter`. The new "family" chip will light up when active.

**In `index-maplibre.css`** -- add source badge styling:

Find the existing `.map-event-badge` styles and add:
```css
.map-event-badge.source {
  background: var(--color-accent, #6366f1);
  color: #fff;
  font-size: 0.65rem;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  font-weight: 600;
}
```

Use a subtle accent color that doesn't compete with existing category colors. The badge should be noticeable but not dominant -- it's attribution, not a call to action.

Also add a style for the family chip when active:
```css
.map-events-chip[data-event-filter="family"].active {
  background: var(--color-family, #ec4899);
  color: #fff;
}
```
  </action>
  <verify>
1. Open the site locally, check events section
2. If events-merged.json is present: verify LibCal events show "Nevada County Library" badge, Trumba events show no badge
3. Click "Family & Kids" chip -- only family-tagged events should appear (if none exist, chip shows empty state)
4. Click "All" chip -- all events return
5. Inspect a source badge element -- should have `.map-event-badge.source` class with accent background
6. Check that existing badges (series count, distance, unmapped) still render correctly
  </verify>
  <done>Source attribution badges appear on non-Trumba events. Family & Kids filter chip is wired and styled. Existing event card layout and badges are unchanged.</done>
</task>

</tasks>

<verification>
1. Page loads with events from merged JSON (or falls back gracefully)
2. LibCal events show "Nevada County Library" badge on cards
3. CivicEngage events show "City of Nevada City" badge on cards
4. Trumba events show NO source badge (they're the default)
5. "Family & Kids" chip filters to family-only events
6. Clicking "All" after "Family & Kids" restores all events
7. Existing filters (today, weekend, 14d) still work
8. No JavaScript errors in console
9. Deleting events-merged.json causes graceful fallback to events.json
</verification>

<success_criteria>
Users see events from all three sources with clear attribution. The family filter works. Fallback to Trumba-only is seamless when merged data is unavailable. Zero regressions to existing event functionality.
</success_criteria>

<output>
After completion, create `.planning/phases/02-tier-2-events/02-03-SUMMARY.md`
</output>
