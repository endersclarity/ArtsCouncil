---
phase: 06.1-deep-analytics-instrumentation
plan: 01
subsystem: analytics
tags: [umami, analytics, utm, event-tracking, outbound-clicks]

# Dependency graph
requires:
  - phase: 06-analytics-foundation
    provides: CulturalMapAnalytics wrapper module with track() and tagOutboundUrl()
provides:
  - 7 new analytics event types (marker:click, itinerary:start/calendar/day-tab, outbound:event-ticket, events:date-filter, events:toggle)
  - UTM-tagged event ticket outbound links across all event render paths
  - Complete outbound click attribution (website + phone + directions + event-ticket)
affects: [analytics-dashboard, committee-presentation]

# Tech tracking
tech-stack:
  added: []
  patterns: [data-track-outbound delegation for outbound link tracking, UTM tagging at render time]

key-files:
  created: []
  modified:
    - website/cultural-map-redesign-stitch-lab/index-maplibre-events-view.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-events-controller.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-events-search.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-detail-view.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-asset-interactions.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-map-label-controller.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-itinerary-controller.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-itinerary-view.js

key-decisions:
  - "UTM tagging applied at render time (URL mutation), tracking at click time (event delegation) -- separation of concerns"
  - "marker:click intentionally distinct from detail:open -- different funnel stages (map engagement vs content consumption)"
  - "Calendar click delegation attached per-activation since overlay DOM is recreated each time"
  - "Event ticket delegation added to detail panel's existing outbound handler (detail-view.js) for coverage"

patterns-established:
  - "data-track-outbound attribute pattern: render adds data attributes, click delegation reads them for tracking"
  - "Itinerary analytics: data-itinerary-title and data-stop-name on calendar links for attribution"

# Metrics
duration: 3min
completed: 2026-02-15
---

# Phase 6.1 Plan 01: Deep Analytics Instrumentation Summary

**7 new Umami event types (marker:click, itinerary lifecycle, event ticket outbound with UTM) bringing total tracked interactions to 23 across 13 JS modules**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-16T03:48:44Z
- **Completed:** 2026-02-16T03:52:03Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments
- All event ticket links (carousel, expanded rows, detail panel, search results) UTM-tagged with utm_campaign=event-ticket
- outbound:event-ticket click delegation across 4 containers (eventsList, allEventsList, searchEventsList, detail panel)
- Map marker clicks tracked at 3 entry points (circle click, mobile label, smart labels) with name/category/city
- Itinerary lifecycle fully instrumented: start, calendar export, day-tab switch
- Events section interactions: date filter chip clicks and section toggle open/close
- Committee's "clicked through to a business" metric now capturable by summing 4 outbound event types in Umami

## Task Commits

Each task was committed atomically:

1. **Task 1: Instrument event ticket outbound tracking and UTM tagging** - `0c51076` (feat)
2. **Task 2: Instrument map markers, itinerary system, and event filter interactions** - `e06c9d7` (feat)

## Files Created/Modified
- `index-maplibre-events-view.js` - UTM-tagged ticket URLs in carousel cards and expanded rows
- `index-maplibre-events-controller.js` - UTM-tagged ticket URLs in detail panel events
- `index-maplibre-events-search.js` - UTM-tagged ticket URLs in search results
- `index-maplibre-bindings.js` - outbound:event-ticket delegation, events:date-filter, events:toggle
- `index-maplibre-detail-view.js` - Extended outbound delegation to handle event-ticket type
- `index-maplibre-asset-interactions.js` - marker:click on circle and mobile label clicks
- `index-maplibre-map-label-controller.js` - marker:click on smart label clicks
- `index-maplibre-itinerary-controller.js` - itinerary:start, itinerary:calendar, itinerary:day-tab
- `index-maplibre-itinerary-view.js` - Added data-itinerary-title and data-stop-name to calendar links

## Decisions Made
- UTM tagging applied at render time, tracking at click time (separation of concerns)
- marker:click is intentionally distinct from detail:open (different funnel stages)
- Calendar click delegation attached per-activation since overlay DOM is recreated each time
- Extended detail-view.js existing outbound handler rather than creating separate delegation

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Extended detail panel outbound delegation for event-ticket**
- **Found during:** Task 1
- **Issue:** Plan mentioned delegation for event ticket links in the detail panel but the detail panel already has its own outbound click handler in detail-view.js that only handled website/phone/directions
- **Fix:** Added event-ticket case to the existing delegation handler in detail-view.js
- **Files modified:** index-maplibre-detail-view.js
- **Verification:** Grep for outbound:event-ticket confirms coverage in detail-view.js
- **Committed in:** 0c51076 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Essential for complete coverage of event ticket click tracking. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 23 event types instrumented and ready to capture data
- A few synthetic walkthroughs will populate the Umami dashboard with visitor behavior data before Wednesday committee presentation
- Share URL (https://cloud.umami.is/share/875bmvTJ7Hd2oLAx) already configured from Phase 6

---
## Self-Check: PASSED

All 10 files verified present. Both task commits (0c51076, e06c9d7) confirmed in git log.

---
*Phase: 06.1-deep-analytics-instrumentation*
*Completed: 2026-02-15*
