---
phase: 06.1-deep-analytics-instrumentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - website/cultural-map-redesign-stitch-lab/index-maplibre-events-view.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-events-controller.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-events-search.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-asset-interactions.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-map-label-controller.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-itinerary-controller.js
autonomous: true
must_haves:
  truths:
    - "Event ticket link clicks fire outbound:event-ticket with title, venue, and url in Umami"
    - "Event ticket URLs have UTM parameters (utm_source=gvnc-cultural-map, utm_campaign=event-ticket)"
    - "Map marker clicks fire marker:click with name, category, and city — distinct from detail:open"
    - "Itinerary activation fires itinerary:start with id and title"
    - "Total outbound clicks (website + phone + directions + event-ticket) are clearly capturable from Umami"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-events-view.js"
      provides: "UTM-tagged event ticket URLs in carousel and expanded card renders"
      contains: "tagOutboundUrl.*event-ticket"
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js"
      provides: "Click delegation for outbound:event-ticket tracking + events:date-filter + events:toggle"
      contains: "outbound:event-ticket"
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-asset-interactions.js"
      provides: "marker:click tracking on map circle and mobile label clicks"
      contains: "marker:click"
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-itinerary-controller.js"
      provides: "itinerary:start, itinerary:calendar, itinerary:day-tab tracking"
      contains: "itinerary:start"
  key_links:
    - from: "index-maplibre-bindings.js"
      to: "index-maplibre-analytics.js"
      via: "window.CulturalMapAnalytics.track('outbound:event-ticket', ...)"
      pattern: "track.*outbound:event-ticket"
    - from: "index-maplibre-events-view.js"
      to: "index-maplibre-analytics.js"
      via: "window.CulturalMapAnalytics.tagOutboundUrl(url, 'event-ticket')"
      pattern: "tagOutboundUrl.*event-ticket"
    - from: "index-maplibre-asset-interactions.js"
      to: "index-maplibre-analytics.js"
      via: "window.CulturalMapAnalytics.track('marker:click', ...)"
      pattern: "track.*marker:click"
---

<objective>
Add 7 new analytics event types to the stitch-lab codebase, bringing total tracked interactions from 16 to 23. The highest-value addition is outbound:event-ticket (click tracking + UTM tagging on all event ticket links), which directly serves the committee's core metric: "How many people clicked through to a business?"

Purpose: Fill remaining high-value instrumentation gaps so even a few synthetic walkthroughs before the Wednesday demo produce enough data to tell a compelling visitor behavior story.
Output: 7 new event types firing via the existing CulturalMapAnalytics wrapper, with UTM tagging on all event ticket outbound links.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/06.1-deep-analytics-instrumentation/06.1-RESEARCH.md
@.planning/phases/06-analytics-foundation/06-01-SUMMARY.md
@website/cultural-map-redesign-stitch-lab/index-maplibre-analytics.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instrument event ticket outbound tracking and UTM tagging</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-events-view.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-events-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-events-search.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js
  </files>
  <action>
    This task adds UTM tagging to all event ticket URLs at render time and click delegation for outbound:event-ticket tracking. This is the committee's most important metric gap.

    **Step 1: UTM-tag ticket URLs in events-view.js**
    Find every render function that builds event card HTML (getEventsCardsHTML and any expanded-detail render). Where ticket_url is used to build an anchor tag:
    - Add a guard: only UTM-tag if URL starts with "http" (skip empty/relative URLs)
    - Call `var analyticsRef = window.CulturalMapAnalytics; if (analyticsRef && ticketUrl) { ticketUrl = analyticsRef.tagOutboundUrl(ticketUrl, 'event-ticket'); }`
    - Add data attributes to the anchor: `data-track-outbound="event-ticket"` plus `data-track-title` and `data-track-venue` for the click handler to read

    **Step 2: UTM-tag ticket URLs in events-controller.js**
    Find the detail-panel event rendering (typically renderDetailEvents or similar). Apply the same UTM-tagging pattern. Grep for `ticket_url` to find all render points.

    **Step 3: UTM-tag ticket URLs in events-search.js**
    Find the search result event card rendering. Apply the same UTM-tagging pattern. Grep for `ticket_url` or `event-link` class.

    **Step 4: Add click delegation for outbound:event-ticket in bindings.js**
    In the existing eventsList click handler (or add delegation on the events container), add BEFORE the existing card-click logic:
    ```javascript
    var ticketLink = e.target.closest('[data-track-outbound="event-ticket"]');
    if (ticketLink) {
      var analytics = window.CulturalMapAnalytics;
      if (analytics) {
        analytics.track('outbound:event-ticket', {
          title: (ticketLink.getAttribute('data-track-title') || '').substring(0, 100),
          venue: (ticketLink.getAttribute('data-track-venue') || '').substring(0, 100),
          url: (ticketLink.href || '').substring(0, 200)
        });
      }
      return; // Let the link navigate naturally
    }
    ```
    If event ticket links also appear outside the eventsList container (e.g., in the detail panel events section), add delegation there too.

    **Important:** Do NOT put tracking calls inside render/build functions. Tracking goes in click handlers only. UTM-tagging goes in render functions (that's URL mutation, not event tracking).

    **Pattern:** Follow the exact same 3-line pattern from Phase 6: `var analytics = window.CulturalMapAnalytics; if (analytics) { analytics.track(...); }`
  </action>
  <verify>
    1. Grep for `tagOutboundUrl.*event-ticket` — should appear in events-view.js, events-controller.js, and events-search.js (3+ locations)
    2. Grep for `outbound:event-ticket` — should appear in bindings.js (click delegation)
    3. Grep for `data-track-outbound="event-ticket"` — should appear in all 3 event render files
    4. Grep for `ticket_url` across all stitch-lab JS files — every instance should now have UTM-tagging nearby
    5. No `analytics.track` calls inside render/build functions (only UTM tagging there)
  </verify>
  <done>
    All event ticket links across carousel cards, expanded rows, detail panel events, and search results are UTM-tagged with campaign=event-ticket. Click delegation in bindings.js fires outbound:event-ticket with title, venue, and url properties. The committee's "clicked through to a business" metric now captures event ticket clicks alongside existing venue website/phone/directions clicks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Instrument map markers, itinerary system, and event filter interactions</name>
  <files>
    website/cultural-map-redesign-stitch-lab/index-maplibre-asset-interactions.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-map-label-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-itinerary-controller.js
    website/cultural-map-redesign-stitch-lab/index-maplibre-bindings.js
  </files>
  <action>
    This task adds 6 remaining event types: marker:click, itinerary:start, itinerary:calendar, itinerary:day-tab, events:date-filter, and events:toggle.

    **Step 1: marker:click in asset-interactions.js**
    In the `map.on('click', 'assets-hit', ...)` handler (around line 80-136), after resolving the venue from the clicked feature but BEFORE calling openDetail():
    ```javascript
    var analytics = window.CulturalMapAnalytics;
    if (analytics) {
      analytics.track('marker:click', {
        name: (venue.n || '').substring(0, 100),
        category: venue.l || '',
        city: venue.c || ''
      });
    }
    ```
    Also add the same tracking in the mobile label click handler (around lines 58-73), using the same venue data.

    **Step 2: marker:click in map-label-controller.js**
    In the smart-label click handler (around line 61-77), after resolving the venue:
    ```javascript
    var analytics = window.CulturalMapAnalytics;
    if (analytics) {
      analytics.track('marker:click', {
        name: (venue.n || '').substring(0, 100),
        category: venue.l || '',
        city: venue.c || ''
      });
    }
    ```
    This is intentionally NOT double-tracking with detail:open — they're different funnel stages (map engagement vs. detail view).

    **Step 3: itinerary:start in itinerary-controller.js**
    In the `activateItinerary()` function (around line 59), after resolving the itinerary object:
    ```javascript
    var analytics = window.CulturalMapAnalytics;
    if (analytics) {
      analytics.track('itinerary:start', {
        id: (id || '').substring(0, 100),
        title: (itinerary.title || '').substring(0, 100)
      });
    }
    ```

    **Step 4: itinerary:calendar click delegation in itinerary-controller.js**
    Add click delegation on the itinerary overlay container for calendar button clicks. Use the `_analyticsDelegate` flag pattern from detail-view.js to prevent duplicate listeners on re-render:
    ```javascript
    var container = document.getElementById('itinerary-overlay'); // or whatever the overlay container is
    if (container && !container._itinAnalyticsDelegate) {
      container._itinAnalyticsDelegate = true;
      container.addEventListener('click', function(e) {
        var calBtn = e.target.closest('.itinerary-stop-calendar-btn, [href*="calendar.google.com"]');
        if (calBtn) {
          var analytics = window.CulturalMapAnalytics;
          if (analytics) {
            analytics.track('itinerary:calendar', {
              itinerary_title: (calBtn.getAttribute('data-itinerary-title') || '').substring(0, 100),
              stop_name: (calBtn.getAttribute('data-stop-name') || calBtn.textContent || '').substring(0, 100)
            });
          }
        }
      });
    }
    ```
    NOTE: If the overlay container gets destroyed/recreated on each activation, move the delegation flag to the persistent parent or attach the delegation ONCE in the init function, not in activateItinerary(). Read the code to determine the right attachment point.

    Also add data attributes (`data-itinerary-title`, `data-stop-name`) to the calendar link rendering in itinerary-view.js if they don't already exist — this is the only acceptable edit in itinerary-view.js (adding data attributes for tracking, not tracking calls).

    **Step 5: itinerary:day-tab in itinerary-controller.js**
    In the day tab click handler (around lines 112-133):
    ```javascript
    var analytics = window.CulturalMapAnalytics;
    if (analytics) {
      analytics.track('itinerary:day-tab', {
        itinerary_id: (currentItineraryId || '').substring(0, 100),
        day: dayNumber
      });
    }
    ```

    **Step 6: events:date-filter in bindings.js**
    In the event filter chip click handler (around lines 77-83), after determining which filter was clicked:
    ```javascript
    var analytics = window.CulturalMapAnalytics;
    if (analytics) {
      analytics.track('events:date-filter', { filter: filterValue });
    }
    ```
    Where filterValue is the chip value like "today", "weekend", "14d".

    **Step 7: events:toggle in bindings.js**
    In the eventsDetails toggle handler (around lines 169-178):
    ```javascript
    var analytics = window.CulturalMapAnalytics;
    if (analytics) {
      analytics.track('events:toggle', { state: isOpen ? 'open' : 'closed' });
    }
    ```

    **Pattern for all:** Follow the exact 3-line Phase 6 pattern. Always null-guard with `if (analytics)`. Use kebab-case event names. Truncate names to 100 chars, URLs to 200 chars.
  </action>
  <verify>
    1. Grep for `marker:click` — should appear in asset-interactions.js (2 locations: circle click + mobile label) and map-label-controller.js (1 location)
    2. Grep for `itinerary:start` — should appear in itinerary-controller.js
    3. Grep for `itinerary:calendar` — should appear in itinerary-controller.js (delegation handler)
    4. Grep for `itinerary:day-tab` — should appear in itinerary-controller.js
    5. Grep for `events:date-filter` — should appear in bindings.js
    6. Grep for `events:toggle` — should appear in bindings.js
    7. Every analytics.track() call is guarded by `if (analytics)` — grep for `analytics.track` and verify each has a guard
    8. No analytics.track() calls inside render/build functions
  </verify>
  <done>
    Map marker clicks (circle + smart labels + mobile labels) fire marker:click with name, category, city. Itinerary activation fires itinerary:start. Calendar export clicks fire itinerary:calendar. Day tab switches fire itinerary:day-tab. Event date filter chips fire events:date-filter. Events section toggle fires events:toggle. Total tracked event types: 23 (16 Phase 6 + 7 Phase 6.1).
  </done>
</task>

</tasks>

<verification>
1. Grep for `CulturalMapAnalytics` across all stitch-lab JS files — count should increase by 7+ new call sites vs. Phase 6 baseline
2. Grep for all 7 new event names: `marker:click`, `itinerary:start`, `itinerary:calendar`, `itinerary:day-tab`, `outbound:event-ticket`, `events:date-filter`, `events:toggle`
3. Grep for `tagOutboundUrl.*event-ticket` — should appear in 3 event render files
4. No broken syntax: open the stitch-lab HTML in a browser, check console for JS errors
5. Committee metric coverage: all 4 outbound event types now tracked (website, phone, directions, event-ticket)
</verification>

<success_criteria>
- 7 new event types instrumented and firing via CulturalMapAnalytics wrapper
- All event ticket outbound links UTM-tagged with campaign=event-ticket
- Total tracked event types: 23 (verifiable by grepping for analytics.track across codebase)
- No JavaScript errors introduced (pages load without console errors)
- Committee's "clicked through to a business" metric capturable by summing outbound:website + outbound:phone + outbound:directions + outbound:event-ticket in Umami
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-deep-analytics-instrumentation/06.1-01-SUMMARY.md`
</output>
