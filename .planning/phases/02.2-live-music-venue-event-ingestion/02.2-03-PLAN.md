---
phase: 02.2-live-music-venue-event-ingestion
plan: 03
type: execute
wave: 2
depends_on:
  - 02.2-01
  - 02.2-02
files_modified:
  - .github/workflows/refresh-events.yml
  - website/cultural-map-redesign-stitch-lab/index-maplibre-events-filter-ui.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-events-model.js
  - website/cultural-map-redesign-stitch-lab/index-maplibre-events-controller.js
autonomous: true
requirements:
  - EVNT-07
  - EVNT-08
  - EVNT-09

must_haves:
  truths:
    - "GitHub Actions workflow runs all 9 ingest scripts daily with continue-on-error for new sources"
    - "Community ingest step writes GOOGLE_SERVICE_ACCOUNT_JSON secret to temp file for gspread auth"
    - "Events source dropdown shows tag options (Live Music, Arts & Gallery, Community) in an optgroup"
    - "Selecting 'Live Music' tag in dropdown filters events list to only events with live-music tag"
    - "Family & Kids events are hidden by default and only shown when user toggles the existing audience filter"
    - "Auto-commit message includes all 9 source names"
  artifacts:
    - path: ".github/workflows/refresh-events.yml"
      provides: "Updated daily cron with 9 ingest steps + Google credentials handling"
      contains: "ingest_crazyhorse_ical"
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-events-filter-ui.js"
      provides: "Source dropdown with tag optgroup sections"
      contains: "tag:live-music"
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-events-model.js"
      provides: "Tag-based filtering in getFilteredMapEvents"
      contains: "event_tags"
  key_links:
    - from: "website/cultural-map-redesign-stitch-lab/index-maplibre-events-filter-ui.js"
      to: "website/cultural-map-redesign-stitch-lab/index-maplibre-events-model.js"
      via: "Filter value 'tag:live-music' passed to model's getFilteredMapEvents"
      pattern: "tag:"
    - from: ".github/workflows/refresh-events.yml"
      to: "scripts/events/ingest_crazyhorse_ical.py"
      via: "Workflow step calling ingest script"
      pattern: "ingest_crazyhorse_ical"
---

<objective>
Update the GitHub Actions workflow for all 9 event sources, and integrate tag-based filtering into the frontend events filter UI and events model.

Purpose: Complete the pipeline end-to-end so new venue events flow from daily cron through merge to the user-facing filter dropdown.
Output: Updated workflow, frontend filter UI with tag options, model with tag filtering.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02.2-live-music-venue-event-ingestion/02.2-RESEARCH.md
@.planning/phases/02.2-live-music-venue-event-ingestion/02.2-01-SUMMARY.md
@.planning/phases/02.2-live-music-venue-event-ingestion/02.2-02-SUMMARY.md
@.github/workflows/refresh-events.yml
@website/cultural-map-redesign-stitch-lab/index-maplibre-events-filter-ui.js
@website/cultural-map-redesign-stitch-lab/index-maplibre-events-model.js
@website/cultural-map-redesign-stitch-lab/index-maplibre-events-controller.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update GitHub Actions workflow with 4 new ingest steps</name>
  <files>.github/workflows/refresh-events.yml</files>
  <action>
  Add 4 new ingest steps to `refresh-events.yml` BEFORE the merge step, all with `continue-on-error: true`:

  1. After "Ingest GVDA Trumba JSON" step, add:

  ```yaml
  - name: Ingest Crazy Horse iCal
    run: python scripts/events/ingest_crazyhorse_ical.py
    continue-on-error: true

  - name: Ingest Golden Era Squarespace
    run: python scripts/events/ingest_squarespace_events.py --site-url https://www.goldeneralounge.com --source-name goldenera --output-file website/cultural-map-redesign-stitch-lab/events-goldenera.json
    continue-on-error: true

  - name: Ingest Bodhi Hive Squarespace
    run: python scripts/events/ingest_squarespace_events.py --site-url https://www.bodhi-hive.com --source-name bodhihive --output-file website/cultural-map-redesign-stitch-lab/events-bodhihive.json
    continue-on-error: true

  - name: Ingest Community Submissions
    run: |
      echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > /tmp/gsa.json
      python scripts/events/ingest_community_form.py --sheet-id '${{ secrets.COMMUNITY_SHEET_ID }}' --credentials-file /tmp/gsa.json --output-file website/cultural-map-redesign-stitch-lab/events-community.json
      rm -f /tmp/gsa.json
    continue-on-error: true
  ```

  2. Update the auto-commit step:
  - commit_message: "chore(data): refresh events from 9 sources (Trumba + LibCal + CivicEngage + KVMR + GVDA + Crazy Horse + Golden Era + Bodhi Hive + Community)"
  - file_pattern: add the new event JSON files to the pattern

  3. Update the report step to handle new merged format (source_counts will now include new sources).
  </action>
  <verify>
  1. `cat .github/workflows/refresh-events.yml | grep -c "continue-on-error"` -- should show 7+ (was 3, now 7 with 4 new)
  2. Verify YAML is valid: `python -c "import yaml; yaml.safe_load(open('.github/workflows/refresh-events.yml'))"` (install pyyaml if needed, or just check syntax)
  3. Grep for all 9 source names in the workflow file
  </verify>
  <done>GitHub Actions workflow runs all 9 ingest scripts with continue-on-error for supplementary sources. Community ingest step handles Google credentials via secrets. Auto-commit message reflects all 9 sources.</done>
</task>

<task type="auto">
  <name>Task 2: Add tag filtering to frontend events filter UI and model</name>
  <files>website/cultural-map-redesign-stitch-lab/index-maplibre-events-filter-ui.js, website/cultural-map-redesign-stitch-lab/index-maplibre-events-model.js, website/cultural-map-redesign-stitch-lab/index-maplibre-events-controller.js</files>
  <action>
  1. Update `index-maplibre-events-filter-ui.js`:

  Modify the `buildMapEventsCategorySelect` function (or the `getOptionsHTML` callback it uses) to add tag-based options to the events source/category dropdown. The dropdown should have this structure:

  ```html
  <option value="all">All events</option>
  <optgroup label="By Type">
    <option value="tag:live-music">Live Music</option>
    <option value="tag:arts-gallery">Arts & Gallery</option>
    <option value="tag:community">Community</option>
  </optgroup>
  <optgroup label="By Source">
    <option value="source:trumba">Arts Council</option>
    <option value="source:kvmr">KVMR</option>
    <option value="source:gvda">GVDA</option>
    <option value="source:crazyhorse">Crazy Horse</option>
    <option value="source:goldenera">Golden Era</option>
    <option value="source:bodhihive">Bodhi Hive</option>
    <option value="source:community">Community</option>
    <!-- existing category options below if any -->
  </optgroup>
  ```

  Note: Family & Kids is NOT in the dropdown per locked decision -- it uses the existing audience toggle (Show Kids/Library button). The audience toggle's behavior already filters family events via eventAudienceFilter.

  Add a helper function `getTagOptionsHTML()` that returns the By Type optgroup HTML. This should be called within the existing getOptionsHTML flow or injected after it.

  2. Update `index-maplibre-events-model.js`:

  In the `getFilteredMapEvents` function (or equivalent filtering logic), add a code path for when the filter value starts with "tag:":
  - Parse the tag slug: `const tagSlug = filterValue.replace('tag:', '')`
  - Filter events to those where `event.event_tags` array includes `tagSlug`
  - Handle events without event_tags gracefully (treat as having no tags, exclude from tag filter)

  Also add a code path for "source:" prefix values:
  - Parse source: `const sourceType = filterValue.replace('source:', '')`
  - Filter events to those where `event.source_type === sourceType`

  3. Update `index-maplibre-events-controller.js` if needed:
  - Ensure the controller passes the raw filter value (including "tag:" or "source:" prefix) to the model
  - The normalizeEventCategoryFilter function in filter-ui.js should pass through "tag:" and "source:" values without normalization

  Key constraint: The existing audience filter (Show Kids/Library toggle) continues to work independently. When audience filter excludes kids/library events AND a tag filter is active, both filters apply (intersection).
  </action>
  <verify>
  1. Open the stitch-lab site locally and verify the events source dropdown shows "By Type" and "By Source" optgroups
  2. Select "Live Music" from the dropdown -- verify only events with live-music tag appear (or none if no tagged events in current data)
  3. Select "All events" -- verify all events appear again
  4. Verify the Show Kids/Library toggle still works independently
  5. Check browser console for no JavaScript errors
  </verify>
  <done>Events dropdown has "By Type" section with Live Music, Arts & Gallery, Community options. Events model filters by tag slug when "tag:*" value selected, by source when "source:*" value selected. Audience toggle works independently for Family & Kids filtering.</done>
</task>

</tasks>

<verification>
1. GitHub Actions workflow YAML is valid and contains all 9 ingest steps
2. Community ingest step writes and cleans up credentials temp file
3. Events dropdown renders with optgroup sections for type and source
4. Tag filtering returns correct subset of events
5. Source filtering returns correct subset of events
6. "All events" option clears all filters
7. Family & Kids audience toggle works independently of tag/source filter
8. No JavaScript console errors
</verification>

<success_criteria>
- Full pipeline: daily cron ingests 9 sources -> merge with tags -> frontend filters by tag
- User can filter events by "Live Music" and see only music events
- User can filter events by source (e.g., "KVMR") and see only that source's events
- Family events remain hidden by default, toggled via existing audience filter
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-live-music-venue-event-ingestion/02.2-03-SUMMARY.md`
</output>
