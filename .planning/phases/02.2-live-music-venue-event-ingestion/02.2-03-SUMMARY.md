---
phase: 02.2-live-music-venue-event-ingestion
plan: 03
subsystem: events
tags: [github-actions, ci-cd, event-filtering, optgroup, tag-filtering, source-filtering]

requires:
  - phase: 02.2-live-music-venue-event-ingestion
    provides: "9 ingest scripts, event_tags.json, merge pipeline with tagging"
provides:
  - "GitHub Actions daily cron running all 9 event ingest sources"
  - "Frontend tag-based filtering (Live Music, Arts & Gallery, Community)"
  - "Frontend source-based filtering (7 individual sources)"
  - "Complete end-to-end pipeline: cron -> ingest -> merge -> tag -> filter"
affects: [frontend-events, deployment, stitch-lab]

tech-stack:
  added: []
  patterns: ["optgroup-based dropdown with tag: and source: value prefixes", "prefix-dispatch filtering in events model"]

key-files:
  created: []
  modified:
    - .github/workflows/refresh-events.yml
    - website/cultural-map-redesign-stitch-lab/index-maplibre-events-filter-ui.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-events-model.js
    - website/cultural-map-redesign-stitch-lab/index-maplibre-events-view.js

key-decisions:
  - "Tag/source filter values use prefix dispatch (tag:live-music, source:kvmr) rather than separate dropdown"
  - "normalizeEventCategoryFilter passes through tag:/source: prefixed values without normalization"
  - "Scope label displays human-readable names for tag and source filters"
  - "Community ingest step in CI uses temp file for Google credentials with cleanup"

patterns-established:
  - "Prefix-dispatch pattern: filter value prefixes (tag:, source:) routed to different filter logic in model"
  - "optgroup sections in event dropdown for organizing filter types"

requirements-completed: [EVNT-07, EVNT-08, EVNT-09]

duration: 3min
completed: 2026-02-17
---

# Phase 02.2 Plan 03: CI Pipeline & Frontend Tag Filtering Summary

**GitHub Actions workflow expanded to 9 event sources with frontend tag/source dropdown filtering via optgroup sections and prefix-dispatch model logic**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-17T07:28:02Z
- **Completed:** 2026-02-17T07:31:00Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- GitHub Actions workflow now runs all 9 ingest sources daily with continue-on-error for supplementary sources
- Community ingest step securely handles Google service account credentials via temp file with cleanup
- Events dropdown includes "By Type" optgroup (Live Music, Arts & Gallery, Community) and "By Source" optgroup (7 sources)
- Events model filters by event_tags array for tag: prefix and by source_type for source: prefix
- Scope label renders human-readable names instead of raw filter slugs

## Task Commits

Each task was committed atomically:

1. **Task 1: Update GitHub Actions workflow with 9 ingest sources** - `6e5e087` (feat)
2. **Task 2: Add tag and source filtering to events frontend** - `ea09d41` (feat)

## Files Created/Modified
- `.github/workflows/refresh-events.yml` - 4 new ingest steps (Crazy Horse, Golden Era, Bodhi Hive, Community), updated commit message and file pattern
- `website/cultural-map-redesign-stitch-lab/index-maplibre-events-filter-ui.js` - getTagAndSourceOptionsHTML() helper, optgroup injection in buildMapEventsCategorySelect, tag:/source: passthrough in normalizeEventCategoryFilter
- `website/cultural-map-redesign-stitch-lab/index-maplibre-events-model.js` - tag: and source: prefix filtering in getFilteredMapEvents
- `website/cultural-map-redesign-stitch-lab/index-maplibre-events-view.js` - Human-readable scope labels for tag and source filters

## Decisions Made
- Tag and source filters share the same dropdown via optgroup sections rather than adding separate UI controls
- Filter value uses prefix dispatch (tag:live-music, source:kvmr) -- model checks prefix to determine filtering strategy
- normalizeEventCategoryFilter passes through prefixed values without normalization (tag: and source: are not category aliases)
- Community ingest writes credentials to /tmp/gsa.json and cleans up after (no credentials persisted in runner)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Added scope label support for tag/source filters**
- **Found during:** Task 2
- **Issue:** events-view.js getEventsScopeLabel would display raw "tag:live-music" to users
- **Fix:** Added human-readable label lookup for tag and source prefixes
- **Files modified:** website/cultural-map-redesign-stitch-lab/index-maplibre-events-view.js
- **Verification:** Syntax check passes, label maps cover all dropdown options
- **Committed in:** ea09d41 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical)
**Impact on plan:** Essential for user-facing label readability. No scope creep.

## Issues Encountered
None

## User Setup Required
None - GitHub Actions secrets (GOOGLE_SERVICE_ACCOUNT_JSON, COMMUNITY_SHEET_ID) documented in 02.2-02-SUMMARY.md.

## Next Phase Readiness
- Full pipeline complete: daily cron ingests 9 sources, merges with dedup and tagging, frontend filters by tag/source
- Phase 02.2 fully complete (3/3 plans)
- Ready for next phase priority work

---
*Phase: 02.2-live-music-venue-event-ingestion*
*Completed: 2026-02-17*
