---
phase: 02.2-live-music-venue-event-ingestion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/events/event_tags.json
  - scripts/events/merge_events.py
  - scripts/events/ingest_community_form.py
  - scripts/requirements.txt
  - website/cultural-map-redesign-stitch-lab/submit-event.html
autonomous: true
requirements:
  - EVNT-03
  - EVNT-04
  - EVNT-05
  - EVNT-06

user_setup:
  - service: google-cloud
    why: "Google Sheets API access for community submission form pipeline"
    env_vars:
      - name: GOOGLE_SERVICE_ACCOUNT_JSON
        source: "Google Cloud Console -> IAM & Admin -> Service Accounts -> Create -> Download JSON key"
      - name: COMMUNITY_SHEET_ID
        source: "Google Sheet URL: docs.google.com/spreadsheets/d/{THIS_ID}/edit"
    dashboard_config:
      - task: "Enable Google Sheets API"
        location: "Google Cloud Console -> APIs & Services -> Library -> search 'Google Sheets API' -> Enable"
      - task: "Create Google Form with fields: Event Name (required), Date (required), Start Time (required), End Time, Venue (dropdown), Other Venue, Event Type (checkboxes: Live Music/Family & Kids/Arts & Gallery/Community), Description, Ticket URL, Image URL, Recurring (One-time/Weekly/Monthly), Submitter Name, Submitter Email"
        location: "Google Forms -> forms.google.com"
      - task: "Link Form to Google Sheet, add 'status' and 'notes' columns to Sheet"
        location: "Form -> Responses tab -> Link to Sheets"
      - task: "Share the Google Sheet with the service account email (read-only)"
        location: "Google Sheet -> Share -> paste service account email"
      - task: "Add GOOGLE_SERVICE_ACCOUNT_JSON as GitHub Actions secret"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "event_tags.json defines Live Music, Family & Kids, Arts/Gallery, and Community tags with keyword patterns and source defaults"
    - "merge_events.py loads all 9 source files (5 existing + 4 new) and applies auto-tagging"
    - "merge_events.py applies venue-specific dedup override (venue source wins for events at its own venue)"
    - "Each merged event has an event_tags array with zero or more tag slugs"
    - "Community form ingest script reads approved rows from Google Sheet and outputs events-community.json"
    - "submit-event.html provides an embedded Google Form or link for venue operators to submit events"
  artifacts:
    - path: "scripts/events/event_tags.json"
      provides: "Tag definitions with keyword regex patterns and source-based defaults"
      contains: "live-music"
    - path: "scripts/events/merge_events.py"
      provides: "Extended merge pipeline with 9 sources, tagging, and venue-specific dedup"
      contains: "event_tags"
    - path: "scripts/events/ingest_community_form.py"
      provides: "Google Sheets reader for community-submitted events (Source 9)"
    - path: "website/cultural-map-redesign-stitch-lab/submit-event.html"
      provides: "Public event submission page"
  key_links:
    - from: "scripts/events/event_tags.json"
      to: "scripts/events/merge_events.py"
      via: "JSON load during merge for auto-tagging"
      pattern: "event_tags\\.json"
    - from: "scripts/events/merge_events.py"
      to: "website/cultural-map-redesign-stitch-lab/events-merged.json"
      via: "Merged output with event_tags arrays on each event"
      pattern: "event_tags"
---

<objective>
Build the event type tagging system (event_tags.json + merge pipeline integration), extend merge_events.py to handle all 9 sources with venue-specific dedup override, create the community form ingest script, and add the event submission page.

Purpose: Enable tag-based event filtering (Live Music, Arts/Gallery, Community) and provide a submission path for venues without structured calendars.
Output: Tagging config, extended merge pipeline, community form ingest script, submission page.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02.2-live-music-venue-event-ingestion/02.2-RESEARCH.md
@scripts/events/merge_events.py
@scripts/events/family_keywords.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create event_tags.json and integrate tagging into merge_events.py</name>
  <files>scripts/events/event_tags.json, scripts/events/merge_events.py, scripts/requirements.txt</files>
  <action>
  1. Create `scripts/events/event_tags.json` with 4 tag definitions:

  ```json
  {
    "tags": {
      "live-music": {
        "display": "Live Music",
        "positive_patterns": [
          "\\b(concert|live music|band|dj|open mic|jam|blues|jazz|rock|folk|bluegrass|reggae|hip hop|samba|acoustic|songwriter)\\b",
          "\\b(featuring|ft\\.|feat\\.)\\b"
        ],
        "source_defaults": ["crazyhorse", "goldenera", "bodhihive"]
      },
      "family-kids": {
        "display": "Family & Kids",
        "positive_patterns": ["\\b(kids|children|family|toddler|youth|teen|storytime|lego|craft time|play group)\\b"],
        "negative_patterns": ["\\b(children of|adults only|21\\+|18\\+|bar.*night)\\b"],
        "default_excluded": true
      },
      "arts-gallery": {
        "display": "Arts & Gallery",
        "positive_patterns": ["\\b(gallery|exhibit|art show|opening reception|visual art|sculpture|painting|photography|craft fair)\\b"]
      },
      "community": {
        "display": "Community",
        "positive_patterns": ["\\b(fundraiser|benefit|community|volunteer|town hall|civic|meeting|cleanup|potluck)\\b"]
      }
    }
  }
  ```

  2. Extend `merge_events.py` with the following changes:

  a) Add 4 new source file defaults and CLI args:
  - DEFAULT_CRAZYHORSE_FILE = Path("website/cultural-map-redesign-stitch-lab/events-crazyhorse.json")
  - DEFAULT_GOLDENERA_FILE = Path("website/cultural-map-redesign-stitch-lab/events-goldenera.json")
  - DEFAULT_BODHIHIVE_FILE = Path("website/cultural-map-redesign-stitch-lab/events-bodhihive.json")
  - DEFAULT_COMMUNITY_FILE = Path("website/cultural-map-redesign-stitch-lab/events-community.json")
  - DEFAULT_EVENT_TAGS = Path("scripts/events/event_tags.json")
  - Add corresponding --crazyhorse-file, --goldenera-file, --bodhihive-file, --community-file, --event-tags-file CLI args

  b) Update SOURCE_PRIORITY dict:
  ```python
  SOURCE_PRIORITY = {
      "trumba": 0, "gvda": 1, "libcal": 2, "kvmr": 3,
      "crazyhorse": 4, "goldenera": 5, "bodhihive": 6,
      "community": 7, "civicengage": 8,
  }
  ```

  c) Add VENUE_SOURCE_MAP for venue-specific dedup override:
  ```python
  VENUE_SOURCE_MAP = {
      "crazyhorse": "Crazy Horse Saloon",
      "goldenera": "Golden Era Lounge",
      "bodhihive": "Bodhi Hive",
  }
  ```

  d) Add `apply_event_tags(events, tag_config)` function:
  - Load event_tags.json
  - For each event, check source_type against source_defaults -> auto-assign tags
  - For each event, run positive_patterns regex against title + description -> assign matching tags
  - For family-kids: check negative_patterns first, skip if matched
  - If event already has tags from community form submission, use those directly (tag_confidence: "manual")
  - Set event["event_tags"] = list of matched tag slugs
  - Derive is_family from "family-kids" in event_tags for backward compatibility

  e) Modify dedup logic for venue-specific override:
  - When two events match on title+date, check if one source is in VENUE_SOURCE_MAP AND the event's venue_name fuzzy-matches that source's venue name
  - If so, prefer the venue source regardless of general SOURCE_PRIORITY
  - Otherwise use existing SOURCE_PRIORITY logic

  f) Call apply_event_tags() after dedup, before output. Load new source files in main().

  3. Add `gspread>=6.0.0` and `google-auth>=2.20.0` to `scripts/requirements.txt` (needed for Plan 02 Task 2).
  </action>
  <verify>
  Run from project root (with existing 5 source files present, new source files may not exist yet):
  1. `python scripts/events/merge_events.py` -- should complete without error, gracefully skipping missing new source files
  2. `python -c "import json; d=json.load(open('website/cultural-map-redesign-stitch-lab/events-merged.json')); e=d['events'][0]; print('event_tags' in e, e.get('event_tags', []))"` -- events should have event_tags arrays
  3. `python -c "import json; t=json.load(open('scripts/events/event_tags.json')); print(list(t['tags'].keys()))"` -- should print ['live-music', 'family-kids', 'arts-gallery', 'community']
  </verify>
  <done>event_tags.json defines 4 tag types with keyword patterns. merge_events.py handles all 9 sources, applies auto-tagging to every event, and uses venue-specific dedup override. Existing pipeline still works with missing new source files.</done>
</task>

<task type="auto">
  <name>Task 2: Create community form ingest script and event submission page</name>
  <files>scripts/events/ingest_community_form.py, website/cultural-map-redesign-stitch-lab/submit-event.html</files>
  <action>
  1. Create `scripts/events/ingest_community_form.py`:
  - Accept CLI args: --sheet-id (Google Sheet ID), --credentials-file (path to service account JSON), --output-file (default: website/cultural-map-redesign-stitch-lab/events-community.json)
  - Also accept --credentials-json (raw JSON string) for CI where the secret is a string, not a file
  - Use gspread + google.oauth2.service_account.Credentials to authenticate
  - Open sheet by ID, read all records
  - Filter to rows where status column == 'approved' (case-insensitive)
  - For each approved row, build event JSON:
    - event_id: "community-{row_number}" or "community-{slugified_title}-{date}"
    - title: from "Event Name" column
    - start_iso: combine Date + Start Time columns, parse to ISO 8601 in America/Los_Angeles
    - end_iso: combine Date + End Time columns, or default to start + 3 hours
    - venue_name: from Venue column (dropdown value)
    - source_type: "community"
    - source_label: "Community Submission"
    - event_tags: from "Event Type" column (checkboxes produce comma-separated string), map to tag slugs
    - tag_confidence: "manual"
    - Optional fields: description, ticket_url, image_url from corresponding columns
  - Output JSON array to output-file
  - Handle missing credentials gracefully: print warning and output empty array (for local dev without GCP setup)
  - Handle empty sheet or no approved rows: output empty array

  2. Create `website/cultural-map-redesign-stitch-lab/submit-event.html`:
  - Simple standalone HTML page with the site's editorial styling (cream background, Playfair Display heading, DM Sans body)
  - Title: "Submit an Event"
  - Brief intro text: "Know about an upcoming event in Nevada County? Submit it here and we'll add it to the cultural calendar."
  - Embed placeholder for Google Form iframe (actual form URL to be filled in after user creates the Google Form)
  - Use `<iframe>` embed with placeholder src: `<!-- Replace with your Google Form embed URL -->`
  - Include a direct link fallback: "Or fill out the form directly: [Google Form link]"
  - Link back to main site: "Back to Cultural Map"
  - Note: The actual Google Form URL will be added by Kaelen after creating the form (user_setup item)
  </action>
  <verify>
  1. `python scripts/events/ingest_community_form.py --help` -- should show usage with --sheet-id, --credentials-file, --output-file args
  2. `python scripts/events/ingest_community_form.py --sheet-id dummy --output-file /tmp/test-community.json` -- should produce empty array with warning about missing credentials (not crash)
  3. Open `website/cultural-map-redesign-stitch-lab/submit-event.html` in a browser -- should render a styled page with form embed placeholder
  </verify>
  <done>Community form ingest script reads approved rows from Google Sheet and outputs events-community.json. Submit-event.html provides the public-facing submission page. Both handle missing configuration gracefully.</done>
</task>

</tasks>

<verification>
1. event_tags.json is valid JSON with 4 tag definitions including keyword patterns
2. merge_events.py accepts 9 source files and produces merged output with event_tags on each event
3. Family & Kids tag has default_excluded: true in event_tags.json
4. Venue-specific dedup override: crazyhorse source wins for Crazy Horse events
5. Community ingest script handles missing credentials without crashing
6. submit-event.html renders with editorial styling
7. requirements.txt includes gspread and google-auth
</verification>

<success_criteria>
- Running merge_events.py with existing sources produces events with event_tags arrays
- The tagging system auto-tags events from live music venue sources as "live-music"
- Community ingest script is ready for Google Sheets integration (pending user_setup)
- Event submission page is deployed and accessible
</success_criteria>

<output>
After completion, create `.planning/phases/02.2-live-music-venue-event-ingestion/02.2-02-SUMMARY.md`
</output>
