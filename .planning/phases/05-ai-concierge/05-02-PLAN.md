---
phase: 05-ai-concierge
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - website/cultural-map-redesign/index-maplibre-chat-widget.js
  - website/cultural-map-redesign/index-maplibre-chat-view.js
  - website/cultural-map-redesign/index-maplibre-chat-controller.js
  - website/cultural-map-redesign/index-maplibre-hero-intent.html
  - website/cultural-map-redesign/index-maplibre-hero-intent.css
autonomous: true

must_haves:
  truths:
    - "A floating chat button (bottom-right) opens a slide-up conversation panel"
    - "On mobile (<600px), the chat panel covers the full screen"
    - "Typing a question and pressing Send posts to /api/chat and renders the response"
    - "Asset names in responses are clickable and trigger the detail panel via deep link"
    - "MUSE citations in responses display as styled attribution blocks with Heyzine link"
    - "A privacy notice is visible in the chat panel"
    - "Off-topic responses show a polite redirect (server-side enforcement)"
  artifacts:
    - path: "website/cultural-map-redesign/index-maplibre-chat-widget.js"
      provides: "FAB button, panel open/close, mobile overlay, privacy notice"
      min_lines: 80
    - path: "website/cultural-map-redesign/index-maplibre-chat-view.js"
      provides: "HTML generation for messages, typing indicator, error states"
      min_lines: 60
    - path: "website/cultural-map-redesign/index-maplibre-chat-controller.js"
      provides: "API calls, response parsing (deep links, MUSE citations), session hash, input sanitization"
      min_lines: 100
  key_links:
    - from: "index-maplibre-chat-controller.js"
      to: "/api/chat"
      via: "fetch POST with messages array and sessionHash"
      pattern: "fetch.*api/chat"
    - from: "index-maplibre-chat-controller.js"
      to: "window.CulturalMapDetailController"
      via: "click handler on .chat-asset-link calls openDetail(pid)"
      pattern: "chat-asset-link.*openDetail|data-pid"
    - from: "index-maplibre-chat-widget.js"
      to: "index-maplibre-chat-controller.js"
      via: "widget.init() calls controller.init() to wire form submit"
      pattern: "CulturalMapChatController"
    - from: "index-maplibre-hero-intent.html"
      to: "index-maplibre-chat-widget.js"
      via: "script tag before closing body, after main app scripts"
      pattern: "chat-widget\\.js"
---

<objective>
Build the client-side chat UI — a floating action button that opens a conversation panel, renders messages with parsed deep links and MUSE citations, handles the fetch-to-API flow, and is fully responsive (full-screen on mobile). Wire all three JS modules into the live HTML page.

Purpose: This is what the user sees and interacts with. The FAB + panel pattern is familiar (like Intercom/Drift) but the content is unique — grounded in 685 local assets with clickable names that open the map's detail panel.

Output: Three IIFE modules (widget, view, controller) + CSS additions + HTML script tags. Working chat flow end-to-end.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-concierge/05-RESEARCH.md
@.planning/phases/05-ai-concierge/05-01-SUMMARY.md

Live page and CSS:
@website/cultural-map-redesign/index-maplibre-hero-intent.html
@website/cultural-map-redesign/index-maplibre-hero-intent.css

Existing module patterns (reference for IIFE structure):
@website/cultural-map-redesign/index-maplibre-itinerary-controller.js
@website/cultural-map-redesign/index-maplibre-itinerary-view.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chat widget, view, and controller JS modules</name>
  <files>
    website/cultural-map-redesign/index-maplibre-chat-widget.js
    website/cultural-map-redesign/index-maplibre-chat-view.js
    website/cultural-map-redesign/index-maplibre-chat-controller.js
  </files>
  <action>
Create three IIFE modules following existing codebase patterns (ES5, `window.CulturalMap*` globals, `'use strict'`).

**Module 1: `index-maplibre-chat-widget.js` — UI shell**

Exposes: `window.CulturalMapChatWidget = { init, open, close, toggle, isOpen }`

`init()`:
- Inject FAB button into document.body (bottom-right fixed position, 56px circle, chat bubble SVG icon, gold `#c8943e` background, white icon)
- Inject chat panel (hidden by default): header with "Local Concierge" title + close button, privacy notice div, messages container (scrollable), input form with text input + send button
- FAB click → `toggle()`
- Close button click → `close()`
- Escape key → `close()` (when panel is open)
- Call `CulturalMapChatController.init()` after DOM injection

`open()`:
- Show panel with GSAP slideUp (if GSAP available) or CSS class toggle
- On mobile (<600px): panel becomes position:fixed fullscreen with z-index above everything
- Focus the input field
- Hide FAB while panel is open
- Add `.chat-open` class to body (prevents background scroll on mobile)

`close()`:
- Hide panel with GSAP slideDown or CSS class toggle
- Show FAB
- Remove `.chat-open` from body

Privacy notice text: "Queries are logged anonymously to improve local services."

**Module 2: `index-maplibre-chat-view.js` — HTML rendering**

Exposes: `window.CulturalMapChatView = { renderUserMessage, renderBotMessage, renderTypingIndicator, removeTypingIndicator, renderError, renderWelcome }`

`renderWelcome()`:
- Append a welcome message to #chatMessages: "Hi! I'm your Nevada County concierge. Ask me about restaurants, galleries, events, hiking trails, or anything to do around here."
- Style as bot message (left-aligned, slightly different background)

`renderUserMessage(text)`:
- Append right-aligned message bubble with the user's text (escaped)
- Auto-scroll messages container to bottom

`renderBotMessage(html)`:
- Append left-aligned message bubble with the parsed HTML (already processed by controller)
- Auto-scroll to bottom
- Wire click handlers on `.chat-asset-link` elements: `e.preventDefault()`, extract `data-pid`, call `CulturalMapChatController.handleAssetClick(pid)`

`renderTypingIndicator()`:
- Append animated three-dot typing indicator (CSS animation)
- Return the element so it can be removed

`removeTypingIndicator(el)`:
- Remove the typing indicator element from DOM

`renderError(message)`:
- Append error message styled differently (subtle red/muted)

Message bubble structure:
```html
<div class="chat-msg chat-msg--user">
  <div class="chat-msg__content">User text</div>
</div>
<div class="chat-msg chat-msg--bot">
  <div class="chat-msg__content">Bot HTML with links</div>
</div>
```

**Module 3: `index-maplibre-chat-controller.js` — Logic**

Exposes: `window.CulturalMapChatController = { init, handleSubmit, handleAssetClick, parseResponse }`

State: `messages` array (conversation history for Gemini context), `isLoading` boolean, `sessionHash` string.

`init()`:
- Generate or retrieve sessionHash from localStorage (`chat_session_hash` key, `crypto.randomUUID()`)
- Wire #chatForm submit → `handleSubmit()`
- Call `CulturalMapChatView.renderWelcome()`

`handleSubmit(e)`:
- Prevent default, get input value, trim, validate (non-empty, max 500 chars)
- Client-side sanitization: strip HTML tags, strip `javascript:` and `on\w+=` patterns
- Render user message via view
- Clear input field
- Push `{role: "user", content: sanitizedText}` to messages array
- Set isLoading = true, disable send button
- Render typing indicator
- `fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ messages, sessionHash }) })`
- On success: parse response JSON, call `parseResponse(data.response)`, render bot message, push `{role: "model", content: data.response}` to messages
- On 429: render error "You're asking too fast! Please wait a moment."
- On other error: render error "Sorry, something went wrong. Please try again."
- Finally: remove typing indicator, set isLoading = false, re-enable send button

`parseResponse(text)`:
- Convert `[[Asset Name|slug-or-pid]]` → `<a href="#" class="chat-asset-link" data-asset-name="Asset Name" data-pid="slug-or-pid">Asset Name</a>`
- Convert `{{MUSE|article-id|quote text}}` → `<div class="chat-muse-cite"><span class="chat-muse-label">Featured in MUSE Issue 3</span> <span class="chat-muse-quote">"quote text"</span> <a href="https://heyzine.com/flip-book/87a3c8db0f.html" target="_blank" rel="noopener" class="chat-muse-link">Read in MUSE →</a></div>`
- Convert newlines to `<br>` for basic formatting
- Convert `**text**` to `<strong>text</strong>` for bold
- Return the HTML string

`handleAssetClick(pid)`:
- Find the asset in the global data by matching pid or fuzzy name match
- If the page has `window.CulturalMapDetailController` or a global `openDetail` function, call it
- Alternatively, set `window.location.hash` to trigger the deep link handler: `#place=Asset+Name`
- Close the chat panel (widget.close()) so the detail panel is visible

**Important implementation notes:**
- Use DOMPurify if loaded (CDN) to sanitize bot responses before rendering. If DOMPurify not available, use basic escapeHTML for user messages and allow the pre-parsed HTML from parseResponse for bot messages (which only generates known-safe HTML patterns).
- Keep conversation history to last 10 messages (5 turns) to avoid token bloat on the API
- Debounce submit: if isLoading, ignore additional submits
  </action>
  <verify>
1. All three files exist: `ls website/cultural-map-redesign/index-maplibre-chat-{widget,view,controller}.js`
2. Each file wraps in IIFE and exposes window global: `grep -l "window.CulturalMapChat" website/cultural-map-redesign/index-maplibre-chat-*.js | wc -l` (expect 3)
3. Controller contains fetch to /api/chat: `grep "api/chat" website/cultural-map-redesign/index-maplibre-chat-controller.js`
4. Controller contains parseResponse with deep link pattern: `grep "chat-asset-link" website/cultural-map-redesign/index-maplibre-chat-controller.js`
5. Controller contains MUSE citation pattern: `grep "chat-muse-cite" website/cultural-map-redesign/index-maplibre-chat-controller.js`
  </verify>
  <done>Three IIFE modules created: widget (FAB + panel + mobile overlay), view (message rendering + typing indicator), controller (API calls + response parsing with [[asset]] deep links and {{MUSE}} citations + session hash + input sanitization)</done>
</task>

<task type="auto">
  <name>Task 2: Add chat CSS and wire modules into live HTML page</name>
  <files>
    website/cultural-map-redesign/index-maplibre-hero-intent.css
    website/cultural-map-redesign/index-maplibre-hero-intent.html
  </files>
  <action>
**1. Add chat CSS to `index-maplibre-hero-intent.css`:**

Append a clearly delimited section at the end of the CSS file:

```css
/* ═══════════════════════════════════════
   AI Concierge Chat Widget
   ═══════════════════════════════════════ */
```

Key styles (use existing design tokens where possible — `--gold: #c8943e`, `--ink: #1a1612`, `--cream: #f5f0e8`, font families from `:root`):

**FAB button (.chat-fab):**
- position: fixed, bottom: 24px, right: 24px, z-index: 9999
- width: 56px, height: 56px, border-radius: 50%
- background: var(--gold, #c8943e), color: white
- box-shadow: 0 4px 12px rgba(0,0,0,0.2)
- cursor: pointer, border: none
- transition: transform 0.2s, box-shadow 0.2s
- hover: transform scale(1.08), box-shadow: 0 6px 16px rgba(0,0,0,0.3)
- SVG inside: width 24px, height 24px

**Chat panel (.chat-panel):**
- position: fixed, bottom: 96px, right: 24px, z-index: 10000
- width: 380px, max-height: 520px
- background: white, border-radius: 16px
- box-shadow: 0 8px 32px rgba(0,0,0,0.15)
- display: none (hidden by default)
- flex-direction: column when visible (display: flex)
- overflow: hidden

**Chat header (.chat-header):**
- padding: 16px 20px, background: var(--ink, #1a1612), color: white
- display: flex, justify-content: space-between, align-items: center
- h3: font-family: Playfair Display, font-size: 1.1rem, margin: 0
- close button: background: none, border: none, color: white, font-size: 1.5rem, cursor: pointer

**Privacy notice (.chat-privacy):**
- padding: 8px 16px, font-size: 0.7rem, color: #888, background: #fafafa
- border-bottom: 1px solid #eee

**Messages area (.chat-messages):**
- flex: 1, overflow-y: auto, padding: 16px
- max-height: 340px, scroll-behavior: smooth

**Message bubbles (.chat-msg):**
- margin-bottom: 12px, display: flex
- `.chat-msg--user`: justify-content: flex-end
- `.chat-msg--bot`: justify-content: flex-start
- `.chat-msg__content`: max-width: 80%, padding: 10px 14px, border-radius: 12px, font-size: 0.9rem, line-height: 1.5
- User bubble: background: var(--gold, #c8943e), color: white, border-bottom-right-radius: 4px
- Bot bubble: background: #f0ede7, color: var(--ink, #1a1612), border-bottom-left-radius: 4px

**Asset links in messages (.chat-asset-link):**
- color: var(--gold, #c8943e), text-decoration: underline, cursor: pointer, font-weight: 600
- hover: color: darken(gold)

**MUSE citation (.chat-muse-cite):**
- margin-top: 8px, padding: 8px 12px, border-left: 3px solid var(--gold, #c8943e)
- background: rgba(200,148,62,0.08), border-radius: 0 8px 8px 0, font-size: 0.8rem
- .chat-muse-label: font-weight: 700, color: var(--gold)
- .chat-muse-quote: font-style: italic
- .chat-muse-link: color: var(--gold), text-decoration: none, font-weight: 600

**Typing indicator (.chat-typing):**
- Three dots with CSS animation (bouncing opacity)

**Input form (.chat-input-form):**
- display: flex, padding: 12px, border-top: 1px solid #eee, background: white
- input: flex: 1, border: 1px solid #ddd, border-radius: 20px, padding: 10px 16px, font-size: 0.9rem, outline: none
- input:focus: border-color: var(--gold)
- button: background: var(--gold), color: white, border: none, border-radius: 20px, padding: 10px 20px, margin-left: 8px, cursor: pointer, font-weight: 600

**Mobile (<600px):**
```css
@media (max-width: 600px) {
  .chat-panel {
    bottom: 0; right: 0; left: 0; top: 0;
    width: 100%; max-height: 100%;
    border-radius: 0;
  }
  .chat-messages { max-height: none; flex: 1; }
  body.chat-open { overflow: hidden; }
}
```

**Active state:**
```css
.chat-panel.chat-panel--open { display: flex; }
.chat-fab.chat-fab--hidden { display: none; }
```

**2. Wire script tags into `index-maplibre-hero-intent.html`:**

Add the three chat module scripts AFTER the existing app scripts (after `index-maplibre.js` or the last existing script tag), BEFORE the closing `</body>` tag. Order matters:
1. `index-maplibre-chat-view.js` (no dependencies)
2. `index-maplibre-chat-controller.js` (depends on view)
3. `index-maplibre-chat-widget.js` (depends on controller)

Then add an inline script or call in the existing init block:
```html
<script>
  // Initialize chat widget after page loads
  if (window.CulturalMapChatWidget) {
    window.CulturalMapChatWidget.init();
  }
</script>
```

Do NOT add DOMPurify CDN for V1 — the response parser only generates known-safe HTML patterns (anchor tags with data attributes, div/span with class names). User messages are escaped. This is sufficient for a demo.
  </action>
  <verify>
1. CSS file contains chat styles: `grep "chat-fab" website/cultural-map-redesign/index-maplibre-hero-intent.css`
2. CSS has mobile media query for chat: `grep -A2 "max-width.*600px" website/cultural-map-redesign/index-maplibre-hero-intent.css | grep "chat-panel"`
3. HTML has all 3 script tags: `grep "chat-widget\|chat-view\|chat-controller" website/cultural-map-redesign/index-maplibre-hero-intent.html | wc -l` (expect 3)
4. HTML has init call: `grep "CulturalMapChatWidget.init" website/cultural-map-redesign/index-maplibre-hero-intent.html`
5. Script load order correct (view before controller before widget): visual inspection of script tag order in HTML
  </verify>
  <done>Chat CSS integrated with the editorial design language (gold accent, cream backgrounds, Playfair Display header). Full-screen mobile overlay at 600px breakpoint. Three script tags added to HTML in correct dependency order with init call. Chat FAB appears bottom-right on page load.</done>
</task>

</tasks>

<verification>
1. Opening index-maplibre-hero-intent.html shows a gold FAB button in the bottom-right corner
2. Clicking FAB opens the chat panel with "Local Concierge" header and privacy notice
3. The input field accepts text and the form submits via POST to /api/chat
4. Bot responses render with styled message bubbles
5. [[Asset Name|pid]] patterns in responses become clickable links
6. {{MUSE|id|quote}} patterns render as styled citation blocks
7. On mobile viewport (<600px), the chat panel covers the full screen
8. Pressing Escape closes the chat panel
9. The privacy notice text is visible in every chat session
</verification>

<success_criteria>
- All 3 JS modules exist and expose window.CulturalMap* globals
- CSS styles are integrated into the existing stylesheet
- HTML has script tags in correct order
- FAB is visible at bottom-right on page load
- Chat panel opens/closes with the FAB
- Mobile overlay works at <600px
- Response parsing handles both [[asset]] and {{MUSE}} patterns
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-concierge/05-02-SUMMARY.md`
</output>
