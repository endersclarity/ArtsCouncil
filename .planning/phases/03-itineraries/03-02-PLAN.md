---
phase: 03-itineraries
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - website/cultural-map-redesign/index-maplibre-itinerary-view.js
  - website/cultural-map-redesign/index-maplibre-itinerary-controller.js
  - website/cultural-map-redesign/index-maplibre-hero-intent.html
  - website/cultural-map-redesign/index-maplibre-core-utils.js
  - website/cultural-map-redesign/index-maplibre.js
autonomous: false

must_haves:
  truths:
    - "Three itinerary cards appear in the hero section and clicking one opens the detail view"
    - "The itinerary detail view shows day-by-day stops with narrative, hours, and Add to Calendar links"
    - "Activating an itinerary draws its route and numbered stop markers on the map"
    - "Navigating to ?itinerary=perfect-day opens the 1-day itinerary directly on page load"
    - "On mobile (<=600px), stops are swipeable horizontal cards with CSS scroll-snap"
  artifacts:
    - path: "website/cultural-map-redesign/index-maplibre-itinerary-view.js"
      provides: "Hero cards HTML, detail overlay HTML, stop cards, mobile swipe layout"
      exports: ["renderHeroCards", "renderDetailOverlay", "renderStopCard"]
    - path: "website/cultural-map-redesign/index-maplibre-itinerary-controller.js"
      provides: "Activation lifecycle, map integration, deep link handling, experience conflict resolution"
      exports: ["activateItinerary", "deactivateItinerary", "initItineraries"]
  key_links:
    - from: "itinerary-controller.js"
      to: "corridor-map.js"
      via: "addCorridorLayers, animateRoute, getCorridorBounds"
      pattern: "CulturalMapCorridorMap\\."
    - from: "itinerary-controller.js"
      to: "experience-controller.js"
      via: "deactivateExperience on itinerary activation"
      pattern: "deactivateExperience"
    - from: "core-utils.js"
      to: "itinerary-controller.js"
      via: "deep link scalar 'itinerary' in parseDeepLinkSearch"
      pattern: "scalars.*itinerary"
    - from: "index-maplibre.js"
      to: "itinerary-controller.js"
      via: "fetch itineraries.json, init, deep link application"
      pattern: "itineraries\\.json|initItineraries|itinerary"
---

<objective>
Build the itinerary UI (hero cards + detail overlay + mobile swipe), controller (map activation + experience conflict + deep link), and wire everything into the main app.

Purpose: This plan takes the data layer from Plan 01 and makes it interactive -- visible in the hero, expandable into a detail view, rendered on the map, exportable to calendar, and deep-linkable.

Output: Two new JS modules, CSS additions, HTML script tags, and modifications to core-utils.js and index-maplibre.js for deep linking and initialization.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-itineraries/03-RESEARCH.md
@.planning/phases/03-itineraries/03-01-SUMMARY.md
@website/cultural-map-redesign/index-maplibre-hero-intent.html
@website/cultural-map-redesign/index-maplibre-corridor-map.js
@website/cultural-map-redesign/index-maplibre-experience-controller.js
@website/cultural-map-redesign/index-maplibre-core-utils.js
@website/cultural-map-redesign/index-maplibre.js
@website/cultural-map-redesign/index-maplibre-experience-view.js
@website/cultural-map-redesign/index-maplibre-detail-view.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create itinerary-view.js and itinerary-controller.js modules</name>
  <files>
website/cultural-map-redesign/index-maplibre-itinerary-view.js
website/cultural-map-redesign/index-maplibre-itinerary-controller.js
  </files>
  <action>
**itinerary-view.js** — IIFE exposing `window.CulturalMapItineraryView`:

1. `renderHeroCards(itineraries)` — returns HTML string for 3 itinerary cards in the hero section. Each card: editorial layout with title, subtitle, duration badge ("1 Day" / "2 Days" / "3 Days"), brief description (truncated to ~80 chars), and a "Plan Your Visit" CTA button. Cards should use the itinerary's theme.accent as border-left or accent color. Use class `itinerary-hero-card` for styling. Cards emit `data-itinerary-id` attribute for click handling.

2. `renderDetailOverlay(itinerary, resolvedStops)` — returns HTML for a modal overlay (like MUSE story panel). Structure:
   - Overlay backdrop with close button (X top-right)
   - Header: itinerary title, subtitle, duration badge
   - Day tabs: clickable "Day 1", "Day 2", "Day 3" tabs (only show tabs for multi-day)
   - Per-day content: ordered stop cards
   - Each stop card: stop number circle (colored with theme.accent), asset name (linked to detail panel via data-pid), time + duration ("9:00 AM - 10:30 AM"), narrative text, tip (if present, in a callout box), "Add to Calendar" button (calls CulturalMapItineraryCalendar.buildStopCalendarUrl), "Show on Map" button (data-stop-index)
   - Use class `itinerary-overlay` for the modal, `itinerary-day-tab` for tabs, `itinerary-stop-card` for stops

3. `renderStopCard(stop, index, itinerary, dateStr)` — renders a single stop card (used by renderDetailOverlay). Formats time from 24h to 12h AM/PM. Calculates end time from start + duration. Includes Google Calendar link via CulturalMapItineraryCalendar.buildStopCalendarUrl(stop, itinerary, dateStr).

4. CSS: Include inline styles OR add a `<style>` block within the IIFE that injects into `<head>` on first call. Styles needed:
   - `.itinerary-hero-cards` — flex row, gap, responsive (stack on mobile)
   - `.itinerary-hero-card` — card styling matching existing editorial cards (cream bg, subtle shadow, hover lift)
   - `.itinerary-overlay` — fixed fullscreen modal with z-index above map, scrollable, cream background
   - `.itinerary-overlay-backdrop` — semi-transparent backdrop
   - `.itinerary-day-tabs` — horizontal tab row
   - `.itinerary-day-tab.active` — accent-colored underline
   - `.itinerary-stop-card` — left-bordered card with stop number, horizontal layout
   - `.itinerary-stop-calendar-btn` — styled button/link for calendar export
   - Mobile (<=600px): `.itinerary-stops-mobile` with `scroll-snap-type: x mandatory`, `.itinerary-stop-card` with `min-width: 85vw; flex-shrink: 0; scroll-snap-align: start`
   - Use CSS custom properties from the existing design system (--color-cream, --color-ink, etc.) where available. Match the editorial/magazine aesthetic.

**itinerary-controller.js** — IIFE exposing `window.CulturalMapItineraryController`:

1. `initItineraries({ itineraries, data, map, heroContainer, overlayContainer })` — main init function:
   - Resolve stops for all itineraries using CulturalMapItineraryModel.resolveItineraryStops
   - Render hero cards into heroContainer using CulturalMapItineraryView.renderHeroCards
   - Bind click handlers on hero cards to call activateItinerary
   - Store state: { itineraries, resolved (map of id -> resolvedStops), data, map, activeId: null }

2. `activateItinerary(id)` — activation lifecycle:
   - Deactivate any currently active experience: `CulturalMapExperienceController.deactivateExperience()` (guard with typeof check)
   - Deactivate any currently active itinerary (if different id)
   - Get resolved stops from stored state
   - Render detail overlay into overlayContainer (or append to body)
   - Show overlay with GSAP animation (fade in + slide up, duration 0.4s)
   - Call `activateItineraryOnMap(id, resolved)` to draw route
   - Bind overlay close button, day tab clicks, "Show on Map" buttons
   - Update URL via CulturalMapCoreUtils.serializeDeepLinkSearch (add itinerary param)
   - Set activeId

3. `activateItineraryOnMap(id, resolved)` — map integration:
   - Get flat stops via CulturalMapItineraryModel.flattenStopsForMap(resolved)
   - Build route coordinates via CulturalMapCorridorMap.getRouteCoordinates(mapStops)
   - Build stops GeoJSON via CulturalMapCorridorMap.getStopsGeoJSON(mapStops)
   - Get itinerary theme colors
   - Call CulturalMapCorridorMap.addCorridorLayers({ map, routeCoords, stopsGeoJSON, routeColor, accentColor })
   - Fit map bounds via CulturalMapCorridorMap.getCorridorBounds(mapStops) with padding 80, maxZoom 13, pitch 30
   - Optionally animate route via CulturalMapCorridorMap.animateRoute

4. `deactivateItinerary()` — cleanup:
   - Remove overlay (GSAP fade out, then remove from DOM)
   - Remove map layers (call corridor-map removal or re-add with empty source)
   - Clear activeId
   - Remove itinerary param from URL

5. `getActiveItineraryId()` — returns activeId or null (for experience-controller conflict check)

**IMPORTANT integration notes:**
- The experience-controller.js needs a small edit: when activating an experience, call `CulturalMapItineraryController.deactivateItinerary()` if it exists (guard with typeof). This prevents both being active simultaneously.
- Day tab click shows/hides the corresponding day's stop cards (use display:none/block or a data attribute).
- "Show on Map" button should call map.flyTo with the stop's coordinates, pitch 45, zoom 14.
  </action>
  <verify>
1. Both files parse without syntax errors
2. window.CulturalMapItineraryView exposes: renderHeroCards, renderDetailOverlay, renderStopCard
3. window.CulturalMapItineraryController exposes: initItineraries, activateItinerary, deactivateItinerary, getActiveItineraryId
4. CSS injection creates the itinerary-overlay and itinerary-hero-card styles
5. Controller references CulturalMapCorridorMap functions (confirmed by grep)
  </verify>
  <done>View module generates all itinerary HTML (hero cards, detail overlay, stop cards with calendar links, mobile swipe). Controller manages activation lifecycle, map integration via corridor-map, and experience conflict resolution.</done>
</task>

<task type="auto">
  <name>Task 2: Wire into HTML, deep link, and main app bootstrap</name>
  <files>
website/cultural-map-redesign/index-maplibre-hero-intent.html
website/cultural-map-redesign/index-maplibre-core-utils.js
website/cultural-map-redesign/index-maplibre.js
website/cultural-map-redesign/index-maplibre-experience-controller.js
  </files>
  <action>
**1. HTML script tags** (`index-maplibre-hero-intent.html`):
Add 4 new script tags AFTER experience-controller.js (line 427) and BEFORE detail-view.js (line 428):
```html
<script src="index-maplibre-itinerary-model.js"></script>
<script src="index-maplibre-itinerary-calendar.js"></script>
<script src="index-maplibre-itinerary-view.js"></script>
<script src="index-maplibre-itinerary-controller.js"></script>
```

Also add a container element for itinerary hero cards in the hero section. Find the hero/intent section in the HTML and add a `<div id="itineraryHeroCards" class="itinerary-hero-cards"></div>` in an appropriate location (after the existing editorial content, before the map section). Also add `<div id="itineraryOverlay"></div>` just before `</body>` for the modal overlay.

**2. Deep link extension** (`index-maplibre-core-utils.js`):
Add `'itinerary'` to the `scalars` array in BOTH `parseDeepLinkSearch` (line 76) and `serializeDeepLinkSearch` (line 99). The arrays currently read:
```javascript
var scalars = ['open', 'events14d', 'experience', 'muse', 'pid', 'event', 'eventDate', 'eventCat'];
```
Change to:
```javascript
var scalars = ['open', 'events14d', 'experience', 'itinerary', 'muse', 'pid', 'event', 'eventDate', 'eventCat'];
```

**3. Main app bootstrap** (`index-maplibre.js`):
- In the data loading section (where experiences.json is fetched), add a parallel fetch for `itineraries.json`. Store result in a variable like `itinerariesData`.
- After map initialization and experience setup, call:
  ```javascript
  if (window.CulturalMapItineraryController && itinerariesData) {
    CulturalMapItineraryController.initItineraries({
      itineraries: itinerariesData,
      data: data,
      map: map,
      heroContainer: document.getElementById('itineraryHeroCards'),
      overlayContainer: document.getElementById('itineraryOverlay')
    });
  }
  ```
- In the deep link application section (`applyDeepLinkFromLocation` or equivalent), add handling for `?itinerary=<id>`:
  ```javascript
  if (deepLink.itinerary && window.CulturalMapItineraryController) {
    CulturalMapItineraryController.activateItinerary(deepLink.itinerary);
  }
  ```
- In `getDeepLinkStateFromApp` / `syncUrlFromApp`, include itinerary state:
  ```javascript
  state.itinerary = CulturalMapItineraryController ? CulturalMapItineraryController.getActiveItineraryId() : null;
  ```

**4. Experience controller conflict** (`index-maplibre-experience-controller.js`):
In the `activateExperience` function (or wherever the experience activation begins), add a guard:
```javascript
if (window.CulturalMapItineraryController) {
  CulturalMapItineraryController.deactivateItinerary();
}
```
This must run BEFORE the experience draws its own corridor layers.
  </action>
  <verify>
1. HTML has 4 new script tags in correct load order (after experience-controller, before detail-view)
2. HTML has itineraryHeroCards container and itineraryOverlay container
3. core-utils.js scalars arrays include 'itinerary' in both parse and serialize
4. index-maplibre.js fetches itineraries.json and calls initItineraries
5. Deep link ?itinerary=perfect-day is parsed and applied
6. experience-controller.js calls deactivateItinerary on activation
7. Open index-maplibre-hero-intent.html in browser — no console errors on load
  </verify>
  <done>All 4 files modified. Itinerary system is fully wired: hero cards render, clicking opens detail overlay, map shows route, calendar links work, deep links work, experience/itinerary mutual exclusion works.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete itinerary feature in browser</name>
  <files>website/cultural-map-redesign/index-maplibre-hero-intent.html</files>
  <action>
Human verification checkpoint. Open the site in a browser and verify all itinerary features work end-to-end.

What was built: Complete itinerary feature — 3 authored itineraries browsable from hero section, stop-by-stop detail view with calendar export, route rendering on map, deep linking, mobile swipe, and experience/itinerary conflict resolution.

How to verify:
1. Open http://localhost:8000/website/cultural-map-redesign/index-maplibre-hero-intent.html (start local server with `python -m http.server 8000`)
2. Hero cards: Scroll to hero section. Three itinerary cards visible with titles, duration badges, "Plan Your Visit" buttons.
3. Detail overlay: Click the 1-day "Arts and Nature: A Perfect Day" card. Modal overlay appears with stop-by-stop cards showing name, time, narrative, "Add to Calendar" button.
4. Calendar link: Click "Add to Calendar" on any stop. Opens Google Calendar in new tab with stop name, address, next Saturday date, Pacific timezone.
5. Map route: With itinerary open, map shows route line connecting stops with numbered markers. Map fits bounds to show all stops.
6. Close and conflict: Close itinerary overlay. Route disappears. Open an experience/corridor, then open an itinerary — experience route deactivates, replaced by itinerary route.
7. Deep link: Navigate to ?itinerary=perfect-day. The 1-day itinerary auto-opens.
8. Mobile: Resize to 375px width. Stop cards are swipeable (horizontal scroll-snap).
  </action>
  <verify>All 8 verification steps pass without console errors</verify>
  <done>User confirms itinerary feature works end-to-end in browser</done>
</task>

</tasks>

<verification>
1. Three itinerary cards visible in hero section
2. Clicking a card opens a detail overlay with day-by-day stops
3. Each stop has narrative text, time range, and working "Add to Calendar" link
4. Map draws route with numbered stop markers when itinerary is active
5. Closing overlay removes route from map
6. ?itinerary=perfect-day deep link works on page load
7. Activating an experience deactivates any active itinerary and vice versa
8. Mobile (375px) shows swipeable stop cards
9. No console errors on load or interaction
</verification>

<success_criteria>
- Itinerary hero cards render in the hero section with editorial styling
- Detail overlay shows stop-by-stop view with day tabs, narratives, and calendar export
- Map route and numbered stops appear via corridor-map.js reuse (no duplicate rendering code)
- Deep link ?itinerary=<id> works
- Experience/itinerary mutual exclusion works
- Mobile swipe view works at 375px
</success_criteria>

<output>
After completion, create `.planning/phases/03-itineraries/03-02-SUMMARY.md`
</output>
