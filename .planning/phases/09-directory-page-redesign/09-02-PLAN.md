---
phase: 09-directory-page-redesign
plan: 02
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - website/cultural-map-redesign-stitch-lab/directory.html
autonomous: true
requirements: [M1, M2, M12, M13, M14, M15, Min1, Min6, Min7]

must_haves:
  truths:
    - "Searching or filtering while a card is expanded collapses the card cleanly before re-render"
    - "Browser back button restores previous directory state (category, expanded card)"
    - "Deep linking with ?place=VenueName shows a loading spinner while data loads, then expands the card"
    - "Deep linking with a nonexistent place name shows an error toast, not a blank page"
    - "Deep-linked users see a breadcrumb back to the category/all view"
    - "All deep link URLs use ?place= format, not ?idx= — stable regardless of data.json reordering"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/directory.html"
      provides: "pushState history management, popstate handler, deep link loading state, error state, collapseCardImmediate before re-render"
      contains: "popstate"
  key_links:
    - from: "onSearch(), city filter click"
      to: "collapseCardImmediate()"
      via: "Called before renderList() to prevent ghost active state"
      pattern: "collapseCardImmediate.*renderList"
    - from: "popstate handler"
      to: "selectCategory() + expandCard()"
      via: "Reads state from history.state object"
      pattern: "addEventListener.*popstate"
    - from: "?place= deep link"
      to: "loadData().then()"
      via: "Shows spinner during load, resolves venue by name match after data ready"
      pattern: "place.*toLowerCase"
---

<objective>
Fix the deep link and history system: prevent card destruction on re-render, add browser back/forward with pushState, add loading/error states for deep links, and ensure stable URL-based IDs.

Purpose: M1 (card destroyed on re-render) is the most visible UX bug — users lose their expanded card when typing in search. M2 (no browser history) means back button exits the page entirely. M12-M15 cover deep link edge cases that affect QR code scans and shared URLs. This plan makes the directory feel like a proper single-page app.

Output: directory.html with robust state management — pushState/popstate for back/forward, collapseCardImmediate before re-renders, loading spinner for deep links, error toast for failed lookups, breadcrumb navigation.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/09-directory-page-redesign/09-RESEARCH.md
@.planning/phases/09-directory-page-redesign/09-01-SUMMARY.md
@website/cultural-map-redesign-stitch-lab/directory.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix card destruction on re-render and add pushState history</name>
  <files>website/cultural-map-redesign-stitch-lab/directory.html</files>
  <action>
  **M1 — Collapse before re-render:** Add `collapseCardImmediate();` as the FIRST line inside:
  1. `onSearch()` function — before `searchQuery = document.getElementById('directorySearch').value;`
  2. The city filter `pill.addEventListener('click', ...)` handler inside `buildHeaderAndFilters()` — before `activeCityFilter = pill.dataset.city || '';`

  This prevents the ghost-active-state bug where `activeItemId` is set but the expanded DOM element is nuked by `renderList()`.

  **M2 + M14 — pushState/popstate:** Replace all `history.replaceState` calls with `history.pushState` for meaningful state transitions. Then add a popstate handler.

  1. In `expandCard()`, change `history.replaceState(null, '', url)` to:
     ```javascript
     history.pushState({ cat: asset.l, place: asset.n }, '', url);
     ```

  2. In `collapseCard()`, change `history.replaceState(null, '', url)` to:
     ```javascript
     history.pushState({ cat: activeCategory || null, place: null }, '', url);
     ```

  3. In `selectCategory()`, after the `updateMapFilter()` call, add:
     ```javascript
     var url = new URL(window.location);
     if (cat) {
       url.searchParams.set('cat', cat);
       url.searchParams.delete('place');
     } else {
       url.searchParams.delete('cat');
       url.searchParams.delete('place');
     }
     history.pushState({ cat: cat || null, place: null }, '', url);
     ```

  4. Add a popstate handler in the `init()` function (after deep link processing):
     ```javascript
     window.addEventListener('popstate', function(e) {
       var state = e.state;
       if (!state) {
         // Back to initial state — show all categories
         collapseCardImmediate();
         activeCategory = null;
         activeCityFilter = '';
         searchQuery = '';
         document.getElementById('directorySearch').value = '';
         document.getElementById('directoryCatGrid').style.display = '';
         document.getElementById('directoryExpandedView').style.display = 'none';
         updateMapFilter();
         map.flyTo({ center: MAP_CENTER, zoom: MAP_ZOOM, pitch: 35, bearing: -15, duration: 800 });
         return;
       }

       collapseCardImmediate();

       if (state.cat && state.cat !== activeCategory) {
         activeCategory = state.cat;
         activeCityFilter = '';
         listPage = 0;
         document.getElementById('directoryCatGrid').style.display = 'none';
         document.getElementById('directoryExpandedView').style.display = '';
         buildHeaderAndFilters(state.cat);
         updateMapFilter();
         renderList();
       } else if (!state.cat) {
         activeCategory = null;
         activeCityFilter = '';
         document.getElementById('directoryCatGrid').style.display = '';
         document.getElementById('directoryExpandedView').style.display = 'none';
         updateMapFilter();
       }

       if (state.place) {
         var target = allData.find(function(d) {
           return d.n.toLowerCase() === state.place.toLowerCase();
         });
         if (target) {
           requestAnimationFrame(function() { expandCard(target); });
         }
       }
     });
     ```

  5. Set initial state on page load (before deep link processing in init):
     ```javascript
     history.replaceState({ cat: null, place: null }, '', window.location.href);
     ```
  </action>
  <verify>(1) Open directory.html, click a category, expand a card — then press browser Back. Should return to category view. Press Back again — should return to all-categories grid. (2) Type in search box while a card is expanded — the expanded card should collapse cleanly before search results render (no ghost gold outline). (3) Click a city filter pill while a card is expanded — same clean collapse behavior.</verify>
  <done>Browser back/forward navigates through directory states. Re-renders collapse active card first. No ghost-active-state bug.</done>
</task>

<task type="auto">
  <name>Task 2: Add deep link loading state, error handling, and breadcrumb</name>
  <files>website/cultural-map-redesign-stitch-lab/directory.html</files>
  <action>
  **M12 — Loading state:** When processing a `?place=` deep link, show a loading indicator. The data might take a moment to fetch. Add a small toast/spinner element:

  1. After `<main>` opens (after the `<header>` and hamburger overlay), add:
     ```html
     <div class="directory-toast" id="directoryToast" hidden>
       <span class="directory-toast-text"></span>
     </div>
     ```

  2. Add toast CSS to the inline `<style>` block:
     ```css
     .directory-toast {
       position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
       background: var(--ink, #1a1612); color: var(--cream, #f5f0e8);
       padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.82rem;
       font-family: 'DM Sans', sans-serif; z-index: 999; box-shadow: 0 4px 16px rgba(0,0,0,0.2);
       transition: opacity 0.3s;
     }
     .directory-toast--error { background: #721c24; }
     ```

  3. Add helper functions:
     ```javascript
     function showToast(msg, isError) {
       var toast = document.getElementById('directoryToast');
       if (!toast) return;
       toast.querySelector('.directory-toast-text').textContent = msg;
       toast.classList.toggle('directory-toast--error', !!isError);
       toast.hidden = false;
       if (isError) {
         setTimeout(function() { toast.hidden = true; }, 4000);
       }
     }
     function hideToast() {
       var toast = document.getElementById('directoryToast');
       if (toast) toast.hidden = true;
     }
     ```

  4. In the `init()` function, update the deep link block. Before the `allData.find()` for `urlPlace`, call `showToast('Loading ' + urlPlace + '...')`. After successfully expanding the card, call `hideToast()`.

  **M13 — Error state:** If the `?place=` value doesn't match any venue, show an error toast:
  ```javascript
  if (target) {
    selectCategory(target.l);
    requestAnimationFrame(function() {
      expandCard(target);
      hideToast();
    });
  } else {
    showToast('Place "' + urlPlace + '" not found', true);
  }
  ```

  **Min1 + Min6 — Stable IDs:** The directory already uses `?place=` and `?cat=` (not `?idx=`). Verify this is the case. If any code path still produces `?idx=` or `?pid=` URLs, replace with `?place=`. The `selectItemById` function uses numeric index internally but should NOT put it in the URL. The URL format is `?cat=Category&place=Venue+Name` — this is stable across data.json reordering.

  **Min7 — Deep link timing:** The deep link processing currently runs inside `loadData().then()` which means allData is populated. However, `initMap()` is called synchronously after `renderCategoryCards()`, and the map load event fires asynchronously. If the deep link tries to fly the map before it's loaded, `map.flyTo` could fail silently. Add a guard:
  ```javascript
  // In expandCard, guard the flyTo:
  if (map && map.loaded()) {
    map.flyTo({ ... });
  } else if (map) {
    map.once('load', function() {
      map.flyTo({ ... });
    });
  }
  ```

  **M15 — Back breadcrumb:** When a user arrives via deep link (has `?place=` in initial URL), add a breadcrumb above the expanded view. In the deep link handler, after `selectCategory(target.l)` (which populates `#directoryHeaderArea` via `buildHeaderAndFilters()`), inject a breadcrumb element at the top of `#directoryHeaderArea`. NOTE: The `#directoryHeaderArea` div exists in directory.html at line 56 (`<div id="directoryHeaderArea"></div>`) and is populated by `buildHeaderAndFilters()` which is called inside `selectCategory()`. So by the time the breadcrumb injection runs, the element exists and has content.
  ```javascript
  var breadcrumb = document.createElement('div');
  breadcrumb.className = 'directory-breadcrumb';
  breadcrumb.innerHTML = '<a href="directory.html">All Categories</a> <span>&rsaquo;</span> <a href="directory.html?cat=' + encodeURIComponent(target.l) + '">' + escapeHtml(target.l) + '</a> <span>&rsaquo;</span> <strong>' + escapeHtml(target.n) + '</strong>';
  var headerArea = document.getElementById('directoryHeaderArea');
  if (headerArea) headerArea.insertBefore(breadcrumb, headerArea.firstChild);
  ```

  Add breadcrumb CSS:
  ```css
  .directory-breadcrumb {
    display: flex; align-items: center; gap: 0.4rem; padding: 0.5rem 0;
    font-size: 0.75rem; color: var(--ink, #1a1612); opacity: 0.7;
    font-family: 'DM Sans', sans-serif;
  }
  .directory-breadcrumb a { color: var(--gold, #c8943e); text-decoration: none; }
  .directory-breadcrumb a:hover { text-decoration: underline; }
  .directory-breadcrumb strong { opacity: 1; font-weight: 600; }
  ```
  </action>
  <verify>(1) Navigate to `directory.html?place=Nevada+Theatre` — should show "Loading Nevada Theatre..." toast, then expand the card and hide the toast. Breadcrumb visible: "All Categories > Performance Spaces > Nevada Theatre". (2) Navigate to `directory.html?place=Nonexistent+Place` — should show red error toast "Place 'Nonexistent Place' not found" that auto-dismisses. (3) Navigate to `directory.html?place=Nevada+Theatre` — press browser Back — should return to Performance Spaces category view. (4) Check that no URL anywhere in the file produces `?idx=` format.</verify>
  <done>Deep links show loading state during data fetch, error message for unmatched places, and breadcrumb for context. Browser history works correctly with deep-linked entries. All URLs use stable ?place= format.</done>
</task>

</tasks>

<verification>
1. Open `directory.html` — click category → expand card → Back → returns to category → Back → returns to all categories grid
2. Forward button works to re-enter the previous state
3. Type in search with expanded card — card collapses cleanly, no gold ghost outline
4. `directory.html?place=Nevada+Theatre` — loading toast, card expands, toast hides, breadcrumb shows
5. `directory.html?place=FakePlace123` — error toast appears and auto-dismisses
6. No `?idx=` or `?pid=` URLs generated anywhere in directory.html code
7. Map flyTo works even when triggered before map fully loads (guard catches it)
</verification>

<success_criteria>
- `collapseCardImmediate()` is called before every `renderList()` in search/filter paths
- `history.pushState` used for category selection, card expansion, card collapse
- `popstate` handler restores category, expanded card, and map camera state
- `?place=` deep links show loading toast → resolve → hide toast
- Unmatched deep links show error toast with auto-dismiss
- Breadcrumb renders for deep-linked entries
- Map flyTo is guarded against pre-load race condition
- No `?idx=` or `?pid=` URL generation in any code path
</success_criteria>

<output>
After completion, create `.planning/phases/09-directory-page-redesign/09-02-SUMMARY.md`
</output>
