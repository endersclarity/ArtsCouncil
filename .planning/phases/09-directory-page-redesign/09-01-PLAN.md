---
phase: 09-directory-page-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - website/cultural-map-redesign-stitch-lab/directory.html
  - website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css
autonomous: true
requirements: [C1, C2, C3, C4, C5, M4, M7]

must_haves:
  truths:
    - "Directory header visually matches the hub header (cream mast bar, brand link, desktop nav links, hamburger button)"
    - "Mobile users (<900px) can open hamburger menu and navigate to other pages"
    - "Expanded cards show real hours state (open/closed/unknown) from hoursUtils, not always 'unknown'"
    - "Expanded cards show real 14-day event counts from events-merged-flat.json, not always 0"
    - "Directory sidebar uses editorial cream/ink/gold palette, not dark charcoal"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/directory.html"
      provides: "Hub-matched header with .mast-inner structure, hamburger overlay, events wiring"
      contains: "mast-inner"
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css"
      provides: "nav-active style for .mast-nav-desktop, hours-pill base CSS"
      contains: "mast-nav-desktop a.nav-active"
  key_links:
    - from: "directory.html header markup"
      to: "index-maplibre-photo-carousel.js"
      via: "setupHamburger() finds .mast-hamburger, #hamburgerOverlay DOM elements"
      pattern: "mast-hamburger.*hamburgerOverlay"
    - from: "directory.html script tags"
      to: "events-merged-flat.json"
      via: "fetch() in loadData chain builds matchedEventsByAsset"
      pattern: "events-merged-flat\\.json"
    - from: "expandCard()"
      to: "eventsModel.getEventCountForAsset14d"
      via: "getEventCountForAsset14d(asset.id) replaces hardcoded 0"
      pattern: "getEventCountForAsset14d"
---

<objective>
Rebuild directory.html foundation: header/nav to match hub, fix sidebar colors, wire real hours and events data, add missing CSS and fonts.

Purpose: The 5 critical issues (C1-C5) block all other directory work. The header mismatch means mobile users are trapped (no hamburger), the dark sidebar clashes with the editorial design system, and stubbed hours/events make the directory feel like a prototype. This plan establishes the visual and data foundation.

Output: directory.html with hub-matching header, hamburger support, real hours in GeoJSON tooltips, real event counts in expanded cards, and editorial color tokens throughout.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/09-directory-page-redesign/09-RESEARCH.md
@website/cultural-map-redesign-stitch-lab/directory.html
@website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css
@website/cultural-map-redesign-stitch-lab/index-maplibre-photo-carousel.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace header markup and add hamburger overlay</name>
  <files>website/cultural-map-redesign-stitch-lab/directory.html</files>
  <action>
  Replace the entire `<header>...</header>` block (lines 33-45) with the hub-matching structure from the research doc. Specifically:

  1. Replace `<div class="brand">` with `<div class="mast-inner">`.
  2. Replace `<h1 class="mast-name">Explore Nevada County</h1>` with `<a href="index-maplibre-hero-intent-stitch-frontend-design-pass.html" class="mast-brand" aria-label="Explore Nevada County homepage">Explore Nevada County</a>`.
  3. Replace `<nav class="stitch-top-nav">` with `<nav class="mast-nav-desktop" aria-label="Primary">`. Keep nav links: Events, Itineraries, Directory (with `class="nav-active"`), Map (href to hub#mapSection), My Trip (with `.trip-badge` span). Remove the "Back to Explore" link — it's redundant when the brand is a link.
  4. Remove `<div class="edition">February 2026</div>` entirely.
  5. Add `<div class="mast-actions">` after the nav with: search toggle button (SVG magnifier), search field (hidden), hamburger button (SVG 3-bar). Use exact markup from research doc Pattern 1.
  6. After closing `</header>`, add the hamburger overlay `<div class="hamburger-overlay" id="hamburgerOverlay" hidden>` with hamburger panel, close button, and nav links (Events, Itineraries, Directory, Explore, My Trip). Use exact markup from research doc.
  7. Add `<script src="index-maplibre-photo-carousel.js"></script>` AFTER the existing detail-view.js script tag (before the inline IIFE `<script>`).
  8. At the end of the `init()` function (after the deep link block, around line 888), add: `if (window.CulturalMapPhotoCarousel && window.CulturalMapPhotoCarousel.init) { window.CulturalMapPhotoCarousel.init(); }` — this initializes hamburger/search toggle. The `cloneCategoryGrid()` inside will silently no-op since `#categoryGrid` doesn't exist in directory.html — this is expected.
  9. Update the trip badge script at the bottom (line 904) to query ALL `.trip-badge` elements (use `querySelectorAll` + `forEach`) since the new header has a trip badge in both desktop nav and hamburger nav.

  Also add Archivo font to the Google Fonts link (M7): change the `<link>` from `family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500` to also include `&family=Archivo:wght@400;500;600;700;800;900`.
  </action>
  <verify>Open directory.html in browser. Verify: (1) cream header bar with "Explore Nevada County" brand link, desktop nav links, search toggle, hamburger icon visible. (2) At 900px or below, desktop nav hides and hamburger icon is the only navigation. (3) Clicking hamburger opens overlay panel with navigation links. (4) Hamburger close button works. (5) "Directory" link in nav has active/gold styling.</verify>
  <done>Directory header visually matches the hub. Mobile hamburger menu opens and closes. No console errors from photo-carousel.js init.</done>
</task>

<task type="auto">
  <name>Task 2: Fix sidebar color tokens and add missing CSS</name>
  <files>website/cultural-map-redesign-stitch-lab/directory.html, website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css</files>
  <action>
  **C3 — Sidebar color fix:** In directory.html's inline `<style>` block (or in the CSS file's `.directory-page` scoped rules), ensure the directory sidebar (`.directory-pane`) uses `background: var(--cream, #f5f0e8)` and `color: var(--ink, #1a1612)` instead of any Tailwind-derived dark charcoal (`#1f2937`). Check the existing CSS file for `.directory-pane` rules — if they already set cream background, the issue may be an inline style or a specificity conflict. Inspect and fix as needed.

  **M4 — Hours pill CSS:** Add base `.hours-pill` styles to the CSS file if not already present. Pattern:
  ```css
  .hours-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.15rem 0.55rem;
    border-radius: 999px;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
  }
  .hours-pill--open { background: #d4edda; color: #155724; }
  .hours-pill--closed { background: #f8d7da; color: #721c24; }
  .hours-pill--unknown { background: #e2e3e5; color: #383d41; }
  ```
  Check if these already exist in the CSS file first — search for `.hours-pill`. Only add if missing.

  **nav-active for mast-nav-desktop:** Add to the CSS file:
  ```css
  .mast-nav-desktop a.nav-active {
    color: var(--gold, #c8943e);
    font-weight: 800;
  }
  ```
  Check if this rule already exists first. Only add if missing.

  **Verify no dark theme leaks:** Search the CSS file for any `.directory-page .directory-pane` rules that set dark backgrounds. If found, override or remove.
  </action>
  <verify>Open directory.html. Verify: (1) sidebar has cream background, not dark charcoal. (2) Expand any card with hours data — the hours pill renders with colored background (green for open, red for closed, gray for unknown), not plain text. (3) "Directory" link in desktop nav has gold color and bold weight.</verify>
  <done>Sidebar uses editorial cream/ink/gold palette. Hours pills render with proper styling. Nav active state is visible.</done>
</task>

<task type="auto">
  <name>Task 3: Wire real hours and events data</name>
  <files>website/cultural-map-redesign-stitch-lab/directory.html</files>
  <action>
  **C4 — Real hours in GeoJSON build:** In the `initMap()` function, change the `buildAssetsGeoJSON` call (around line 316-325). Replace:
  ```javascript
  getHoursState: function() { return 'unknown'; },
  getHoursLabel: function() { return ''; },
  ```
  with:
  ```javascript
  getHoursState: function(asset) { return hoursUtils.getHoursState ? hoursUtils.getHoursState(asset) : 'unknown'; },
  getHoursLabel: function(state) { return hoursUtils.getHoursLabel ? hoursUtils.getHoursLabel(state) : ''; },
  ```

  **C5 — Events wiring:** This requires multiple changes:

  1. Add two script tags before the existing inline IIFE `<script>` (after detail-view.js, before photo-carousel.js):
     ```html
     <script src="index-maplibre-events-utils.js"></script>
     <script src="index-maplibre-events-model.js"></script>
     ```

  2. Inside the IIFE, after the existing module declarations (around line 108), add:
     ```javascript
     var eventsUtils = window.CulturalMapEventsUtils || {};
     var eventsModel = window.CulturalMapEventsModel || {};
     var matchedEventsByAsset = new Map();
     ```

  3. Add a helper function after the module declarations. **DO NOT** write a custom date-filtering helper — use the module's existing `eventsModel.getEventCountForAsset14d()` which properly uses `event.start_iso` (not `event.date` or `event.start`) via `isEventWithinDays`. The custom wrapper just provides the closure variables:
     ```javascript
     function getEventCountForAsset14d(assetIdx) {
       return eventsModel.getEventCountForAsset14d
         ? eventsModel.getEventCountForAsset14d({
             matchedEventsByAsset: matchedEventsByAsset,
             assetIdx: assetIdx,
             isEventWithinDays: eventsUtils.isEventWithinDays || function() { return false; },
             days: 14
           })
         : 0;
     }
     ```

  4. In `loadData()`, after `allData` is built and the subtitle is updated (after line 269), **save a reference to the raw unfiltered data BEFORE the `.filter()` call**, then use it for event matching. This is critical because `buildVenueEventIndex` keys `matchedEventsByAsset` by array position within the `data` argument, and `events.index.json` stores `matched_asset_idx` values based on the raw unfiltered array. If we pass the filtered `allData`, positions diverge and event counts silently return 0.

     **First**, change the data loading to preserve raw data. Around line 249, BEFORE the `.filter()`:
     ```javascript
     var rawMapped = raw.map(function(item, idx) {
       var normalized = normalizeCategory(item.l);
       return {
         id: idx,
         n: item.n || '',
         l: normalized,
         l_original: normalized !== item.l ? item.l : '',
         c: item.c || '',
         a: item.a || '',
         d: item.d || '',
         p: item.p || '',
         w: item.w || '',
         h: item.h || '',
         x: parseFloat(item.x) || 0,
         y: parseFloat(item.y) || 0
       };
     });
     allData = rawMapped.filter(function(d) { return CATS[d.l]; });
     ```
     Then store `rawMapped` in a module-level variable (add `var rawDataForEvents = [];` next to the `allData` declaration). After building rawMapped, set `rawDataForEvents = rawMapped;`.

     **Then** add the events fetch chain:
     ```javascript
     // Fetch events data (non-blocking — events are optional enhancement)
     Promise.all([
       fetch('events-merged-flat.json').then(function(r) { return r.json(); }).catch(function() { return []; }),
       fetch('events.index.json').then(function(r) { return r.json(); }).catch(function() { return {}; })
     ]).then(function(results) {
       var rawEvents = results[0];
       var eventIndex = results[1];
       if (eventsModel.buildVenueEventIndex) {
         var result = eventsModel.buildVenueEventIndex({
           data: rawDataForEvents,  // Use raw unfiltered data so indices match events.index.json
           eventIndex: eventIndex,
           events: rawEvents,
           makeEventVenueKey: eventsUtils.makeEventVenueKey || function() { return ''; },
           parseEventDate: eventsUtils.parseEventDate || function() { return null; }
         });
         if (result && result.matchedEventsByAsset) {
           matchedEventsByAsset = result.matchedEventsByAsset;
         }
       }
     }).catch(function(err) {
       console.warn('[Directory] Events fetch failed (non-critical):', err);
     });
     ```

  5. In `buildAssetsGeoJSON` call (initMap), replace the event stub:
     ```javascript
     getEventCountForAsset14d: function(asset) { return getEventCountForAsset14d(asset.id); },
     ```
     This works because `asset.id` is the raw index (set as `id: idx` from the raw `.map()`), and `matchedEventsByAsset` is keyed by raw index (since we passed `rawDataForEvents` to `buildVenueEventIndex`).

  6. In `expandCard()` (around line 709), replace `eventCount14d: 0` with:
     ```javascript
     eventCount14d: getEventCountForAsset14d(asset.id),
     ```

  **IMPORTANT:** The events fetch is non-blocking. If events data fails to load, the page still works — event counts just stay at 0. The `catch` ensures no errors propagate.
  </action>
  <verify>Open directory.html. (1) Open browser DevTools Network tab — confirm events-merged-flat.json and events.index.json are fetched. (2) Expand a card for a venue known to have events (e.g., "Nevada Theatre" or "Center for the Arts"). The event count in the meta section should be > 0 if events exist. (3) Check map tooltips — hours state should show real values for venues with hours data in data.json, not always "unknown". (4) No console errors.</verify>
  <done>Hours data flows from hoursUtils through GeoJSON build to map tooltips. Events data loads from events-merged-flat.json and populates expanded card event counts. Both degrade gracefully to defaults if data is missing.</done>
</task>

</tasks>

<verification>
1. Open `directory.html` at `http://localhost:8001/directory.html`
2. Header: cream mast bar matches hub — brand link, nav links (Events, Itineraries, Directory active, Map, My Trip), search toggle, hamburger
3. Resize to 900px width — desktop nav hides, hamburger visible. Click hamburger — panel slides in with nav links.
4. Sidebar: cream background, ink text, gold accents — no dark charcoal anywhere
5. Click a category card (e.g., "Performance Spaces"). Expand "Nevada Theatre" — hours pill shows styled state (green/red/gray), event count reflects real data
6. Map tooltips show hours state for venues with hours data
7. No console errors
8. All fonts load (Playfair Display, DM Sans, JetBrains Mono, Archivo)
</verification>

<success_criteria>
- Header markup uses `.mast-inner` / `.mast-nav-desktop` / `.mast-actions` structure
- Hamburger overlay exists and functions on mobile (<900px)
- `index-maplibre-photo-carousel.js` loaded and init'd without errors
- `index-maplibre-events-utils.js` and `index-maplibre-events-model.js` loaded
- `events-merged-flat.json` and `events.index.json` fetched on page load
- `getHoursState` in buildAssetsGeoJSON calls real hoursUtils function
- `getEventCountForAsset14d` in expandCard returns real count from matchedEventsByAsset
- Sidebar background is cream (`--cream` or `#f5f0e8`), not `#1f2937`
- `.hours-pill` CSS renders pills with colored backgrounds
- `.mast-nav-desktop a.nav-active` shows gold active state
- Archivo font included in Google Fonts link
</success_criteria>

<output>
After completion, create `.planning/phases/09-directory-page-redesign/09-01-SUMMARY.md`
</output>
