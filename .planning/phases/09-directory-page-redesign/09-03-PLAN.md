---
phase: 09-directory-page-redesign
plan: 03
type: execute
wave: 3
depends_on: [09-02]
files_modified:
  - website/cultural-map-redesign-stitch-lab/directory.html
  - website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css
autonomous: true
requirements: [M3, M5, M6, M8, M9, M10, M11, Min2, Min3, Min4, Min5, Min8, Min9, Min10]

must_haves:
  truths:
    - "Empty search results show a clear 'No places found' message with suggestion to broaden search"
    - "Pagination shows 'Showing X of Y places' count, not just a bare 'Show more' button"
    - "Hovering a map marker highlights the corresponding card in the sidebar list"
    - "Sort dropdown allows alphabetical (A-Z, Z-A) and city sorting"
    - "Mobile map pane has a collapse/expand toggle"
    - "Footer has proper credits, attribution, and links"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/directory.html"
      provides: "Empty state, pagination progress, sort options, hover sync, mobile map toggle, footer, keyboard a11y, sticky header"
      contains: "directory-empty-state"
    - path: "website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css"
      provides: "Responsive category grid, sticky header, focus ring styles, tooltip token alignment"
      contains: "directory-empty-state"
  key_links:
    - from: "map mouseenter event on assets-circle"
      to: "sidebar .directory-item highlight"
      via: "Feature properties.idx → querySelector [data-asset-id=idx] → add highlight class"
      pattern: "mouseenter.*directory-item--hover"
    - from: "sidebar .directory-item mouseenter"
      to: "map setFeatureState"
      via: "asset.id → map.setFeatureState for hover glow"
      pattern: "setFeatureState.*hover"
---

<objective>
Polish directory interactions: empty states, pagination counts, sort options, map-list hover sync, mobile map toggle, footer, keyboard accessibility, and CSS refinements.

Purpose: With foundation (09-01) and deep links (09-02) in place, this plan addresses the 14 remaining UX and polish issues. These are the details that make the directory feel finished rather than functional — hover feedback, keyboard navigation, proper empty states, and responsive refinements.

Output: directory.html with complete interaction layer — empty states, sort/pagination UX, bidirectional map-list hover sync, mobile-friendly map toggle, upgraded footer, keyboard accessibility, and editorial CSS polish.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/09-directory-page-redesign/09-RESEARCH.md
@.planning/phases/09-directory-page-redesign/09-01-SUMMARY.md
@.planning/phases/09-directory-page-redesign/09-02-SUMMARY.md
@website/cultural-map-redesign-stitch-lab/directory.html
@website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Empty state, pagination progress, sort options, footer</name>
  <files>website/cultural-map-redesign-stitch-lab/directory.html, website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css</files>
  <action>
  **M3 — Empty state:** In `renderList()`, after `var visible = filtered.slice(0, end);`, add:
  ```javascript
  if (filtered.length === 0) {
    list.innerHTML = '<div class="directory-empty-state">' +
      '<p class="directory-empty-state-msg">No places found</p>' +
      '<p class="directory-empty-state-hint">Try a different search term or browse by category</p>' +
    '</div>';
    if (loadMore) loadMore.style.display = 'none';
    return;
  }
  ```
  Add CSS for `.directory-empty-state`:
  ```css
  .directory-empty-state {
    text-align: center; padding: 3rem 1.5rem; color: var(--ink, #1a1612); opacity: 0.6;
  }
  .directory-empty-state-msg {
    font-family: 'Playfair Display', serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.5rem;
  }
  .directory-empty-state-hint {
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem;
  }
  ```

  **M11 — Pagination progress:** Replace the bare "Show more" button text with a count. In `renderList()`, update the loadMore button text:
  ```javascript
  if (loadMore) {
    if (end >= filtered.length) {
      loadMore.style.display = 'none';
    } else {
      loadMore.style.display = 'block';
      loadMore.textContent = 'Show more (' + visible.length + ' of ' + filtered.length + ')';
    }
  }
  ```

  **M9 — Sort options:** Add a sort dropdown to the expanded view header area. In `buildHeaderAndFilters()`, after the city filter pills `</div>`, add a sort control:
  ```javascript
  html += '<div class="directory-sort">';
  html += '<label for="directorySort" class="directory-sort-label">Sort:</label>';
  html += '<select id="directorySort" class="directory-sort-select">';
  html += '<option value="name">A \u2013 Z</option>';
  html += '<option value="name-desc">Z \u2013 A</option>';
  html += '<option value="city">By City</option>';
  html += '</select>';
  html += '</div>';
  ```
  After `headerEl.innerHTML = html;`, add the sort event listener:
  ```javascript
  var sortSelect = headerEl.querySelector('#directorySort');
  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      listPage = 0;
      renderList();
    });
  }
  ```
  In `getFilteredData()`, after the search filter, add sort logic:
  ```javascript
  var sortVal = document.getElementById('directorySort');
  var sortBy = sortVal ? sortVal.value : 'name';
  filtered.sort(function(a, b) {
    if (sortBy === 'name') return a.n.localeCompare(b.n);
    if (sortBy === 'name-desc') return b.n.localeCompare(a.n);
    if (sortBy === 'city') return (a.c || '').localeCompare(b.c || '') || a.n.localeCompare(b.n);
    return 0;
  });
  ```
  Add CSS:
  ```css
  .directory-sort {
    display: flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0;
    font-family: 'DM Sans', sans-serif; font-size: 0.78rem;
  }
  .directory-sort-label { color: var(--ink, #1a1612); opacity: 0.6; white-space: nowrap; }
  .directory-sort-select {
    font-family: 'DM Sans', sans-serif; font-size: 0.78rem;
    padding: 0.25rem 0.5rem; border: 1px solid rgba(0,0,0,0.15); border-radius: 6px;
    background: var(--cream, #f5f0e8); color: var(--ink, #1a1612); cursor: pointer;
  }
  ```

  **M6 — Footer upgrade:** Replace the skeletal footer with a proper version. In directory.html, replace the `<footer class="colophon">` block:
  ```html
  <footer class="colophon">
    <div class="colophon-inner">
      <div class="colophon-brand">
        <strong>Explore Nevada County</strong>
        <span>A Nevada County Arts Council Initiative</span>
      </div>
      <nav class="colophon-links" aria-label="Footer">
        <a href="index-maplibre-hero-intent-stitch-frontend-design-pass.html">Explore</a>
        <a href="events.html">Events</a>
        <a href="itineraries.html">Itineraries</a>
        <a href="directory.html">Directory</a>
      </nav>
      <div class="colophon-meta">
        <span>&copy; 2026 Nevada County Arts Council</span>
        <span>Data sourced from ArcGIS Cultural Asset Map</span>
      </div>
    </div>
  </footer>
  ```
  Check that `.colophon-brand`, `.colophon-links`, `.colophon-meta` CSS already exists in the main CSS file (it likely does from the hub). If not, add basic styling.
  </action>
  <verify>(1) Search for "xyznonexistent" — should show "No places found" empty state. (2) In a category with 30+ items, "Show more" button shows count "(30 of 85)". (3) Sort dropdown changes list order (A-Z, Z-A, By City). (4) Footer has brand, nav links, and attribution.</verify>
  <done>Empty state renders for zero results. Pagination shows progress count. Sort dropdown works with A-Z, Z-A, and By City options. Footer has proper content.</done>
</task>

<task type="auto">
  <name>Task 2: Category grid density, mobile map toggle, city filter constant</name>
  <files>website/cultural-map-redesign-stitch-lab/directory.html, website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css</files>
  <action>
  **M5 — Category grid density:** In the CSS file, find `.directory-grid` and change the 3-column grid to 2-column inside the split pane:
  ```css
  .directory-page .directory-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  @media (max-width: 600px) {
    .directory-page .directory-grid {
      grid-template-columns: 1fr;
    }
  }
  ```
  Check existing CSS rules first — if `.directory-grid` already has `grid-template-columns`, override it for `.directory-page` context.

  **M8 — Mobile map collapse toggle:** Add a toggle button between the map pane and directory pane. In the HTML, add before `<div class="map-pane">`:
  ```html
  <button class="directory-map-toggle" id="directoryMapToggle" type="button" aria-label="Toggle map">
    <span class="directory-map-toggle-text">Hide Map</span>
  </button>
  ```
  In JS init, add:
  ```javascript
  var mapToggle = document.getElementById('directoryMapToggle');
  if (mapToggle) {
    mapToggle.addEventListener('click', function() {
      var mapPane = document.querySelector('.map-pane');
      var isHidden = mapPane.classList.toggle('map-pane--collapsed');
      mapToggle.querySelector('.directory-map-toggle-text').textContent = isHidden ? 'Show Map' : 'Hide Map';
      if (!isHidden && map) {
        setTimeout(function() { map.resize(); }, 300);
      }
    });
  }
  ```
  CSS:
  ```css
  .directory-map-toggle {
    display: none; /* only show on mobile */
    width: 100%; padding: 0.4rem; text-align: center;
    font-family: 'DM Sans', sans-serif; font-size: 0.75rem; font-weight: 600;
    letter-spacing: 0.05em; text-transform: uppercase;
    background: var(--cream, #f5f0e8); border: 1px solid rgba(0,0,0,0.1); border-radius: 0;
    color: var(--ink, #1a1612); cursor: pointer;
  }
  @media (max-width: 900px) {
    .directory-map-toggle { display: block; }
    .map-pane--collapsed { display: none; }
  }
  ```

  **Min3 — City filter threshold:** The threshold is already 3 (line 576: `filter(function(p) { return p[1] >= 3; })`). Document this as a constant. Add at the top of the IIFE near `PAGE_SIZE`:
  ```javascript
  var CITY_FILTER_MIN = 3;  // Minimum venues in a city to show as a filter pill
  ```
  Then use it: `.filter(function(p) { return p[1] >= CITY_FILTER_MIN; })`
  </action>
  <verify>(1) Category grid shows 2 columns in sidebar, 1 column on mobile (<600px). (2) On mobile viewport (<900px), map toggle button shows — click "Hide Map" hides the map, "Show Map" restores it. Map resizes correctly on re-show. (3) City filter threshold uses `CITY_FILTER_MIN` constant.</verify>
  <done>Category grid uses 2-column layout in sidebar context. Mobile map toggle collapses/expands. City filter threshold is a named constant.</done>
</task>

<task type="auto">
  <name>Task 3: Map-list hover sync, sticky header, keyboard a11y, CSS polish</name>
  <files>website/cultural-map-redesign-stitch-lab/directory.html, website/cultural-map-redesign-stitch-lab/index-maplibre-hero-intent-stitch-frontend-design-pass.css</files>
  <action>
  **M10 — Map-list hover sync (bidirectional):**

  *List → Map:* In `renderList()`, after creating each `item` element and before `list.appendChild(item)`, add mouseenter/mouseleave handlers:
  ```javascript
  item.addEventListener('mouseenter', function() {
    if (!map || isCoarsePointer) return;
    var featureId = asset.id;
    if (hoveredFeatureId !== null) {
      map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: false });
    }
    hoveredFeatureId = featureId;
    map.setFeatureState({ source: 'assets', id: featureId }, { hover: true });
  });
  item.addEventListener('mouseleave', function() {
    if (!map || isCoarsePointer) return;
    if (hoveredFeatureId !== null) {
      map.setFeatureState({ source: 'assets', id: hoveredFeatureId }, { hover: false });
      hoveredFeatureId = null;
    }
  });
  ```
  NOTE: For `setFeatureState` to work, the GeoJSON features need a numeric `id` property at the feature level (not just in `properties`). Check if `buildAssetsGeoJSON` sets `feature.id` — if not, the feature state won't work. Instead, use map filter approach: set a temporary filter highlight or use `setPaintProperty` to override the hovered marker's color. Alternatively, if the `assets` source uses `promoteId: 'idx'` in its source config, feature state will work. Add `promoteId: 'idx'` to the source definition:
  ```javascript
  map.addSource('assets', { type: 'geojson', data: geojson, promoteId: 'idx' });
  ```

  *Map → List:* In the `assetInteractions.bindAssetInteractions` setup (or in a custom mousemove handler on the map), when hovering a map marker, find the corresponding sidebar card and add a highlight class. If using the `assetInteractions` module, it already handles hover via `setHoveredFeatureId`. Add a watcher:
  ```javascript
  // In the mouseenter handler of assets-circle (or via assetInteractions callback)
  // Highlight sidebar card
  function highlightSidebarCard(assetId) {
    var prev = document.querySelector('.directory-item--hover');
    if (prev) prev.classList.remove('directory-item--hover');
    if (assetId !== null) {
      var card = document.querySelector('.directory-item[data-asset-id="' + assetId + '"]');
      if (card) {
        card.classList.add('directory-item--hover');
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }
  }
  ```
  Wire this into the existing hover tracking. **Explicitly modify BOTH existing `setHoveredFeatureId` callbacks** in directory.html's `initMap()` function. There are two locations (around lines ~384 and ~405 in the current file) that look like:
  ```javascript
  setHoveredFeatureId: function(v) { hoveredFeatureId = v; },
  ```
  Change BOTH to:
  ```javascript
  setHoveredFeatureId: function(v) { hoveredFeatureId = v; highlightSidebarCard(v); },
  ```
  This ensures that when the map interaction module calls `setHoveredFeatureId`, the sidebar card highlight is triggered in both the `bindAssetInteractions` and `assetInteractions.setupAssetLabelLayer` code paths.

  Add CSS:
  ```css
  .directory-item--hover {
    box-shadow: 0 0 0 2px var(--gold, #c8943e);
    transition: box-shadow 0.15s ease;
  }
  ```

  **Min4 — Sticky header:** Add CSS for the directory pane title area to stick on scroll:
  ```css
  .directory-page .directory-pane > .directory-pane-title,
  .directory-page .directory-pane > .directory-search-input {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--cream, #f5f0e8);
  }
  ```
  Actually, a better approach is to make the search input sticky within the scrollable pane. The `.directory-pane` is the scrollable container. Make the search input stick to the top:
  ```css
  .directory-page #directorySearch {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--cream, #f5f0e8);
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }
  ```

  **Min5 — Keyboard accessibility:**
  1. Make category cards focusable: in `renderCategoryCards()`, add `card.setAttribute('tabindex', '0'); card.setAttribute('role', 'button');`. Add keydown handler: `card.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectCategory(name); } });`
  2. Make directory items focusable: in `renderList()`, add `item.setAttribute('tabindex', '0'); item.setAttribute('role', 'button');`. Add keydown handler: `item.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectItem(asset); } });`
  3. Search submit on Enter: the search input already debounces on `input` event, which fires on Enter too. No change needed.

  **Min9 — Search focus ring:** Add CSS:
  ```css
  .directory-search-input:focus {
    outline: 2px solid var(--gold, #c8943e);
    outline-offset: 2px;
  }
  ```

  **Min8 — Inline tooltip tokens:** Check the inline tooltip styles in the `<style>` block. Replace any hardcoded colors with CSS custom properties:
  - `#1a1612` → `var(--ink, #1a1612)`
  - `#f5f0e8` → `var(--cream, #f5f0e8)`
  - Any other hardcoded colors → appropriate CSS vars
  The existing tooltip styles already use some vars. Ensure consistency.

  **Min10 — Expanded card contrast:** Check `.directory-item--expanded` and `.directory-item-expanded` styles for WCAG AA contrast. The expanded content text should be at minimum 4.5:1 against its background. If the expanded div has low-contrast text (e.g., gray on cream), increase opacity or use darker text:
  ```css
  .directory-item-expanded { color: var(--ink, #1a1612); }
  .directory-item-full-desc { color: var(--ink, #1a1612); opacity: 0.85; line-height: 1.6; }
  ```

  **Min2 — Category/fuzzy match edge cases:** In the deep link handler (from 09-02), the `?cat=` matching already does case-insensitive comparison and strips `&,` characters. Add an additional fuzzy match: if exact match fails, try partial match:
  ```javascript
  if (!match) {
    match = Object.keys(CATS).find(function(k) {
      return k.toLowerCase().indexOf(urlCat.toLowerCase()) !== -1;
    });
  }
  ```
  This handles cases like `?cat=galleries` matching "Galleries & Museums".
  </action>
  <verify>(1) Hover over a card in the sidebar — corresponding map marker should get a highlight glow. (2) Hover over a map marker — corresponding sidebar card gets gold outline and scrolls into view. (3) Tab through category cards — focus ring visible, Enter/Space activates. (4) Tab through directory items — same keyboard behavior. (5) Search input has gold focus ring. (6) Check expanded card text contrast with browser DevTools accessibility audit. (7) Search input sticks to top when scrolling the directory pane.</verify>
  <done>Bidirectional map-list hover sync works. Keyboard tabbing through cards and items with Enter/Space activation. Focus rings visible. Sticky search. Tooltip colors use CSS tokens. Expanded card meets WCAG AA contrast.</done>
</task>

</tasks>

<verification>
1. Search "xyzfake" → empty state with message and hint
2. Category with 50+ items → "Show more (30 of 52)" button text
3. Sort dropdown: A-Z, Z-A, By City all reorder the list
4. Mobile viewport → "Hide Map" / "Show Map" toggle works
5. Footer has brand name, nav links, copyright, data attribution
6. Hover sidebar card → map marker glows. Hover map marker → sidebar card outlined in gold.
7. Tab through cards → visible focus ring, Enter activates
8. Search input sticky on scroll within directory pane
9. Expanded card text passes WCAG AA contrast check
10. `?cat=galleries` matches "Galleries & Museums" (fuzzy)
</verification>

<success_criteria>
- `.directory-empty-state` renders when filtered results are empty
- Load more button shows "Show more (X of Y)" text
- Sort select changes list order (A-Z, Z-A, By City)
- `.directory-map-toggle` visible on mobile, toggles `.map-pane--collapsed`
- Footer has `.colophon-brand`, `.colophon-links`, `.colophon-meta`
- `promoteId: 'idx'` on assets source enables feature state
- `setFeatureState` hover glow on map when sidebar card hovered
- `highlightSidebarCard()` adds `.directory-item--hover` when map marker hovered
- Category cards and directory items have `tabindex="0"` and Enter/Space handlers
- Search input has `:focus` style with gold outline
- `CITY_FILTER_MIN` constant defined and used
- Tooltip colors use CSS custom properties
- Expanded card text color at minimum 4.5:1 contrast ratio
</success_criteria>

<output>
After completion, create `.planning/phases/09-directory-page-redesign/09-03-SUMMARY.md`
</output>
