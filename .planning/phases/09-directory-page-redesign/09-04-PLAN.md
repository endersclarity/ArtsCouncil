---
phase: 09-directory-page-redesign
plan: 04
type: execute
wave: 2
depends_on: [09-01]
files_modified:
  - website/cultural-map-redesign-stitch-lab/data.json
  - website/cultural-map-redesign-stitch-lab/qr-gallery.html
autonomous: true
requirements: [D1, D2, M16, Min11]

must_haves:
  truths:
    - "No assets in data.json have coordinates outside Nevada County bounds (-122 to -119 lng, 38 to 40.5 lat)"
    - "No duplicate asset names exist within the same category in data.json"
    - "QR gallery Elixart link uses ?place= format, not ?idx=544"
    - "QR gallery communicates its scope (7 of 25 stops featured)"
  artifacts:
    - path: "website/cultural-map-redesign-stitch-lab/data.json"
      provides: "Corrected coordinates and deduplicated entries"
    - path: "website/cultural-map-redesign-stitch-lab/qr-gallery.html"
      provides: "Stable deep link for Elixart, scope messaging"
      contains: "place=Elixart"
  key_links:
    - from: "qr-gallery.html Elixart link"
      to: "hub ?place= deep link handler"
      via: "URL parameter parsed by hub's parseDeepLinkSearch"
      pattern: "place=Elixart"
---

<objective>
Fix data quality issues (bad coordinates, duplicate entries) and update QR gallery deep link from fragile ?idx= to stable ?place= format.

Purpose: D1/D2 are data integrity issues that affect map rendering (bad coordinates show markers in wrong locations) and directory counts (duplicates inflate numbers). M16 and Min11 address the QR code gallery's incomplete scope messaging and fragile Elixart link that would break on any data.json reorder. This plan can run in parallel with 09-02 since it touches different files.

Output: Cleaned data.json, updated qr-gallery.html with stable links and scope messaging.
</objective>

<execution_context>
@C:/Users/ender/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/ender/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/09-directory-page-redesign/09-RESEARCH.md
@website/cultural-map-redesign-stitch-lab/qr-gallery.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix data.json coordinates and duplicates</name>
  <files>website/cultural-map-redesign-stitch-lab/data.json</files>
  <action>
  **D1 — Bad coordinates:** Write a quick Node.js audit script (inline or temp file) that:
  1. Reads `data.json`
  2. Checks each entry's `x` (longitude) and `y` (latitude) against Nevada County bounds: lng should be between -122.0 and -119.5, lat should be between 38.5 and 40.0
  3. Reports any entries outside these bounds with their name, current coordinates, and array index
  4. For each bad-coordinate entry, research the correct location (use the asset name + "Nevada County CA" to determine correct coords). The audit mentioned 3 specific assets — identify them and fix their coordinates in data.json.

  If an entry has `x: 0, y: 0` or clearly wrong coordinates (e.g., in the ocean), either:
  - Fix to correct coordinates if the venue is real and identifiable
  - Remove the entry if it's a data error with no real location

  **D2 + Min11 — Duplicate entries:** The audit script should also:
  1. Group entries by name (`n` field)
  2. Report any names that appear more than once
  3. For duplicates within the SAME category: remove the duplicate (keep the first occurrence, or the one with more complete data — has description, phone, website, etc.)
  4. For duplicates across DIFFERENT categories: these may be intentional (e.g., a venue listed as both "Galleries" and "Performance Spaces"). Flag but do not auto-remove.

  **Implementation approach:**
  ```bash
  node -e "
    var data = require('./website/cultural-map-redesign-stitch-lab/data.json');
    var bounds = { minLng: -122.0, maxLng: -119.5, minLat: 38.5, maxLat: 40.0 };
    var badCoords = [];
    var nameCount = {};
    data.forEach(function(d, i) {
      var lng = parseFloat(d.x) || 0;
      var lat = parseFloat(d.y) || 0;
      if (lng < bounds.minLng || lng > bounds.maxLng || lat < bounds.minLat || lat > bounds.maxLat) {
        badCoords.push({ idx: i, name: d.n, lng: lng, lat: lat, layer: d.l });
      }
      var key = d.n + '|' + d.l;
      nameCount[key] = (nameCount[key] || 0) + 1;
    });
    console.log('=== BAD COORDINATES ===');
    badCoords.forEach(function(b) { console.log(JSON.stringify(b)); });
    console.log('=== DUPLICATES (same name + category) ===');
    Object.entries(nameCount).filter(function(e) { return e[1] > 1; }).forEach(function(e) {
      console.log(e[0] + ': ' + e[1] + ' occurrences');
    });
  "
  ```

  Run this first to identify issues, then make targeted fixes to data.json. data.json is a single-line JSON array — use `JSON.parse` + targeted edits + `JSON.stringify` to write back.

  **IMPORTANT:** data.json is large (687 items, ~160KB). Do NOT reformat it — keep it as compact JSON (no pretty-printing) to minimize diff size. Use a script to read, modify, and write back:
  ```bash
  node -e "
    var fs = require('fs');
    var path = 'website/cultural-map-redesign-stitch-lab/data.json';
    var data = JSON.parse(fs.readFileSync(path, 'utf8'));
    // ... apply fixes ...
    fs.writeFileSync(path, JSON.stringify(data));
  "
  ```
  </action>
  <verify>Run the audit script again after fixes. (1) Zero entries outside Nevada County bounds. (2) Zero same-name-same-category duplicates. (3) data.json is valid JSON (parse it). (4) Total entry count should be 687 minus any removed duplicates.</verify>
  <done>All data.json coordinates are within Nevada County bounds. No same-category duplicate names exist. data.json is valid compact JSON.</done>
</task>

<task type="auto">
  <name>Task 2: Update QR gallery Elixart link and add scope messaging</name>
  <files>website/cultural-map-redesign-stitch-lab/qr-gallery.html</files>
  <action>
  **M16 partial — Fix Elixart link:** In `qr-gallery.html`, find the Elixart entry (Stop 6, around line 527). Replace:
  ```html
  href="index-maplibre-hero-intent-stitch-frontend-design-pass.html?idx=544"
  ```
  with:
  ```html
  href="index-maplibre-hero-intent-stitch-frontend-design-pass.html?place=Elixart+Herbal+Lounge+and+Gallery"
  ```
  First verify the exact name in data.json by searching for "Elixart" — use the EXACT `n` field value. URL-encode spaces as `+`.

  **M16 — Scope messaging:** The QR gallery shows 7 stops but the full trail has 25 venues. Add scope messaging to make this clear. Find the gallery intro/header section and add text like:
  ```html
  <p class="gallery-scope">Featuring 7 of 25 stops on the Nevada County Cultural Trail. <a href="directory.html">Browse all venues</a></p>
  ```
  If a header section doesn't exist, add it above the first stop card. Style to match the existing page aesthetic — check the QR gallery's existing inline CSS for font/color patterns.

  Also check if any OTHER links in the QR gallery use `?idx=` or `?pid=` format and convert them to `?place=` if so. Scan all `href` attributes in the file.
  </action>
  <verify>(1) Open qr-gallery.html, click the Elixart venue flyer/link — it should navigate to the hub page with `?place=Elixart...` in the URL and expand the correct venue. (2) The gallery page shows "Featuring 7 of 25 stops" messaging. (3) Grep qr-gallery.html for `idx=` — should return zero results.</verify>
  <done>Elixart deep link uses stable ?place= format. QR gallery communicates scope (7 of 25). No ?idx= links remain.</done>
</task>

</tasks>

<verification>
1. Run coordinate bounds check on data.json — all entries within Nevada County
2. Run duplicate name check on data.json — no same-category duplicates
3. QR gallery Elixart link uses `?place=` not `?idx=`
4. QR gallery shows scope messaging (7 of 25)
5. No `?idx=` links anywhere in qr-gallery.html
6. data.json is valid JSON and parseable
</verification>

<success_criteria>
- data.json passes bounds check: all x values between -122.0 and -119.5, all y values between 38.5 and 40.0
- data.json passes dedup check: no entries with identical name AND category
- qr-gallery.html Elixart href contains `?place=Elixart` (not `?idx=544`)
- qr-gallery.html contains scope text mentioning "7 of 25" or similar
- data.json remains compact single-line JSON (not pretty-printed)
</success_criteria>

<output>
After completion, create `.planning/phases/09-directory-page-redesign/09-04-SUMMARY.md`
</output>
